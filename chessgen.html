<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChessGen Pro | AI Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chessboard.js dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #09090b;
            color: #fafafa;
            margin: 0;
            overflow-y: auto !important; /* Force scrollability */
        }

        .dot-grid { 
            background-image: radial-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px); 
            background-size: 30px 30px; 
        }

        /* Responsive Board Container */
        #board { 
            width: 100%; 
            max-width: 600px;
            margin: 0 auto;
            border: 6px solid #18181b; 
            border-radius: 8px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Fullscreen Overlay */
        .fullscreen-active {
            position: fixed !important;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            background: #000;
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .fullscreen-active #board {
            max-width: 95vw !important;
            max-height: 95vh !important;
        }

        /* Square Highlights */
        .legal-dot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 25%;
            height: 25%;
            background: rgba(16, 185, 129, 0.5);
            border-radius: 50%;
            pointer-events: none;
        }

        .highlight-selected {
            background-color: rgba(16, 185, 129, 0.3) !important;
            box-shadow: inset 0 0 0 4px rgba(16, 185, 129, 0.5) !important;
        }

        .eval-bar-container { 
            width: 12px; 
            height: auto; 
            min-height: 300px;
            background: #18181b; 
            border-radius: 6px; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid #27272a;
        }
        
        #eval-bar-fill { 
            position: absolute; 
            bottom: 0; 
            width: 100%; 
            background: #ffffff; 
            transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* Board Colors */
        .white-1e1d7 { background-color: #3b3b3b !important; }
        .black-3c85d { background-color: #1a1a1a !important; }

        @media (max-width: 768px) {
            #board { max-width: 100%; }
            .eval-bar-container { width: 8px; min-height: 200px; }
        }
    </style>
</head>
<body class="min-h-screen dot-grid">
    <!-- Fullscreen Controls -->
    <div id="fs-ui" class="fixed top-4 right-4 z-[10000] hidden">
        <button onclick="exitFullscreen()" class="p-3 bg-zinc-900/90 border border-zinc-700 rounded-full hover:bg-zinc-800">
            <i data-lucide="minimize-2" class="w-6 h-6 text-white"></i>
        </button>
    </div>

    <!-- Main Responsive Layout -->
    <div class="max-w-7xl mx-auto px-4 py-6 md:py-10">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 backdrop-blur-sm">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-600/20">
                    <i data-lucide="shield-check" class="text-white w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">ChessGen <span class="text-emerald-500">Pro</span></h1>
                    <div id="user-badge" class="text-[10px] text-zinc-500 font-mono flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                        <span id="user-display">Loading Analyst...</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="flex-1 md:flex-none px-4 py-2 bg-zinc-950 rounded-lg border border-zinc-800 text-center">
                    <span class="text-[10px] uppercase text-zinc-500 block font-bold">Studio ELO</span>
                    <span id="user-elo" class="text-sm font-mono text-emerald-400 font-bold">1200</span>
                </div>
                <button onclick="handleLogout()" class="p-3 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- Left Side: Board & Eval -->
            <div class="lg:col-span-8 space-y-6">
                <div class="flex gap-4 md:gap-6 items-stretch justify-center">
                    <!-- Eval Bar -->
                    <div class="eval-bar-container">
                        <div id="eval-bar-fill" style="height: 50%;"></div>
                    </div>
                    
                    <!-- Chess Board -->
                    <div class="flex-1 flex flex-col items-center">
                        <div id="board" class="w-full"></div>
                        <div class="mt-4 flex w-full justify-between items-center px-2">
                            <button onclick="resetGame()" class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-400 hover:text-white transition-colors">
                                <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Reset
                            </button>
                            <span class="text-[10px] text-zinc-600 uppercase font-bold tracking-widest hidden sm:block">Double Click to Fullscreen</span>
                            <button onclick="toggleFullscreen()" class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-emerald-500">
                                <i data-lucide="maximize" class="w-3.5 h-3.5"></i> Expand
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Live Status Card -->
                <div class="grid grid-cols-2 gap-4 bg-zinc-900/30 border border-zinc-800 p-6 rounded-2xl">
                    <div class="space-y-1">
                        <p class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest">Neural Eval</p>
                        <p id="eval-score-text" class="text-2xl font-mono font-bold text-emerald-500">+0.0</p>
                    </div>
                    <div class="space-y-1 text-right">
                        <p class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest">Match State</p>
                        <p id="game-status" class="text-sm font-bold uppercase text-white truncate">Calculating...</p>
                    </div>
                </div>
            </div>

            <!-- Right Side: Controls & History -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Engine Config -->
                <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-2xl space-y-4">
                    <div class="flex items-center gap-2">
                        <i data-lucide="cpu" class="w-4 h-4 text-emerald-500"></i>
                        <h3 class="text-sm font-bold uppercase tracking-widest">Neural Depth</h3>
                    </div>
                    <select id="level-select" class="w-full bg-zinc-950 border border-zinc-700 rounded-xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                        <option value="1">Lvl 1 - Novice (Depth 1)</option>
                        <option value="2">Lvl 2 - Casual (Depth 2)</option>
                        <option value="3" selected>Lvl 3 - Standard (Depth 3)</option>
                        <option value="4">Lvl 4 - Advanced (Depth 4)</option>
                        <option value="5">Lvl 5 - Expert (Depth 5)</option>
                        <option value="6">Lvl 6 - Grandmaster (Depth 6)</option>
                    </select>
                </div>

                <!-- Move History -->
                <div class="bg-zinc-900/50 border border-zinc-800 rounded-2xl flex flex-col h-[400px]">
                    <div class="p-6 border-b border-zinc-800 flex items-center gap-2">
                        <i data-lucide="scroll-text" class="w-4 h-4 text-emerald-500"></i>
                        <h3 class="text-sm font-bold uppercase tracking-widest">Analyst Log</h3>
                    </div>
                    <div id="move-history" class="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-[11px]">
                        <div class="text-zinc-600 italic">No moves recorded.</div>
                    </div>
                </div>

                <button onclick="window.location.href='portal.html'" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold text-xs uppercase tracking-[0.2em] shadow-lg shadow-emerald-600/20 transition-all">
                    Return to Portal
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://rnlwrngfgvznndlekmrz.supabase.co";
        const SUPABASE_KEY = "sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt";
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let board = null;
        let game = new Chess();
        let selectedSquare = null;
        let userElo = 1200;
        let isFullscreen = false;

        async function checkAuth() {
            const { data: { session } } = await client.auth.getSession();
            if (!session) {
                const currentUrl = window.location.href;
                window.location.href = `auth.html?redirect=${encodeURIComponent(currentUrl)}`;
                return;
            }
            
            const user = session.user;
            document.getElementById('user-display').innerText = user.email.split('@')[0].toUpperCase();
            
            const savedElo = localStorage.getItem('chessgen_elo');
            if (savedElo) userElo = parseInt(savedElo);
            document.getElementById('user-elo').innerText = userElo;

            initBoard();
            document.getElementById('game-status').innerText = 'Your Move';
        }

        async function handleLogout() {
            await client.auth.signOut();
            window.location.href = 'auth.html';
        }

        function initBoard() {
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: (source, piece) => {
                    if (game.game_over() || piece.search(/^w/) === -1 || game.turn() === 'b') return false;
                    removeHighlights();
                    highlightSquare(source);
                    selectedSquare = source;
                },
                onDrop: (source, target) => {
                    const move = game.move({ from: source, to: target, promotion: 'q' });
                    removeHighlights();
                    selectedSquare = null;
                    if (move === null) return 'snapback';
                    
                    updateUI();
                    if (!game.game_over()) makeEngineMove();
                    else checkGameEnd();
                },
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            
            board = Chessboard('board', config);
            
            $(document).on('click', '#board .square-55d63', function() {
                onSquareClick($(this).attr('data-square'));
            });

            $(document).on('dblclick', '#board', toggleFullscreen);
            window.addEventListener('resize', () => board.resize());
        }

        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            const boardContainer = document.getElementById('board');
            const fsUI = document.getElementById('fs-ui');
            
            if (isFullscreen) {
                boardContainer.parentElement.classList.add('fullscreen-active');
                fsUI.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                boardContainer.parentElement.classList.remove('fullscreen-active');
                fsUI.classList.add('hidden');
                document.body.style.overflow = '';
            }
            board.resize();
        }

        window.exitFullscreen = () => { if (isFullscreen) toggleFullscreen(); }

        function onSquareClick(square) {
            if (game.turn() === 'b' || game.game_over()) return;
            const piece = game.get(square);

            if (selectedSquare && $(`#board .square-${square}`).hasClass('legal-dot')) {
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                if (move) {
                    selectedSquare = null;
                    removeHighlights();
                    board.position(game.fen());
                    updateUI();
                    if(!game.game_over()) makeEngineMove();
                    else checkGameEnd();
                    return;
                }
            }

            if (piece && piece.color === 'w') {
                if (selectedSquare === square) {
                    selectedSquare = null;
                    removeHighlights();
                } else {
                    selectedSquare = square;
                    removeHighlights();
                    highlightSquare(square);
                }
            } else {
                selectedSquare = null;
                removeHighlights();
            }
        }

        function removeHighlights() { 
            $('#board .square-55d63').removeClass('legal-dot highlight-selected'); 
        }
        
        function highlightSquare(square) {
            const moves = game.moves({ square: square, verbose: true });
            if (moves.length === 0) return;
            $(`#board .square-${square}`).addClass('highlight-selected');
            moves.forEach(move => { $(`#board .square-${move.to}`).addClass('legal-dot'); });
        }

        function checkGameEnd() {
            if (game.game_over()) {
                let status = "Game Over";
                if (game.in_checkmate()) {
                    status = game.turn() === 'w' ? "CHECKMATE: AI WON" : "CHECKMATE: YOU WON";
                    updateElo(game.turn() === 'w' ? -1 : 1);
                } else if (game.in_draw()) {
                    status = "DRAW";
                    updateElo(0);
                }
                document.getElementById('game-status').innerText = status;
            }
        }

        function updateElo(result) {
            const K = 32;
            const engineElo = [800, 1000, 1400, 1800, 2200, 2600][parseInt(document.getElementById('level-select').value) - 1];
            const expectedScore = 1 / (1 + Math.pow(10, (engineElo - userElo) / 400));
            const actualScore = result === 1 ? 1 : (result === 0 ? 0.5 : 0);
            userElo = Math.round(userElo + K * (actualScore - expectedScore));
            document.getElementById('user-elo').innerText = userElo;
            localStorage.setItem('chessgen_elo', userElo);
        }

        function makeEngineMove() {
            document.getElementById('game-status').innerText = 'AI Thinking...';
            setTimeout(() => {
                const bestMove = getBestMove(game);
                if (bestMove) {
                    game.move(bestMove);
                    board.position(game.fen());
                    updateUI();
                    if (game.game_over()) checkGameEnd();
                    else document.getElementById('game-status').innerText = 'Your Move';
                }
            }, 600);
        }

        // MiniMax Logic
        const weights = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };
        function evaluateBoard(game) {
            let total = 0;
            game.board().forEach(row => { row.forEach(piece => {
                if (piece) total += (piece.color === 'w' ? weights[piece.type] : -weights[piece.type]);
            })});
            return total;
        }

        function minimax(game, depth, alpha, beta, isMaximizing) {
            if (depth === 0) return -evaluateBoard(game);
            const moves = game.moves();
            if (isMaximizing) {
                let best = -99999;
                for (let move of moves) {
                    game.move(move);
                    best = Math.max(best, minimax(game, depth - 1, alpha, beta, !isMaximizing));
                    game.undo();
                    alpha = Math.max(alpha, best);
                    if (beta <= alpha) break;
                }
                return best;
            } else {
                let best = 99999;
                for (let move of moves) {
                    game.move(move);
                    best = Math.min(best, minimax(game, depth - 1, alpha, beta, !isMaximizing));
                    game.undo();
                    beta = Math.min(beta, best);
                    if (beta <= alpha) break;
                }
                return best;
            }
        }

        function getBestMove(game) {
            const moves = game.moves();
            let bestMove = null;
            let bestVal = -99999;
            const depth = parseInt(document.getElementById('level-select').value);
            moves.sort(() => Math.random() - 0.5);
            for (let move of moves) {
                game.move(move);
                const val = minimax(game, depth - 1, -100000, 100000, false);
                game.undo();
                if (val > bestVal) { bestVal = val; bestMove = move; }
            }
            return bestMove;
        }

        function updateUI() {
            const history = game.history();
            const historyEl = document.getElementById('move-history');
            if (history.length === 0) {
                historyEl.innerHTML = '<div class="text-zinc-600 italic">No moves recorded.</div>';
            } else {
                historyEl.innerHTML = history.map((m, i) => `
                    <div class="flex justify-between p-2 rounded bg-zinc-950 border border-zinc-800">
                        <span class="text-zinc-500">${i + 1}.</span>
                        <span class="text-white font-bold">${m}</span>
                    </div>
                `).reverse().join('');
            }

            const score = (evaluateBoard(game) / 100).toFixed(1);
            document.getElementById('eval-score-text').innerText = (score > 0 ? "+" : "") + score;
            const percentage = Math.min(100, Math.max(0, 50 - (score * 5)));
            document.getElementById('eval-bar-fill').style.height = `${percentage}%`;
        }

        window.resetGame = () => {
            game.reset();
            board.start();
            updateUI();
            document.getElementById('game-status').innerText = 'Your Move';
        };

        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            if (window.lucide) window.lucide.createIcons();
        });
    </script>
</body>
</html>

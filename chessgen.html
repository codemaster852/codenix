<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChessGen Pro | Nix AI Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chessboard.js dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-dark: #09090b;
            --accent: #10b981;
            --glass: rgba(24, 24, 27, 0.8);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark);
            color: #fafafa;
            margin: 0;
            overflow-x: hidden;
        }

        .dot-grid { 
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px); 
            background-size: 24px 24px; 
        }

        .glass-card { 
            background: rgba(18, 18, 20, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        #board { 
            width: 100%; 
            max-width: 520px; 
            border: 8px solid #18181b; 
            border-radius: 12px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.8);
        }

        /* Legal Move Indicator */
        .legal-dot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: rgba(16, 185, 129, 0.4);
            border-radius: 50%;
            pointer-events: none;
        }

        .highlight-selected {
            background-color: rgba(16, 185, 129, 0.2) !important;
            box-shadow: inset 0 0 0 3px rgba(16, 185, 129, 0.5) !important;
        }

        .eval-bar-container { 
            width: 12px; 
            height: 520px; 
            background: #18181b; 
            border-radius: 6px; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid #27272a;
        }
        
        #eval-bar-fill { 
            position: absolute; 
            bottom: 0; 
            width: 100%; 
            background: #ffffff; 
            transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* Board Colors Overrides */
        .white-1e1d7 { background-color: #27272a !important; }
        .black-3c85d { background-color: #09090b !important; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .move-anim { animation: slideIn 0.3s ease forwards; }
    </style>
</head>
<body class="min-h-screen selection:bg-emerald-500/30">
    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-80 border-r border-zinc-800 bg-zinc-950 flex flex-col hidden lg:flex">
            <div class="p-6 border-b border-zinc-800 flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-600/20">
                    <i data-lucide="shield-check" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm tracking-tight text-white leading-tight">ChessGen Pro</h1>
                    <p class="text-[10px] text-zinc-500 font-medium tracking-wider uppercase">Advanced Neural Studio</p>
                </div>
            </div>

            <div class="flex-1 p-6 space-y-8 overflow-y-auto custom-scrollbar">
                <!-- User Profile Section -->
                <div class="space-y-4">
                    <header class="flex items-center gap-2 mb-2">
                        <i data-lucide="user" class="w-3.5 h-3.5 text-zinc-500"></i>
                        <label class="text-[10px] uppercase tracking-[0.15em] text-zinc-500 font-bold">Studio Profile</label>
                    </header>
                    <div class="glass-card p-4 rounded-xl space-y-3">
                        <div class="flex items-center gap-3">
                            <div id="user-initial" class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center text-sm font-bold text-emerald-400">?</div>
                            <div class="flex-1 overflow-hidden">
                                <div id="user-name" class="text-xs font-bold truncate">Guest Analyst</div>
                                <div id="user-elo" class="text-xs font-mono text-emerald-500 font-bold">ELO: 1200</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Engine Config -->
                <div>
                    <header class="flex items-center gap-2 mb-4">
                        <i data-lucide="cpu" class="w-3.5 h-3.5 text-zinc-500"></i>
                        <label class="text-[10px] uppercase tracking-[0.15em] text-zinc-500 font-bold">Neural Engine Depth</label>
                    </header>
                    <div class="grid grid-cols-1 gap-2">
                        <select id="level-select" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-xs font-semibold focus:ring-1 focus:ring-emerald-500 outline-none transition-all">
                            <option value="1">Level 1 - Novice (Depth 1)</option>
                            <option value="2">Level 2 - Casual (Depth 2)</option>
                            <option value="3" selected>Level 3 - Intermediate (Depth 3)</option>
                            <option value="4">Level 4 - Expert (Depth 4)</option>
                            <option value="5">Level 5 - Master (Depth 5)</option>
                            <option value="6">Level 6 - Grandmaster (Depth 6)</option>
                        </select>
                    </div>
                </div>

                <!-- History -->
                <div class="flex-1 flex flex-col min-h-0">
                    <header class="flex items-center gap-2 mb-4">
                        <i data-lucide="list" class="w-3.5 h-3.5 text-zinc-500"></i>
                        <label class="text-[10px] uppercase tracking-[0.15em] text-zinc-500 font-bold">Analysis Log</label>
                    </header>
                    <div id="move-history" class="space-y-2 font-mono text-[11px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Moves injected here -->
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-zinc-800">
                <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-zinc-900 border border-zinc-800 text-xs font-bold text-zinc-400 hover:text-white hover:bg-zinc-800 transition-all">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Sign Out Studio
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col relative dot-grid bg-zinc-950 overflow-y-auto">
            <header class="h-16 border-b border-zinc-800/50 flex items-center justify-between px-8 bg-zinc-950/80 backdrop-blur-md sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-zinc-900 border border-zinc-800">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                        <span class="text-[10px] font-bold text-zinc-300 uppercase tracking-widest" id="turn-indicator">System Booting</span>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="resetGame()" class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest bg-zinc-900 border border-zinc-800 px-5 py-2.5 rounded-lg hover:bg-zinc-800 transition-all">
                        <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                        Reset Session
                    </button>
                    <button onclick="window.location.href='portal.html'" class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest bg-emerald-600 px-5 py-2.5 rounded-lg hover:bg-emerald-500 shadow-lg shadow-emerald-600/20 transition-all">
                        <i data-lucide="grid" class="w-3.5 h-3.5"></i>
                        Portal
                    </button>
                </div>
            </header>

            <div class="flex-1 flex flex-col items-center justify-center p-8 space-y-8">
                <div class="flex gap-6 items-center">
                    <div class="eval-bar-container hidden md:block">
                        <div id="eval-bar-fill" style="height: 50%;"></div>
                    </div>
                    <div id="board"></div>
                </div>

                <div class="w-full max-w-[520px] glass-card p-6 rounded-2xl border border-zinc-800 flex justify-between items-center">
                    <div class="space-y-1">
                        <div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Position Eval</div>
                        <div id="eval-score-text" class="text-2xl font-bold font-mono text-emerald-500">0.0</div>
                    </div>
                    <div class="h-8 w-px bg-zinc-800"></div>
                    <div class="text-right space-y-1">
                        <div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Game Status</div>
                        <div id="game-status" class="text-sm font-bold uppercase text-white">READY</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Supabase Init
        const SUPABASE_URL = "https://rnlwrngfgvznndlekmrz.supabase.co";
        const SUPABASE_KEY = "sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt";
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State Management
        let board = null;
        let game = new Chess();
        let selectedSquare = null;
        let userElo = 1200;

        // Elo Logic
        function updateElo(result) {
            // result: 1 (win), 0 (draw), -1 (loss)
            const K = 32;
            const engineElo = [800, 1000, 1400, 1800, 2200, 2600][parseInt(document.getElementById('level-select').value) - 1];
            const expectedScore = 1 / (1 + Math.pow(10, (engineElo - userElo) / 400));
            const actualScore = result === 1 ? 1 : (result === 0 ? 0.5 : 0);
            
            userElo = Math.round(userElo + K * (actualScore - expectedScore));
            document.getElementById('user-elo').innerText = `ELO: ${userElo}`;
            localStorage.setItem('chessgen_elo', userElo);
        }

        async function checkAuth() {
            const { data: { session }, error } = await client.auth.getSession();
            if (error || !session) {
                // Not logged in, redirect to auth.html with current page as callback
                const currentUrl = window.location.href;
                window.location.href = `auth.html?redirect=${encodeURIComponent(currentUrl)}`;
                return;
            }

            const user = session.user;
            document.getElementById('user-name').innerText = user.email.split('@')[0];
            document.getElementById('user-initial').innerText = user.email[0].toUpperCase();
            
            // Load ELO from local storage or set default
            const savedElo = localStorage.getItem('chessgen_elo');
            if (savedElo) userElo = parseInt(savedElo);
            document.getElementById('user-elo').innerText = `ELO: ${userElo}`;

            setupBoard();
            document.getElementById('turn-indicator').innerText = 'Your Move';
        }

        async function handleLogout() {
            await client.auth.signOut();
            window.location.href = 'auth.html';
        }

        function setupBoard() {
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: (source, piece) => {
                    if (game.game_over() || piece.search(/^w/) === -1 || game.turn() === 'b') return false;
                    removeHighlights();
                    highlightSquare(source);
                    selectedSquare = source;
                },
                onDrop: (source, target) => {
                    const move = game.move({ from: source, to: target, promotion: 'q' });
                    removeHighlights();
                    selectedSquare = null;
                    if (move === null) return 'snapback';
                    
                    updateUI();
                    checkGameEnd();
                    if (!game.game_over()) makeEngineMove();
                },
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('board', config);
            
            // Handle Square Clicks for Touch/Mobile
            $(document).on('click', '#board .square-55d63', function() {
                const square = $(this).attr('data-square');
                onSquareClick(square);
            });

            window.addEventListener('resize', () => board.resize());
        }

        function onSquareClick(square) {
            if (game.turn() === 'b' || game.game_over()) return;
            const piece = game.get(square);

            if (selectedSquare && $(`#board .square-${square}`).hasClass('legal-dot')) {
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                if (move) {
                    selectedSquare = null;
                    removeHighlights();
                    board.position(game.fen());
                    updateUI();
                    checkGameEnd();
                    if(!game.game_over()) makeEngineMove();
                    return;
                }
            }

            if (piece && piece.color === 'w') {
                if (selectedSquare === square) {
                    selectedSquare = null;
                    removeHighlights();
                } else {
                    selectedSquare = square;
                    removeHighlights();
                    highlightSquare(square);
                }
            } else {
                selectedSquare = null;
                removeHighlights();
            }
        }

        function removeHighlights() { 
            $('#board .square-55d63').removeClass('legal-dot highlight-selected'); 
        }
        
        function highlightSquare(square) {
            const moves = game.moves({ square: square, verbose: true });
            if (moves.length === 0) return;
            $(`#board .square-${square}`).addClass('highlight-selected');
            moves.forEach(move => { $(`#board .square-${move.to}`).addClass('legal-dot'); });
        }

        function checkGameEnd() {
            if (game.game_over()) {
                let status = "Game Over";
                if (game.in_checkmate()) {
                    status = game.turn() === 'w' ? "AI WON BY MATE" : "YOU WON BY MATE";
                    updateElo(game.turn() === 'w' ? -1 : 1);
                } else if (game.in_draw()) {
                    status = "DRAW";
                    updateElo(0);
                }
                document.getElementById('game-status').innerText = status;
                document.getElementById('turn-indicator').innerText = 'Match Finished';
            }
        }

        function makeEngineMove() {
            document.getElementById('game-status').innerText = 'AI ANALYZING...';
            document.getElementById('turn-indicator').innerText = 'Engine Computing';
            
            setTimeout(() => {
                const bestMove = getBestMove(game);
                if (bestMove) {
                    game.move(bestMove);
                    board.position(game.fen());
                    updateUI();
                    checkGameEnd();
                    if (!game.game_over()) {
                        document.getElementById('game-status').innerText = 'YOUR TURN';
                        document.getElementById('turn-indicator').innerText = 'Your Move';
                    }
                }
            }, 500);
        }

        // MiniMax Engine with Alpha-Beta Pruning
        const weights = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };
        
        function evaluateBoard(game) {
            let total = 0;
            game.board().forEach(row => { 
                row.forEach(piece => {
                    if (piece) { 
                        total += (piece.color === 'w' ? weights[piece.type] : -weights[piece.type]); 
                    }
                }); 
            });
            return total;
        }

        function minimax(game, depth, alpha, beta, isMaximizing) {
            if (depth === 0) return -evaluateBoard(game);
            
            const moves = game.moves();
            if (isMaximizing) {
                let best = -99999;
                for (let move of moves) {
                    game.move(move);
                    best = Math.max(best, minimax(game, depth - 1, alpha, beta, !isMaximizing));
                    game.undo();
                    alpha = Math.max(alpha, best);
                    if (beta <= alpha) break;
                }
                return best;
            } else {
                let best = 99999;
                for (let move of moves) {
                    game.move(move);
                    best = Math.min(best, minimax(game, depth - 1, alpha, beta, !isMaximizing));
                    game.undo();
                    beta = Math.min(beta, best);
                    if (beta <= alpha) break;
                }
                return best;
            }
        }

        function getBestMove(game) {
            const moves = game.moves();
            let bestMove = null;
            let bestVal = -99999;
            const depth = parseInt(document.getElementById('level-select').value);

            moves.sort(() => Math.random() - 0.5); // Add slight variety

            for (let move of moves) {
                game.move(move);
                const val = minimax(game, depth - 1, -100000, 100000, false);
                game.undo();
                if (val > bestVal) {
                    bestVal = val;
                    bestMove = move;
                }
            }
            return bestMove;
        }

        function updateUI() {
            const history = game.history();
            const historyEl = document.getElementById('move-history');
            historyEl.innerHTML = history.map((m, i) => `
                <div class="flex justify-between items-center p-2 rounded bg-zinc-900/50 border border-zinc-800/50 text-zinc-400 move-anim">
                    <span class="text-zinc-600 font-bold">${i + 1}.</span>
                    <span class="text-white">${m}</span>
                </div>
            `).reverse().join('');

            const score = (evaluateBoard(game) / 100).toFixed(1);
            const scoreEl = document.getElementById('eval-score-text');
            scoreEl.innerText = score;
            
            // Update Bar: score 0 is 50%. +10 is 0%. -10 is 100%
            const percentage = Math.min(100, Math.max(0, 50 - (score * 5)));
            document.getElementById('eval-bar-fill').style.height = `${percentage}%`;
        }

        window.resetGame = () => {
            game.reset();
            board.start();
            selectedSquare = null;
            removeHighlights();
            updateUI();
            document.getElementById('game-status').innerText = 'READY';
            document.getElementById('turn-indicator').innerText = 'Your Move';
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            if (window.lucide) window.lucide.createIcons();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RenderNix Pro | Professional Geometry Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #030303;
            color: #e0e0e0;
            font-family: 'JetBrains+Mono', monospace;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .ui-overlay { position: relative; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }

        .node-item {
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        .node-item.selected {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            color: #60a5fa;
        }

        .sidebar-hidden {
            transform: translateX(-100%);
            opacity: 0;
        }
        .sidebar-right-hidden {
            transform: translateX(100%);
            opacity: 0;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }

        .btn-action {
            @apply px-4 py-2 rounded bg-white/5 border border-white/10 text-[10px] font-bold uppercase transition-all hover:bg-white/10 active:scale-95 flex items-center gap-2;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 160px;
            z-index: 100;
            margin-top: 8px;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body class="h-screen flex">

    <div id="canvas-container"></div>

    <!-- Layout Controller -->
    <div class="absolute top-6 left-1/2 -translate-x-1/2 flex gap-2 z-50 ui-overlay interactive">
        <button onclick="toggleSidebar('left')" class="btn-action" title="Toggle Hierarchy">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>
        </button>
        <button onclick="toggleSidebar('right')" class="btn-action" title="Toggle Inspector">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M15 3v18"/></svg>
        </button>
        
        <!-- Multi-Export Dropdown -->
        <div class="dropdown relative">
            <button class="btn-action bg-blue-600/20 border-blue-500/30 text-blue-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Export
            </button>
            <div class="dropdown-content glass-panel p-2 rounded-xl border border-white/10 shadow-2xl">
                <button onclick="exportData('json')" class="w-full text-left p-2 hover:bg-blue-500/10 rounded text-[10px] font-bold uppercase transition-colors">JSON Blueprint</button>
                <button onclick="exportData('glb')" class="w-full text-left p-2 hover:bg-blue-500/10 rounded text-[10px] font-bold uppercase transition-colors">GLB 3D Object</button>
                <button onclick="exportData('png')" class="w-full text-left p-2 hover:bg-blue-500/10 rounded text-[10px] font-bold uppercase transition-colors">PNG Capture</button>
            </div>
        </div>
    </div>

    <!-- Left Sidebar: Hierarchy -->
    <aside id="sidebar-left" class="w-80 glass-panel h-full flex flex-col z-20 ui-overlay interactive border-r border-white/5">
        <div class="p-8 border-b border-white/10">
            <h1 class="text-xl font-black tracking-tighter text-blue-500 italic">RENDER<span class="text-white font-light">NIX</span></h1>
            <p class="text-[8px] text-white/30 uppercase tracking-[0.4em] mt-1">Advanced Voxel Architecture</p>
        </div>

        <div class="p-6 border-b border-white/5 bg-white/5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[10px] uppercase font-bold text-white/40 tracking-widest">Scene Hierarchy</h3>
                <span id="nodeCount" class="text-[10px] text-blue-500 font-bold bg-blue-500/10 px-2 py-0.5 rounded">0</span>
            </div>
            <div id="nodeList" class="space-y-1 max-h-80 overflow-y-auto pr-2">
                <div class="text-[10px] text-white/20 italic p-4 text-center border border-dashed border-white/10 rounded-lg">Awaiting construction...</div>
            </div>
        </div>

        <div id="logs" class="flex-1 overflow-y-auto p-6 space-y-3 text-[10px] font-mono">
            <div class="text-blue-400 opacity-60">>> Core systems online.</div>
            <div class="text-white/20">>> Export engines ready.</div>
        </div>

        <div class="p-6 bg-black/40 border-t border-white/5 flex gap-2">
            <button onclick="clearScene()" class="flex-1 py-3 rounded bg-red-900/10 border border-red-500/20 text-[9px] font-bold uppercase hover:bg-red-900/30 text-red-500 transition-all">
                Reset Project
            </button>
        </div>
    </aside>

    <!-- Right Sidebar: Logic Tuner -->
    <aside id="sidebar-right" class="w-96 glass-panel h-full flex flex-col z-20 ui-overlay interactive border-l border-white/5 absolute right-0">
        <div class="p-8 border-b border-white/10 bg-blue-500/5">
            <h2 class="text-sm font-black uppercase tracking-widest text-blue-400 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                Logic Tuner
            </h2>
            <p class="text-[9px] text-white/40 mt-1 uppercase">Neural Modification Interface</p>
        </div>

        <div class="p-8 flex-1 space-y-8 overflow-y-auto">
            <div class="space-y-4">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] uppercase font-bold text-white/50 tracking-widest">Constructive Prompt</label>
                    <span class="text-[8px] text-white/20">GLOBAL ENGINE</span>
                </div>
                <textarea id="mainPrompt" 
                    placeholder="E.g., A vintage cyberpunk computer with a terminal screen and tangled wires..."
                    class="w-full h-40 bg-black border border-white/10 rounded-2xl p-5 text-sm focus:ring-2 focus:ring-blue-500/30 outline-none resize-none transition-all"></textarea>
                <button onclick="generate('global')" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-xs uppercase tracking-[0.2em] shadow-2xl transition-all active:scale-95 flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                    Synthesize Object
                </button>
            </div>

            <div id="editPanel" class="hidden space-y-4 pt-8 border-t border-white/10 animate-fade-in">
                <div class="flex justify-between items-center">
                    <label class="text-[10px] uppercase font-bold text-yellow-500 tracking-widest">Selected Component Script</label>
                    <div class="px-2 py-0.5 rounded bg-yellow-500/10 border border-yellow-500/20 text-[8px] text-yellow-500 font-bold" id="targetName">NONE</div>
                </div>
                <textarea id="editPrompt" 
                    placeholder="E.g., Change this to a glowing green screen..."
                    class="w-full h-32 bg-black border border-yellow-500/20 rounded-2xl p-5 text-sm focus:ring-2 focus:ring-yellow-500/30 outline-none resize-none transition-all"></textarea>
                <button onclick="generate('edit')" class="w-full py-4 bg-yellow-600 hover:bg-yellow-500 rounded-xl font-black text-xs uppercase tracking-[0.2em] shadow-xl transition-all text-black">
                    Apply Modification
                </button>
            </div>
        </div>

        <div id="loader" class="hidden p-6 text-center bg-blue-600 text-[10px] font-black uppercase tracking-[0.3em]">
            Processing Logic Layers...
        </div>
    </aside>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/controls/OrbitControls.js",
                "three/examples/jsm/exporters/GLTFExporter.js": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/exporters/GLTFExporter.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
        import { GLTFExporter } from 'three/examples/jsm/exporters/GLTFExporter.js';

        let scene, camera, renderer, controls;
        let selectedNodeId = null;
        let sceneData = []; 
        const objectsGroup = new THREE.Group();
        const apiKey = "ak_2BU76L6db5Zx1kS6MS4ys1uv1oR3E";

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020202);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(30, 25, 30);

            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                preserveDrawingBuffer: true // Required for PNG export
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            scene.add(new THREE.AmbientLight(0xffffff, 0.3));
            const mainLight = new THREE.DirectionalLight(0xffffff, 1);
            mainLight.position.set(50, 50, 50);
            scene.add(mainLight);

            const blueRim = new THREE.PointLight(0x3b82f6, 2, 100);
            blueRim.position.set(-20, 10, -20);
            scene.add(blueRim);

            const purpleRim = new THREE.PointLight(0x8b5cf6, 2, 100);
            purpleRim.position.set(20, -10, 20);
            scene.add(purpleRim);

            scene.add(new THREE.GridHelper(100, 100, 0x111111, 0x080808));
            scene.add(objectsGroup);

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        window.toggleSidebar = (side) => {
            const el = document.getElementById(`sidebar-${side}`);
            if (side === 'left') el.classList.toggle('sidebar-hidden');
            else el.classList.toggle('sidebar-right-hidden');
        };

        window.addLog = (text, type = 'system') => {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            const colorClass = type === 'error' ? 'text-red-400 font-bold' : (type === 'ai' ? 'text-blue-400' : 'text-white/30');
            div.className = `leading-relaxed ${colorClass}`;
            div.innerHTML = `<span class="opacity-20 mr-2">></span> ${text}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        };

        window.clearScene = () => {
            sceneData = [];
            selectedNodeId = null;
            document.getElementById('editPanel').classList.add('hidden');
            renderAll();
            addLog("Scene memory purged.");
        };

        window.exportData = (type) => {
            if (sceneData.length === 0 && type !== 'png') return addLog("No scene data available.", "error");

            const filename = `rendernix-${Date.now()}`;

            if (type === 'json') {
                const blob = new Blob([JSON.stringify(sceneData, null, 2)], { type: 'application/json' });
                download(blob, `${filename}.json`);
                addLog("Exported JSON Blueprint.");
            } 
            else if (type === 'png') {
                renderer.render(scene, camera);
                const dataURL = renderer.domElement.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `${filename}.png`;
                link.click();
                addLog("Exported Viewport Capture.");
            }
            else if (type === 'glb') {
                const exporter = new GLTFExporter();
                exporter.parse(objectsGroup, (result) => {
                    const blob = new Blob([JSON.stringify(result)], { type: 'application/json' });
                    download(blob, `${filename}.glb`);
                    addLog("Exported GLB Mesh Data.");
                }, { binary: false });
            }
        };

        function download(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        window.generate = async (mode) => {
            const promptInput = mode === 'global' ? document.getElementById('mainPrompt') : document.getElementById('editPrompt');
            const prompt = promptInput.value.trim();

            if (!prompt) return;

            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');
            addLog(`Analyzing ${mode} architecture...`, 'system');

            let systemPrompt = `You are a Master 3D Voxel Architect. Return ONLY a valid JSON array.
            Shapes: cube, sphere, cylinder, torus, cone.
            Schema: {"id": string, "type": string, "pos": [x,y,z], "size": [w,h,d], "color": hex, "opacity": 0-1, "metalness": 0-1}
            ACCURACY: Use 15-30 shapes for extreme detail. Align parts perfectly. Use floats for precision.`;

            if (mode === 'edit') {
                const target = sceneData.find(s => s.id === selectedNodeId);
                systemPrompt += `\nTASK: Update node "${target.id}" specifically. Keep others intact.`;
            }

            try {
                const response = await fetch("https://api.longcat.chat/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "LongCat-Flash-Chat",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: mode === 'edit' ? `Modify scene: ${JSON.stringify(sceneData)} with script: ${prompt}` : prompt }
                        ],
                        temperature: 0.1
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content;
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                
                if (jsonMatch) {
                    sceneData = JSON.parse(jsonMatch[0]);
                    renderAll();
                    addLog(`Synthesis complete. ${sceneData.length} parts mapped.`, 'ai');
                    if (mode === 'global') promptInput.value = '';
                }
            } catch (err) {
                addLog(`Engine Error: ${err.message}`, 'error');
            } finally {
                loader.classList.add('hidden');
            }
        };

        function renderAll() {
            while(objectsGroup.children.length > 0) {
                const obj = objectsGroup.children[0];
                obj.geometry.dispose();
                obj.material.dispose();
                objectsGroup.remove(obj);
            }

            const nodeList = document.getElementById('nodeList');
            nodeList.innerHTML = '';
            document.getElementById('nodeCount').innerText = sceneData.length;

            sceneData.forEach((item, index) => {
                if (!item.id) item.id = `part_${index}`;

                let geo;
                const s = item.size || [1,1,1];
                switch(item.type) {
                    case 'sphere': geo = new THREE.SphereGeometry(s[0] || 1, 32, 32); break;
                    case 'cylinder': geo = new THREE.CylinderGeometry(s[0] || 1, s[1] || s[0] || 1, s[2] || 2, 32); break;
                    case 'torus': geo = new THREE.TorusGeometry(s[0] || 1, s[1] || 0.3, 16, 100); break;
                    case 'cone': geo = new THREE.ConeGeometry(s[0] || 1, s[1] || 2, 32); break;
                    default: geo = new THREE.BoxGeometry(s[0] || 1, s[1] || 1, s[2] || 1);
                }

                const isSelected = selectedNodeId === item.id;
                const mat = new THREE.MeshStandardMaterial({
                    color: item.color || '#3b82f6',
                    transparent: true,
                    opacity: item.opacity || 1,
                    metalness: item.metalness || 0.6,
                    roughness: 0.2,
                    emissive: isSelected ? '#3b82f6' : '#000000',
                    emissiveIntensity: isSelected ? 0.8 : 0
                });

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(...(item.pos || [0,0,0]));
                mesh.userData.id = item.id;
                objectsGroup.add(mesh);

                const el = document.createElement('div');
                el.className = `node-item p-3 text-[10px] flex justify-between items-center rounded-lg border border-white/5 bg-white/5 mb-1 ${isSelected ? 'selected' : 'hover:border-white/20'}`;
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full" style="background: ${item.color || '#3b82f6'}"></div>
                        <span class="font-bold tracking-tight">${item.type.toUpperCase()}</span>
                    </div>
                    <span class="text-[8px] opacity-30 font-mono">${item.id}</span>
                `;
                el.onclick = () => selectNode(item.id);
                nodeList.appendChild(el);
            });
        }

        function selectNode(id) {
            selectedNodeId = id;
            document.getElementById('targetName').innerText = id.toUpperCase();
            document.getElementById('editPanel').classList.remove('hidden');
            renderAll();
            addLog(`Inspecting part: ${id}`);
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nix 2.1 Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; }
        
        .dark { background-color: #050505; color: #EDEDED; }
        .light { background-color: #F9F9F9; color: #1A1A1A; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        .light .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 10px; }

        .dot-grid-dark { background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 32px 32px; }
        .dot-grid-light { background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 32px 32px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body class="dark overflow-hidden h-screen">
    <div class="flex h-full w-full">
        
        <!-- Sidebar -->
        <aside class="w-72 border-r hidden md:flex flex-col bg-black border-zinc-800 transition-colors duration-300" id="sidebar">
            <div class="p-6 border-b border-zinc-800 flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center font-bold text-white shadow-[0_0_15px_rgba(79,70,229,0.4)]">N</div>
                <span class="font-bold tracking-tight text-lg text-white">Nix 2 Studio</span>
            </div>
            
            <div class="flex-1 p-4 overflow-y-auto space-y-2 custom-scrollbar">
                <button onclick="clearChat()" class="w-full text-left p-3 rounded-xl border border-zinc-800 bg-zinc-900 text-zinc-300 hover:bg-zinc-800 transition-all flex items-center gap-3 group">
                    <i data-lucide="plus" class="w-4 h-4 text-indigo-500 group-hover:scale-125 transition-transform"></i>
                    New Session
                </button>
            </div>

            <div class="p-4 border-t border-zinc-800 bg-zinc-950/50">
                <div class="flex items-center gap-3 p-2 rounded-xl transition-colors cursor-pointer hover:bg-zinc-900">
                    <div id="user-avatar" class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white text-[10px] font-bold">?</div>
                    <div class="flex-1 overflow-hidden">
                        <div id="user-display-name" class="text-xs font-bold truncate text-white">Checking Auth...</div>
                        <div id="user-status" class="text-[10px] text-zinc-500">Connecting...</div>
                    </div>
                    <button onclick="toggleTheme()" class="p-1.5 hover:bg-zinc-800 rounded-md transition-colors theme-btn-sidebar">
                        <i data-lucide="sun" class="w-4 h-4 text-zinc-400"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative dot-grid-dark" id="main-content">
            <!-- Header -->
            <header class="h-14 border-b border-zinc-800 flex items-center justify-between px-6 backdrop-blur-xl z-30 bg-black/80 transition-colors duration-300" id="header">
                <div class="flex items-center gap-3">
                    <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Active Model</span>
                    <span class="h-1.5 w-1.5 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.8)] animate-pulse"></span>
                    <span class="text-sm font-bold tracking-tight text-white" id="model-tag">Nix-2.1-LongCat</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleTheme()" class="p-2 text-zinc-500 hover:text-indigo-500 transition-colors md:hidden">
                        <i data-lucide="sun" class="w-5 h-5 theme-icon-mobile"></i>
                    </button>
                    <button id="logout-btn" class="text-[10px] uppercase font-bold tracking-wider border border-zinc-800 text-zinc-500 px-3 py-1.5 rounded-md hover:text-white transition-colors">Logout</button>
                </div>
            </header>

            <!-- Chat Area -->
            <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <div class="max-w-3xl mx-auto py-12" id="messages-list">
                    <!-- Initial State -->
                    <div id="welcome-screen" class="py-20 text-center animate-fade-in">
                        <div class="w-16 h-16 border border-zinc-800 bg-zinc-900 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl">
                            <i data-lucide="terminal" class="w-8 h-8 text-indigo-500"></i>
                        </div>
                        <h1 class="text-4xl font-bold mb-4 tracking-tight text-white welcome-title">How can I help today?</h1>
                        <p class="text-zinc-500 text-sm max-w-sm mx-auto leading-relaxed">
                            Connected to Long Cat API via CodeNix. Type <span class="text-indigo-500 font-mono">/</span> to explore specialized commands.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-6 relative z-40">
                <div class="max-w-3xl mx-auto relative">
                    
                    <!-- File Preview Area -->
                    <div id="file-previews" class="flex flex-wrap gap-2 mb-3"></div>

                    <div class="border border-zinc-800 bg-[#0c0c0c] rounded-[2.5rem] shadow-2xl overflow-hidden transition-all focus-within:ring-4 focus-within:ring-indigo-500/10 focus-within:border-indigo-500/50" id="input-container">
                        <form id="chat-form">
                            <textarea 
                                id="user-input"
                                placeholder="Ask Nix 2.1... Type / for Commands"
                                class="w-full bg-transparent px-8 py-6 text-sm focus:outline-none resize-none min-h-[70px] max-h-[200px] text-white placeholder:text-zinc-600"
                                rows="1"
                            ></textarea>
                            
                            <input type="file" id="file-input" class="hidden" multiple>

                            <div class="flex items-center justify-between px-6 py-4 border-t border-white/5 bg-black/40">
                                <button type="button" onclick="document.getElementById('file-input').click()" class="p-2.5 rounded-xl text-zinc-500 hover:text-indigo-400 hover:bg-indigo-500/5 transition-all">
                                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                                </button>
                                
                                <div class="flex items-center gap-4">
                                    <span class="text-[10px] text-zinc-500 font-mono hidden sm:block">AI Ready</span>
                                    <button 
                                        type="submit"
                                        id="send-btn"
                                        class="bg-indigo-600 text-white px-8 py-2.5 rounded-full text-xs font-bold hover:bg-indigo-500 transition-all shadow-[0_4px_15px_rgba(79,70,229,0.3)] flex items-center gap-2 group"
                                    >
                                        Send
                                        <i data-lucide="send" class="w-3 h-3 group-hover:translate-x-0.5 transition-transform"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global state for chat logic
        window.currentUser = null;

        // Initialize Authentication (Rule 3)
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth initialization failed:", error);
                document.getElementById('user-status').innerText = "Auth Error";
            }
        }

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            const displayName = document.getElementById('user-display-name');
            const userStatus = document.getElementById('user-status');
            const userAvatar = document.getElementById('user-avatar');

            if (user) {
                const email = user.email || "Guest User";
                displayName.innerText = email;
                userStatus.innerText = user.isAnonymous ? "Limited Session" : "API Key Active";
                userAvatar.innerText = (user.email ? user.email[0] : "G").toUpperCase();
                
                // If it's a long email, show first part
                if (email.length > 20) {
                    displayName.title = email;
                    displayName.innerText = email.substring(0, 17) + '...';
                }
            } else {
                displayName.innerText = "Signed Out";
                userStatus.innerText = "No Connection";
                userAvatar.innerText = "!";
            }
            lucide.createIcons();
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // Start Auth process
        initAuth();
    </script>

    <script>
        const API_KEY = "ak_26w2J55rY5wR44L3ij9Rg1dH6SR7C";
        const WEBHOOK_URL = 'https://cloud.activepieces.com/api/v1/webhooks/WR43cDYER0O9TiHq8exAH/sync';
        
        let theme = 'dark';
        let selectedFiles = [];

        // Initialize Lucide Icons
        lucide.createIcons();

        // Theme Toggling
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.body.className = theme + " overflow-hidden h-screen";
            
            const mainContent = document.getElementById('main-content');
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header');
            const inputContainer = document.getElementById('input-container');
            const userInputArea = document.getElementById('user-input');

            if (theme === 'light') {
                mainContent.classList.replace('dot-grid-dark', 'dot-grid-light');
                sidebar.className = "w-72 border-r hidden md:flex flex-col bg-white border-zinc-200 transition-colors duration-300";
                header.className = "h-14 border-b border-zinc-200 flex items-center justify-between px-6 backdrop-blur-xl z-30 bg-white/80 transition-colors duration-300";
                inputContainer.className = "border border-zinc-200 bg-white rounded-[2.5rem] shadow-2xl overflow-hidden transition-all focus-within:ring-4 focus-within:ring-indigo-500/10 focus-within:border-indigo-500";
                userInputArea.className = "w-full bg-transparent px-8 py-6 text-sm focus:outline-none resize-none min-h-[70px] max-h-[200px] text-zinc-900 placeholder:text-zinc-400";
                
                document.querySelectorAll('.welcome-title, #model-tag, #user-display-name').forEach(el => {
                    el.classList.replace('text-white', 'text-zinc-900');
                });
            } else {
                mainContent.classList.replace('dot-grid-light', 'dot-grid-dark');
                sidebar.className = "w-72 border-r hidden md:flex flex-col bg-black border-zinc-800 transition-colors duration-300";
                header.className = "h-14 border-b border-zinc-800 flex items-center justify-between px-6 backdrop-blur-xl z-30 bg-black/80 transition-colors duration-300";
                inputContainer.className = "border border-zinc-800 bg-[#0c0c0c] rounded-[2.5rem] shadow-2xl overflow-hidden transition-all focus-within:ring-4 focus-within:ring-indigo-500/10 focus-within:border-indigo-500/50";
                userInputArea.className = "w-full bg-transparent px-8 py-6 text-sm focus:outline-none resize-none min-h-[70px] max-h-[200px] text-white placeholder:text-zinc-600";
                
                document.querySelectorAll('.welcome-title, #model-tag, #user-display-name').forEach(el => {
                    el.classList.replace('text-zinc-900', 'text-white');
                });
            }
            lucide.createIcons();
        }

        // File Management
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            selectedFiles = [...selectedFiles, ...files];
            renderFilePreviews();
        });

        function renderFilePreviews() {
            const container = document.getElementById('file-previews');
            container.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = "bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 px-3 py-1.5 rounded-xl text-[10px] font-bold flex items-center gap-2 animate-fade-in";
                div.innerHTML = `
                    <i data-lucide="file-text" class="w-3 h-3"></i>
                    ${file.name}
                    <button onclick="removeFile(${index})" class="hover:text-white ml-1">Ã—</button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFilePreviews();
        }

        // Chat Logic
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const messagesList = document.getElementById('messages-list');
        const welcomeScreen = document.getElementById('welcome-screen');

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text && selectedFiles.length === 0) return;

            if (document.getElementById('welcome-screen')) document.getElementById('welcome-screen').remove();

            appendMessage('user', text, selectedFiles);
            
            userInput.value = '';
            const filesToSend = [...selectedFiles];
            selectedFiles = [];
            renderFilePreviews();

            await handleApiCall(text, filesToSend);
        });

        async function handleApiCall(question, files) {
            const botMsgId = appendMessage('bot', '', [], true);
            
            try {
                const preparedFiles = await Promise.all(files.map(async (file) => {
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
                    return { name: file.name, type: file.type, data: base64 };
                }));

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({ 
                        question: question,
                        files: preparedFiles,
                        user: { 
                            id: window.currentUser ? window.currentUser.uid : 'anonymous',
                            email: window.currentUser ? window.currentUser.email : 'anonymous@codenix.ai'
                        }
                    })
                });

                if (!response.ok) throw new Error('Network error');

                const data = await response.json();
                const rawContent = data.answer || data.output || data.response || "Task completed.";
                updateBotMessage(botMsgId, rawContent, data);

            } catch (err) {
                updateBotMessage(botMsgId, "Nix Error: Failed to secure connection with Long Cat. Check API Key.", null, true);
            }
        }

        function appendMessage(role, content, files = [], isThinking = false) {
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            const themeClass = theme === 'dark' ? 'text-zinc-300' : 'text-zinc-700';
            const bgClass = role === 'user' ? (theme === 'dark' ? 'bg-zinc-900/30 border border-white/5' : 'bg-zinc-100 border border-zinc-200') : '';
            
            div.id = id;
            div.className = `flex gap-6 p-8 rounded-[2rem] mb-6 animate-fade-in ${bgClass}`;
            
            const avatarColor = role === 'user' ? 'bg-zinc-500' : 'bg-indigo-600';
            const avatarName = role === 'user' ? 'You' : 'Nix';

            div.innerHTML = `
                <div class="w-10 h-10 rounded-2xl shrink-0 flex items-center justify-center font-bold text-[10px] uppercase text-white ${avatarColor}">
                    ${avatarName}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="message-body text-[15px] leading-relaxed whitespace-pre-wrap ${themeClass}">
                        ${isThinking ? '<div class="flex gap-1.5 py-2"><div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce [animation-delay:0.2s]"></div><div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce [animation-delay:0.4s]"></div></div>' : content}
                    </div>
                </div>
            `;
            
            messagesList.appendChild(div);
            scrollChat();
            return id;
        }

        function updateBotMessage(id, content, fullData, isError = false) {
            const container = document.getElementById(id);
            const body = container.querySelector('.message-body');
            
            if (isError) {
                body.className = "message-body text-[15px] text-red-400 font-medium";
            }
            
            body.innerHTML = content;

            if (fullData) {
                const urls = extractUrls(fullData);
                urls.forEach(url => {
                    const mediaDiv = document.createElement('div');
                    mediaDiv.className = "mt-6 group relative max-w-xl animate-fade-in";
                    
                    if (url.match(/\.(jpg|jpeg|png|webp|gif|avif)$|image/i)) {
                        mediaDiv.innerHTML = `
                            <div class="rounded-2xl overflow-hidden border ${theme === 'dark' ? 'border-white/10 shadow-2xl bg-zinc-900' : 'border-zinc-200 bg-white'}">
                                <img src="${url}" class="w-full h-auto cursor-zoom-in" onclick="window.open('${url}', '_blank')">
                            </div>
                        `;
                    } else {
                        mediaDiv.innerHTML = `
                             <a href="${url}" target="_blank" class="flex items-center gap-3 p-4 border rounded-xl transition-all ${theme === 'dark' ? 'bg-zinc-900 border-zinc-800 hover:border-indigo-500/50' : 'bg-white border-zinc-200 hover:border-indigo-500/50'}">
                                <i data-lucide="file-text" class="text-indigo-500"></i>
                                <div class="flex-1 overflow-hidden">
                                    <div class="text-xs font-bold truncate ${theme === 'dark' ? 'text-white' : 'text-zinc-900'}">Download Asset</div>
                                    <div class="text-[10px] text-zinc-500 font-mono">External Resource</div>
                                </div>
                                <i data-lucide="download" class="w-4 h-4 text-zinc-400"></i>
                             </a>
                        `;
                    }
                    body.appendChild(mediaDiv);
                });
            }

            lucide.createIcons();
            scrollChat();
        }

        function extractUrls(obj) {
            const urls = [];
            const urlRegex = /(https?:\/\/[^\s"'<>]+)/g;
            const find = (o) => {
                if (typeof o === 'string') {
                    const matches = o.match(urlRegex);
                    if (matches) urls.push(...matches);
                } else if (o && typeof o === 'object') {
                    Object.values(o).forEach(find);
                }
            };
            find(obj);
            return [...new Set(urls)];
        }

        function scrollChat() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function clearChat() {
            messagesList.innerHTML = `
                <div id="welcome-screen" class="py-20 text-center animate-fade-in">
                    <div class="w-16 h-16 border border-zinc-800 bg-zinc-900 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl">
                        <i data-lucide="terminal" class="w-8 h-8 text-indigo-500"></i>
                    </div>
                    <h1 class="text-4xl font-bold mb-4 tracking-tight text-white welcome-title">How can I help today?</h1>
                </div>
            `;
            lucide.createIcons();
        }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

    </script>
</body>
</html>

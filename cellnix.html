<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CellNix by Codenix</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for Excel/XLSX Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        :root {
            --bg-app: #ffffff;
            --bg-header: #f8fafc;
            --bg-toolbar: #f1f5f9;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #9333ea;
            --accent-hover: #7e22ce;
            --accent-light: #f3e8ff;
            --focus-ring: #c084fc;
            --cell-selected-bg: rgba(147, 51, 234, 0.1);
            --cell-selected-border: #9333ea;
        }

        [data-theme="dark"] {
            --bg-app: #0f0f0f;
            --bg-header: #18181b;
            --bg-toolbar: #27272a;
            --border-color: #3f3f46;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-primary: #a855f7;
            --accent-hover: #c084fc;
            --accent-light: #2e1065;
            --focus-ring: #a855f7;
            --cell-selected-bg: rgba(168, 85, 247, 0.2);
            --cell-selected-border: #a855f7;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: var(--bg-app);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .spreadsheet-container::-webkit-scrollbar { width: 10px; height: 10px; }
        .spreadsheet-container::-webkit-scrollbar-track { background: var(--bg-app); }
        .spreadsheet-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 5px; }

        .cell {
            min-width: 100px; max-width: 100px; height: 28px;
            outline: none; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);
            padding: 0 4px; font-size: 13px; white-space: nowrap; overflow: hidden; cursor: cell;
            background-color: var(--bg-app); color: var(--text-primary);
            position: relative;
        }

        .cell:focus { border: 2px solid var(--cell-selected-border); z-index: 10; position: relative; }
        .cell.selected { background-color: var(--cell-selected-bg); border: 1px solid var(--cell-selected-border); z-index: 5; }
        .cell.active-cell { border: 2px solid var(--cell-selected-border) !important; z-index: 10; }

        .header-col, .header-row, .header-corner {
            background-color: var(--bg-header); font-weight: 600; color: var(--text-secondary);
            text-align: center; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);
            user-select: none; position: sticky; z-index: 20; font-size: 12px;
        }
        
        .header-col { top: 0; }
        .header-row { left: 0; min-width: 40px; }
        .header-corner { top: 0; left: 0; z-index: 30; }

        .theme-border { border-color: var(--border-color) !important; }
        .theme-bg-header { background-color: var(--bg-header) !important; }
        .theme-bg-toolbar { background-color: var(--bg-toolbar) !important; }
        .theme-text-primary { color: var(--text-primary) !important; }
        .theme-text-secondary { color: var(--text-secondary) !important; }
        .theme-accent-bg { background-color: var(--accent-primary) !important; }
        
        #loading-screen {
            position: fixed; inset: 0; background: var(--bg-app);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; transition: opacity 0.5s;
        }

        .export-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-header);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 160px;
            margin-top: 0.5rem;
        }
        .export-dropdown.active { display: block; }
        
        .export-item {
            width: 100%; padding: 8px 16px; text-align: left; font-size: 13px;
            display: flex; align-items: center; gap: 10px; transition: background 0.2s;
            color: var(--text-primary);
        }
        .export-item:hover { background: var(--bg-toolbar); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="loading-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2" style="border-color: var(--accent-primary)"></div>
    </div>

    <header class="theme-bg-header theme-border border-b flex items-center justify-between px-4 py-2 shadow-sm z-40">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 theme-accent-bg rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg">C</div>
            <div>
                <h1 class="font-bold text-lg theme-text-primary">CellNix</h1>
                <p class="text-[10px] theme-text-secondary font-medium tracking-wider uppercase">by Codenix</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="toggleTheme()" class="w-8 h-8 rounded-full flex items-center justify-center theme-text-secondary hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <i class="fa-solid fa-moon" id="theme-icon"></i>
            </button>

            <div class="relative">
                <button onclick="toggleExportMenu()" id="export-btn" class="text-sm font-medium theme-text-secondary hover:text-purple-500 transition flex items-center gap-2 px-3 py-1.5 rounded bg-gray-100 dark:bg-zinc-800">
                    <i class="fa-solid fa-file-export"></i> Export <i class="fa-solid fa-chevron-down text-[10px]"></i>
                </button>
                <div id="export-menu" class="export-dropdown">
                    <button onclick="exportData('xlsx')" class="export-item"><i class="fa-solid fa-file-excel text-green-600"></i> Excel (.xlsx)</button>
                    <button onclick="exportData('csv')" class="export-item"><i class="fa-solid fa-file-csv text-blue-500"></i> CSV (.csv)</button>
                    <button onclick="exportData('ods')" class="export-item"><i class="fa-solid fa-file-lines text-orange-500"></i> OpenDoc (.ods)</button>
                    <button onclick="exportData('json')" class="export-item"><i class="fa-solid fa-code text-yellow-500"></i> JSON (.json)</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <span id="user-email" class="text-xs theme-text-secondary hidden md:block"></span>
                <button onclick="signOut()" class="h-8 w-8 rounded-full theme-bg-toolbar flex items-center justify-center theme-text-secondary theme-border border hover:text-purple-500 transition">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="theme-bg-toolbar theme-border border-b px-4 py-2 flex items-center gap-4 overflow-x-auto">
        <div class="flex items-center theme-bg-header theme-border border rounded-md shadow-sm">
            <button onclick="execStyle('bold')" class="p-2 hover:bg-black/5 theme-text-secondary w-9 h-9 flex items-center justify-center border-r theme-border"><i class="fa-solid fa-bold"></i></button>
            <button onclick="execStyle('italic')" class="p-2 hover:bg-black/5 theme-text-secondary w-9 h-9 flex items-center justify-center border-r theme-border"><i class="fa-solid fa-italic"></i></button>
            <button onclick="execStyle('underline')" class="p-2 hover:bg-black/5 theme-text-secondary w-9 h-9 flex items-center justify-center"><i class="fa-solid fa-underline"></i></button>
        </div>

        <div class="flex items-center theme-bg-header theme-border border rounded-md shadow-sm">
            <button onclick="execStyle('justifyLeft')" class="p-2 hover:bg-black/5 theme-text-secondary w-9 h-9 flex items-center justify-center border-r theme-border"><i class="fa-solid fa-align-left"></i></button>
            <button onclick="execStyle('justifyCenter')" class="p-2 hover:bg-black/5 theme-text-secondary w-9 h-9 flex items-center justify-center border-r theme-border"><i class="fa-solid fa-align-center"></i></button>
            <button onclick="execStyle('justifyRight')" class="p-2 hover:bg-black/5 theme-text-secondary w-9 h-9 flex items-center justify-center"><i class="fa-solid fa-align-right"></i></button>
        </div>

        <div class="flex items-center gap-2">
            <div class="relative group">
                <button class="p-2 theme-bg-header theme-border border rounded-md shadow-sm w-9 h-9 flex items-center justify-center theme-text-secondary">
                    <i class="fa-solid fa-fill-drip"></i>
                </button>
                <input type="color" onchange="execColor('backColor', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
            </div>
            <div class="relative group">
                <button class="p-2 theme-bg-header theme-border border rounded-md shadow-sm w-9 h-9 flex items-center justify-center theme-text-secondary">
                    <i class="fa-solid fa-font"></i>
                </button>
                <input type="color" onchange="execColor('foreColor', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
            </div>
        </div>

        <div class="h-6 w-px theme-border border-l mx-2"></div>
        <button onclick="resetGrid()" class="text-xs font-semibold text-red-500 px-3 py-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/20 transition">Reset</button>
    </div>

    <div class="flex items-center px-4 py-2 theme-border border-b theme-bg-header gap-2">
        <div class="theme-text-secondary font-serif italic font-bold w-8 text-center theme-bg-toolbar rounded theme-border border select-none">fx</div>
        <div id="selected-cell-indicator" class="w-16 text-center text-xs font-bold theme-text-primary theme-border border rounded theme-bg-toolbar py-1.5">A1</div>
        <input type="text" id="formula-input" class="flex-1 theme-border border rounded px-3 py-1 text-sm theme-bg-toolbar theme-text-primary focus:ring-1 transition" placeholder="Enter value or formula (e.g., =SUM(A1:A5))">
    </div>

    <div class="flex-1 overflow-hidden relative">
        <div class="spreadsheet-container w-full h-full overflow-auto" id="grid-container" style="background-color: var(--bg-app);">
            <table class="border-collapse" id="spreadsheet">
                <thead id="header-row"></thead>
                <tbody id="grid-body"></tbody>
            </table>
        </div>
    </div>

    <div class="theme-accent-bg text-white text-xs px-4 py-1 flex justify-between items-center select-none">
        <div class="flex gap-4"><span>Ready</span><span id="status-selection">Cell: A1</span></div>
        <div>Powered by <span class="font-bold">CellNix</span></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rnlwrngfgvznndlekmrz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'auth.html';
            } else {
                document.getElementById('user-email').innerText = session.user.email;
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 500);
            }
        }
        checkAuth();

        const COLS = 26; 
        const ROWS = 100;
        let cellData = {};
        let activeCellId = "A1";
        let isEditing = false;
        let isMouseDown = false;
        let selectionStart = null;

        const gridBody = document.getElementById('grid-body');
        const headerRow = document.getElementById('header-row');
        const formulaInput = document.getElementById('formula-input');
        const selectedCellIndicator = document.getElementById('selected-cell-indicator');

        function initGrid() {
            let trHead = document.createElement('tr');
            let thCorner = document.createElement('th');
            thCorner.className = 'header-corner h-[30px] w-[40px]';
            trHead.appendChild(thCorner);

            for (let c = 0; c < COLS; c++) {
                let th = document.createElement('th');
                th.className = 'header-col';
                th.innerText = String.fromCharCode(65 + c); 
                trHead.appendChild(th);
            }
            headerRow.appendChild(trHead);

            for (let r = 1; r <= ROWS; r++) {
                let tr = document.createElement('tr');
                let thRow = document.createElement('td');
                thRow.className = 'header-row';
                thRow.innerText = r;
                tr.appendChild(thRow);

                for (let c = 0; c < COLS; c++) {
                    let cellId = `${String.fromCharCode(65 + c)}${r}`;
                    let td = document.createElement('td');
                    td.className = 'cell';
                    td.id = cellId;
                    td.contentEditable = true;
                    td.spellcheck = false;

                    td.addEventListener('mousedown', (e) => handleCellMouseDown(e, cellId));
                    td.addEventListener('mouseenter', () => handleCellMouseEnter(cellId));
                    td.addEventListener('focus', () => handleCellFocus(cellId));
                    td.addEventListener('input', (e) => handleCellInput(e, cellId));
                    td.addEventListener('keydown', (e) => handleCellKeydown(e, cellId));
                    td.addEventListener('blur', () => handleCellBlur(cellId));
                    
                    tr.appendChild(td);
                }
                gridBody.appendChild(tr);
            }
            window.addEventListener('mouseup', () => isMouseDown = false);
            selectCell("A1");
        }

        // --- Selection Logic ---
        function handleCellMouseDown(e, cellId) {
            isMouseDown = true;
            selectionStart = cellId;
            
            // Reference Mode Logic
            const activeCell = document.getElementById(activeCellId);
            const currentVal = formulaInput.value;
            
            if (activeCellId !== cellId && currentVal.startsWith('=') && document.activeElement === activeCell) {
                e.preventDefault();
                const lastChar = currentVal.slice(-1);
                const separator = /^[A-Z0-9]$/i.test(lastChar) ? "+" : "";
                formulaInput.value = currentVal + separator + cellId;
                return;
            }
            
            selectCell(cellId);
        }

        function handleCellMouseEnter(cellId) {
            if (isMouseDown && selectionStart) {
                clearSelection();
                applyRangeSelection(selectionStart, cellId);
            }
        }

        function clearSelection() {
            document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected'));
        }

        function applyRangeSelection(startId, endId) {
            const startCol = startId.match(/[A-Z]+/)[0].charCodeAt(0);
            const startRow = parseInt(startId.match(/\d+/)[0]);
            const endCol = endId.match(/[A-Z]+/)[0].charCodeAt(0);
            const endRow = parseInt(endId.match(/\d+/)[0]);

            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);
            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);

            for (let c = minCol; c <= maxCol; c++) {
                for (let r = minRow; r <= maxRow; r++) {
                    const id = `${String.fromCharCode(c)}${r}`;
                    document.getElementById(id).classList.add('selected');
                }
            }
        }

        function selectCell(cellId) {
            document.querySelectorAll('.active-cell').forEach(c => c.classList.remove('active-cell'));
            clearSelection();
            
            activeCellId = cellId;
            const cell = document.getElementById(cellId);
            cell.classList.add('active-cell');
            cell.classList.add('selected');
            selectedCellIndicator.innerText = cellId;
            document.getElementById('status-selection').innerText = `Cell: ${cellId}`;
            
            formulaInput.value = (cellData[cellId] && cellData[cellId].formula) ? cellData[cellId].formula : cell.innerText;
        }

        // --- Input & Formula Logic ---
        function handleCellFocus(cellId) {
            isEditing = true;
            const cell = document.getElementById(cellId);
            if (cellData[cellId] && cellData[cellId].formula) {
                cell.innerText = cellData[cellId].formula;
            }
        }

        function handleCellInput(e, cellId) {
            formulaInput.value = e.target.innerText;
        }

        function handleCellBlur(cellId) {
            isEditing = false;
            updateCellData(cellId, document.getElementById(cellId).innerText);
        }

        function handleCellKeydown(e, cellId) {
            const row = parseInt(cellId.match(/\d+/)[0]);
            const col = cellId.match(/[A-Z]+/)[0].charCodeAt(0);

            if (e.key === 'Enter') {
                e.preventDefault();
                moveSelection(col, row + 1);
            } else if (e.key === 'Tab') {
                e.preventDefault();
                moveSelection(col + 1, row);
            } else if (!isEditing) {
                if (e.key === 'ArrowDown') moveSelection(col, row + 1);
                else if (e.key === 'ArrowUp') moveSelection(col, row - 1);
                else if (e.key === 'ArrowRight') moveSelection(col + 1, row);
                else if (e.key === 'ArrowLeft') moveSelection(col - 1, row);
            }
        }

        function moveSelection(c, r) {
            if (c < 65 || c >= 65 + COLS || r < 1 || r > ROWS) return;
            const nextId = `${String.fromCharCode(c)}${r}`;
            const nextCell = document.getElementById(nextId);
            if (nextCell) {
                nextCell.focus();
                selectCell(nextId);
            }
        }

        function updateCellData(cellId, input) {
            if (!cellData[cellId]) cellData[cellId] = {};
            if (input.startsWith('=')) {
                cellData[cellId].formula = input;
                cellData[cellId].value = evaluateFormula(input.substring(1));
            } else {
                cellData[cellId].formula = '';
                cellData[cellId].value = input;
            }
            renderCell(cellId);
            recalculateAll();
        }

        function evaluateFormula(expression) {
            try {
                // SUM Range Logic
                const sumRegex = /SUM\(([A-Z]+)(\d+):([A-Z]+)(\d+)\)/i;
                const sumMatch = expression.match(sumRegex);
                if (sumMatch) {
                    const sCol = sumMatch[1], sRow = parseInt(sumMatch[2]);
                    const eCol = sumMatch[3], eRow = parseInt(sumMatch[4]);
                    let total = 0;
                    for (let r = sRow; r <= eRow; r++) {
                        let val = cellData[`${sCol}${r}`]?.value;
                        total += isNaN(Number(val)) ? 0 : Number(val);
                    }
                    return total;
                }
                
                // Direct Reference Logic
                const parsedExpr = expression.replace(/[A-Z]+[0-9]+/g, (m) => {
                    let v = cellData[m]?.value;
                    return isNaN(Number(v)) ? 0 : Number(v);
                });
                
                // Basic Sanitization
                if (!/^[0-9+\-*/().\s]*$/.test(parsedExpr)) return "#NAME?";
                return eval(parsedExpr);
            } catch { return "#ERR"; }
        }

        function renderCell(cellId) {
            const cell = document.getElementById(cellId);
            if (cellData[cellId] && document.activeElement !== cell) {
                cell.innerText = cellData[cellId].value;
            }
        }

        function recalculateAll() {
            Object.keys(cellData).forEach(id => {
                if (cellData[id].formula) {
                    cellData[id].value = evaluateFormula(cellData[id].formula.substring(1));
                    renderCell(id);
                }
            });
        }

        formulaInput.addEventListener('input', (e) => {
            const cell = document.getElementById(activeCellId);
            cell.innerText = e.target.value;
        });

        formulaInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const cell = document.getElementById(activeCellId);
                updateCellData(activeCellId, e.target.value);
                cell.blur();
            }
        });

        // --- UI & Utilities ---
        function toggleExportMenu() { document.getElementById('export-menu').classList.toggle('active'); }
        window.onclick = (e) => { if (!e.target.closest('#export-btn')) document.getElementById('export-menu').classList.remove('active'); }

        function exportData(format) {
            let dataRows = [];
            for(let r=1; r<=ROWS; r++) {
                let row = {}, hasData = false;
                for(let c=0; c<COLS; c++) {
                    let id = `${String.fromCharCode(65+c)}${r}`;
                    let val = cellData[id] ? cellData[id].value : "";
                    if(val !== "") hasData = true;
                    row[String.fromCharCode(65+c)] = val;
                }
                if(hasData) dataRows.push(row);
            }
            if(format === 'json') {
                const blob = new Blob([JSON.stringify(cellData, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'cellnix.json'; a.click();
                return;
            }
            const ws = XLSX.utils.json_to_sheet(dataRows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `CellNix_Export.${format}`, { bookType: format === 'ods' ? 'ods' : format });
        }

        function execStyle(cmd) { document.execCommand(cmd, false, null); }
        function execColor(type, color) {
            const cell = document.getElementById(activeCellId);
            if(type === 'backColor') cell.style.backgroundColor = color;
            else cell.style.color = color;
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('cellnix-theme', target);
            document.getElementById('theme-icon').className = target === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        async function signOut() { await supabaseClient.auth.signOut(); window.location.href = 'auth.html'; }
        function resetGrid() { if(confirm("Reset all data?")) location.reload(); }

        initGrid();
    </script>
</body>
</html>

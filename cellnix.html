<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CellNix by Codenix</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        :root {
            /* Light Mode (White & Purple) */
            --bg-app: #ffffff;
            --bg-header: #f8fafc;
            --bg-toolbar: #f1f5f9;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #9333ea; /* Purple 600 */
            --accent-hover: #7e22ce;
            --accent-light: #f3e8ff;
            --focus-ring: #c084fc;
            --cell-selected-bg: rgba(147, 51, 234, 0.1);
            --cell-selected-border: #9333ea;
        }

        [data-theme="dark"] {
            /* Dark Mode (Black & Purple) */
            --bg-app: #0f0f0f; /* Near Black */
            --bg-header: #18181b; /* Zinc 900 */
            --bg-toolbar: #27272a; /* Zinc 800 */
            --border-color: #3f3f46; /* Zinc 700 */
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-primary: #a855f7; /* Purple 500 */
            --accent-hover: #c084fc;
            --accent-light: #2e1065;
            --focus-ring: #a855f7;
            --cell-selected-bg: rgba(168, 85, 247, 0.2);
            --cell-selected-border: #a855f7;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: var(--bg-app);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom Scrollbar */
        .spreadsheet-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        .spreadsheet-container::-webkit-scrollbar-track {
            background: var(--bg-app);
        }
        .spreadsheet-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }
        .spreadsheet-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Cell Styling */
        .cell {
            min-width: 100px;
            max-width: 100px;
            height: 28px;
            outline: none;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            cursor: cell;
            background-color: var(--bg-app);
            color: var(--text-primary);
        }

        .cell:focus {
            border: 2px solid var(--cell-selected-border);
            z-index: 10;
            position: relative;
        }

        .cell.selected {
            background-color: var(--cell-selected-bg);
            border: 2px solid var(--cell-selected-border);
            z-index: 10;
        }

        /* Header Styling */
        .header-col, .header-row, .header-corner {
            background-color: var(--bg-header);
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            user-select: none;
            position: sticky;
            z-index: 20;
        }
        
        .header-col { top: 0; }
        .header-row { left: 0; min-width: 40px; }
        .header-corner { top: 0; left: 0; z-index: 30; }

        /* Component Overrides for Theme */
        .theme-border { border-color: var(--border-color) !important; }
        .theme-bg-header { background-color: var(--bg-header) !important; }
        .theme-bg-toolbar { background-color: var(--bg-toolbar) !important; }
        .theme-text-primary { color: var(--text-primary) !important; }
        .theme-text-secondary { color: var(--text-secondary) !important; }
        .theme-accent-text { color: var(--accent-primary) !important; }
        .theme-accent-bg { background-color: var(--accent-primary) !important; }
        
        input:focus { outline: none; }
        
        /* Loader */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-app);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 theme-accent-border" style="border-color: var(--accent-primary)"></div>
    </div>

    <!-- Top Navigation / Branding -->
    <header class="theme-bg-header theme-border border-b flex items-center justify-between px-4 py-2 shadow-sm z-40 transition-colors duration-300">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 theme-accent-bg rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg" style="box-shadow: 0 4px 6px -1px var(--accent-light);">
                C
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight tracking-tight theme-text-primary">CellNix</h1>
                <p class="text-[10px] theme-text-secondary font-medium tracking-wider uppercase">by Codenix</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" class="w-8 h-8 rounded-full flex items-center justify-center theme-text-secondary hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <i class="fa-solid fa-moon" id="theme-icon"></i>
            </button>

            <button onclick="downloadCSV()" class="text-sm font-medium theme-text-secondary hover:theme-accent-text transition flex items-center gap-2 px-3 py-1.5 rounded hover:bg-opacity-10 hover:bg-gray-500">
                <i class="fa-solid fa-download"></i> Export
            </button>
            
            <!-- User Profile / Sign Out -->
            <div class="flex items-center gap-2">
                <span id="user-email" class="text-xs theme-text-secondary hidden md:block"></span>
                <button onclick="signOut()" class="h-8 w-8 rounded-full theme-bg-toolbar flex items-center justify-center theme-text-secondary theme-border border hover:theme-accent-text transition" title="Sign Out">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="theme-bg-toolbar theme-border border-b px-4 py-2 flex items-center gap-4 overflow-x-auto transition-colors duration-300">
        <!-- Text Formatting -->
        <div class="flex items-center theme-bg-header theme-border border rounded-md shadow-sm">
            <button onclick="execStyle('bold')" class="p-2 hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center theme-border border-r" title="Bold">
                <i class="fa-solid fa-bold"></i>
            </button>
            <button onclick="execStyle('italic')" class="p-2 hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center theme-border border-r" title="Italic">
                <i class="fa-solid fa-italic"></i>
            </button>
            <button onclick="execStyle('underline')" class="p-2 hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center" title="Underline">
                <i class="fa-solid fa-underline"></i>
            </button>
        </div>

        <!-- Alignment -->
        <div class="flex items-center theme-bg-header theme-border border rounded-md shadow-sm">
            <button onclick="execStyle('justifyLeft')" class="p-2 hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center theme-border border-r">
                <i class="fa-solid fa-align-left"></i>
            </button>
            <button onclick="execStyle('justifyCenter')" class="p-2 hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center theme-border border-r">
                <i class="fa-solid fa-align-center"></i>
            </button>
            <button onclick="execStyle('justifyRight')" class="p-2 hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center">
                <i class="fa-solid fa-align-right"></i>
            </button>
        </div>

        <!-- Colors -->
        <div class="flex items-center gap-2">
            <div class="relative group">
                <button class="p-2 theme-bg-header theme-border border rounded-md shadow-sm hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center">
                    <i class="fa-solid fa-fill-drip group-hover:theme-accent-text"></i>
                </button>
                <input type="color" onchange="execColor('backColor', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Background Color">
            </div>
            <div class="relative group">
                <button class="p-2 theme-bg-header theme-border border rounded-md shadow-sm hover:bg-opacity-5 hover:bg-black theme-text-secondary w-9 h-9 flex items-center justify-center">
                    <i class="fa-solid fa-font group-hover:theme-accent-text"></i>
                </button>
                <input type="color" onchange="execColor('foreColor', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Text Color">
            </div>
        </div>

        <div class="h-6 w-px theme-bg-header border-l theme-border mx-2"></div>
        
        <button onclick="resetGrid()" class="text-xs font-semibold text-red-500 hover:text-red-600 bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40 px-3 py-1.5 rounded transition">
            Reset
        </button>
    </div>

    <!-- Formula Bar -->
    <div class="flex items-center px-4 py-2 theme-border border-b theme-bg-header gap-2 transition-colors duration-300">
        <div class="theme-text-secondary font-serif italic font-bold w-8 text-center theme-bg-toolbar rounded theme-border border select-none">fx</div>
        <div id="selected-cell-indicator" class="w-16 text-center text-xs font-bold theme-text-primary theme-border border rounded theme-bg-toolbar py-1.5">
            A1
        </div>
        <input type="text" id="formula-input" class="flex-1 theme-border border rounded px-3 py-1 text-sm theme-bg-toolbar theme-text-primary focus:ring-1 transition shadow-inner" style="--tw-ring-color: var(--focus-ring); --tw-ring-opacity: 1;" placeholder="Enter value or formula (e.g., =SUM(A1:A5))">
    </div>

    <!-- Main Spreadsheet Area -->
    <div class="flex-1 overflow-hidden relative">
        <div class="spreadsheet-container w-full h-full overflow-auto" id="grid-container" style="background-color: var(--bg-app);">
            <table class="border-collapse" id="spreadsheet">
                <thead id="header-row"></thead>
                <tbody id="grid-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Footer Status Bar -->
    <div class="theme-accent-bg text-white text-xs px-4 py-1 flex justify-between items-center select-none">
        <div class="flex gap-4">
            <span>Ready</span>
            <span id="status-selection">Mode: Standard</span>
        </div>
        <div class="flex gap-4 opacity-90">
            <span>Powered by <span class="font-bold">CellNix</span></span>
        </div>
    </div>

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://rnlwrngfgvznndlekmrz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Auth Check ---
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'auth.html';
            } else {
                document.getElementById('user-email').innerText = session.user.email;
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);
            }
        }

        async function signOut() {
            await supabase.auth.signOut();
            window.location.href = 'auth.html';
        }

        checkAuth();

        // --- Configuration ---
        const COLS = 26; // A to Z
        const ROWS = 100;
        let cellData = {};
        let selectedCellId = null;

        // --- Initialization ---
        const gridBody = document.getElementById('grid-body');
        const headerRow = document.getElementById('header-row');
        const formulaInput = document.getElementById('formula-input');
        const selectedCellIndicator = document.getElementById('selected-cell-indicator');

        function initGrid() {
            let trHead = document.createElement('tr');
            let thCorner = document.createElement('th');
            thCorner.className = 'header-corner h-[30px] w-[40px]';
            trHead.appendChild(thCorner);

            for (let c = 0; c < COLS; c++) {
                let th = document.createElement('th');
                th.className = 'header-col';
                th.innerText = String.fromCharCode(65 + c); 
                trHead.appendChild(th);
            }
            headerRow.appendChild(trHead);

            for (let r = 1; r <= ROWS; r++) {
                let tr = document.createElement('tr');
                let thRow = document.createElement('td');
                thRow.className = 'header-row';
                thRow.innerText = r;
                tr.appendChild(thRow);

                for (let c = 0; c < COLS; c++) {
                    let colLetter = String.fromCharCode(65 + c);
                    let cellId = `${colLetter}${r}`;
                    
                    let td = document.createElement('td');
                    td.className = 'cell';
                    td.id = cellId;
                    td.contentEditable = true;
                    td.spellcheck = false;
                    
                    td.addEventListener('focus', () => selectCell(cellId));
                    td.addEventListener('input', (e) => handleInput(e, cellId));
                    td.addEventListener('blur', () => handleBlur(cellId));
                    td.addEventListener('keydown', (e) => handleKeyDown(e, cellId));

                    tr.appendChild(td);
                }
                gridBody.appendChild(tr);
            }
            selectCell("A1");
        }

        // --- Core Logic ---
        function selectCell(cellId) {
            if (selectedCellId) {
                document.getElementById(selectedCellId).classList.remove('selected');
            }
            selectedCellId = cellId;
            const cell = document.getElementById(cellId);
            cell.classList.add('selected');
            selectedCellIndicator.innerText = cellId;
            
            const data = cellData[cellId];
            if (data && data.formula) {
                formulaInput.value = data.formula;
            } else {
                formulaInput.value = cell.innerText;
            }
        }

        function handleInput(e, cellId) {
            const value = e.target.innerText;
            if (!cellData[cellId]) cellData[cellId] = {};
            if (!value.startsWith('=')) {
                cellData[cellId].formula = '';
            }
        }

        function handleBlur(cellId) {
            const cell = document.getElementById(cellId);
            const rawValue = cell.innerText;
            updateCellData(cellId, rawValue);
        }

        function handleKeyDown(e, cellId) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const col = cellId.match(/[A-Z]+/)[0];
                const row = parseInt(cellId.match(/\d+/)[0]);
                const nextId = `${col}${row + 1}`;
                const nextCell = document.getElementById(nextId);
                if (nextCell) nextCell.focus();
                else document.getElementById(cellId).blur();
            }
        }

        formulaInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const value = formulaInput.value;
                const cell = document.getElementById(selectedCellId);
                cell.innerText = value;
                updateCellData(selectedCellId, value);
                cell.focus();
            }
        });

        // --- Calculation Engine ---
        function updateCellData(cellId, input) {
            if (!cellData[cellId]) cellData[cellId] = {};
            
            if (input.startsWith('=')) {
                cellData[cellId].formula = input;
                cellData[cellId].value = evaluateFormula(input.substring(1));
            } else {
                cellData[cellId].formula = '';
                cellData[cellId].value = input;
            }
            renderCell(cellId);
            recalculateAll();
        }

        function getCellValue(cellId) {
            if (!cellData[cellId]) return 0;
            const val = cellData[cellId].value;
            return isNaN(Number(val)) ? 0 : Number(val);
        }

        function evaluateFormula(expression) {
            try {
                // SUM(A1:A5) logic
                const sumRegex = /SUM\(([A-Z]+)(\d+):([A-Z]+)(\d+)\)/i;
                const sumMatch = expression.match(sumRegex);

                if (sumMatch) {
                    const startCol = sumMatch[1];
                    const startRow = parseInt(sumMatch[2]);
                    const endCol = sumMatch[3];
                    const endRow = parseInt(sumMatch[4]);
                    if (startCol !== endCol) return "#ERR-COL";
                    let total = 0;
                    for (let r = startRow; r <= endRow; r++) {
                        total += getCellValue(`${startCol}${r}`);
                    }
                    return total;
                }

                // Variable substitution
                const parsedExpr = expression.replace(/[A-Z]+[0-9]+/g, (match) => getCellValue(match));

                // Safety check
                if (/^[0-9+\-*/().\s]*$/.test(parsedExpr)) {
                    // eslint-disable-next-line no-eval
                    return eval(parsedExpr);
                } else {
                    return "#ERR";
                }
            } catch (e) {
                console.error(e);
                return "#ERR";
            }
        }

        function recalculateAll() {
            for (let i = 0; i < 2; i++) {
                Object.keys(cellData).forEach(id => {
                    if (cellData[id].formula) {
                        cellData[id].value = evaluateFormula(cellData[id].formula.substring(1));
                        renderCell(id);
                    }
                });
            }
        }

        function renderCell(cellId) {
            const cell = document.getElementById(cellId);
            const data = cellData[cellId];
            if (data && document.activeElement !== cell) {
                cell.innerText = data.value;
            }
        }

        // --- Toolbar ---
        function execStyle(command, value = null) {
            if (!selectedCellId) return;
            document.execCommand(command, false, value);
            document.getElementById(selectedCellId).focus();
        }

        function execColor(type, color) {
            if (!selectedCellId) return;
            const cell = document.getElementById(selectedCellId);
            if (type === 'backColor') cell.style.backgroundColor = color;
            else if (type === 'foreColor') cell.style.color = color;
        }

        function resetGrid() {
            if(confirm("Clear entire sheet?")) {
                cellData = {};
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.innerText = '';
                    cell.style.backgroundColor = ''; 
                    cell.style.color = '';
                    // We don't reset font styles as easily without removing tags, but clearing text helps
                });
                formulaInput.value = '';
                selectCell("A1");
            }
        }

        function downloadCSV() {
            let csv = [];
            let header = ["Row"];
            for(let c=0; c<COLS; c++) header.push(String.fromCharCode(65+c));
            csv.push(header.join(","));

            for(let r=1; r<=ROWS; r++) {
                let row = [r];
                for(let c=0; c<COLS; c++) {
                    let id = `${String.fromCharCode(65+c)}${r}`;
                    let val = cellData[id] ? cellData[id].value : "";
                    row.push(val);
                }
                csv.push(row.join(","));
            }

            let csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            let downloadLink = document.createElement("a");
            downloadLink.download = "cellnix_sheet.csv";
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // --- Theme Management ---
        const themeIcon = document.getElementById('theme-icon');
        
        // Check local storage or system preference
        const savedTheme = localStorage.getItem('cellnix-theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('cellnix-theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        initGrid();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StarWar: New Genesis - War Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --bg-deep: #020406;
            --panel-bg: rgba(10, 14, 20, 0.95);
            --accent: #00f2ff;
            --road-grey: #2a2d35;
            --danger: #ff3e3e;
            --army-gold: #fbbf24;
            --success: #10b981;
            --ai-enemy: #ff4444;
        }

        body {
            background-color: var(--bg-deep);
            color: #e6edf3;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
            user-select: none;
            width: 100vw;
            height: 100vh;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        #city-grid-container {
            width: 3000px;
            height: 3000px;
            background: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 60px 60px;
            position: absolute;
            transform-origin: 0 0;
        }

        .cell {
            width: 60px;
            height: 60px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, box-shadow 0.3s;
            z-index: 10;
        }

        .cell.player-soil { background: rgba(0, 242, 255, 0.05); border: 0.5px solid rgba(0, 242, 255, 0.1); }
        .cell.enemy-soil { background: rgba(255, 62, 62, 0.1); border: 0.5px solid rgba(255, 62, 62, 0.2); }
        .cell.neutral-soil { background: transparent; }

        /* Unit Styles */
        .unit {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: absolute;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid white;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .unit-player { background: var(--accent); border-color: #fff; box-shadow: 0 0 10px var(--accent); }
        .unit-enemy { background: var(--danger); border-color: #fff; box-shadow: 0 0 10px var(--danger); }
        .unit.selected { ring: 4px solid #fff; ring-offset: 2px; transform: scale(1.2); z-index: 60; }

        .b-palace { background: gold; border-radius: 10%; box-shadow: 0 0 20px gold; }
        .b-barracks { background: #3f6212; border: 2px solid #a3e635; }
        .b-factory { background: #334155; border-top: 4px solid orange; }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: #05070a;
        }

        .action-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s;
        }
        .action-btn:hover { background: var(--accent); color: black; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 62, 62, 0); }
        }
        .invading { animation: pulse-red 2s infinite; }
    </style>
</head>
<body>

<div id="game-container" class="w-screen h-screen flex flex-col relative overflow-hidden">
    
    <!-- HUD -->
    <div class="hud-top glass-panel flex items-center justify-between px-6 py-3 z-50">
        <div class="flex flex-col">
            <span class="orbitron text-accent text-xl font-bold tracking-tighter">COMMAND & CONQUER</span>
            <span id="level-display" class="text-[10px] orbitron opacity-70">LVL 1 PRESIDENT</span>
        </div>

        <div class="flex gap-6">
            <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500 uppercase font-bold">Treasury</span>
                <span id="res-money" class="text-emerald-400 font-bold orbitron">$5,000</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500 uppercase font-bold">Sovereign Soil</span>
                <span id="res-territory" class="text-indigo-400 font-bold orbitron">225 sq</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500 uppercase font-bold">Military Units</span>
                <span id="res-units" class="text-amber-400 font-bold orbitron">0</span>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="saveGame()" class="px-3 py-1 bg-white/10 rounded text-[10px] orbitron hover:bg-white/20">SAVE</button>
            <button onclick="resetGame()" class="px-3 py-1 bg-red-500/20 rounded text-[10px] orbitron hover:bg-red-500/40">RESET</button>
        </div>
    </div>

    <!-- MAP -->
    <div id="viewport">
        <div id="city-grid-container">
            <!-- Soil and Units Rendered Here -->
        </div>
    </div>

    <!-- UI OVERLAYS -->
    <div class="absolute bottom-6 left-6 z-50 flex flex-col gap-4 pointer-events-none w-64">
        <div class="glass-panel p-4 rounded-xl pointer-events-auto">
            <p class="text-[10px] text-accent font-bold orbitron mb-2">CONSTRUCTION</p>
            <div id="build-menu" class="grid grid-cols-2 gap-2"></div>
        </div>
        
        <div class="glass-panel p-4 rounded-xl pointer-events-auto">
            <p class="text-[10px] text-amber-500 font-bold orbitron mb-2">BATTLE LOG</p>
            <div id="log" class="text-[9px] h-20 overflow-y-auto text-gray-400 font-mono italic">
                - System Online...<br>
                - Awaiting orders...
            </div>
        </div>
    </div>

    <!-- SELECTION PANEL -->
    <div id="selection-panel" class="hidden absolute top-24 right-6 w-48 glass-panel p-4 rounded-xl z-50 border-r-4 border-accent">
        <p id="sel-title" class="orbitron text-xs font-bold text-accent mb-1">Unit Selected</p>
        <p id="sel-stats" class="text-[10px] text-gray-400 mb-3">Power: 100 | Ready</p>
        <button id="spawn-btn" class="w-full py-2 bg-accent text-black text-[10px] font-bold orbitron rounded mb-2 hidden">SPAWN ARMY ($2000)</button>
        <p class="text-[8px] text-gray-500 italic">Click adjacent soil to move/attack</p>
    </div>
</div>

<script>
    const CONFIG = {
        GRID_SIZE: 50,
        CELL_SIZE: 60,
        TYPES: {
            palace:   { cost: 0, icon: 'üèõÔ∏è', class: 'b-palace', desc: 'HQ' },
            barracks: { cost: 4000, icon: 'üéñÔ∏è', class: 'b-barracks', desc: 'Army Spawn' },
            factory:  { cost: 3000, icon: 'üè≠', class: 'b-factory', desc: 'Income', income: 400 }
        }
    };

    let state = {
        money: 5000,
        level: 1,
        xp: 0,
        territory: [], // Array of {x, y, owner: 'player'|'ai1'|'ai2'}
        buildings: [], // Array of {x, y, type}
        units: [],     // Array of {id, x, y, owner: 'player'|'ai', power: 100}
        selectedId: null,
        zoom: 0.8,
        mapPos: { x: 100, y: 100 }
    };

    // Initialize map
    function initMap() {
        const grid = document.getElementById('city-grid-container');
        
        // Setup initial territories
        for (let x = 0; x < CONFIG.GRID_SIZE; x++) {
            for (let y = 0; y < CONFIG.GRID_SIZE; y++) {
                let owner = null;
                if (x >= 15 && x < 30 && y >= 15 && y < 30) owner = 'player';
                else if (x < 10 && y < 15) owner = 'ai1';
                else if (x > 40 && y > 35) owner = 'ai2';
                
                if (owner) state.territory.push({ x, y, owner });

                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${x}-${y}`;
                cell.style.left = (x * CONFIG.CELL_SIZE) + 'px';
                cell.style.top = (y * CONFIG.CELL_SIZE) + 'px';
                cell.onclick = () => handleCellClick(x, y);
                grid.appendChild(cell);
            }
        }
        
        // Starting Palace
        addBuilding(22, 22, 'palace');
        renderAll();
        updateUI();
        updateBuildMenu();
        
        // Start Loops
        setInterval(gameTick, 2000);
        setInterval(aiTick, 5000);
    }

    function handleCellClick(x, y) {
        // If building mode active
        if (state.activeBuild) {
            if (isPlayerSoil(x, y)) {
                addBuilding(x, y, state.activeBuild);
                state.activeBuild = null;
            } else {
                addLog("Cannot build on foreign or neutral soil!");
            }
            return;
        }

        // If unit selected
        if (state.selectedId !== null) {
            const unit = state.units.find(u => u.id === state.selectedId);
            if (unit && unit.owner === 'player') {
                const dist = Math.abs(unit.x - x) + Math.abs(unit.y - y);
                if (dist === 1) {
                    moveUnit(unit, x, y);
                    return;
                }
            }
        }

        // Select existing building or unit
        const building = state.buildings.find(b => b.x === x && b.y === y);
        if (building && building.type === 'barracks') {
            showSelection('Barracks', 'Military Output Hub', true, x, y);
            return;
        }

        hideSelection();
    }

    function isPlayerSoil(x, y) {
        return state.territory.some(t => t.x === x && t.y === y && t.owner === 'player');
    }

    function addBuilding(x, y, type) {
        const cfg = CONFIG.TYPES[type];
        if (state.money < cfg.cost) return;
        if (state.buildings.some(b => b.x === x && b.y === y)) return;

        state.money -= cfg.cost;
        state.buildings.push({ x, y, type });
        renderAll();
        updateUI();
    }

    function spawnArmy(x, y) {
        if (state.money < 2000) return;
        state.money -= 2000;
        const id = Date.now();
        state.units.push({ id, x, y, owner: 'player', power: 100 + (state.level * 20) });
        renderAll();
        updateUI();
    }

    function moveUnit(unit, nx, ny) {
        unit.x = nx;
        unit.y = ny;

        // Check Annexation
        const tIdx = state.territory.findIndex(t => t.x === nx && t.y === ny);
        if (tIdx > -1) {
            const currentOwner = state.territory[tIdx].owner;
            if (currentOwner !== unit.owner) {
                state.territory[tIdx].owner = unit.owner;
                if (unit.owner === 'player') {
                    state.money += 200;
                    addLog(`Annexed territory at [${nx},${ny}]! +$200`);
                }
            }
        } else {
            // Claiming neutral soil
            state.territory.push({ x: nx, y: ny, owner: unit.owner });
        }

        // Combat Check
        const enemies = state.units.filter(u => u.x === nx && u.y === ny && u.owner !== unit.owner);
        enemies.forEach(enemy => resolveCombat(unit, enemy));

        renderAll();
        updateUI();
    }

    function resolveCombat(u1, u2) {
        addLog(`BATTLE ENGAGED at [${u1.x},${u1.y}]`);
        if (u1.power >= u2.power) {
            state.units = state.units.filter(u => u.id !== u2.id);
            u1.power -= 20;
            addLog("Victory! Enemy unit destroyed.");
        } else {
            state.units = state.units.filter(u => u.id !== u1.id);
            u2.power -= 20;
            addLog("Defeat! Our unit was lost.");
        }
    }

    function aiTick() {
        // AI Spawns units if they have territory
        ['ai1', 'ai2'].forEach(ai => {
            const aiSoil = state.territory.filter(t => t.owner === ai);
            if (aiSoil.length > 0 && Math.random() > 0.7) {
                const start = aiSoil[0];
                state.units.push({ id: Math.random(), x: start.x, y: start.y, owner: 'ai', power: 80 + (state.level * 15) });
            }
        });

        // AI Moves units toward player palace
        state.units.filter(u => u.owner === 'ai').forEach(u => {
            const palace = state.buildings.find(b => b.type === 'palace') || {x: 25, y: 25};
            const dx = palace.x - u.x;
            const dy = palace.y - u.y;
            
            let nx = u.x, ny = u.y;
            if (Math.abs(dx) > Math.abs(dy)) nx += Math.sign(dx);
            else ny += Math.sign(dy);

            moveUnit(u, nx, ny);
        });
    }

    function gameTick() {
        state.buildings.forEach(b => {
            const cfg = CONFIG.TYPES[b.type];
            if (cfg.income) state.money += (cfg.income / 10);
        });
        updateUI();
    }

    function renderAll() {
        // Render Soil
        state.territory.forEach(t => {
            const cell = document.getElementById(`cell-${t.x}-${t.y}`);
            if (cell) {
                cell.className = `cell ${t.owner}-soil`;
            }
        });

        // Render Buildings
        state.buildings.forEach(b => {
            const cell = document.getElementById(`cell-${b.x}-${b.y}`);
            if (cell) {
                const cfg = CONFIG.TYPES[b.type];
                cell.innerHTML = `<span class="text-2xl">${cfg.icon}</span>`;
                cell.classList.add(cfg.class);
            }
        });

        // Render Units
        // Clear old unit DOM
        document.querySelectorAll('.unit').forEach(u => u.remove());
        const grid = document.getElementById('city-grid-container');
        state.units.forEach(u => {
            const el = document.createElement('div');
            el.className = `unit unit-${u.owner === 'player' ? 'player' : 'enemy'} ${state.selectedId === u.id ? 'selected' : ''}`;
            el.style.left = (u.x * CONFIG.CELL_SIZE + 10) + 'px';
            el.style.top = (u.y * CONFIG.CELL_SIZE + 10) + 'px';
            el.innerHTML = u.owner === 'player' ? 'üéñÔ∏è' : 'üíÄ';
            el.onclick = (e) => {
                e.stopPropagation();
                if (u.owner === 'player') {
                    state.selectedId = u.id;
                    showSelection('Army Unit', `Power: ${u.power.toFixed(0)}`, false);
                    renderAll();
                }
            };
            grid.appendChild(el);
        });
    }

    function updateUI() {
        document.getElementById('res-money').innerText = `$${Math.floor(state.money).toLocaleString()}`;
        document.getElementById('res-territory').innerText = `${state.territory.filter(t => t.owner === 'player').length} sq`;
        document.getElementById('res-units').innerText = state.units.filter(u => u.owner === 'player').length;
    }

    function showSelection(title, stats, canSpawn, x, y) {
        const p = document.getElementById('selection-panel');
        p.classList.remove('hidden');
        document.getElementById('sel-title').innerText = title;
        document.getElementById('sel-stats').innerText = stats;
        const btn = document.getElementById('spawn-btn');
        if (canSpawn) {
            btn.classList.remove('hidden');
            btn.onclick = () => spawnArmy(x, y);
        } else {
            btn.classList.add('hidden');
        }
    }

    function hideSelection() {
        document.getElementById('selection-panel').classList.add('hidden');
        state.selectedId = null;
    }

    function updateBuildMenu() {
        const menu = document.getElementById('build-menu');
        Object.entries(CONFIG.TYPES).forEach(([id, cfg]) => {
            if (id === 'palace') return;
            const btn = document.createElement('button');
            btn.className = "action-btn p-2 rounded text-[10px] orbitron flex flex-col items-center pointer-events-auto";
            btn.innerHTML = `<span>${cfg.icon}</span><span>$${cfg.cost}</span>`;
            btn.onclick = () => {
                state.activeBuild = id;
                addLog(`Construction ready: Place ${id} on your soil.`);
            };
            menu.appendChild(btn);
        });
    }

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML = `> ${msg}<br>${log.innerHTML}`;
    }

    // Viewport panning
    let isDragging = false;
    let startX, startY;
    const vp = document.getElementById('viewport');
    vp.onmousedown = (e) => {
        isDragging = true;
        startX = e.clientX - state.mapPos.x;
        startY = e.clientY - state.mapPos.y;
    };
    window.onmousemove = (e) => {
        if (!isDragging) return;
        state.mapPos.x = e.clientX - startX;
        state.mapPos.y = e.clientY - startY;
        document.getElementById('city-grid-container').style.transform = `translate(${state.mapPos.x}px, ${state.mapPos.y}px) scale(${state.zoom})`;
    };
    window.onmouseup = () => isDragging = false;

    window.onload = initMap;
</script>

</body>
</html>

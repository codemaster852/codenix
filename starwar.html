<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>War Genesis: Total Conflict</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap');

        :root {
            --bg-deep: #020406;
            --panel-bg: rgba(7, 10, 15, 0.95);
            --accent: #00f2ff;
            --danger: #ff3e3e;
            --nuke: #dfff00;
        }

        body {
            background-color: var(--bg-deep);
            color: #e6edf3;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
            user-select: none;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        #city-grid-container {
            width: 4200px;
            height: 4200px;
            background: 
                radial-gradient(circle at 50% 50%, #0a0d14 0%, #020406 100%),
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 100%, 70px 70px, 70px 70px;
            position: absolute;
            transform-origin: 0 0;
            will-change: transform;
        }

        .cell {
            width: 70px;
            height: 70px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            z-index: 5;
        }

        .player-soil { background: rgba(0, 242, 255, 0.05); border: 0.5px solid rgba(0, 242, 255, 0.15); }
        .ai1-soil { background: rgba(255, 62, 62, 0.1); border: 0.5px solid rgba(255, 62, 62, 0.2); }
        .ai2-soil { background: rgba(168, 85, 247, 0.1); border: 0.5px solid rgba(168, 85, 247, 0.2); }
        .ai3-soil { background: rgba(34, 197, 94, 0.1); border: 0.5px solid rgba(34, 197, 94, 0.2); }

        .unit {
            width: 50px;
            height: 50px;
            position: absolute;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 12px;
        }
        .unit-player { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }
        .unit-enemy { background: var(--danger); color: #fff; box-shadow: 0 0 10px var(--danger); }
        .unit-nuke { background: var(--nuke) !important; color: #000 !important; animation: pulse-nuke 1s infinite; }
        
        @keyframes pulse-nuke {
            0% { transform: scale(1); box-shadow: 0 0 10px var(--nuke); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px var(--nuke); }
            100% { transform: scale(1); box-shadow: 0 0 10px var(--nuke); }
        }

        .unit.selected { 
            outline: 4px solid white; 
            outline-offset: 4px; 
            z-index: 100;
        }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-game {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .btn-game:hover { background: var(--accent); color: #000; }
        .btn-game:active { transform: scale(0.95); }

        #viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .mobile-controls {
            position: absolute;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
    </style>
</head>
<body>

<div id="game-container" class="w-screen h-screen flex flex-col relative overflow-hidden">
    
    <!-- TOP HUD -->
    <div class="hud-top glass-panel flex flex-wrap items-center justify-between px-4 py-3 md:px-6 md:py-4 z-50">
        <div class="flex flex-col mb-2 md:mb-0">
            <h1 class="orbitron text-accent text-xl md:text-2xl font-black tracking-tighter leading-none">WAR GENESIS</h1>
            <p id="war-status" class="text-[8px] md:text-[10px] orbitron text-gray-400 mt-1 uppercase">Operational Priority: Expansion</p>
        </div>

        <div class="flex flex-wrap gap-2 md:gap-4">
            <div class="bg-white/5 border border-white/10 px-3 py-1 rounded flex flex-col items-center min-w-[70px] md:min-w-[100px]">
                <span class="text-[7px] text-gray-500 uppercase font-bold">Treasury</span>
                <span id="res-money" class="text-emerald-400 font-bold orbitron text-sm md:text-base">$0</span>
            </div>
            <div class="bg-white/5 border border-white/10 px-3 py-1 rounded flex flex-col items-center min-w-[70px] md:min-w-[100px]">
                <span class="text-[7px] text-gray-500 uppercase font-bold">Pop. Rank</span>
                <span id="res-rank" class="text-indigo-400 font-bold orbitron text-sm md:text-base">D-4</span>
            </div>
            <div class="bg-white/5 border border-white/10 px-3 py-1 rounded flex flex-col items-center min-w-[70px] md:min-w-[100px]">
                <span class="text-[7px] text-gray-500 uppercase font-bold">Combat Force</span>
                <span id="res-units" class="text-amber-400 font-bold orbitron text-sm md:text-base">0</span>
            </div>
        </div>

        <div class="hidden md:flex gap-2">
            <button onclick="saveGame()" class="p-2 btn-game rounded text-[10px] orbitron">SAVE</button>
            <button onclick="resetGame()" class="p-2 bg-red-500/10 border border-red-500/20 rounded text-[10px] orbitron">WIPE</button>
        </div>
    </div>

    <!-- VIEWPORT -->
    <div id="viewport">
        <div id="city-grid-container"></div>
        
        <!-- Zoom Buttons -->
        <div class="mobile-controls">
            <button onclick="changeZoom(0.1)" class="w-12 h-12 glass-panel rounded-full flex items-center justify-center text-white text-xl font-bold">+</button>
            <button onclick="changeZoom(-0.1)" class="w-12 h-12 glass-panel rounded-full flex items-center justify-center text-white text-xl font-bold">-</button>
            <button onclick="resetCamera()" class="w-12 h-12 glass-panel rounded-full flex items-center justify-center text-white text-xs">RESET</button>
        </div>
    </div>

    <!-- UI PANELS -->
    <div class="absolute bottom-4 left-4 z-50 flex flex-col gap-4 pointer-events-none w-full max-w-[300px] md:max-w-sm">
        <div class="glass-panel p-3 md:p-4 rounded-2xl pointer-events-auto">
            <p class="text-[9px] text-accent font-bold orbitron mb-2 md:mb-3 tracking-widest">BUILD OPTIONS</p>
            <div id="build-menu" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
        
        <div class="glass-panel p-3 md:p-4 rounded-2xl pointer-events-auto hidden md:block">
            <p class="text-[9px] text-red-500 font-bold orbitron mb-2 tracking-widest">SITUATION REPORT</p>
            <div id="log" class="text-[10px] h-20 overflow-y-auto text-gray-400 font-mono space-y-1">
                <p class="text-accent">> Satellite Link established...</p>
            </div>
        </div>
    </div>

    <!-- UNIT COMMAND PANEL -->
    <div id="selection-panel" class="hidden absolute top-32 right-4 w-56 md:w-64 glass-panel p-4 rounded-2xl z-50 border-r-4 border-accent">
        <div class="flex items-center gap-3 mb-4">
            <div id="sel-icon" class="text-3xl"></div>
            <div>
                <p id="sel-title" class="orbitron text-xs font-bold text-white uppercase"></p>
                <p id="sel-stats" class="text-[9px] text-accent font-mono"></p>
            </div>
        </div>
        <div id="selection-actions" class="grid grid-cols-1 gap-2">
            <!-- Dynamic Actions -->
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        GRID_SIZE: 60,
        CELL_SIZE: 70,
        UNIT_TYPES: {
            infantry: { cost: 1500, icon: 'üéñÔ∏è', power: 100, range: 1, speed: 2, desc: 'Basic Ground Unit' },
            tank:     { cost: 4000, icon: 'üöú', power: 250, range: 1, speed: 1, desc: 'Heavy Armor' },
            rocket:   { cost: 8000, icon: 'üöÄ', power: 150, range: 3, speed: 1, desc: 'Long Range Siege' },
            nawawy:   { cost: 25000, icon: '‚öõÔ∏è', power: 999, range: 1, speed: 1, desc: 'Nuclear Annihilator' }
        },
        BUILDINGS: {
            palace:   { cost: 0, icon: 'üèõÔ∏è', class: 'bg-amber-500 shadow-xl', income: 100 },
            barracks: { cost: 4000, icon: 'üéñÔ∏è', class: 'bg-slate-700 border-2 border-accent' },
            factory:  { cost: 6000, icon: 'üè≠', class: 'bg-zinc-800 border-t-4 border-orange-500', income: 800 },
            silo:     { cost: 12000, icon: 'üöÄ', class: 'bg-red-900 border-2 border-white' }
        }
    };

    let state = {
        money: 10000,
        territory: [], 
        buildings: [], 
        units: [],     
        nations: {
            'player': { name: 'United Terra' },
            'ai1': { name: 'Eastern Bloc' },
            'ai2': { name: 'Northern Legion' },
            'ai3': { name: 'Pacific Coast' }
        },
        selectedUnitId: null,
        activeBuild: null,
        mapPos: { x: -1800, y: -1800 },
        zoom: 0.6
    };

    function init() {
        const grid = document.getElementById('city-grid-container');
        
        for (let x = 0; x < CONFIG.GRID_SIZE; x++) {
            for (let y = 0; y < CONFIG.GRID_SIZE; y++) {
                let owner = null;
                if (x >= 25 && x < 35 && y >= 25 && y < 35) owner = 'player';
                else if (x < 10 && y < 10) owner = 'ai1';
                else if (x > 50 && y < 10) owner = 'ai2';
                else if (x < 10 && y > 50) owner = 'ai3';
                
                if (owner) state.territory.push({ x, y, owner });

                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${x}-${y}`;
                cell.style.left = (x * CONFIG.CELL_SIZE) + 'px';
                cell.style.top = (y * CONFIG.CELL_SIZE) + 'px';
                cell.onclick = (e) => handleCellClick(x, y, e);
                grid.appendChild(cell);
            }
        }

        addBuilding(30, 30, 'palace', true);
        applyTransform();
        updateBuildMenu();
        renderAll();
        
        setInterval(economyTick, 2000);
        setInterval(aiTick, 4500);
    }

    function handleCellClick(x, y, event) {
        if (state.activeBuild) {
            const soil = state.territory.find(t => t.x === x && t.y === y);
            if (soil && soil.owner === 'player') {
                addBuilding(x, y, state.activeBuild);
                state.activeBuild = null;
            } else {
                addLog("CAN ONLY BUILD ON SOVEREIGN SOIL", "text-red-400");
            }
            return;
        }

        // Check if clicked a unit
        const unit = state.units.find(u => u.x === x && u.y === y && u.owner === 'player');
        if (unit) {
            state.selectedUnitId = unit.id;
            showUnitPanel(unit);
            renderAll();
            return;
        }

        // If unit selected, move it
        if (state.selectedUnitId) {
            const myUnit = state.units.find(u => u.id === state.selectedUnitId);
            const dist = Math.abs(myUnit.x - x) + Math.abs(myUnit.y - y);
            
            // Movement logic: Allow movement if it's within range
            if (dist > 0 && dist <= 2) {
                moveUnit(myUnit, x, y);
                state.selectedUnitId = null;
                hidePanel();
            } else {
                state.selectedUnitId = null;
                hidePanel();
            }
            renderAll();
            return;
        }

        // Building check
        const b = state.buildings.find(b => b.x === x && b.y === y);
        if (b) {
            showBuildingPanel(b);
            return;
        }

        hidePanel();
    }

    function addBuilding(x, y, type, free = false) {
        const cfg = CONFIG.BUILDINGS[type];
        if (!free && state.money < cfg.cost) { addLog("FUNDS CRITICAL"); return; }
        if (state.buildings.some(b => b.x === x && b.y === y)) return;

        if (!free) state.money -= cfg.cost;
        state.buildings.push({ x, y, type });
        addLog(`COMMISSIONED: ${type.toUpperCase()}`, "text-cyan-400");
        renderAll();
        updateUI();
    }

    function moveUnit(unit, nx, ny) {
        unit.x = nx;
        unit.y = ny;

        const soil = state.territory.find(t => t.x === nx && t.y === ny);
        if (soil) {
            if (soil.owner !== unit.owner) {
                soil.owner = unit.owner;
                if (unit.owner === 'player') {
                    state.money += 300;
                    addLog("TERRITORY SEIZED", "text-green-400");
                }
            }
        } else {
            state.territory.push({ x: nx, y: ny, owner: unit.owner });
        }

        if (unit.type === 'nawawy') {
            state.buildings = state.buildings.filter(b => b.x !== nx || b.y !== ny);
            addLog("NUCLEAR IMPACT DETECTED", "text-yellow-400");
        }

        const enemies = state.units.filter(u => u.x === nx && u.y === ny && u.owner !== unit.owner);
        enemies.forEach(enemy => {
            if (unit.power >= enemy.power) {
                state.units = state.units.filter(u => u.id !== enemy.id);
                unit.power -= 20;
                addLog("ENEMIES NEUTRALIZED", "text-orange-400");
            } else {
                state.units = state.units.filter(u => u.id !== unit.id);
                state.selectedUnitId = null;
                addLog("UNIT LOST IN ACTION", "text-red-500");
            }
        });

        renderAll();
    }

    function economyTick() {
        let income = state.territory.filter(t => t.owner === 'player').length * 10;
        state.buildings.forEach(b => {
            const cfg = CONFIG.BUILDINGS[b.type];
            if (cfg.income) income += (cfg.income / 10);
        });
        state.money += income;
        updateUI();
    }

    function aiTick() {
        ['ai1', 'ai2', 'ai3'].forEach(id => {
            const soil = state.territory.filter(t => t.owner === id);
            if (soil.length === 0) return;

            if (Math.random() > 0.7) {
                const s = soil[Math.floor(Math.random() * soil.length)];
                state.units.push({
                    id: Math.random(),
                    x: s.x, y: s.y,
                    owner: id,
                    type: 'infantry',
                    power: 100
                });
            }

            state.units.filter(u => u.owner === id).forEach(u => {
                const target = { x: 30, y: 30 };
                let nx = u.x + Math.sign(target.x - u.x);
                let ny = u.y + Math.sign(target.y - u.y);
                moveUnit(u, nx, ny);
            });
        });
    }

    function renderAll() {
        state.territory.forEach(t => {
            const cell = document.getElementById(`cell-${t.x}-${t.y}`);
            if (cell) cell.className = `cell ${t.owner}-soil`;
        });

        state.buildings.forEach(b => {
            const cell = document.getElementById(`cell-${b.x}-${b.y}`);
            if (cell) {
                const cfg = CONFIG.BUILDINGS[b.type];
                cell.innerHTML = `<span class="text-3xl">${cfg.icon}</span>`;
                // Split classes by spaces to avoid InvalidCharacterError
                const classList = cfg.class.split(' ');
                classList.forEach(cls => cell.classList.add(cls));
            }
        });

        document.querySelectorAll('.unit').forEach(u => u.remove());
        const grid = document.getElementById('city-grid-container');
        state.units.forEach(u => {
            const el = document.createElement('div');
            el.className = `unit unit-${u.owner === 'player' ? 'player' : 'enemy'} ${u.type === 'nawawy' ? 'unit-nuke' : ''} ${state.selectedUnitId === u.id ? 'selected' : ''}`;
            el.style.left = (u.x * CONFIG.CELL_SIZE + 10) + 'px';
            el.style.top = (u.y * CONFIG.CELL_SIZE + 10) + 'px';
            el.innerHTML = CONFIG.UNIT_TYPES[u.type]?.icon || 'üéñÔ∏è';
            el.onclick = (e) => {
                e.stopPropagation();
                handleCellClick(u.x, u.y);
            };
            grid.appendChild(el);
        });
    }

    function showUnitPanel(unit) {
        const p = document.getElementById('selection-panel');
        p.classList.remove('hidden');
        document.getElementById('sel-title').innerText = unit.type;
        document.getElementById('sel-stats').innerText = `POWER: ${unit.power} | ATK RANGE: 1`;
        document.getElementById('sel-icon').innerText = CONFIG.UNIT_TYPES[unit.type].icon;
        
        const actions = document.getElementById('selection-actions');
        actions.innerHTML = '<p class="text-[9px] text-gray-500 italic">Select adjacent tile to move</p>';
    }

    function showBuildingPanel(b) {
        const p = document.getElementById('selection-panel');
        p.classList.remove('hidden');
        document.getElementById('sel-title').innerText = b.type;
        document.getElementById('sel-stats').innerText = `STATUS: OPERATIONAL`;
        document.getElementById('sel-icon').innerText = CONFIG.BUILDINGS[b.type].icon;
        
        const actions = document.getElementById('selection-actions');
        actions.innerHTML = '';
        
        if (b.type === 'barracks' || b.type === 'silo') {
            Object.entries(CONFIG.UNIT_TYPES).forEach(([id, u]) => {
                const btn = document.createElement('button');
                btn.className = "w-full py-2 bg-accent text-black orbitron text-[9px] font-black rounded hover:bg-white";
                btn.innerText = `TRAIN ${id.toUpperCase()} ($${u.cost})`;
                btn.onclick = () => spawnUnit(b.x, b.y, id);
                actions.appendChild(btn);
            });
        }
    }

    function spawnUnit(x, y, type) {
        const cfg = CONFIG.UNIT_TYPES[type];
        if (state.money < cfg.cost) return;
        state.money -= cfg.cost;
        state.units.push({
            id: Date.now(),
            x, y,
            owner: 'player',
            type: type,
            power: cfg.power
        });
        renderAll();
        updateUI();
    }

    function hidePanel() { document.getElementById('selection-panel').classList.add('hidden'); }

    function updateBuildMenu() {
        const menu = document.getElementById('build-menu');
        menu.innerHTML = '';
        Object.entries(CONFIG.BUILDINGS).forEach(([id, cfg]) => {
            if (id === 'palace') return;
            const btn = document.createElement('button');
            btn.className = "p-2 bg-white/5 border border-white/10 rounded flex flex-col items-center pointer-events-auto hover:border-accent";
            btn.innerHTML = `<span class="text-xl">${cfg.icon}</span><span class="text-[8px] orbitron font-bold">$${cfg.cost}</span>`;
            btn.onclick = () => { state.activeBuild = id; addLog(`ORDER: PLACE ${id.toUpperCase()}`); };
            menu.appendChild(btn);
        });
    }

    function updateUI() {
        document.getElementById('res-money').innerText = `$${Math.floor(state.money).toLocaleString()}`;
        document.getElementById('res-units').innerText = state.units.filter(u => u.owner === 'player').length;
    }

    function addLog(msg, colorClass = "text-gray-400") {
        const log = document.getElementById('log');
        const p = document.createElement('p');
        p.className = colorClass;
        p.innerText = `> ${msg}`;
        log.prepend(p);
    }

    function changeZoom(amt) {
        state.zoom = Math.max(0.2, Math.min(1.5, state.zoom + amt));
        applyTransform();
    }
    function resetCamera() { state.zoom = 0.6; state.mapPos = { x: -1800, y: -1800 }; applyTransform(); }
    function applyTransform() {
        document.getElementById('city-grid-container').style.transform = `translate(${state.mapPos.x}px, ${state.mapPos.y}px) scale(${state.zoom})`;
    }

    let isDragging = false, startX, startY;
    const vp = document.getElementById('viewport');
    vp.onmousedown = (e) => { isDragging = true; startX = e.clientX - state.mapPos.x; startY = e.clientY - state.mapPos.y; };
    vp.ontouchstart = (e) => { isDragging = true; startX = e.touches[0].clientX - state.mapPos.x; startY = e.touches[0].clientY - state.mapPos.y; };
    window.onmousemove = (e) => { if (!isDragging) return; state.mapPos.x = e.clientX - startX; state.mapPos.y = e.clientY - startY; applyTransform(); };
    window.ontouchmove = (e) => { if (!isDragging) return; state.mapPos.x = e.touches[0].clientX - startX; state.mapPos.y = e.touches[0].clientY - startY; applyTransform(); };
    window.onmouseup = window.ontouchend = () => isDragging = false;

    function saveGame() { localStorage.setItem('war_genesis_save', JSON.stringify(state)); addLog("STATE SAVED"); }
    function resetGame() { localStorage.removeItem('war_genesis_save'); location.reload(); }

    window.onload = init;
</script>

</body>
</html>

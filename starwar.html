<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>War Genesis: 3D Total Conflict</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap');

        :root {
            --bg-deep: #020406;
            --panel-bg: rgba(7, 10, 15, 0.9);
            --accent: #00f2ff;
            --danger: #ff3e3e;
        }

        body {
            background-color: var(--bg-deep);
            color: #e6edf3;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
            user-select: none;
            width: 100vw;
            height: 100vh;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #three-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .ui-overlay {
            position: relative;
            z-index: 10;
            pointer-events: none;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .pointer-events-auto { pointer-events: auto; }

        .toggle-active {
            background: var(--accent) !important;
            color: black !important;
            box-shadow: 0 0 15px var(--accent);
        }

        .defense-active {
            border-color: #dfff00 !important;
            color: #dfff00 !important;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: rgba(223, 255, 0, 0.5); }
            50% { border-color: rgba(223, 255, 0, 1); box-shadow: 0 0 10px rgba(223, 255, 0, 0.3); }
        }

        #log::-webkit-scrollbar { width: 4px; }
        #log::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>

<div id="three-container"></div>

<div class="ui-overlay">
    <!-- TOP HUD -->
    <div class="hud-top glass-panel flex flex-wrap items-center justify-between px-6 py-4 pointer-events-auto">
        <div class="flex flex-col">
            <h1 class="orbitron text-accent text-2xl font-black tracking-tighter leading-none">WAR GENESIS 3D</h1>
            <p id="war-status" class="text-[10px] orbitron text-gray-400 mt-1 uppercase tracking-widest">Global Conflict: 10 AI Active</p>
        </div>

        <div class="flex gap-4">
            <div class="bg-white/5 border border-white/10 px-4 py-1 rounded flex flex-col items-center min-w-[100px]">
                <span class="text-[7px] text-gray-500 uppercase font-bold">Treasury</span>
                <span id="res-money" class="text-emerald-400 font-bold orbitron text-base">$0</span>
            </div>
            <div class="bg-white/5 border border-white/10 px-4 py-1 rounded flex flex-col items-center min-w-[100px]">
                <span class="text-[7px] text-gray-500 uppercase font-bold">Units</span>
                <span id="res-units" class="text-amber-400 font-bold orbitron text-base">0</span>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="buyDefense()" id="btn-defense" class="px-3 py-2 bg-white/5 border border-white/10 rounded text-[10px] orbitron hover:bg-white hover:text-black transition-all">
                BUY AEGIS DEFENSE ($3,000)
            </button>
            <button onclick="resetGame()" class="p-2 bg-red-500/10 border border-red-500/20 rounded text-[10px] orbitron">RESET</button>
        </div>
    </div>

    <!-- MIDDLE LEFT -->
    <div class="flex-1 flex items-center px-4">
        <div class="glass-panel p-3 rounded-xl w-48 pointer-events-auto space-y-2">
            <p class="text-[8px] text-accent font-bold orbitron mb-2 uppercase">Command Auto</p>
            <button id="toggle-autoRecruit" onclick="toggleAutomation('autoRecruit')" class="w-full text-[9px] orbitron py-2 px-2 border border-white/10 rounded bg-white/5">AUTO-RECRUIT</button>
            <button id="toggle-autoExpand" onclick="toggleAutomation('autoExpand')" class="w-full text-[9px] orbitron py-2 px-2 border border-white/10 rounded bg-white/5">AUTO-EXPAND</button>
            <div class="h-[1px] bg-white/10 my-2"></div>
            <p class="text-[7px] text-gray-500 orbitron uppercase">Active Threats</p>
            <div id="ai-status-list" class="space-y-1 max-h-32 overflow-y-auto pr-1"></div>
        </div>
    </div>

    <!-- BOTTOM UI -->
    <div class="flex flex-col md:flex-row gap-4 p-4 items-end justify-between">
        <div class="glass-panel p-4 rounded-2xl w-full max-w-sm pointer-events-auto">
            <p class="text-[9px] text-accent font-bold orbitron mb-3 tracking-widest uppercase">Factory Selection</p>
            <div id="build-menu" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div class="glass-panel p-4 rounded-2xl w-full max-w-xs pointer-events-auto">
            <p class="text-[9px] text-red-500 font-bold orbitron mb-2 tracking-widest">TACTICAL FEED</p>
            <div id="log" class="text-[10px] h-24 overflow-y-auto text-gray-400 font-mono space-y-1">
                <p class="text-accent">> Hyper-War Protocol Initialized...</p>
            </div>
        </div>
    </div>
</div>

<div id="unit-menu" class="hidden fixed glass-panel p-4 rounded-xl z-50 w-48 pointer-events-auto border-l-4 border-accent">
    <p id="menu-title" class="orbitron text-xs font-bold text-white mb-1"></p>
    <p id="menu-stats" class="text-[9px] text-accent mb-3"></p>
    <div id="menu-actions" class="flex flex-col gap-2">
        <p class="text-[8px] text-gray-400">Right click ground to relocate</p>
    </div>
</div>

<script>
    // --- CONFIG ---
    const CONFIG = {
        UNIT_TYPES: {
            infantry: { cost: 100, color: 0x00f2ff, power: 100, speed: 0.12, type: 'infantry' },
            tank:     { cost: 350, color: 0x888888, power: 300, speed: 0.07, type: 'tank' },
            plane:    { cost: 600, color: 0xffffff, power: 450, speed: 0.25, type: 'plane' },
            nuke:     { cost: 1500, color: 0xdfff00, power: 1500, speed: 0.04, type: 'nuke' }
        },
        AEGIS_COST: 3000,
        AI_PLAYERS: [
            { id: 1, name: "Bot Zero", level: 1, color: 0xff4444, pos: {x: 70, z: 0} },
            { id: 2, name: "Stalker", level: 2, color: 0xff8844, pos: {x: 70, z: 30} },
            { id: 3, name: "Viper", level: 3, color: 0x44ff44, pos: {x: 70, z: -30} },
            { id: 4, name: "Sentinel", level: 4, color: 0x4488ff, pos: {x: 0, z: 70} },
            { id: 5, name: "Titan", level: 5, color: 0x8844ff, pos: {x: -70, z: 70} },
            { id: 6, name: "Ghost", level: 6, color: 0xff44ff, pos: {x: -70, z: 0} },
            { id: 7, name: "Raven", level: 7, color: 0x00ff88, pos: {x: -70, z: -70} },
            { id: 8, name: "Colossus", level: 8, color: 0xffcc00, pos: {x: 0, z: -70} },
            { id: 9, name: "MAX-ALPHA", level: 9, color: 0xffffff, pos: {x: 50, z: 50}, master: true },
            { id: 10, name: "MAX-OMEGA", level: 10, color: 0xff0000, pos: {x: -50, z: -50}, master: true }
        ]
    };

    let state = {
        money: 1000,
        units: [],
        selectedUnit: null,
        autoRecruit: false,
        autoExpand: false,
        aegisDefense: false,
        mouse: new THREE.Vector2(),
        raycaster: new THREE.Raycaster()
    };

    let scene, camera, renderer, terrain;
    let unitMeshes = new Map();

    // --- 3D MODEL FACTORY ---
    function createUnitModel(type, color) {
        const group = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({ 
            color: color, 
            emissive: color, 
            emissiveIntensity: 0.2 
        });

        if (type === 'infantry') {
            // "Pawn" style character
            const base = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.2, 8), mat);
            const body = new THREE.Mesh(new THREE.ConeGeometry(0.35, 1, 8), mat);
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 8, 8), mat);
            body.position.y = 0.5;
            head.position.y = 1.1;
            group.add(base, body, head);
        } else if (type === 'tank') {
            // Detailed Tank
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.5, 1.8), mat);
            const turret = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.4, 0.7), mat);
            const gun = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1, 8), mat);
            turret.position.y = 0.45;
            gun.rotation.x = Math.PI / 2;
            gun.position.y = 0.45;
            gun.position.z = 0.8;
            group.add(body, turret, gun);
        } else if (type === 'plane') {
            // Sleek Fighter
            const fuselage = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.05, 2, 8), mat);
            const wings = new THREE.Mesh(new THREE.BoxGeometry(2, 0.05, 0.6), mat);
            const tail = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.05, 0.3), mat);
            fuselage.rotation.x = Math.PI / 2;
            wings.position.z = -0.2;
            tail.position.z = -0.8;
            group.add(fuselage, wings, tail);
        } else if (type === 'nuke') {
            // Rocket Silo
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 2, 8), mat);
            const cone = new THREE.Mesh(new THREE.ConeGeometry(0.4, 0.6, 8), mat);
            const fins = new THREE.Mesh(new THREE.BoxGeometry(1, 0.5, 0.1), mat);
            cone.position.y = 1.3;
            fins.position.y = -0.5;
            group.add(body, cone, fins);
        }
        return group;
    }

    // --- INITIALIZATION ---
    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020406);
        scene.fog = new THREE.FogExp2(0x020406, 0.015);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(50, 60, 50);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('three-container').appendChild(renderer.domElement);

        const ambient = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambient);
        const light = new THREE.PointLight(0xffffff, 1.5, 200);
        light.position.set(0, 100, 0);
        scene.add(light);

        // Ground
        terrain = new THREE.Mesh(
            new THREE.PlaneGeometry(300, 300),
            new THREE.MeshStandardMaterial({ color: 0x0a0f1a, roughness: 0.8 })
        );
        terrain.rotation.x = -Math.PI / 2;
        scene.add(terrain);

        const grid = new THREE.GridHelper(300, 60, 0x00f2ff, 0x111111);
        grid.position.y = 0.01;
        scene.add(grid);

        window.addEventListener('resize', onResize);
        window.addEventListener('mousedown', onMouseDown);
        
        setupAIStatus();
        animate();
        setInterval(gameTick, 1000);
    }

    function setupAIStatus() {
        const list = document.getElementById('ai-status-list');
        CONFIG.AI_PLAYERS.forEach(ai => {
            const div = document.createElement('div');
            div.className = "text-[8px] flex justify-between items-center bg-white/5 p-1 rounded";
            div.innerHTML = `
                <span style="color: #${ai.color.toString(16).padStart(6, '0')}">${ai.name}</span>
                <span class="text-gray-500">LVL ${ai.level}</span>
            `;
            list.appendChild(div);
        });
    }

    // --- CORE LOGIC ---
    function gameTick() {
        state.money += 100 + (state.units.filter(u => u.owner === 'player').length * 10);

        // Aegis
        if (state.aegisDefense) {
            state.units.filter(u => u.owner !== 'player').forEach(enemy => {
                const d = Math.sqrt(enemy.x*enemy.x + enemy.z*enemy.z);
                if (d < 25) {
                    addLog(`AEGIS FIRING: ${enemy.owner.toUpperCase()} UNIT DESTROYED`, "text-yellow-400");
                    destroyUnit(enemy.id);
                    createExplosion(enemy.x, enemy.z, 0xffff00);
                }
            });
        }

        // AI Systems
        CONFIG.AI_PLAYERS.forEach(ai => {
            const aiUnits = state.units.filter(u => u.owner === ai.name);
            const spawnRate = ai.master ? 0.8 : (ai.level * 0.1);
            
            if (Math.random() < spawnRate) {
                const types = Object.keys(CONFIG.UNIT_TYPES);
                const pick = ai.master ? types[Math.floor(Math.random() * 2) + 2] : types[Math.floor(Math.random() * 2)];
                spawnUnit(ai.pos.x, ai.pos.z, pick, ai.name, ai.color);
            }

            aiUnits.forEach(u => {
                // AI Units always move towards player center
                u.targetX = 0;
                u.targetZ = 0;
            });
        });

        // Auto Player Logic
        if (state.autoRecruit && state.money >= 500) {
            spawnUnit(0, 0, 'tank', 'player', CONFIG.UNIT_TYPES.tank.color);
        }
        if (state.autoExpand) {
            state.units.filter(u => u.owner === 'player').forEach(u => {
                if (Math.random() > 0.8) {
                    u.targetX = (Math.random() - 0.5) * 100;
                    u.targetZ = (Math.random() - 0.5) * 100;
                }
            });
        }

        updateUI();
    }

    function spawnUnit(x, z, type, owner, color) {
        const cfg = CONFIG.UNIT_TYPES[type];
        if (owner === 'player' && state.money < cfg.cost) return;
        if (owner === 'player') state.money -= cfg.cost;

        const id = Math.random().toString(36).substr(2, 9);
        const unit = { id, x, z, targetX: x, targetZ: z, type, owner, color, power: cfg.power };
        state.units.push(unit);

        const model = createUnitModel(type, color);
        model.position.set(x, 0, z);
        model.userData = { id };
        scene.add(model);
        unitMeshes.set(id, model);
        
        if (owner === 'player') addLog(`BATTALION DEPLOYED: ${type.toUpperCase()}`);
    }

    function destroyUnit(id) {
        state.units = state.units.filter(u => u.id !== id);
        const mesh = unitMeshes.get(id);
        if (mesh) {
            scene.remove(mesh);
            unitMeshes.delete(id);
        }
    }

    function onMouseDown(event) {
        state.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        state.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        state.raycaster.setFromCamera(state.mouse, camera);
        
        const intersects = state.raycaster.intersectObjects(scene.children, true);
        if (intersects.length > 0) {
            const hit = intersects[0];
            let mesh = hit.object;
            while(mesh.parent && !mesh.userData.id) mesh = mesh.parent;

            if (mesh.userData.id) {
                const unit = state.units.find(u => u.id === mesh.userData.id);
                if (unit && unit.owner === 'player') {
                    state.selectedUnit = unit;
                    showUnitMenu(event.clientX, event.clientY, unit);
                }
                return;
            }

            if (state.selectedUnit && (hit.object === terrain)) {
                state.selectedUnit.targetX = hit.point.x;
                state.selectedUnit.targetZ = hit.point.z;
                addLog("UNIT RELOCATING...");
                hideUnitMenu();
                state.selectedUnit = null;
            } else {
                hideUnitMenu();
                state.selectedUnit = null;
            }
        }
    }

    function animate() {
        requestAnimationFrame(animate);

        state.units.forEach(u => {
            const mesh = unitMeshes.get(u.id);
            if (mesh) {
                const cfg = CONFIG.UNIT_TYPES[u.type];
                const dx = u.targetX - u.x;
                const dz = u.targetZ - u.z;
                const d = Math.sqrt(dx*dx + dz*dz);
                
                if (d > 0.5) {
                    u.x += (dx / d) * cfg.speed;
                    u.z += (dz / d) * cfg.speed;
                    mesh.position.set(u.x, (u.type === 'plane' ? 6 : 0), u.z);
                    mesh.lookAt(u.targetX, (u.type === 'plane' ? 6 : 0), u.targetZ);
                }

                // Conflict
                state.units.forEach(other => {
                    if (other.owner !== u.owner) {
                        const dist = Math.sqrt(Math.pow(u.x - other.x, 2) + Math.pow(u.z - other.z, 2));
                        if (dist < 2.5) {
                            if (u.power >= other.power) {
                                createExplosion(other.x, other.z, other.color);
                                destroyUnit(other.id);
                            }
                        }
                    }
                });
            }
        });

        renderer.render(scene, camera);
    }

    function createExplosion(x, z, color) {
        const geo = new THREE.SphereGeometry(0.2, 4, 4);
        const mat = new THREE.MeshBasicMaterial({ color: color });
        for(let i=0; i<10; i++) {
            const p = new THREE.Mesh(geo, mat);
            p.position.set(x, 1, z);
            scene.add(p);
            const v = new THREE.Vector3((Math.random()-0.5)*2, Math.random()*2, (Math.random()-0.5)*2);
            const tick = () => {
                p.position.addScaledVector(v, 0.1);
                p.scale.multiplyScalar(0.9);
                if (p.scale.x > 0.1) requestAnimationFrame(tick);
                else scene.remove(p);
            };
            tick();
        }
    }

    // --- UI HELPERS ---
    function updateUI() {
        document.getElementById('res-money').innerText = `$${Math.floor(state.money)}`;
        document.getElementById('res-units').innerText = state.units.filter(u => u.owner === 'player').length;
    }

    function addLog(msg, color = "text-gray-400") {
        const log = document.getElementById('log');
        const p = document.createElement('p');
        p.className = color;
        p.innerText = `> ${msg}`;
        log.prepend(p);
    }

    function toggleAutomation(key) {
        state[key] = !state[key];
        document.getElementById('toggle-' + key).classList.toggle('toggle-active', state[key]);
        addLog(`${key.toUpperCase()} TOGGLED`);
    }

    function buyDefense() {
        if (state.money >= CONFIG.AEGIS_COST) {
            state.money -= CONFIG.AEGIS_COST;
            state.aegisDefense = true;
            document.getElementById('btn-defense').classList.add('defense-active');
            document.getElementById('btn-defense').innerText = "AEGIS: ACTIVE";
            addLog("AEGIS ORBITAL WEAPONRY ONLINE", "text-yellow-400");
        }
    }

    function showUnitMenu(x, y, unit) {
        const menu = document.getElementById('unit-menu');
        menu.style.display = 'block';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        document.getElementById('menu-title').innerText = unit.type.toUpperCase();
        document.getElementById('menu-stats').innerText = `COMBAT POWER: ${unit.power}`;
    }

    function hideUnitMenu() {
        document.getElementById('unit-menu').style.display = 'none';
    }

    function onResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function resetGame() { location.reload(); }

    window.onload = () => {
        init();
        const build = document.getElementById('build-menu');
        Object.entries(CONFIG.UNIT_TYPES).forEach(([type, cfg]) => {
            const btn = document.createElement('button');
            btn.className = "p-2 bg-white/5 border border-white/10 rounded text-[9px] orbitron hover:border-accent transition-all pointer-events-auto";
            btn.innerHTML = `<div class="text-[10px] mb-1">${type.toUpperCase()}</div>$${cfg.cost}`;
            btn.onclick = (e) => { e.stopPropagation(); spawnUnit(0, 0, type, 'player', cfg.color); };
            build.appendChild(btn);
        });
    };
</script>

</body>
</html>

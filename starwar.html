<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StarWar: New Genesis - Presidential Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --bg-deep: #020406;
            --panel-bg: rgba(10, 14, 20, 0.95);
            --accent: #00f2ff;
            --road-grey: #2a2d35;
            --danger: #ff3e3e;
            --army-gold: #fbbf24;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-deep);
            color: #e6edf3;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
            user-select: none;
            width: 100vw;
            height: 100vh;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        /* Territorial Grid */
        #city-grid-container {
            width: 2400px;
            height: 2400px;
            background: radial-gradient(circle, #0a0d14 0%, #020406 100%);
            position: absolute;
            transform-origin: 0 0;
            transition: transform 0.1s linear;
        }

        /* Border Styling */
        .player-border {
            position: absolute;
            border: 2px dashed var(--accent);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
            pointer-events: none;
            z-index: 1;
        }

        .neighbor-border {
            position: absolute;
            border: 2px solid rgba(255, 62, 62, 0.2);
            background: rgba(255, 62, 62, 0.01);
            pointer-events: none;
        }

        .cell {
            width: 60px;
            height: 60px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.02);
            z-index: 2;
        }

        .cell.out-of-bounds {
            cursor: pointer;
            background: rgba(255, 62, 62, 0.03);
        }
        .cell.out-of-bounds:hover {
            background: rgba(255, 62, 62, 0.1);
        }

        /* Floating Tooltip */
        .foreign-toast {
            position: absolute;
            background: rgba(255, 62, 62, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            animation: fadeUp 1.5s forwards;
            font-family: 'Orbitron', sans-serif;
            border: 1px solid white;
        }

        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; transform: translateY(-20px); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-40px); }
        }

        /* Building Visuals */
        .b-road { background: var(--road-grey) !important; border: none !important; z-index: 3; }
        .b-road::after { content: ''; position: absolute; width: 100%; height: 2px; background: rgba(255,255,255,0.05); }
        
        .b-palace { background: linear-gradient(135deg, #ffd700, #b8860b); clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); border: 2px solid #fff; z-index: 10; }
        .b-house { background: #1e293b; border-bottom: 4px solid #3b82f6; border-radius: 4px; z-index: 10; }
        .b-factory { background: #334155; border-top: 6px solid #f97316; border-radius: 2px; z-index: 10; }
        .b-police { background: #1e3a8a; border: 2px solid #60a5fa; box-shadow: 0 0 10px #60a5fa; z-index: 10; }
        .b-barracks { background: #3f6212; border: 2px solid #a3e635; box-shadow: 0 0 10px rgba(163, 230, 53, 0.3); z-index: 10; }

        .building-icon { font-size: 24px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }

        /* UI Panels */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .task-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 2px solid var(--accent);
            transition: all 0.3s;
        }
        .task-item.complete {
            border-left-color: #10b981;
            opacity: 0.6;
        }

        /* Zoom & Map Controls Overlay */
        .map-controls {
            position: absolute;
            right: 20px;
            bottom: 120px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: var(--panel-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ctrl-btn:active {
            transform: scale(0.9);
            background: rgba(0, 242, 255, 0.1);
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .cell { width: 50px; height: 50px; }
            .map-controls { right: 10px; bottom: 100px; }
            .hud-top { padding: 0.5rem; height: auto; flex-wrap: wrap; gap: 0.5rem; }
            .sidebar-left { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; top: auto; z-index: 100; max-height: 45vh; border-radius: 20px 20px 0 0; }
        }

        #viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            cursor: grab;
        }
        #viewport:active { cursor: grabbing; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    </style>
</head>
<body>

<div id="game-container" class="w-screen h-screen flex flex-col relative overflow-hidden">
    
    <!-- TOP HUD -->
    <div class="hud-top glass-panel border-b border-white/10 flex items-center justify-between px-4 md:px-8 py-2 md:h-20 z-50">
        <div class="flex flex-col">
            <span class="orbitron text-accent text-sm md:text-xl font-bold">TERRA NOVA</span>
            <div class="flex items-center gap-2">
                <span id="level-display" class="orbitron text-[10px] text-white">LVL 1</span>
                <div class="w-20 md:w-40 bg-gray-800 rounded-full h-1 overflow-hidden">
                    <div id="level-bar" class="h-full bg-accent shadow-[0_0:10px_#00f2ff]"></div>
                </div>
            </div>
        </div>

        <div class="flex gap-2 md:gap-4 flex-wrap justify-center">
            <div class="glass-panel px-2 md:px-4 py-0.5 md:py-1 rounded-lg flex flex-col items-center min-w-[70px]">
                <span class="text-[7px] md:text-[8px] text-gray-500 uppercase">Treasury</span>
                <span id="res-money" class="text-emerald-400 font-bold orbitron text-[10px] md:text-sm">$0</span>
            </div>
            <div class="glass-panel px-2 md:px-4 py-0.5 md:py-1 rounded-lg flex flex-col items-center min-w-[70px]">
                <span class="text-[7px] md:text-[8px] text-gray-500 uppercase">Pop</span>
                <span id="res-pop" class="text-blue-400 font-bold orbitron text-[10px] md:text-sm">0</span>
            </div>
            <div class="glass-panel px-2 md:px-4 py-0.5 md:py-1 rounded-lg flex flex-col items-center min-w-[70px]">
                <span class="text-[7px] md:text-[8px] text-gray-500 uppercase">Power</span>
                <span id="res-power" class="text-amber-400 font-bold orbitron text-[10px] md:text-sm">0</span>
            </div>
        </div>

        <div class="flex gap-1 md:gap-2">
            <button onclick="saveGame()" class="p-2 bg-white/5 border border-white/10 rounded text-[9px] orbitron" title="Save">S</button>
            <button onclick="resetGame()" class="p-2 bg-red-500/10 border border-red-500/20 rounded text-[9px] orbitron" title="Reset">R</button>
        </div>
    </div>

    <!-- MAIN VIEWPORT -->
    <div class="flex-grow relative bg-[#010204]">
        <!-- MAP CONTROLS -->
        <div class="map-controls">
            <button class="ctrl-btn orbitron" onclick="adjustZoom(0.1)">+</button>
            <button class="ctrl-btn orbitron" onclick="adjustZoom(-0.1)">‚àí</button>
            <button class="ctrl-btn text-[10px] orbitron" onclick="centerOnPalace()">üìç</button>
            <button class="ctrl-btn text-[10px] orbitron" onclick="resetZoom()">1:1</button>
        </div>

        <div id="viewport">
            <div id="city-grid-container">
                <!-- Borders -->
                <div id="p-border" class="player-border"></div>
                <div id="n-border-1" class="neighbor-border"><span class="p-2 orbitron text-[8px] text-red-500/30">United Federation</span></div>
                <div id="n-border-2" class="neighbor-border"><span class="p-2 orbitron text-[8px] text-red-500/30">Sino-Republic</span></div>
                <!-- Grid Cells -->
            </div>
        </div>

        <!-- LEFT SIDEBAR -->
        <div class="sidebar-left absolute left-4 top-4 md:top-24 w-full md:w-64 z-50 flex flex-col gap-4 pointer-events-none">
            <!-- BUILD MENU -->
            <div class="glass-panel p-3 md:p-4 rounded-xl pointer-events-auto">
                <p class="text-[9px] md:text-[10px] text-accent font-bold mb-2 md:mb-3 orbitron uppercase">Strategic Construction</p>
                <div id="build-menu" class="flex md:block gap-2 overflow-x-auto md:overflow-y-auto md:max-h-[35vh] custom-scrollbar pb-2 md:pb-0">
                    <!-- Buttons JS -->
                </div>
            </div>

            <!-- TASKS PANEL -->
            <div class="hidden md:block glass-panel p-4 rounded-xl pointer-events-auto">
                <p class="text-[10px] text-emerald-400 font-bold mb-2 orbitron uppercase">Presidential Directives</p>
                <div id="task-list" class="space-y-2 overflow-y-auto max-h-[30vh] custom-scrollbar pr-1">
                    <!-- Tasks JS -->
                </div>
            </div>
        </div>

        <!-- NARRATOR -->
        <div class="narrator-box absolute bottom-4 md:bottom-6 left-1/2 -translate-x-1/2 w-full max-w-xl glass-panel p-3 md:p-5 rounded-xl md:rounded-2xl flex items-center gap-3 md:gap-4 z-50 border-b-4 border-accent">
            <div class="w-10 h-10 md:w-12 md:h-12 bg-accent/20 border border-accent rounded flex items-center justify-center shrink-0">
                <span class="text-lg md:text-xl">ü§µ</span>
            </div>
            <div class="flex-grow">
                <div class="flex justify-between items-center mb-0.5">
                    <p class="text-[8px] md:text-[9px] text-accent orbitron font-bold">CHIEF OF STAFF</p>
                    <p id="tension-level" class="text-[8px] text-red-500 orbitron">TENSION: 0%</p>
                </div>
                <p id="narrator-text" class="text-[10px] md:text-xs text-gray-300 italic">"Welcome, Mr. President. Drag the map to scout territory."</p>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        GRID_SIZE: 40,
        PLAYER_ZONE: { x: 10, y: 10, size: 10 },
        CELL_SIZE: window.innerWidth < 768 ? 50 : 60,
        XP_STEP: 3000,
        BUILDINGS: {
            palace:   { cost: 0,     xp: 1000, icon: 'üèõÔ∏è', class: 'b-palace',  desc: 'Capital', limit: 1 },
            road:     { cost: 100,   xp: 50,   icon: 'üõ£Ô∏è', class: 'b-road',    desc: 'Basic Transit' },
            house:    { cost: 800,   xp: 250,  icon: 'üèòÔ∏è', class: 'b-house',   desc: 'Residential', pop: 100 },
            factory:  { cost: 2500,  xp: 600,  icon: 'üè≠', class: 'b-factory', desc: 'Industry', income: 150 },
            barracks: { cost: 5000,  xp: 1200, icon: 'üéñÔ∏è', class: 'b-barracks', desc: 'Military', power: 50, lvl: 2 },
            police:   { cost: 4000,  xp: 1000, icon: 'üöì', class: 'b-police',  desc: 'Security', lvl: 2 },
            park:     { cost: 1500,  xp: 400,  icon: 'üå≥', class: 'b-park',    desc: 'Welfare', lvl: 2 }
        },
        TASKS: [
            { id: 't1', title: 'Urbanization', goal: 'Build 5 Houses', type: 'house', count: 5, reward: 2000 },
            { id: 't2', title: 'Industrialization', goal: 'Build 3 Factories', type: 'factory', count: 3, reward: 5000 },
            { id: 't3', title: 'Defense Shield', goal: 'Establish 2 Barracks', type: 'barracks', count: 2, reward: 10000 },
            { id: 't4', title: 'Road Network', goal: 'Build 10 Roads', type: 'road', count: 10, reward: 1000 }
        ]
    };

    let state = {
        money: 5000, pop: 0, power: 0, xp: 0, level: 1, tension: 0,
        buildings: [], currentSelected: null, zoom: 1.0, completedTasks: [],
        mapPos: { x: -600, y: -600 }
    };

    // Pan variables
    let isPanning = false;
    let startPan = { x: 0, y: 0 };
    let lastMapPos = { x: -600, y: -600 };
    let hasMoved = false;

    function applyMapTransform() {
        const grid = document.getElementById('city-grid-container');
        grid.style.transform = `scale(${state.zoom}) translate(${state.mapPos.x}px, ${state.mapPos.y}px)`;
    }

    function adjustZoom(delta) {
        state.zoom = Math.min(Math.max(0.3, state.zoom + delta), 2.0);
        applyMapTransform();
    }

    function resetZoom() {
        state.zoom = 1.0;
        applyMapTransform();
    }

    function centerOnPalace() {
        const cs = CONFIG.CELL_SIZE;
        const palace = state.buildings.find(b => b.type === 'palace') || { x: 15, y: 15 };
        const view = document.getElementById('viewport');
        state.mapPos.x = -(palace.x * cs) + (view.clientWidth / (2 * state.zoom));
        state.mapPos.y = -(palace.y * cs) + (view.clientHeight / (2 * state.zoom));
        applyMapTransform();
    }

    function initPanControls() {
        const view = document.getElementById('viewport');

        const onStart = (e) => {
            isPanning = true;
            hasMoved = false;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startPan = { x: clientX, y: clientY };
            lastMapPos = { ...state.mapPos };
        };

        const onMove = (e) => {
            if (!isPanning) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const dx = (clientX - startPan.x) / state.zoom;
            const dy = (clientY - startPan.y) / state.zoom;
            
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) hasMoved = true;
            
            state.mapPos.x = lastMapPos.x + dx;
            state.mapPos.y = lastMapPos.y + dy;
            
            // Constrain map movement (approximate)
            const limit = 2400;
            state.mapPos.x = Math.max(-limit, Math.min(0, state.mapPos.x));
            state.mapPos.y = Math.max(-limit, Math.min(0, state.mapPos.y));
            
            applyMapTransform();
        };

        const onEnd = () => { isPanning = false; };

        view.addEventListener('mousedown', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
        
        view.addEventListener('touchstart', onStart, { passive: false });
        window.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('touchend', onEnd);
    }

    function saveGame() { localStorage.setItem('starwar_save_v6', JSON.stringify(state)); }

    function loadGame() {
        const saved = localStorage.getItem('starwar_save_v6');
        if (saved) { 
            state = JSON.parse(saved); 
            renderBuildings(); 
            applyMapTransform();
        } else { 
            placeBuilding(15, 15, 'palace', true); 
            centerOnPalace();
        }
    }

    function resetGame() { localStorage.removeItem('starwar_save_v6'); location.reload(); }

    function showForeignToast(x, y) {
        const cs = CONFIG.CELL_SIZE;
        const toast = document.createElement('div');
        toast.className = 'foreign-toast';
        toast.innerText = 'FOREIGN SOIL';
        toast.style.left = (x * cs) + 'px';
        toast.style.top = (y * cs) + 'px';
        document.getElementById('city-grid-container').appendChild(toast);
        setTimeout(() => toast.remove(), 1500);
    }

    function initGrid() {
        const grid = document.getElementById('city-grid-container');
        const cs = CONFIG.CELL_SIZE;

        document.getElementById('p-border').style = `left: ${10*cs}px; top: ${10*cs}px; width: ${10*cs}px; height: ${10*cs}px;`;
        document.getElementById('n-border-1').style = `left: 0; top: ${10*cs}px; width: 9*cs; height: 10*cs;`;
        document.getElementById('n-border-2').style = `left: ${21*cs}px; top: ${10*cs}px; width: 10*cs; height: 10*cs;`;

        for (let y = 0; y < CONFIG.GRID_SIZE; y++) {
            for (let x = 0; x < CONFIG.GRID_SIZE; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.left = (x * cs) + 'px';
                cell.style.top = (y * cs) + 'px';
                const inZone = x >= 10 && x < 20 && y >= 10 && y < 20;
                if (!inZone) cell.classList.add('out-of-bounds');
                
                cell.onclick = (e) => {
                    if (hasMoved) return; // Don't click while dragging
                    handleCellClick(x, y, inZone);
                };
                grid.appendChild(cell);
            }
        }
        updateBuildMenu();
        updateTaskList();
        updateUI();
        initPanControls();
    }

    function handleCellClick(x, y, inZone) {
        if (!inZone) { 
            showForeignToast(x, y);
            state.tension = Math.min(100, state.tension + 2);
            triggerNarrator("Your scouts were spotted in foreign territory. Tension is increasing."); 
            updateUI();
            return; 
        }
        if (state.currentSelected) {
            placeBuilding(x, y, state.currentSelected);
        }
    }

    function placeBuilding(x, y, type, free = false) {
        const data = CONFIG.BUILDINGS[type];
        if (!free && state.money < data.cost) { triggerNarrator("Insufficient funds for this construction."); return; }
        if (state.buildings.some(b => b.x === x && b.y === y)) return;

        if (!free) state.money -= data.cost;
        const bObj = { x, y, type };
        state.buildings.push(bObj);
        renderBuilding(bObj);
        
        if (data.pop) state.pop += data.pop;
        if (data.power) state.power += data.power;
        state.xp += data.xp;
        
        checkTasks();
        checkLevel();
        updateUI();
        saveGame();
    }

    function renderBuilding(b) {
        const data = CONFIG.BUILDINGS[b.type];
        const cs = CONFIG.CELL_SIZE;
        const cell = document.querySelector(`.cell[style*="left: ${b.x * cs}px"][style*="top: ${b.y * cs}px"]`);
        if(cell) {
            cell.className = `cell building ${data.class}`;
            cell.innerHTML = `<span class="building-icon">${data.icon}</span>`;
        }
    }

    function renderBuildings() { state.buildings.forEach(renderBuilding); }

    function checkLevel() {
        const nextXp = state.level * CONFIG.XP_STEP;
        if (state.xp >= nextXp) {
            state.level++;
            state.money += (state.level * 5000);
            triggerNarrator(`National Level ${state.level} achieved! Grants issued.`);
            updateBuildMenu();
        }
    }

    function checkTasks() {
        CONFIG.TASKS.forEach(task => {
            if (state.completedTasks.includes(task.id)) return;
            const count = state.buildings.filter(b => b.type === task.type).length;
            if (count >= task.count) {
                state.completedTasks.push(task.id);
                state.money += task.reward;
                triggerNarrator(`Task Complete: ${task.title}. Reward: $${task.reward}.`);
                updateTaskList();
            }
        });
    }

    function updateBuildMenu() {
        const menu = document.getElementById('build-menu');
        menu.innerHTML = '';
        Object.entries(CONFIG.BUILDINGS).forEach(([id, data]) => {
            if (id === 'palace' && state.buildings.some(b => b.type === 'palace')) return;
            const isLocked = data.lvl && state.level < data.lvl;
            const btn = document.createElement('button');
            const isSelected = state.currentSelected === id;
            btn.className = `shrink-0 w-28 md:w-full p-2 mb-2 rounded-lg text-left transition-all ${isLocked ? 'opacity-20 grayscale cursor-not-allowed' : 'bg-white/5 border border-white/10'} ${isSelected ? 'border-accent ring-1 ring-accent' : ''}`;
            btn.innerHTML = `
                <div class="flex justify-between items-center text-[9px] font-bold">
                    <span>${data.icon} ${id.toUpperCase()}</span>
                    ${isLocked ? `<span class="text-[7px]">LVL ${data.lvl}</span>` : ''}
                </div>
                <p class="text-[8px] text-emerald-400">$${data.cost}</p>
            `;
            btn.onclick = (e) => {
                e.stopPropagation();
                if (isLocked) return;
                state.currentSelected = state.currentSelected === id ? null : id;
                updateBuildMenu();
            };
            menu.appendChild(btn);
        });
    }

    function updateTaskList() {
        const list = document.getElementById('task-list');
        list.innerHTML = '';
        CONFIG.TASKS.forEach(task => {
            const isDone = state.completedTasks.includes(task.id);
            const count = state.buildings.filter(b => b.type === task.type).length;
            const item = document.createElement('div');
            item.className = `task-item p-2 rounded-md ${isDone ? 'complete' : ''}`;
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="text-[9px] orbitron text-white">${task.title}</span>
                    <span class="text-[8px] text-gray-400">${isDone ? 'DONE' : `${count}/${task.count}`}</span>
                </div>
                <p class="text-[8px] text-gray-500 mt-1">${task.goal}</p>
            `;
            list.appendChild(item);
        });
    }

    function updateUI() {
        document.getElementById('res-money').innerText = `$${Math.floor(state.money)}`;
        document.getElementById('res-pop').innerText = state.pop.toLocaleString();
        document.getElementById('res-power').innerText = state.power.toLocaleString();
        document.getElementById('level-display').innerText = `LVL ${state.level}`;
        document.getElementById('tension-level').innerText = `TENSION: ${Math.floor(state.tension)}%`;
        
        const prevLevelXp = (state.level - 1) * CONFIG.XP_STEP;
        const currentProgress = state.xp - prevLevelXp;
        const xpPerc = Math.min(100, (currentProgress / CONFIG.XP_STEP) * 100);
        document.getElementById('level-bar').style.width = `${xpPerc}%`;
    }

    function triggerNarrator(text) { document.getElementById('narrator-text').innerText = text; }

    setInterval(() => {
        const factories = state.buildings.filter(b => b.type === 'factory').length;
        state.money += (factories * 50) + (state.pop * 0.5);
        if (state.tension > 0) state.tension = Math.max(0, state.tension - 0.1);
        updateUI();
    }, 2000);

    window.onload = () => { initGrid(); loadGame(); };
</script>

</body>
</html>

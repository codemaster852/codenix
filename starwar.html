<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StarWar: New Genesis - Global Conflict</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --bg-deep: #020406;
            --panel-bg: rgba(10, 14, 20, 0.98);
            --accent: #00f2ff;
            --danger: #ff3e3e;
            --army-gold: #fbbf24;
            --success: #10b981;
        }

        body {
            background-color: var(--bg-deep);
            color: #e6edf3;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
            user-select: none;
            width: 100vw;
            height: 100vh;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        #city-grid-container {
            width: 4000px;
            height: 4000px;
            background: 
                radial-gradient(circle at 50% 50%, #0a0d14 0%, #020406 100%),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 100% 100%, 60px 60px, 60px 60px;
            position: absolute;
            transform-origin: 0 0;
        }

        .cell {
            width: 60px;
            height: 60px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.4s;
            z-index: 5;
        }

        /* Dynamic Ownership Colors */
        .player-soil { background: rgba(0, 242, 255, 0.08); border: 0.5px solid rgba(0, 242, 255, 0.2); }
        .ai1-soil { background: rgba(255, 62, 62, 0.15); border: 0.5px solid rgba(255, 62, 62, 0.3); }
        .ai2-soil { background: rgba(168, 85, 247, 0.15); border: 0.5px solid rgba(168, 85, 247, 0.3); }
        .ai3-soil { background: rgba(34, 197, 94, 0.15); border: 0.5px solid rgba(34, 197, 94, 0.3); }
        .ai4-soil { background: rgba(234, 179, 8, 0.15); border: 0.5px solid rgba(234, 179, 8, 0.3); }

        .unit {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            position: absolute;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255,255,255,0.8);
        }
        .unit-player { background: var(--accent); box-shadow: 0 0 15px var(--accent); color: #000; }
        .unit-enemy { background: var(--danger); box-shadow: 0 0 15px var(--danger); color: #fff; }
        .unit.selected { ring: 4px solid #fff; transform: scale(1.1) translateY(-5px); z-index: 100; }

        .b-sam { background: #1e293b; border: 2px solid #ef4444; border-radius: 50%; animation: scan 4s linear infinite; }
        @keyframes scan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div id="game-container" class="w-screen h-screen flex flex-col relative overflow-hidden">
    
    <!-- TOP HUD -->
    <div class="hud-top glass-panel flex items-center justify-between px-6 py-4 z-50">
        <div class="flex flex-col">
            <h1 class="orbitron text-accent text-2xl font-black tracking-tighter leading-none">WAR GENESIS</h1>
            <p id="war-status" class="text-[9px] orbitron text-gray-400 mt-1 uppercase">Peace Protocol Active</p>
        </div>

        <div class="flex gap-4">
            <div class="stat-card flex flex-col items-center min-w-[100px]">
                <span class="text-[8px] text-gray-500 uppercase font-bold">Treasury</span>
                <span id="res-money" class="text-emerald-400 font-bold orbitron text-lg">$0</span>
            </div>
            <div class="stat-card flex flex-col items-center min-w-[100px]">
                <span class="text-[8px] text-gray-500 uppercase font-bold">Global Rank</span>
                <span id="res-rank" class="text-indigo-400 font-bold orbitron text-lg">E-1</span>
            </div>
            <div class="stat-card flex flex-col items-center min-w-[100px]">
                <span class="text-[8px] text-gray-500 uppercase font-bold">Active Armies</span>
                <span id="res-units" class="text-amber-400 font-bold orbitron text-lg">0</span>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="saveGame()" class="p-2 bg-white/5 border border-white/10 rounded-lg text-[10px] orbitron hover:bg-white/20 transition-all">SAVE</button>
            <button onclick="resetGame()" class="p-2 bg-red-500/10 border border-red-500/20 rounded-lg text-[10px] orbitron hover:bg-red-500/40 transition-all">PURGE</button>
        </div>
    </div>

    <!-- MAIN VIEWPORT -->
    <div id="viewport">
        <div id="city-grid-container"></div>
    </div>

    <!-- UI PANELS -->
    <div class="absolute bottom-6 left-6 z-50 flex flex-col gap-4 pointer-events-none w-72">
        <div class="glass-panel p-4 rounded-2xl pointer-events-auto shadow-2xl">
            <p class="text-[10px] text-accent font-bold orbitron mb-3 tracking-widest">INFRASTRUCTURE</p>
            <div id="build-menu" class="grid grid-cols-2 gap-2"></div>
        </div>
        
        <div class="glass-panel p-4 rounded-2xl pointer-events-auto shadow-2xl">
            <p class="text-[10px] text-red-500 font-bold orbitron mb-3 tracking-widest">TACTICAL LOG</p>
            <div id="log" class="text-[10px] h-28 overflow-y-auto text-gray-400 font-mono space-y-1">
                <p class="text-accent">> Initializing Global Satellite...</p>
            </div>
        </div>
    </div>

    <!-- SELECTION OVERLAY -->
    <div id="selection-panel" class="hidden absolute top-28 right-8 w-60 glass-panel p-5 rounded-2xl z-50 border-r-8 border-accent">
        <div class="flex items-center gap-3 mb-4">
            <div id="sel-icon" class="text-3xl"></div>
            <div>
                <p id="sel-title" class="orbitron text-sm font-bold text-white uppercase"></p>
                <p id="sel-stats" class="text-[10px] text-accent font-mono"></p>
            </div>
        </div>
        <div id="selection-actions" class="space-y-2">
            <!-- Dynamic buttons based on selection -->
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        GRID_SIZE: 60,
        CELL_SIZE: 60,
        TYPES: {
            palace:   { cost: 0, icon: 'üèõÔ∏è', class: 'bg-amber-500 shadow-[0_0_30px_rgba(245,158,11,0.5)]', desc: 'Central Command' },
            barracks: { cost: 5000, icon: 'üéñÔ∏è', class: 'bg-slate-700 border-2 border-accent', desc: 'Unit Production' },
            factory:  { cost: 3500, icon: 'üè≠', class: 'bg-zinc-800 border-t-4 border-orange-500', income: 600, desc: 'Heavy Industry' },
            sam:      { cost: 8000, icon: 'üöÄ', class: 'b-sam', desc: 'Air Defense', damage: 30 },
            uplink:   { cost: 15000, icon: 'üì°', class: 'bg-indigo-900 border-2 border-indigo-400', income: 1500, power: 50, desc: 'Intel Center' }
        }
    };

    let state = {
        money: 8000,
        techLevel: 1,
        territory: [], // {x, y, owner: 'player'|'ai1'|'ai2'|'ai3'|'ai4'}
        buildings: [], // {x, y, type}
        units: [],     // {id, x, y, owner: 'player'|'ai1'..., power, veterancy}
        nations: {
            'player': { color: 'var(--accent)', name: 'United Terra' },
            'ai1': { color: '#ff3e3e', name: 'Sino-Red Alliance', mood: 'Wary' },
            'ai2': { color: '#a855f7', name: 'Void Republic', mood: 'Neutral' },
            'ai3': { color: '#22c55e', name: 'Emerald Union', mood: 'Wary' },
            'ai4': { color: '#eab308', name: 'Golden Horde', mood: 'Aggressive' }
        },
        selectedId: null,
        activeBuild: null,
        mapPos: { x: -600, y: -600 },
        zoom: 0.9
    };

    function init() {
        const grid = document.getElementById('city-grid-container');
        
        // Spawn Nations in different corners
        for (let x = 0; x < CONFIG.GRID_SIZE; x++) {
            for (let y = 0; y < CONFIG.GRID_SIZE; y++) {
                let owner = null;
                if (x >= 25 && x < 35 && y >= 25 && y < 35) owner = 'player';
                else if (x < 8 && y < 8) owner = 'ai1';
                else if (x > 52 && y < 8) owner = 'ai2';
                else if (x < 8 && y > 52) owner = 'ai3';
                else if (x > 52 && y > 52) owner = 'ai4';
                
                if (owner) state.territory.push({ x, y, owner });

                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${x}-${y}`;
                cell.style.left = (x * CONFIG.CELL_SIZE) + 'px';
                cell.style.top = (y * CONFIG.CELL_SIZE) + 'px';
                cell.onclick = () => handleCellClick(x, y);
                grid.appendChild(cell);
            }
        }

        addBuilding(30, 30, 'palace', true);
        applyTransform();
        updateBuildMenu();
        renderAll();
        
        // Game Loops
        setInterval(economyLoop, 2000);
        setInterval(aiLogicLoop, 4000);
        setInterval(defenseLoop, 1500);
    }

    function handleCellClick(x, y) {
        if (state.activeBuild) {
            const soil = state.territory.find(t => t.x === x && t.y === y);
            if (soil && soil.owner === 'player') {
                addBuilding(x, y, state.activeBuild);
                state.activeBuild = null;
            } else {
                addLog("OUTSIDE JURISDICTION", "text-red-400");
            }
            return;
        }

        // Unit Selection
        const unit = state.units.find(u => u.x === x && u.y === y && u.owner === 'player');
        if (unit) {
            state.selectedId = unit.id;
            showSelectionPanel('ARMY', `POWER: ${unit.power.toFixed(0)}`, 'üéñÔ∏è', unit);
            renderAll();
            return;
        }

        // Movement/Attack Command
        if (state.selectedId) {
            const myUnit = state.units.find(u => u.id === state.selectedId);
            const dist = Math.abs(myUnit.x - x) + Math.abs(myUnit.y - y);
            if (dist === 1) {
                moveUnit(myUnit, x, y);
                return;
            }
        }

        // Building Interaction
        const b = state.buildings.find(b => b.x === x && b.y === y);
        if (b) {
            const cfg = CONFIG.TYPES[b.type];
            showSelectionPanel(b.type, cfg.desc, cfg.icon, b);
            return;
        }

        hideSelectionPanel();
    }

    function addBuilding(x, y, type, free = false) {
        const cfg = CONFIG.TYPES[type];
        if (!free && state.money < cfg.cost) { addLog("INSUFFICIENT FUNDS"); return; }
        if (state.buildings.some(b => b.x === x && b.y === y)) return;

        if (!free) state.money -= cfg.cost;
        state.buildings.push({ x, y, type });
        addLog(`CONSTRUCTION COMPLETE: ${type.toUpperCase()}`, "text-green-400");
        renderAll();
        updateUI();
    }

    function moveUnit(unit, nx, ny) {
        unit.x = nx;
        unit.y = ny;

        // Check Soil Ownership Change
        const soil = state.territory.find(t => t.x === nx && t.y === ny);
        if (soil) {
            if (soil.owner !== unit.owner) {
                const victim = state.nations[soil.owner];
                soil.owner = unit.owner;
                if (unit.owner === 'player') {
                    state.money += 250;
                    addLog(`ANNEXED TERRITORY: ${victim.name} lost soil.`, "text-cyan-400");
                }
            }
        } else {
            // New discovery
            state.territory.push({ x: nx, y: ny, owner: unit.owner });
        }

        // Combat Collision
        const enemies = state.units.filter(u => u.x === nx && u.y === ny && u.owner !== unit.owner);
        enemies.forEach(enemy => resolveCombat(unit, enemy));

        renderAll();
    }

    function resolveCombat(u1, u2) {
        addLog(`ENGAGEMENT: [${u1.x},${u1.y}]`, "text-orange-500 font-bold");
        const u1_final = u1.power * (1 + (u1.veterancy || 0) * 0.1);
        const u2_final = u2.power * (1 + (u2.veterancy || 0) * 0.1);

        if (u1_final >= u2_final) {
            state.units = state.units.filter(u => u.id !== u2.id);
            u1.veterancy = (u1.veterancy || 0) + 1;
            u1.power -= 20;
        } else {
            state.units = state.units.filter(u => u.id !== u1.id);
            u2.veterancy = (u2.veterancy || 0) + 1;
            u2.power -= 20;
        }
    }

    function defenseLoop() {
        // SAM Batteries fire at nearby enemies
        state.buildings.filter(b => b.type === 'sam').forEach(sam => {
            const owner = 'player'; // Player SAMs
            const enemies = state.units.filter(u => u.owner !== owner && Math.abs(u.x - sam.x) <= 2 && Math.abs(u.y - sam.y) <= 2);
            enemies.forEach(e => {
                e.power -= CONFIG.TYPES.sam.damage;
                if (e.power <= 0) {
                    state.units = state.units.filter(u => u.id !== e.id);
                    addLog("AIR DEFENSE: Enemy unit neutralized.", "text-red-500");
                }
            });
        });
    }

    function aiLogicLoop() {
        ['ai1', 'ai2', 'ai3', 'ai4'].forEach(aiId => {
            const nation = state.nations[aiId];
            const mySoil = state.territory.filter(t => t.owner === aiId);
            if (mySoil.length === 0) return;

            // 1. Spawning
            if (Math.random() > 0.6) {
                const spawn = mySoil[Math.floor(Math.random() * mySoil.length)];
                state.units.push({
                    id: Math.random(),
                    x: spawn.x, y: spawn.y,
                    owner: aiId,
                    power: 80 + (state.techLevel * 20),
                    veterancy: 0
                });
            }

            // 2. Movement & Conquest
            state.units.filter(u => u.owner === aiId).forEach(u => {
                // Find nearest player building or soil
                const target = state.buildings[0] || { x: 30, y: 30 };
                const dx = Math.sign(target.x - u.x);
                const dy = Math.sign(target.y - u.y);

                // Move closer to player, but explore a bit
                let nx = u.x + (Math.random() > 0.3 ? dx : (Math.random() > 0.5 ? 1 : -1));
                let ny = u.y + (Math.random() > 0.3 ? dy : (Math.random() > 0.5 ? 1 : -1));

                // Constrain
                nx = Math.max(0, Math.min(CONFIG.GRID_SIZE - 1, nx));
                ny = Math.max(0, Math.min(CONFIG.GRID_SIZE - 1, ny));
                
                moveUnit(u, nx, ny);
            });
        });
    }

    function economyLoop() {
        let passiveIncome = state.territory.filter(t => t.owner === 'player').length * 5;
        state.buildings.forEach(b => {
            const cfg = CONFIG.TYPES[b.type];
            if (cfg.income) passiveIncome += (cfg.income / 10);
        });
        state.money += passiveIncome;
        updateUI();
    }

    function renderAll() {
        // Render Soil
        state.territory.forEach(t => {
            const cell = document.getElementById(`cell-${t.x}-${t.y}`);
            if (cell) cell.className = `cell ${t.owner}-soil`;
        });

        // Render Buildings
        state.buildings.forEach(b => {
            const cell = document.getElementById(`cell-${b.x}-${b.y}`);
            if (cell) {
                const cfg = CONFIG.TYPES[b.type];
                cell.innerHTML = `<span class="text-3xl drop-shadow-md">${cfg.icon}</span>`;
                cell.className = `cell ${cfg.class} ${b.owner || 'player'}-soil`;
            }
        });

        // Render Units
        document.querySelectorAll('.unit').forEach(u => u.remove());
        const grid = document.getElementById('city-grid-container');
        state.units.forEach(u => {
            const el = document.createElement('div');
            el.className = `unit unit-${u.owner === 'player' ? 'player' : 'enemy'} ${state.selectedId === u.id ? 'selected' : ''}`;
            el.style.left = (u.x * CONFIG.CELL_SIZE + 8) + 'px';
            el.style.top = (u.y * CONFIG.CELL_SIZE + 8) + 'px';
            el.innerHTML = u.owner === 'player' ? 'üéñÔ∏è' : 'üíÄ';
            
            if (u.veterancy > 0) {
                const rank = document.createElement('span');
                rank.className = "absolute -top-2 -right-2 bg-white text-black text-[8px] px-1 rounded border border-black";
                rank.innerText = u.veterancy;
                el.appendChild(rank);
            }

            el.onclick = (e) => {
                e.stopPropagation();
                handleCellClick(u.x, u.y);
            };
            grid.appendChild(el);
        });
    }

    function showSelectionPanel(title, stats, icon, ref) {
        const p = document.getElementById('selection-panel');
        p.classList.remove('hidden');
        document.getElementById('sel-title').innerText = title;
        document.getElementById('sel-stats').innerText = stats;
        document.getElementById('sel-icon').innerText = icon;
        
        const actions = document.getElementById('selection-actions');
        actions.innerHTML = '';
        
        if (title === 'barracks') {
            const btn = document.createElement('button');
            btn.className = "w-full py-3 bg-accent text-black orbitron text-[10px] font-black rounded-xl hover:scale-95 transition-transform";
            btn.innerText = "TRAIN ARMY ($3000)";
            btn.onclick = () => spawnPlayerUnit(ref.x, ref.y);
            actions.appendChild(btn);
        }
    }

    function spawnPlayerUnit(x, y) {
        if (state.money < 3000) return;
        state.money -= 3000;
        state.units.push({
            id: Date.now(),
            x, y,
            owner: 'player',
            power: 100 + (state.techLevel * 25),
            veterancy: 0
        });
        renderAll();
        updateUI();
    }

    function hideSelectionPanel() {
        document.getElementById('selection-panel').classList.add('hidden');
        state.selectedId = null;
        renderAll();
    }

    function updateBuildMenu() {
        const menu = document.getElementById('build-menu');
        menu.innerHTML = '';
        Object.entries(CONFIG.TYPES).forEach(([id, cfg]) => {
            if (id === 'palace') return;
            const btn = document.createElement('button');
            btn.className = "p-3 bg-white/5 border border-white/10 rounded-xl hover:bg-accent hover:text-black transition-all flex flex-col items-center pointer-events-auto";
            btn.innerHTML = `<span class="text-xl">${cfg.icon}</span><span class="text-[9px] orbitron font-bold mt-1">$${cfg.cost}</span>`;
            btn.onclick = () => {
                state.activeBuild = id;
                addLog(`TARGETING: Place ${id} on your territory.`);
            };
            menu.appendChild(btn);
        });
    }

    function updateUI() {
        document.getElementById('res-money').innerText = `$${Math.floor(state.money).toLocaleString()}`;
        document.getElementById('res-rank').innerText = `T-${state.techLevel}`;
        document.getElementById('res-units').innerText = state.units.filter(u => u.owner === 'player').length;
    }

    function addLog(msg, colorClass = "text-gray-400") {
        const log = document.getElementById('log');
        const p = document.createElement('p');
        p.className = colorClass;
        p.innerText = `> ${msg}`;
        log.prepend(p);
    }

    function applyTransform() {
        document.getElementById('city-grid-container').style.transform = `translate(${state.mapPos.x}px, ${state.mapPos.y}px) scale(${state.zoom})`;
    }

    // Camera Panning
    let isDragging = false, startX, startY;
    document.getElementById('viewport').onmousedown = (e) => {
        isDragging = true;
        startX = e.clientX - state.mapPos.x;
        startY = e.clientY - state.mapPos.y;
    };
    window.onmousemove = (e) => {
        if (!isDragging) return;
        state.mapPos.x = e.clientX - startX;
        state.mapPos.y = e.clientY - startY;
        applyTransform();
    };
    window.onmouseup = () => isDragging = false;

    function saveGame() { localStorage.setItem('war_genesis_v1', JSON.stringify(state)); addLog("SYSTEM STATE STORED"); }
    function resetGame() { localStorage.removeItem('war_genesis_v1'); location.reload(); }

    window.onload = init;
</script>

</body>
</html>

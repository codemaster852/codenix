<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheckerGen | Nix AI Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-dark: #09090b;
            --accent: #6366f1;
            --glass: rgba(24, 24, 27, 0.8);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark);
            color: #fafafa;
            margin: 0;
        }

        .dot-grid { 
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px); 
            background-size: 24px 24px; 
        }

        /* Checkerboard Styling */
        .checker-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 520px;
            border: 12px solid #18181b;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 20px 50px -12px rgba(0, 0, 0, 0.8);
        }

        .square {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .square.dark-sq { background-color: #0c0c0e; }
        .square.light-sq { background-color: #1a1a1e; }

        /* Pieces */
        .piece {
            width: 82%;
            height: 82%;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 -4px 6px rgba(0,0,0,0.4), 0 4px 10px rgba(0,0,0,0.5);
        }

        .piece::before {
            content: '';
            position: absolute;
            inset: 15%;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .piece.red { background: linear-gradient(145deg, #f43f5e, #881337); }
        .piece.black { background: linear-gradient(145deg, #4f46e5, #1e1b4b); }
        
        .piece.king::after {
            content: 'K';
            color: rgba(255, 255, 255, 0.9);
            font-weight: 900;
            font-size: 1.1rem;
        }

        .piece.selected {
            transform: scale(1.1) translateY(-4px);
            box-shadow: 0 15px 25px -5px rgba(99, 102, 241, 0.4);
            outline: 3px solid rgba(99, 102, 241, 0.5);
        }

        .valid-move::before {
            content: '';
            width: 14px;
            height: 14px;
            background-color: rgba(99, 102, 241, 0.5);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.8);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body class="overflow-hidden h-screen selection:bg-indigo-500/30">
    <div class="flex h-full w-full">
        <!-- Professional Sidebar -->
        <aside class="w-80 border-r border-zinc-800 hidden lg:flex flex-col bg-zinc-950 transition-colors">
            <div class="p-6 border-b border-zinc-800 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <i data-lucide="cpu" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-sm tracking-tight text-white leading-tight">CheckerGen</h1>
                        <p class="text-[10px] text-zinc-500 font-medium tracking-wider uppercase">Nix AI Studio</p>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 p-5 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Level Selector -->
                <div>
                    <header class="flex items-center gap-2 mb-4">
                        <i data-lucide="layers" class="w-3.5 h-3.5 text-zinc-500"></i>
                        <label class="text-[10px] uppercase tracking-[0.15em] text-zinc-500 font-bold">Difficulty Engine</label>
                    </header>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="setLevel(1)" class="level-btn group relative p-3 rounded-xl border border-zinc-800 bg-zinc-900/40 text-left transition-all hover:bg-zinc-800" data-level="1">
                            <span class="text-xs font-semibold text-zinc-400 group-hover:text-white">Novice Engine</span>
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-zinc-600 font-mono">01</span>
                        </button>
                        <button onclick="setLevel(2)" class="level-btn group relative p-3 rounded-xl border border-zinc-800 bg-zinc-900/40 text-left transition-all hover:bg-zinc-800" data-level="2">
                            <span class="text-xs font-semibold text-zinc-400 group-hover:text-white">Advanced Tactical</span>
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-zinc-600 font-mono">02</span>
                        </button>
                        <button onclick="setLevel(3)" class="level-btn group relative p-3 rounded-xl border-indigo-500/40 bg-indigo-500/10 text-left transition-all" data-level="3">
                            <span class="text-xs font-semibold text-white">Deep Blue Gen</span>
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-indigo-400 font-mono">03</span>
                        </button>
                    </div>
                </div>

                <!-- History -->
                <div>
                    <header class="flex items-center gap-2 mb-4">
                        <i data-lucide="activity" class="w-3.5 h-3.5 text-zinc-500"></i>
                        <label class="text-[10px] uppercase tracking-[0.15em] text-zinc-500 font-bold">Analysis Log</label>
                    </header>
                    <div id="move-history" class="space-y-1.5 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar font-mono text-[11px]">
                        <!-- History injected here -->
                    </div>
                </div>
            </div>

            <!-- Profile Footer -->
            <div class="p-4 border-t border-zinc-800 bg-zinc-950/80 backdrop-blur-md">
                <div class="flex items-center gap-3 p-3 rounded-xl bg-zinc-900/50 border border-zinc-800/50">
                    <div id="user-avatar" class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white text-xs font-bold shadow-inner">?</div>
                    <div class="flex-1 min-w-0">
                        <div id="user-display-name" class="text-xs font-bold truncate text-zinc-200">Session User</div>
                        <div class="text-[9px] text-zinc-500 uppercase tracking-tighter">Verified Studio Member</div>
                    </div>
                    <button id="logout-btn" class="p-1.5 text-zinc-500 hover:text-white transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Stage -->
        <main class="flex-1 flex flex-col relative dot-grid bg-zinc-950" id="main-content">
            <!-- Glass Header -->
            <header class="h-16 border-b border-zinc-800/50 flex items-center justify-between px-8 backdrop-blur-2xl z-40 bg-zinc-950/60 sticky top-0">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-zinc-900 border border-zinc-800">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        <span class="text-[11px] font-bold text-zinc-300 uppercase tracking-widest" id="turn-indicator">System Ready</span>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="resetGame()" class="flex items-center gap-2 text-[10px] uppercase font-bold tracking-widest border border-zinc-800 bg-zinc-900 text-zinc-400 px-4 py-2 rounded-lg hover:text-white hover:border-zinc-700 transition-all">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        Restart
                    </button>
                    <button onclick="window.location.href='portal.html'" class="flex items-center gap-2 text-[10px] uppercase font-bold tracking-widest bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-500 shadow-lg shadow-indigo-600/20 transition-all">
                        <i data-lucide="layout-grid" class="w-3 h-3"></i>
                        Portal
                    </button>
                </div>
            </header>

            <!-- Board Area -->
            <div class="flex-1 flex flex-col items-center justify-center p-8">
                <div class="checker-board" id="board">
                    <!-- JS Grid -->
                </div>
                
                <!-- Performance Stats -->
                <div class="mt-12 flex gap-20">
                    <div class="text-center group">
                        <div class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-2 font-bold group-hover:text-indigo-400 transition-colors">Player Score</div>
                        <div class="text-4xl font-bold text-zinc-200 tabular-nums" id="player-score">12</div>
                    </div>
                    <div class="text-center group">
                        <div class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-2 font-bold group-hover:text-rose-400 transition-colors">Engine Score</div>
                        <div class="text-4xl font-bold text-zinc-200 tabular-nums" id="ai-score">12</div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Navigation (Overlay) -->
            <div class="lg:hidden absolute bottom-6 left-1/2 -translate-x-1/2 bg-zinc-900/90 border border-zinc-800 px-6 py-3 rounded-2xl backdrop-blur-xl flex gap-8 items-center shadow-2xl z-50">
                <i data-lucide="menu" class="w-5 h-5 text-zinc-400"></i>
                <i data-lucide="bar-chart-2" class="w-5 h-5 text-zinc-400"></i>
                <i data-lucide="settings" class="w-5 h-5 text-zinc-400"></i>
            </div>
        </main>
    </div>

    <script>
        // Use a unique name for the client to avoid clashing with the global 'supabase' object from the script tag
        const SUPABASE_API_URL = "https://rnlwrngfgvznndlekmrz.supabase.co";
        const SUPABASE_API_KEY = "sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt";
        
        let supabaseSvc;
        try {
            supabaseSvc = window.supabase.createClient(SUPABASE_API_URL, SUPABASE_API_KEY);
        } catch (e) {
            console.error("Supabase init error:", e);
        }

        // Game State
        let boardState = [];
        let selectedPiece = null;
        let turn = 'black'; // Black = User, Red = AI
        let currentLevel = 3;
        let gameOver = false;

        // Security Check & User Display
        async function checkAuth() {
            if (!supabaseSvc) return;
            
            const { data: { session }, error } = await supabaseSvc.auth.getSession();
            if (error || !session) {
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `auth.html?redirect=${returnUrl}`;
                return;
            }
            
            // Populate Profile
            const user = session.user;
            document.getElementById('user-display-name').innerText = user.email.split('@')[0];
            document.getElementById('user-avatar').innerText = user.email[0].toUpperCase();
            
            // Update turn indicator
            document.getElementById('turn-indicator').innerText = 'Your Move';
        }

        // Logout
        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            if (supabaseSvc) {
                await supabaseSvc.auth.signOut();
                window.location.href = 'auth.html';
            }
        });

        function setLevel(lvl) {
            currentLevel = lvl;
            document.querySelectorAll('.level-btn').forEach(btn => {
                const isActive = parseInt(btn.dataset.level) === lvl;
                if(isActive) {
                    btn.className = "level-btn group relative p-3 rounded-xl border-indigo-500/40 bg-indigo-500/10 text-left transition-all";
                    const span = btn.querySelector('span');
                    if (span) span.className = "text-xs font-semibold text-white";
                } else {
                    btn.className = "level-btn group relative p-3 rounded-xl border border-zinc-800 bg-zinc-900/40 text-left transition-all hover:bg-zinc-800";
                    const span = btn.querySelector('span');
                    if (span) span.className = "text-xs font-semibold text-zinc-400 group-hover:text-white";
                }
            });
        }

        function initBoard() {
            boardState = Array(8).fill(null).map(() => Array(8).fill(null));
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 8; c++) {
                    if ((r + c) % 2 !== 0) boardState[r][c] = { color: 'red', king: false };
                }
            }
            for (let r = 5; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if ((r + c) % 2 !== 0) boardState[r][c] = { color: 'black', king: false };
                }
            }
            renderBoard();
        }

        function renderBoard() {
            const boardEl = document.getElementById('board');
            if (!boardEl) return;
            boardEl.innerHTML = '';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const sq = document.createElement('div');
                    sq.className = `square ${(r + c) % 2 === 0 ? 'light-sq' : 'dark-sq'}`;
                    
                    if (boardState[r][c]) {
                        const piece = document.createElement('div');
                        piece.className = `piece ${boardState[r][c].color} ${boardState[r][c].king ? 'king' : ''}`;
                        if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) {
                            piece.classList.add('selected');
                        }
                        piece.onclick = () => handlePieceClick(r, c);
                        sq.appendChild(piece);
                    } else if (selectedPiece) {
                        const moves = getValidMoves(selectedPiece.r, selectedPiece.c);
                        if (moves.some(m => m.r === r && m.c === c)) {
                            sq.classList.add('valid-move');
                            sq.onclick = () => executeMove(selectedPiece.r, selectedPiece.c, r, c);
                        }
                    }
                    boardEl.appendChild(sq);
                }
            }
            updateScores();
        }

        function handlePieceClick(r, c) {
            if (gameOver || turn !== boardState[r][c].color) return;
            selectedPiece = (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) ? null : { r, c };
            renderBoard();
        }

        function getValidMoves(r, c) {
            const piece = boardState[r][c];
            if (!piece) return [];
            const moves = [];
            const dirs = piece.king ? [[1,1],[1,-1],[-1,1],[-1,-1]] : 
                         (piece.color === 'black' ? [[-1,1],[-1,-1]] : [[1,1],[1,-1]]);

            dirs.forEach(([dr, dc]) => {
                const nr = r + dr;
                const nc = c + dc;
                if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                    if (!boardState[nr][nc]) {
                        moves.push({ r: nr, c: nc });
                    } else if (boardState[nr][nc].color !== piece.color) {
                        const jr = nr + dr;
                        const jc = nc + dc;
                        if (jr >= 0 && jr < 8 && jc >= 0 && jc < 8 && !boardState[jr][jc]) {
                            moves.push({ r: jr, c: jc, jump: { r: nr, c: nc } });
                        }
                    }
                }
            });
            return moves;
        }

        function executeMove(fromR, fromC, toR, toC) {
            const moves = getValidMoves(fromR, fromC);
            const move = moves.find(m => m.r === toR && m.c === toC);
            if (!move) return;

            const piece = boardState[fromR][fromC];
            boardState[toR][toC] = piece;
            boardState[fromR][fromC] = null;

            if (move.jump) {
                boardState[move.jump.r][move.jump.c] = null;
            }

            if ((turn === 'black' && toR === 0) || (turn === 'red' && toR === 7)) {
                piece.king = true;
            }

            addToHistory(fromR, fromC, toR, toC, turn);
            selectedPiece = null;
            turn = turn === 'black' ? 'red' : 'black';
            
            const indicator = document.getElementById('turn-indicator');
            if (indicator) indicator.innerText = turn === 'black' ? 'Your Move' : 'AI Computing...';
            
            renderBoard();
            
            if (turn === 'red' && !gameOver) {
                setTimeout(aiMove, 600);
            }
        }

        function aiMove() {
            let allMoves = [];
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (boardState[r][c] && boardState[r][c].color === 'red') {
                        const moves = getValidMoves(r, c);
                        moves.forEach(m => allMoves.push({ fromR: r, fromC: c, ...m }));
                    }
                }
            }

            if (allMoves.length === 0) {
                endGame('User Victors');
                return;
            }

            let selectedMove;
            const jumps = allMoves.filter(m => m.jump);
            
            if (currentLevel >= 2 && jumps.length > 0) {
                selectedMove = jumps[Math.floor(Math.random() * jumps.length)];
            } else {
                selectedMove = allMoves[Math.floor(Math.random() * allMoves.length)];
            }

            executeMove(selectedMove.fromR, selectedMove.fromC, selectedMove.r, selectedMove.c);
        }

        function addToHistory(fr, fc, tr, tc, color) {
            const hist = document.getElementById('move-history');
            if (!hist) return;
            const div = document.createElement('div');
            div.className = "flex justify-between items-center p-2 rounded bg-zinc-900/40 border border-zinc-800/50 text-zinc-400 animate-in";
            div.innerHTML = `
                <span class="${color === 'black' ? 'text-indigo-400' : 'text-rose-400'} font-bold">${color.substring(0,1).toUpperCase()}</span>
                <span>${String.fromCharCode(65+fc)}${8-fr} â†’ ${String.fromCharCode(65+tc)}${8-tr}</span>
            `;
            hist.prepend(div);
        }

        function updateScores() {
            let p = 0, a = 0;
            boardState.flat().forEach(cell => {
                if (cell?.color === 'black') p++;
                if (cell?.color === 'red') a++;
            });
            const pScore = document.getElementById('player-score');
            const aScore = document.getElementById('ai-score');
            if (pScore) pScore.innerText = p;
            if (aScore) aScore.innerText = a;
            
            if (p === 0) endGame('AI Dominance');
            if (a === 0) endGame('User Victors');
        }

        function endGame(msg) {
            gameOver = true;
            const indicator = document.getElementById('turn-indicator');
            if (indicator) {
                indicator.innerText = msg;
                indicator.parentElement.classList.remove('bg-zinc-900');
                indicator.parentElement.classList.add('bg-indigo-600/20', 'border-indigo-500/50');
            }
        }

        function resetGame() {
            gameOver = false;
            turn = 'black';
            selectedPiece = null;
            const indicator = document.getElementById('turn-indicator');
            if (indicator) indicator.innerText = 'System Ready';
            const hist = document.getElementById('move-history');
            if (hist) hist.innerHTML = '';
            initBoard();
        }

        // Run on load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initBoard();
            if (window.lucide) window.lucide.createIcons();
        });
    </script>
</body>
</html>

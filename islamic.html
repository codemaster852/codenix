<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codenix Islamic AI Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;700&display=swap');
        
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* Fixed Dark Mode Contrast */
        body.dark { background-color: #000000; color: #ffffff; }
        body:not(.dark) { background-color: #ffffff; color: #0f172a; }

        .dark .bg-card { background-color: #0a0a0a; border-color: #1a1a1a; }
        .bg-card { background-color: #f8fafc; border-color: #f1f5f9; }

        .quran-font { font-family: 'Amiri', serif; }
        .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .rtl { direction: rtl; }
        .ltr { direction: ltr; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-content.hidden { display: none; }
        .nav-btn.active { background-color: #8b5cf6; color: white; box-shadow: 0 10px 15px -3px rgba(139, 92, 246, 0.4); }

        /* Smooth Settings Dropdown */
        #settings-menu {
            transform-origin: top right;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .ayah-card:hover { border-color: #8b5cf6; transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden dark" id="body">

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/80 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-[#050505] border-r border-slate-100 dark:border-zinc-900 z-50 sidebar-transition -translate-x-full lg:translate-x-0">
        <div class="p-6 flex flex-col h-full">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-purple-600/30">CX</div>
                <span class="text-xl font-bold tracking-tight dark:text-white text-slate-900">AI <span class="text-purple-500">Studio</span></span>
            </div>

            <nav class="flex-1 space-y-1.5 overflow-y-auto">
                <button onclick="switchTab('quran')" class="nav-btn active w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all" data-tab="quran">
                    <i class="fa-solid fa-book-quran"></i> <span data-i18n="quran">Quran</span>
                </button>
                <button onclick="switchTab('hadith')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all dark:text-zinc-400 text-slate-600 hover:bg-purple-50 dark:hover:bg-purple-950/20" data-tab="hadith">
                    <i class="fa-solid fa-mosque"></i> <span data-i18n="hadith">Hadith</span>
                </button>
                <button onclick="switchTab('prayer')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all dark:text-zinc-400 text-slate-600 hover:bg-purple-50 dark:hover:bg-purple-950/20" data-tab="prayer">
                    <i class="fa-solid fa-clock"></i> <span data-i18n="prayerTimes">Prayer Times</span>
                </button>
                <button onclick="switchTab('qibla')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all dark:text-zinc-400 text-slate-600 hover:bg-purple-50 dark:hover:bg-purple-950/20" data-tab="qibla">
                    <i class="fa-solid fa-compass"></i> <span data-i18n="qibla">Qibla</span>
                </button>
                <button onclick="switchTab('tracker')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all dark:text-zinc-400 text-slate-600 hover:bg-purple-50 dark:hover:bg-purple-950/20" data-tab="tracker">
                    <i class="fa-solid fa-check-double"></i> <span data-i18n="tracker">Tracker</span>
                </button>
                <button onclick="switchTab('azkar')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all dark:text-zinc-400 text-slate-600 hover:bg-purple-50 dark:hover:bg-purple-950/20" data-tab="azkar">
                    <i class="fa-solid fa-beads"></i> <span data-i18n="azkar">Azkar</span>
                </button>
            </nav>

            <div class="pt-6 border-t dark:border-zinc-900">
                <a href="portal.html" class="flex items-center gap-4 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-all font-semibold">
                    <i class="fa-solid fa-house-user"></i>
                    <span data-i18n="backPortal">Back to Portal</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="lg:ml-72 min-h-screen transition-all duration-300 pb-24">
        
        <!-- Header -->
        <header class="sticky top-0 z-30 glass border-b border-slate-100 dark:border-zinc-900 px-4 md:px-8 py-4 flex items-center justify-between bg-white/80 dark:bg-black/80">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-purple-100 dark:hover:bg-purple-950/30 rounded-lg dark:text-white">
                    <i class="fa-solid fa-bars-staggered"></i>
                </button>
                <div>
                    <h2 id="page-title" class="font-bold text-lg dark:text-white text-slate-900">The Noble Quran</h2>
                    <p id="hijri-date" class="text-[10px] text-purple-500 font-bold uppercase tracking-widest">-- --- ----</p>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="toggleDarkMode()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-zinc-900 hover:bg-purple-500 hover:text-white transition-all dark:text-white">
                    <i class="fa-solid fa-moon dark:fa-sun" id="theme-icon"></i>
                </button>

                <div class="relative">
                    <button onclick="toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-zinc-900 hover:bg-purple-500 hover:text-white transition-all dark:text-white">
                        <i class="fa-solid fa-sliders"></i>
                    </button>
                    <!-- Settings Menu -->
                    <div id="settings-menu" class="absolute right-0 mt-3 w-72 bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl border border-slate-100 dark:border-zinc-800 p-5 hidden animate-in slide-in-from-top-2">
                        <h4 class="font-bold mb-4 text-purple-500 text-sm uppercase tracking-widest">Configuration</h4>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-bold opacity-50 block mb-2 uppercase">Interface Language</label>
                                <select onchange="changeLanguage(this.value)" id="lang-select" class="w-full bg-slate-50 dark:bg-black text-sm font-semibold p-2.5 rounded-xl border dark:border-zinc-800 dark:text-white">
                                    <option value="en">English</option>
                                    <option value="ar">العربية</option>
                                    <option value="ur">اردو</option>
                                    <option value="id">Bahasa Indo</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold opacity-50 block mb-2 uppercase">Manual Location</label>
                                <input type="text" id="settings-city-input" placeholder="City Name (e.g. London)..." class="w-full bg-slate-50 dark:bg-black text-sm p-2.5 rounded-xl border dark:border-zinc-800 dark:text-white outline-none focus:border-purple-500" onkeypress="if(event.key==='Enter') applySettingsLocation()">
                                <p id="location-error" class="text-[9px] text-red-500 mt-1 hidden">GPS access denied. Use manual input.</p>
                            </div>
                            <button id="gps-btn" onclick="requestLocation()" class="w-full py-2.5 bg-purple-600 text-white rounded-xl text-xs font-bold hover:bg-purple-700 transition-all shadow-lg shadow-purple-600/20">
                                <i class="fa-solid fa-location-crosshairs mr-2"></i>Detect GPS
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-4 md:p-8 max-w-6xl mx-auto space-y-8">
            
            <!-- Hero Section (Daily Inspiration) -->
            <section id="hero-inspire" class="relative overflow-hidden rounded-[2.5rem] p-8 md:p-12 bg-purple-600 text-white shadow-2xl shadow-purple-900/40">
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-8">
                    <div class="max-w-xl text-center md:text-left">
                        <span class="inline-block px-4 py-1.5 rounded-full bg-white/20 text-xs font-bold tracking-widest uppercase mb-4">Verse of the Day</span>
                        <p id="daily-ayah-ar" class="text-3xl md:text-4xl quran-font leading-relaxed mb-6">فَاذْكُرُونِي أَذْكُرْكُمْ وَاشْكُرُوا لِي وَلَا تَكْفُرُونِ</p>
                        <p id="daily-ayah-en" class="text-lg opacity-90 italic">"So remember Me; I will remember you. And be grateful to Me and do not deny Me."</p>
                    </div>
                    <div class="flex flex-col items-center bg-black/20 p-6 rounded-[2rem] backdrop-blur-md min-w-[200px]">
                        <span class="text-xs uppercase font-bold tracking-tighter opacity-70 mb-2" id="next-prayer-label">Asr In</span>
                        <h2 id="next-prayer-countdown-hero" class="text-4xl font-mono font-black">00:00:00</h2>
                    </div>
                </div>
                <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
            </section>

            <!-- Quran Tab -->
            <div id="quran-tab" class="tab-content">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h3 class="text-2xl font-bold dark:text-white">Surah Directory</h3>
                    <div class="relative w-full md:w-72">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" onkeyup="filterSurahs(this.value)" placeholder="Search Surah..." class="w-full pl-12 pr-4 py-3 rounded-2xl bg-slate-50 dark:bg-zinc-900 border border-transparent focus:border-purple-500 outline-none dark:text-white">
                    </div>
                </div>
                <div id="surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                
                <!-- Ayah View -->
                <div id="ayah-view" class="hidden space-y-6">
                    <button onclick="backToSurahs()" class="bg-purple-100 dark:bg-purple-900/30 text-purple-600 px-6 py-2.5 rounded-full font-bold flex items-center gap-2 hover:bg-purple-600 hover:text-white transition-all">
                        <i class="fa-solid fa-chevron-left"></i> <span data-i18n="back">Back to List</span>
                    </button>
                    <div id="ayahs-container" class="space-y-6"></div>
                </div>
            </div>

            <!-- Tracker Tab -->
            <div id="tracker-tab" class="tab-content hidden space-y-6">
                <div class="bg-white dark:bg-[#0a0a0a] p-8 rounded-[2.5rem] border dark:border-zinc-900 shadow-xl">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-3xl font-black dark:text-white">Daily Salawat</h2>
                            <p class="text-slate-400">Mark your prayers to maintain your streak.</p>
                        </div>
                        <div class="text-right">
                            <span id="streak-count" class="text-4xl font-black text-purple-500">0</span>
                            <p class="text-[10px] font-bold uppercase opacity-50 dark:text-zinc-500">Day Streak</p>
                        </div>
                    </div>
                    <div id="tracker-grid" class="grid grid-cols-1 sm:grid-cols-5 gap-4"></div>
                </div>
            </div>

            <!-- Prayer Tab -->
            <div id="prayer-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="prayer-cards-container"></div>
            </div>

            <!-- Qibla Tab -->
            <div id="qibla-tab" class="tab-content hidden">
                 <div class="bg-white dark:bg-[#0a0a0a] p-10 rounded-[2.5rem] flex flex-col items-center justify-center border dark:border-zinc-900 shadow-xl">
                    <h3 class="text-2xl font-bold mb-10 dark:text-white" data-i18n="qibla">Interactive Qibla</h3>
                    <div class="relative w-64 h-64 md:w-80 md:h-80 border-4 border-purple-500/20 rounded-full p-4">
                        <div id="compass" class="relative w-full h-full transition-transform duration-1000">
                             <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-1.5 h-full bg-gradient-to-t from-transparent via-purple-600 to-purple-400 rounded-full relative">
                                    <i class="fa-solid fa-kaaba absolute -top-8 left-1/2 -translate-x-1/2 text-4xl text-purple-500"></i>
                                </div>
                             </div>
                        </div>
                    </div>
                    <h2 class="text-5xl font-black text-purple-500 mt-12" id="qibla-degree">--°</h2>
                </div>
            </div>

            <!-- Placeholder Hadith Tab -->
            <div id="hadith-tab" class="tab-content hidden">
                <div class="bg-white dark:bg-[#0a0a0a] p-10 rounded-[2.5rem] border dark:border-zinc-900 shadow-xl text-center">
                    <i class="fa-solid fa-mosque text-5xl text-purple-500 mb-6"></i>
                    <h3 class="text-2xl font-bold dark:text-white mb-4">Hadith Collections</h3>
                    <p class="text-slate-500">Integration with Hadith API coming soon in the next update.</p>
                </div>
            </div>

            <!-- Placeholder Azkar Tab -->
            <div id="azkar-tab" class="tab-content hidden">
                <div class="bg-white dark:bg-[#0a0a0a] p-10 rounded-[2.5rem] border dark:border-zinc-900 shadow-xl text-center">
                    <i class="fa-solid fa-beads text-5xl text-purple-500 mb-6"></i>
                    <h3 class="text-2xl font-bold dark:text-white mb-4">Azkar & Duas</h3>
                    <p class="text-slate-500 mb-8">Counter and digital Tasbih.</p>
                    <div class="flex flex-col items-center">
                        <span id="counter-val" class="text-6xl font-black text-purple-500 mb-6">0</span>
                        <button onclick="countAzkar()" class="w-24 h-24 rounded-full bg-purple-600 text-white text-2xl shadow-xl shadow-purple-600/30 hover:scale-105 active:scale-95 transition-all">
                            TAP
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Global Floating Audio Player -->
    <div id="audio-player-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-2xl bg-white dark:bg-[#111] rounded-3xl border border-slate-100 dark:border-zinc-800 shadow-2xl p-4 flex items-center gap-4 z-[100] translate-y-32 transition-transform duration-500">
        <div class="w-12 h-12 bg-purple-600 rounded-2xl flex items-center justify-center text-white shrink-0">
            <i class="fa-solid fa-volume-high animate-pulse"></i>
        </div>
        <div class="flex-1 min-w-0">
            <h4 id="audio-title" class="text-sm font-bold truncate dark:text-white">Playing Quran</h4>
            <p id="audio-subtitle" class="text-[10px] text-slate-500 truncate">Mishary Rashid Alafasy</p>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleAudio()" id="audio-main-btn" class="w-10 h-10 rounded-full bg-purple-600 text-white flex items-center justify-center hover:scale-105 active:scale-95 transition-all">
                <i class="fa-solid fa-pause"></i>
            </button>
            <button onclick="closeAudio()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-zinc-800 text-slate-400 flex items-center justify-center hover:text-red-500 transition-all">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <audio id="global-audio" onended="closeAudio()"></audio>
    </div>

    <script>
        const LANGUAGES = {
            en: { quran: "Noble Quran", prayerTimes: "Prayer Times", tracker: "Daily Tracker", azkar: "Azkar", qibla: "Qibla", back: "Back", backPortal: "To Portal", next: "Next", hadith: "Hadith Collections" },
            ar: { quran: "القرآن الكريم", prayerTimes: "مواقيت الصلاة", tracker: "المتابع اليومي", azkar: "الأذكار", qibla: "القبلة", back: "رجوع", backPortal: "للمنصة", next: "التالي", hadith: "الأحاديث النبوية" },
            ur: { quran: "قرآن کریم", prayerTimes: "نماز کے اوقات", tracker: "ٹریکر", azkar: "اذکار", qibla: "قبلہ", back: "پیچھے", backPortal: "پورٹل", next: "اگلی", hadith: "احادیث" },
            id: { quran: "Al-Quran", prayerTimes: "Waktu Salat", tracker: "Pelacak Harian", azkar: "Azkar", qibla: "Kiblat", back: "Kembali", backPortal: "Ke Portal", next: "Berikutnya", hadith: "Hadits" }
        };

        let currentLang = 'en';
        let isDarkMode = true;
        let surahData = [];
        let prayerTimings = null;
        let azkarCounter = 0;
        let trackerData = JSON.parse(localStorage.getItem('cx_tracker')) || { Fajr: false, Dhuhr: false, Asr: false, Maghrib: false, Isha: false, date: new Date().toDateString() };

        window.onload = () => {
            initTheme();
            fetchSurahs();
            fetchDailyVerse();
            fetchHijriDate();
            fetchPrayerTimes("Cairo");
            renderTracker();
            
            // Auto-reset tracker if new day
            if (trackerData.date !== new Date().toDateString()) {
                trackerData = { Fajr: false, Dhuhr: false, Asr: false, Maghrib: false, Isha: false, date: new Date().toDateString() };
                localStorage.setItem('cx_tracker', JSON.stringify(trackerData));
            }
        };

        function initTheme() {
            const saved = localStorage.getItem('cx_theme') || 'dark';
            isDarkMode = (saved === 'dark');
            applyTheme();
        }

        function applyTheme() {
            const body = document.getElementById('body');
            const icon = document.getElementById('theme-icon');
            if (isDarkMode) {
                body.classList.add('dark');
                icon.className = 'fa-solid fa-sun';
            } else {
                body.classList.remove('dark');
                icon.className = 'fa-solid fa-moon';
            }
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            applyTheme();
            localStorage.setItem('cx_theme', isDarkMode ? 'dark' : 'light');
        }

        function toggleSettings() {
            const menu = document.getElementById('settings-menu');
            menu.classList.toggle('hidden');
            // Reset location error message when opening settings
            if (!menu.classList.contains('hidden')) {
                document.getElementById('location-error').classList.add('hidden');
            }
        }

        function changeLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.body.dir = (lang === 'ar' || lang === 'ur') ? 'rtl' : 'ltr';
            
            // Update UI texts
            const activeNav = document.querySelector('.nav-btn.active');
            const currentTabId = activeNav ? activeNav.dataset.tab : 'quran';
            document.getElementById('page-title').innerText = LANGUAGES[currentLang][currentTabId] || currentTabId;
            
            // Localize sidebar labels
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (LANGUAGES[currentLang][key]) {
                    el.innerText = LANGUAGES[currentLang][key];
                }
            });

            toggleSettings();
        }

        async function fetchHijriDate() {
            try {
                const res = await fetch('https://api.aladhan.com/v1/gToH');
                const data = await res.json();
                const h = data.data.hijri;
                document.getElementById('hijri-date').innerText = `${h.day} ${h.month.en} ${h.year} AH`;
            } catch (e) {
                document.getElementById('hijri-date').innerText = "Islamic Calendar";
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId + '-tab').classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            document.getElementById('page-title').innerText = LANGUAGES[currentLang][tabId] || tabId;
            if (window.innerWidth < 1024) toggleSidebar();
        }

        async function fetchSurahs() {
            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                surahData = data.data;
                renderSurahList(surahData);
            } catch (e) { console.error("Surah fetch failed", e); }
        }

        function renderSurahList(list) {
            const container = document.getElementById('surah-list');
            container.innerHTML = list.map(s => `
                <div onclick="loadSurah(${s.number})" class="p-6 rounded-2xl bg-white dark:bg-[#0a0a0a] border border-slate-100 dark:border-zinc-900 cursor-pointer hover:border-purple-500 transition-all group shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center text-[10px] font-bold">${s.number}</span>
                        <h4 class="text-2xl quran-font text-purple-500">${s.name}</h4>
                    </div>
                    <div class="mt-4">
                        <h5 class="font-bold dark:text-white">${s.englishName}</h5>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">${s.englishNameTranslation}</p>
                    </div>
                </div>
            `).join('');
        }

        function filterSurahs(val) {
            const filtered = surahData.filter(s => s.englishName.toLowerCase().includes(val.toLowerCase()) || s.name.includes(val));
            renderSurahList(filtered);
        }

        async function loadSurah(num) {
            document.getElementById('quran-tab').querySelector('div').classList.add('hidden');
            document.getElementById('surah-list').classList.add('hidden');
            document.getElementById('ayah-view').classList.remove('hidden');
            const container = document.getElementById('ayahs-container');
            container.innerHTML = '<div class="py-20 flex justify-center"><div class="loader"></div></div>';
            
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}/editions/quran-uthmani,en.sahih`);
                const data = await res.json();
                
                container.innerHTML = data.data[0].ayahs.map((a, i) => `
                    <div class="ayah-card p-6 md:p-8 rounded-[2rem] bg-white dark:bg-[#0a0a0a] border border-slate-100 dark:border-zinc-900 transition-all shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-xs font-bold text-purple-500">${num}:${a.numberInSurah}</span>
                            <button onclick="playAudio(${a.number}, '${data.data[0].englishName} Ayah ${a.numberInSurah}')" class="w-10 h-10 rounded-full bg-slate-50 dark:bg-zinc-900 text-purple-500 flex items-center justify-center hover:bg-purple-500 hover:text-white transition-all shadow-sm"><i class="fa-solid fa-play"></i></button>
                        </div>
                        <p class="text-3xl md:text-4xl quran-font text-right leading-[2] dark:text-white mb-6">${a.text}</p>
                        <p class="text-slate-500 italic border-l-2 border-purple-500/20 pl-4 ltr text-left">${data.data[1].ayahs[i].text}</p>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<p class="text-center text-red-500">Failed to load Surah. Please try again.</p>`;
            }
        }

        function backToSurahs() {
            document.getElementById('quran-tab').querySelector('div').classList.remove('hidden');
            document.getElementById('surah-list').classList.remove('hidden');
            document.getElementById('ayah-view').classList.add('hidden');
        }

        function playAudio(id, title) {
            const player = document.getElementById('audio-player-bar');
            const audio = document.getElementById('global-audio');
            const btn = document.getElementById('audio-main-btn');
            
            audio.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${id}.mp3`;
            document.getElementById('audio-title').innerText = title;
            player.classList.remove('translate-y-32');
            audio.play();
            btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
        }

        function toggleAudio() {
            const audio = document.getElementById('global-audio');
            const btn = document.getElementById('audio-main-btn');
            if (audio.paused) {
                audio.play();
                btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
            } else {
                audio.pause();
                btn.innerHTML = '<i class="fa-solid fa-play"></i>';
            }
        }

        function closeAudio() {
            const player = document.getElementById('audio-player-bar');
            const audio = document.getElementById('global-audio');
            audio.pause();
            player.classList.add('translate-y-32');
        }

        async function fetchDailyVerse() {
            const randomId = Math.floor(Math.random() * 6236) + 1;
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${randomId}/editions/quran-uthmani,en.sahih`);
                const data = await res.json();
                document.getElementById('daily-ayah-ar').innerText = data.data[0].text;
                document.getElementById('daily-ayah-en').innerText = `"${data.data[1].text}" — Surah ${data.data[0].surah.englishName}`;
            } catch (e) { console.error("Verse fetch failed", e); }
        }

        async function fetchPrayerTimes(city) {
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=&method=2`);
                const data = await res.json();
                if (data.code === 200) {
                    prayerTimings = data.data.timings;
                    renderPrayerTab();
                    startMainCountdown();
                    
                    // Qibla Logic
                    const qiblaRes = await fetch(`https://api.aladhan.com/v1/qibla/${data.data.meta.latitude}/${data.data.meta.longitude}`);
                    const qiblaData = await qiblaRes.json();
                    const degree = qiblaData.data.direction;
                    document.getElementById('qibla-degree').innerText = `${Math.round(degree)}°`;
                    document.getElementById('compass').style.transform = `rotate(${degree}deg)`;
                }
            } catch (e) { console.error("Prayer fetch failed", e); }
        }

        function renderPrayerTab() {
            if (!prayerTimings) return;
            const container = document.getElementById('prayer-cards-container');
            const map = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            container.innerHTML = map.map(p => `
                <div class="p-6 rounded-[2rem] bg-white dark:bg-[#0a0a0a] border dark:border-zinc-900 flex justify-between items-center shadow-sm">
                    <div>
                        <h4 class="font-bold text-slate-400 text-xs uppercase tracking-widest">${p}</h4>
                        <p class="text-3xl font-black text-purple-600">${prayerTimings[p]}</p>
                    </div>
                    <div class="w-12 h-12 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-500 flex items-center justify-center">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                </div>
            `).join('');
        }

        function startMainCountdown() {
            setInterval(() => {
                if(!prayerTimings) return;
                const now = new Date();
                const map = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                let next = null, name = "";
                for(let p of map) {
                    const [h,m] = prayerTimings[p].split(':');
                    const pt = new Date(); pt.setHours(h,m,0);
                    if(pt > now) { next = pt; name = p; break; }
                }
                if(!next) {
                    const [h,m] = prayerTimings['Fajr'].split(':');
                    next = new Date(); next.setDate(next.getDate()+1); next.setHours(h,m,0); name = "Fajr";
                }
                const diff = next - now;
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                
                const label = document.getElementById('next-prayer-label');
                const countdown = document.getElementById('next-prayer-countdown-hero');
                if (label) label.innerText = `${name} In`;
                if (countdown) countdown.innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        function renderTracker() {
            const grid = document.getElementById('tracker-grid');
            const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            grid.innerHTML = prayers.map(p => `
                <button onclick="toggleTrack('${p}')" class="p-6 rounded-[2rem] flex flex-col items-center gap-4 transition-all ${trackerData[p] ? 'bg-purple-600 text-white shadow-xl shadow-purple-600/30 scale-105' : 'bg-slate-50 dark:bg-zinc-900 text-slate-400'}">
                    <i class="fa-solid ${trackerData[p] ? 'fa-circle-check' : 'fa-circle'} text-3xl"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">${p}</span>
                </button>
            `).join('');
            
            const doneCount = Object.values(trackerData).filter(v => typeof v === 'boolean' && v === true).length;
            document.getElementById('streak-count').innerText = doneCount;
        }

        function toggleTrack(p) {
            trackerData[p] = !trackerData[p];
            localStorage.setItem('cx_tracker', JSON.stringify(trackerData));
            renderTracker();
        }

        function applySettingsLocation() {
            const city = document.getElementById('settings-city-input').value;
            if(city) {
                fetchPrayerTimes(city);
                toggleSettings();
            }
        }

        function requestLocation() {
            const btn = document.getElementById('gps-btn');
            const errEl = document.getElementById('location-error');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin mr-2"></i>Detecting...';
            errEl.classList.add('hidden');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=2`);
                            const data = await res.json();
                            prayerTimings = data.data.timings;
                            renderPrayerTab();
                            startMainCountdown();
                            
                            // Update Qibla from lat/lng
                            const qiblaRes = await fetch(`https://api.aladhan.com/v1/qibla/${latitude}/${longitude}`);
                            const qiblaData = await qiblaRes.json();
                            const degree = qiblaData.data.direction;
                            document.getElementById('qibla-degree').innerText = `${Math.round(degree)}°`;
                            document.getElementById('compass').style.transform = `rotate(${degree}deg)`;
                            
                            btn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i>Detect GPS';
                            toggleSettings();
                        } catch (e) { 
                            console.error("GPS API Fetch failed", e);
                            btn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i>Detect GPS';
                        }
                    },
                    (error) => { 
                        let msg = "GPS error";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: msg = "Permission denied."; break;
                            case error.POSITION_UNAVAILABLE: msg = "Location unavailable."; break;
                            case error.TIMEOUT: msg = "Request timed out."; break;
                        }
                        console.error("GPS Error:", msg, error);
                        errEl.innerText = msg + " Use manual input.";
                        errEl.classList.remove('hidden');
                        btn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i>Detect GPS';
                    },
                    { timeout: 10000 }
                );
            } else {
                errEl.innerText = "Geolocation not supported.";
                errEl.classList.remove('hidden');
                btn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i>Detect GPS';
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        function countAzkar() {
            azkarCounter++;
            document.getElementById('counter-val').innerText = azkarCounter;
            if (navigator.vibrate) navigator.vibrate(50);
        }
    </script>
</body>
</html>

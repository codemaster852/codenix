<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nix 3 - CodeNix Training Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nix-gradient {
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active {
            border-bottom: 2px solid #38bdf8;
            color: #38bdf8;
        }
        .sync-indicator {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-6 border-b border-slate-800 flex justify-between items-center glass-card sticky top-0 z-50">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-sky-500 rounded-lg flex items-center justify-center font-bold text-xl shadow-lg shadow-sky-500/20">N3</div>
            <div>
                <h1 class="text-2xl font-bold nix-gradient">Nix 3</h1>
                <p class="text-xs text-slate-400 uppercase tracking-widest">Fine-Tuning Portal</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <div id="api-status" class="hidden flex items-center space-x-2 bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-full text-sm border border-emerald-500/20">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                <span>API Linked</span>
            </div>
            <div id="sync-active" class="sync-indicator">Pushing to Google Sheets...</div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left Column -->
        <div class="lg:col-span-5 space-y-6">
            <section class="glass-card rounded-2xl shadow-xl overflow-hidden">
                <div class="flex border-b border-slate-800">
                    <button id="tab-manual" class="flex-1 py-4 text-sm font-semibold transition-all tab-active">Manual Input</button>
                    <button id="tab-ai" class="flex-1 py-4 text-sm font-semibold transition-all text-slate-500">AI Generator</button>
                </div>

                <div class="p-6">
                    <!-- Manual View -->
                    <div id="view-manual" class="space-y-4">
                        <h2 class="text-sm font-medium text-slate-400 uppercase tracking-wider">New Training Pair</h2>
                        <textarea id="train-q" rows="2" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none text-sm text-slate-200" placeholder="User Question..."></textarea>
                        <textarea id="train-a" rows="3" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none text-sm text-slate-200" placeholder="Ideal Nix 3 Response..."></textarea>
                        <button id="add-training" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-semibold py-3 rounded-lg transition-all shadow-lg shadow-sky-600/20">
                            Add & Sync Pair
                        </button>
                    </div>

                    <!-- AI View -->
                    <div id="view-ai" class="hidden space-y-4">
                        <div class="space-y-2 mb-6">
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Nix Engine Key</label>
                            <input type="password" id="api-key" placeholder="Paste Gemini Key here..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-purple-500 transition-all text-slate-200 text-sm">
                        </div>
                        
                        <input type="text" id="gen-topic" placeholder="Topic (e.g. Linux Kernels...)" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all text-slate-200 text-sm">
                        
                        <button id="generate-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-semibold py-3 rounded-lg transition-all shadow-lg shadow-purple-600/20 flex items-center justify-center space-x-2">
                            <span id="gen-text">Generate & Sync 5 Pairs</span>
                            <span id="gen-loader" class="loader hidden"></span>
                        </button>
                    </div>
                </div>
            </section>

            <div class="p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Sync Connection</h3>
                <p class="text-[11px] text-slate-400 leading-relaxed">Status: <span id="sync-status-text" class="text-amber-400">Idle</span></p>
                <div class="mt-4 p-3 bg-slate-950 rounded border border-slate-800">
                    <p class="text-[10px] text-slate-500 mb-1 uppercase font-bold">Latest Endpoint Active:</p>
                    <code class="text-[9px] text-sky-400 block break-all">...3Gw/exec</code>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="lg:col-span-7 space-y-6">
            <!-- Simulation -->
            <section class="glass-card rounded-2xl shadow-xl flex flex-col h-[350px]">
                <div class="p-4 border-b border-slate-800">
                    <h2 class="text-sm font-semibold text-slate-300">Model Simulation</h2>
                </div>
                <div id="chat-box" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scrollbar"></div>
                <div class="p-4 border-t border-slate-800 flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Type message..." class="flex-grow bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none text-sm">
                    <button id="send-btn" class="bg-sky-600 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </div>
            </section>

            <!-- Table -->
            <section class="glass-card rounded-2xl shadow-xl overflow-hidden">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h2 class="text-sm font-semibold text-slate-300 uppercase">Recent Dataset (<span id="count">0</span>)</h2>
                </div>
                <div class="max-h-[300px] overflow-y-auto custom-scrollbar">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-900/50 sticky top-0">
                            <tr>
                                <th class="p-3 text-slate-500 font-medium">Input</th>
                                <th class="p-3 text-slate-500 font-medium">Expected Output</th>
                            </tr>
                        </thead>
                        <tbody id="dataset-body"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 px-6 py-3 rounded-xl shadow-2xl z-[100] text-sm"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyzagltuU7I4FOoLWDlKqq3p_z3gkYjUtVePatNBByOggW56NU2pPnxmlP7aJTB3Gw/exec";
        
        let apiKey = localStorage.getItem('nix3_api_key') || '';
        let dataset = JSON.parse(localStorage.getItem('nix3_dataset')) || [];

        const apiKeyInput = document.getElementById('api-key');
        const apiStatus = document.getElementById('api-status');
        const trainQ = document.getElementById('train-q');
        const trainA = document.getElementById('train-a');
        const addTrainBtn = document.getElementById('add-training');
        const genTopic = document.getElementById('gen-topic');
        const generateBtn = document.getElementById('generate-btn');
        const datasetBody = document.getElementById('dataset-body');
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const pairCount = document.getElementById('count');
        const syncActive = document.getElementById('sync-active');
        const syncStatusText = document.getElementById('sync-status-text');

        // UI Tabs
        const tabManual = document.getElementById('tab-manual');
        const tabAI = document.getElementById('tab-ai');
        const viewManual = document.getElementById('view-manual');
        const viewAI = document.getElementById('view-ai');

        if (apiKey) { 
            apiKeyInput.value = apiKey; 
            apiStatus.classList.remove('hidden'); 
        }
        updateDatasetUI();

        tabManual.addEventListener('click', () => {
            tabManual.className = 'flex-1 py-4 text-sm font-semibold transition-all tab-active';
            tabAI.className = 'flex-1 py-4 text-sm font-semibold transition-all text-slate-500';
            viewManual.classList.remove('hidden'); viewAI.classList.add('hidden');
        });

        tabAI.addEventListener('click', () => {
            tabAI.className = 'flex-1 py-4 text-sm font-semibold transition-all tab-active';
            tabManual.className = 'flex-1 py-4 text-sm font-semibold transition-all text-slate-500';
            viewAI.classList.remove('hidden'); viewManual.classList.add('hidden');
        });

        apiKeyInput.addEventListener('input', (e) => {
            apiKey = e.target.value.trim();
            localStorage.setItem('nix3_api_key', apiKey);
            apiStatus.classList.toggle('hidden', !apiKey);
        });

        // SYNC ENGINE - Updated to only send Q and A
        async function syncToSheets(rawPayload) {
            syncActive.style.display = 'block';
            syncStatusText.innerText = "Syncing...";
            syncStatusText.className = "text-sky-400";

            // Map payload to remove timestamps before sending to Google Sheets
            const cleanPayload = rawPayload.map(item => ({
                q: item.q,
                a: item.a
            }));

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(cleanPayload)
                });
                
                syncStatusText.innerText = "QA Synced";
                syncStatusText.className = "text-emerald-400";
                return true;
            } catch (err) {
                console.error("Sync Error:", err);
                syncStatusText.innerText = "Network Error";
                syncStatusText.className = "text-red-400";
                return false;
            } finally {
                setTimeout(() => { syncActive.style.display = 'none'; }, 3000);
            }
        }

        addTrainBtn.addEventListener('click', async () => {
            const q = trainQ.value.trim(), a = trainA.value.trim();
            if (q && a) {
                const newPair = { q, a, timestamp: new Date().toLocaleString() };
                dataset.unshift(newPair);
                saveLocally();
                trainQ.value = ''; trainA.value = '';
                showToast('Adding pair...', 'success');
                await syncToSheets([newPair]);
            }
        });

        generateBtn.addEventListener('click', async () => {
            const topic = genTopic.value.trim();
            if (!apiKey) return showToast('API Key Required', 'error');
            if (!topic) return showToast('Enter Topic', 'error');

            setLoading(true);
            const prompt = `Create 5 high-quality training examples for an AI assistant on the topic: "${topic}". 
            Format as a plain JSON array: [{"q": "question", "a": "answer"}]. 
            Return ONLY the JSON array.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                const newPairs = JSON.parse(text);
                
                const pairsWithTime = newPairs.map(p => ({ ...p, timestamp: new Date().toLocaleString() }));
                pairsWithTime.forEach(p => dataset.unshift(p));
                
                saveLocally();
                showToast('QA AI Syncing...', 'success');
                await syncToSheets(pairsWithTime);
                genTopic.value = '';
            } catch (err) {
                showToast('AI Generation Failed', 'error');
            } finally {
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            document.getElementById('gen-loader').classList.toggle('hidden', !isLoading);
            document.getElementById('gen-text').innerText = isLoading ? 'Processing...' : 'Generate & Sync 5 Pairs';
            generateBtn.disabled = isLoading;
        }

        function saveLocally() {
            localStorage.setItem('nix3_dataset', JSON.stringify(dataset));
            updateDatasetUI();
        }

        function updateDatasetUI() {
            pairCount.innerText = dataset.length;
            datasetBody.innerHTML = dataset.slice(0, 20).map(item => `
                <tr class="border-b border-slate-800 hover:bg-slate-800/20">
                    <td class="p-3 text-slate-300 truncate max-w-[200px]">${item.q}</td>
                    <td class="p-3 text-slate-400 truncate max-w-[250px]">${item.a}</td>
                </tr>
            `).join('');
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `fixed bottom-6 right-6 px-6 py-3 rounded-xl shadow-2xl z-[100] transition-all duration-300 ${type === 'success' ? 'bg-sky-600' : 'bg-red-600'} text-white border border-white/10`;
            t.style.opacity = '1'; t.style.transform = 'translateY(0)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(20px)'; }, 3000);
        }
    </script>
</body>
</html>

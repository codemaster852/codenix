<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nix 3 - Voice AI</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e5e7eb;
            overflow: hidden;
            touch-action: manipulation;
        }

        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 10px; }

        .voice-active-ring {
            animation: pulse-ring 2s cubic-bezier(0.24, 0, 0.38, 1) infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.5); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 40px rgba(139, 92, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }

        .gemini-thinking {
            background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5);
            background-size: 200% auto;
            animation: shine 1.5s linear infinite;
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        .glass {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(10, 10, 10, 0.75);
        }

        .message-anim {
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-anim {
            animation: welcomeIn 0.8s ease-out;
        }
        @keyframes welcomeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SHEET_ID = "1BwS2zO3IGppDo2r_ROZVW74iSmu6aGSyE8j1O63UjbE";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx3YKf3u6KoxvHJc3bBRJzWYg1CPcpHAFXUTTWTh28FR2XcOJlqzcIsJC19_9X7ozH8/exec";
        const API_KEY = "ak_2OJ4ng6za7b74DP3hu32a6P04XH8J";
        const API_URL = "https://api.longcat.chat/openai/v1/chat/completions";

        const App = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isTyping, setIsTyping] = useState(false);
            const [isVoiceMode, setIsVoiceMode] = useState(false);
            const [voiceStatus, setVoiceStatus] = useState("Listening...");
            const [interimTranscript, setInterimTranscript] = useState("");
            const scrollRef = useRef(null);
            
            const recognitionRef = useRef(null);
            const synth = window.speechSynthesis;

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'en-US';

                    recognitionRef.current.onresult = (event) => {
                        const transcript = Array.from(event.results)
                            .map(result => result[0].transcript)
                            .join('');
                        
                        setInterimTranscript(transcript);

                        if (event.results[0].isFinal) {
                            setVoiceStatus("Processing...");
                            // Critical: Force stop recognition before AI processing/speaking
                            recognitionRef.current.stop(); 
                            processQuery(transcript);
                        }
                    };

                    recognitionRef.current.onerror = (e) => {
                        if (e.error !== 'no-speech') {
                            console.error("Speech Recognition Error:", e.error);
                            setVoiceStatus("Retry speaking...");
                        }
                    };

                    recognitionRef.current.onend = () => {
                        // Only restart if we are in Voice Mode and expecting to listen
                        if (isVoiceMode && voiceStatus === "Listening...") {
                            try { recognitionRef.current.start(); } catch(e) {}
                        }
                    };
                }
            }, [isVoiceMode, voiceStatus]);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });
                }
            }, [messages, isTyping, interimTranscript]);

            const speak = (text) => {
                // Clear any existing queue to prevent sticking
                synth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                utterance.onstart = () => {
                    setVoiceStatus("Nix is speaking...");
                    setInterimTranscript("");
                };
                
                utterance.onend = () => {
                    if (isVoiceMode) {
                        setVoiceStatus("Listening...");
                        setInterimTranscript("");
                        // Small delay before turning mic back on to avoid feedback
                        setTimeout(() => {
                            try { recognitionRef.current.start(); } catch(e) {}
                        }, 300);
                    }
                };

                utterance.onerror = (e) => {
                    console.error("Speech Synthesis Error:", e);
                    if (isVoiceMode) setVoiceStatus("Listening...");
                };
                
                synth.speak(utterance);
            };

            const toggleVoiceMode = () => {
                if (!isVoiceMode) {
                    setIsVoiceMode(true);
                    setVoiceStatus("Listening...");
                    setInterimTranscript("");
                    try { recognitionRef.current.start(); } catch(e) {}
                } else {
                    setIsVoiceMode(false);
                    synth.cancel();
                    recognitionRef.current?.stop();
                    setInterimTranscript("");
                }
            };

            const processQuery = async (query) => {
                if (!query.trim()) return;
                
                setMessages(prev => [...prev, { role: 'user', content: query, id: Date.now() }]);
                setInterimTranscript("");
                setIsTyping(true);

                try {
                    const local = await checkLocal(query);
                    let response;
                    
                    if (local) {
                        response = local;
                    } else {
                        response = await askAI(query);
                        saveToSheet(query, response);
                    }

                    setMessages(prev => [...prev, { role: 'assistant', content: response, id: Date.now() + 1 }]);
                    
                    // Trigger speak after state update
                    speak(response);
                } catch (e) {
                    const err = "I'm having trouble connecting.";
                    setMessages(prev => [...prev, { role: 'assistant', content: err, id: Date.now() + 2 }]);
                    speak(err);
                } finally {
                    setIsTyping(false);
                }
            };

            const checkLocal = async (q) => {
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tq=${encodeURIComponent("SELECT A, B")}&headers=0&t=${Date.now()}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/)[1]);
                    const norm = q.toLowerCase().trim();
                    const match = json.table.rows.find(r => r.c && r.c[0] && String(r.c[0].v).toLowerCase().trim() === norm);
                    return match ? String(match.c[1].v) : null;
                } catch(e) { return null; }
            };

            const askAI = async (q) => {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "LongCat-Flash-Chat",
                        messages: [{ role: "user", content: q }],
                        temperature: 0.7
                    })
                });
                const data = await res.json();
                return data.choices[0].message.content;
            };

            const saveToSheet = (q, a) => {
                fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ values: [[q, a]] }) });
            };

            const copyToClipboard = (text) => {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            };

            return (
                <div className="flex flex-col h-[100dvh] w-full bg-[#050505] text-gray-100">
                    {/* Header */}
                    <header className="flex items-center justify-between p-4 px-6 glass border-b border-white/5 z-40">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 via-purple-600 to-pink-500 flex items-center justify-center shadow-lg">
                                <span className="text-white font-black text-[10px]">N3</span>
                            </div>
                            <h1 className="font-bold text-lg tracking-tight">Nix 3</h1>
                        </div>
                        <button 
                            onClick={toggleVoiceMode}
                            className={`px-4 py-1.5 rounded-full text-[11px] font-bold tracking-wider uppercase transition-all flex items-center gap-2 ${isVoiceMode ? 'bg-red-500/10 text-red-400 border border-red-500/20' : 'bg-white/10 text-white border border-white/10'}`}
                        >
                            <span className={`w-2 h-2 rounded-full ${isVoiceMode ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`}></span>
                            {isVoiceMode ? 'Stop Voice' : 'Voice Mode'}
                        </button>
                    </header>

                    {/* Chat Area */}
                    <main ref={scrollRef} className="flex-1 overflow-y-auto px-4 pt-6 pb-32 space-y-8 relative">
                        
                        {messages.length === 0 && (
                            <div className="h-full flex flex-col items-center justify-center text-center welcome-anim px-8">
                                <div className="w-20 h-20 rounded-[2rem] bg-gradient-to-tr from-purple-600 to-indigo-600 flex items-center justify-center shadow-2xl mb-8 relative">
                                    <div className="absolute inset-0 bg-purple-500 blur-3xl opacity-30"></div>
                                    <span className="text-white font-black text-3xl relative">N</span>
                                </div>
                                <h2 className="text-3xl font-extrabold mb-3 tracking-tighter">How can I help you today?</h2>
                                <p className="text-sm opacity-40 max-w-xs leading-relaxed">Nix 3 is synced with your knowledge base and generative AI.</p>
                            </div>
                        )}

                        <div className="max-w-3xl mx-auto space-y-8">
                            {messages.map((msg) => (
                                <div key={msg.id} className={`flex gap-4 message-anim ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                    <div className={`w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center text-[10px] font-bold ${msg.role === 'user' ? 'bg-white/10' : 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white'}`}>
                                        {msg.role === 'user' ? 'YOU' : 'N3'}
                                    </div>
                                    <div className={`max-w-[85%] ${msg.role === 'user' ? 'text-right' : ''}`}>
                                        <div className={`p-4 rounded-2xl text-[15px] leading-relaxed ${msg.role === 'user' ? 'bg-neutral-900 border border-white/5' : 'bg-transparent'}`}>
                                            {msg.content}
                                        </div>
                                        {msg.role === 'assistant' && (
                                            <div className="mt-3 flex gap-4 px-1">
                                                <button onClick={() => copyToClipboard(msg.content)} className="flex items-center gap-1.5 text-[10px] font-semibold opacity-40 hover:opacity-100 uppercase tracking-widest transition-opacity">
                                                    <span>ðŸ“‹</span> Copy
                                                </button>
                                                <button onClick={() => speak(msg.content)} className="flex items-center gap-1.5 text-[10px] font-semibold opacity-40 hover:opacity-100 uppercase tracking-widest transition-opacity">
                                                    <span>ðŸ”Š</span> Replay
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}

                            {interimTranscript && (
                                <div className="flex flex-row-reverse gap-4 message-anim opacity-60">
                                    <div className="w-8 h-8 rounded-lg flex-shrink-0 bg-white/5 border border-white/10 flex items-center justify-center text-[10px] font-bold">...</div>
                                    <div className="p-4 rounded-2xl bg-white/5 italic text-[15px]">{interimTranscript}</div>
                                </div>
                            )}

                            {isTyping && (
                                <div className="flex gap-4 message-anim">
                                    <div className="w-8 h-8 rounded-lg flex-shrink-0 bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-[10px] font-bold text-white">N3</div>
                                    <div className="flex flex-col gap-2 w-full max-w-[200px]">
                                        <div className="h-4 w-full rounded gemini-thinking opacity-40"></div>
                                        <div className="h-4 w-[80%] rounded gemini-thinking opacity-30"></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Voice Interface Overlay */}
                    {isVoiceMode && (
                        <div className="fixed inset-0 top-[72px] bg-black/80 backdrop-blur-md z-30 flex flex-col items-center justify-center text-center p-8">
                            <div className="mb-12 relative">
                                <div className={`absolute -inset-10 rounded-full bg-purple-500/20 blur-3xl transition-opacity duration-1000 ${voiceStatus === "Listening..." ? 'opacity-100' : 'opacity-0'}`}></div>
                                <div className={`w-36 h-36 rounded-full bg-gradient-to-tr from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center shadow-2xl relative z-10 transition-transform duration-500 ${voiceStatus === "Listening..." ? 'voice-active-ring scale-110' : 'scale-100 grayscale-[0.5]'}`}>
                                    {voiceStatus === "Listening..." ? (
                                        <svg className="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                                    ) : (
                                        <svg className="w-14 h-14 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    )}
                                </div>
                            </div>
                            
                            <h2 className="text-3xl font-black mb-2 tracking-tight">{voiceStatus}</h2>
                            <div className="h-12 overflow-hidden px-4">
                                <p className="text-lg font-medium opacity-60 italic line-clamp-2">{interimTranscript || "Speak naturally..."}</p>
                            </div>

                            <button onClick={toggleVoiceMode} className="mt-12 px-8 py-3 rounded-2xl bg-white/5 border border-white/10 text-sm font-bold uppercase tracking-widest hover:bg-white/10 transition-colors">
                                Close Voice Mode
                            </button>
                        </div>
                    )}

                    {/* Chat Input Bar */}
                    {!isVoiceMode && (
                        <div className="fixed bottom-0 left-0 right-0 p-4 md:p-6 glass border-t border-white/5 z-40 bg-[#050505]/90">
                            <form 
                                onSubmit={(e) => { e.preventDefault(); processQuery(input); setInput(""); }} 
                                className="max-w-3xl mx-auto flex gap-3 items-center"
                            >
                                <div className="relative flex-1 group">
                                    <div className="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-focus-within:opacity-40 transition"></div>
                                    <input 
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        placeholder="Type your message..."
                                        className="relative w-full bg-neutral-900 border border-white/10 rounded-2xl px-5 py-4 outline-none focus:border-purple-500/50 text-[15px] placeholder:opacity-30"
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={!input.trim() || isTyping}
                                    className="bg-indigo-600 w-14 h-14 rounded-2xl shadow-xl shadow-indigo-600/20 active:scale-95 transition-all flex items-center justify-center disabled:opacity-20"
                                >
                                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M5 12h14M12 5l7 7-7 7"/></svg>
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nix 3 - Universal Voice AI</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e5e7eb;
            overflow: hidden;
            touch-action: manipulation;
        }

        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 10px; }

        .glass {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(10, 10, 10, 0.8);
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 6px;
            height: 60px;
        }

        .bar {
            width: 6px;
            height: 12px;
            background: #6366f1;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .bar-active {
            animation: wave 1.2s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { height: 12px; transform: scaleY(1); }
            50% { height: 48px; transform: scaleY(1.2); }
        }

        .message-anim {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SHEET_ID = "1BwS2zO3IGppDo2r_ROZVW74iSmu6aGSyE8j1O63UjbE";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx3YKf3u6KoxvHJc3bBRJzWYg1CPcpHAFXUTTWTh28FR2XcOJlqzcIsJC19_9X7ozH8/exec";
        const API_KEY = "ak_2OJ4ng6za7b74DP3hu32a6P04XH8J";
        const API_URL = "https://api.longcat.chat/openai/v1/chat/completions";

        const App = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isTyping, setIsTyping] = useState(false);
            const [isVoiceMode, setIsVoiceMode] = useState(false);
            const [voiceStatus, setVoiceStatus] = useState("Idle");
            const [hasActivatedVoice, setHasActivatedVoice] = useState(false);
            
            const recognitionRef = useRef(null);
            const synth = window.speechSynthesis;
            const scrollRef = useRef(null);

            useEffect(() => {
                const loadVoices = () => synth.getVoices();
                loadVoices();
                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = loadVoices;
                }
            }, []);

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;
                    // Setting lang to empty or navigator.language allows for broader auto-detection
                    recognitionRef.current.lang = navigator.language || 'en-US';

                    recognitionRef.current.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setVoiceStatus("Processing...");
                        processQuery(transcript);
                    };

                    recognitionRef.current.onend = () => {
                        if (isVoiceMode && voiceStatus === "Listening...") {
                            startRecognition();
                        }
                    };

                    recognitionRef.current.onerror = () => {
                        setVoiceStatus("Listening...");
                    };
                }
            }, [isVoiceMode, voiceStatus]);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });
                }
            }, [messages, isTyping]);

            const startRecognition = () => {
                try {
                    recognitionRef.current?.start();
                } catch (e) {}
            };

            const detectLanguage = (text) => {
                // Simple regex based detection for common scripts, 
                // but usually the API returns the language used by the user.
                if (/[\u0600-\u06FF]/.test(text)) return 'ar-SA';
                if (/[\u4E00-\u9FFF]/.test(text)) return 'zh-CN';
                if (/[\u0400-\u04FF]/.test(text)) return 'ru-RU';
                if (/[\u0590-\u05FF]/.test(text)) return 'he-IL';
                if (/[\u3040-\u309F\u30A0-\u30FF]/.test(text)) return 'ja-JP';
                return 'en-US';
            };

            const speak = (text) => {
                synth.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = synth.getVoices();
                
                // Determine appropriate voice based on content
                const detectedLang = detectLanguage(text);
                const langPrefix = detectedLang.split('-')[0];
                
                // Try to find a voice matching the specific language code or at least the language prefix
                const matchVoice = voices.find(v => v.lang === detectedLang) || 
                                   voices.find(v => v.lang.startsWith(langPrefix)) ||
                                   voices.find(v => v.name.includes("Google") && v.lang.startsWith("en")) || 
                                   voices[0];
                
                if (matchVoice) {
                    utterance.voice = matchVoice;
                    utterance.lang = matchVoice.lang;
                }

                utterance.onstart = () => setVoiceStatus("Speaking...");
                utterance.onend = () => {
                    setVoiceStatus("Listening...");
                    if (isVoiceMode) {
                        setTimeout(() => startRecognition(), 400);
                    }
                };

                synth.speak(utterance);
            };

            const activateVoiceSession = () => {
                setHasActivatedVoice(true);
                setVoiceStatus("Listening...");
                // Note: The welcome message remains in English by default, but it will detect and reply in whatever language the user uses next.
                const welcome = "Hello! I am Nix 3. I support all languages. How can I help you today?";
                setMessages(prev => [...prev, { role: 'assistant', content: welcome, id: Date.now() }]);
                speak(welcome);
            };

            const toggleVoiceMode = () => {
                if (!isVoiceMode) {
                    setIsVoiceMode(true);
                    setHasActivatedVoice(false);
                } else {
                    setIsVoiceMode(false);
                    setVoiceStatus("Idle");
                    synth.cancel();
                    recognitionRef.current?.stop();
                }
            };

            const copyToClipboard = (text) => {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            };

            const processQuery = async (query) => {
                if (!query.trim()) return;
                
                setMessages(prev => [...prev, { role: 'user', content: query, id: Date.now() }]);
                setIsTyping(true);

                try {
                    const local = await checkLocal(query);
                    let response;
                    
                    if (local) {
                        response = local;
                    } else {
                        response = await askAI(query);
                        saveToSheet(query, response);
                    }

                    setMessages(prev => [...prev, { role: 'assistant', content: response, id: Date.now() + 1 }]);
                    if (isVoiceMode) speak(response);
                    else setVoiceStatus("Idle");
                } catch (e) {
                    const err = "I'm having a connection issue.";
                    setMessages(prev => [...prev, { role: 'assistant', content: err, id: Date.now() + 2 }]);
                    if (isVoiceMode) speak(err);
                } finally {
                    setIsTyping(false);
                }
            };

            const checkLocal = async (q) => {
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tq=${encodeURIComponent("SELECT A, B")}&headers=0&t=${Date.now()}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/)[1]);
                    const norm = q.toLowerCase().trim();
                    const match = json.table.rows.find(r => r.c && r.c[0] && String(r.c[0].v).toLowerCase().trim() === norm);
                    return match ? String(match.c[1].v) : null;
                } catch(e) { return null; }
            };

            const askAI = async (q) => {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "LongCat-Flash-Chat",
                        messages: [{ role: "user", content: q }],
                        temperature: 0.7
                    })
                });
                const data = await res.json();
                return data.choices[0].message.content;
            };

            const saveToSheet = (q, a) => {
                fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ values: [[q, a]] }) });
            };

            return (
                <div className="flex flex-col h-[100dvh] w-full bg-[#050505] text-gray-100">
                    <header className="flex items-center justify-between p-4 px-6 glass border-b border-white/5 z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center">
                                <span className="text-white font-black text-[10px]">N3</span>
                            </div>
                            <h1 className="font-bold text-sm tracking-widest uppercase opacity-80">Nix 3 AI</h1>
                        </div>
                    </header>

                    <main ref={scrollRef} className="flex-1 overflow-y-auto px-4 pt-6 pb-32 chat-container">
                        <div className="max-w-2xl mx-auto space-y-6">
                            {messages.length === 0 && !isVoiceMode && (
                                <div className="h-[60vh] flex flex-col items-center justify-center text-center opacity-40">
                                    <div className="w-16 h-16 bg-white/5 rounded-3xl flex items-center justify-center mb-4">
                                        <span className="text-2xl">üåç</span>
                                    </div>
                                    <h2 className="text-lg font-bold">Nix 3 - Universal</h2>
                                    <p className="text-xs">Speak or type in any language</p>
                                </div>
                            )}

                            {!isVoiceMode ? (
                                messages.map((msg) => (
                                    <div key={msg.id} className={`flex gap-3 message-anim ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                        <div className={`w-7 h-7 rounded-md flex-shrink-0 flex items-center justify-center text-[9px] font-bold ${msg.role === 'user' ? 'bg-white/10' : 'bg-indigo-600 text-white'}`}>
                                            {msg.role === 'user' ? 'U' : 'N'}
                                        </div>
                                        <div className={`max-w-[85%] ${msg.role === 'user' ? 'text-right' : ''}`}>
                                            <div className={`p-3 px-4 rounded-2xl text-[14px] leading-relaxed ${msg.role === 'user' ? 'bg-neutral-900 border border-white/5 text-white' : 'bg-transparent text-gray-300'}`}>
                                                {msg.content}
                                            </div>
                                            {msg.role === 'assistant' && (
                                                <div className="flex gap-4 mt-2 px-1">
                                                    <button onClick={() => copyToClipboard(msg.content)} className="flex items-center gap-1 text-[9px] font-bold opacity-30 hover:opacity-100 transition-opacity uppercase tracking-wider">
                                                        <span>üìã</span> Copy
                                                    </button>
                                                    <button onClick={() => speak(msg.content)} className="flex items-center gap-1 text-[9px] font-bold opacity-30 hover:opacity-100 transition-opacity uppercase tracking-wider">
                                                        <span>üîä</span> Hear
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="h-[60vh] flex flex-col items-center justify-center text-center">
                                    {!hasActivatedVoice ? (
                                        <div className="space-y-6">
                                            <div className="w-20 h-20 bg-indigo-600/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                                <svg className="w-10 h-10 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                                            </div>
                                            <h2 className="text-xl font-bold">Nix 3 Voice Mode</h2>
                                            <p className="text-gray-400 text-sm max-w-xs mx-auto">I'll listen and respond in your language.</p>
                                            <div className="flex flex-col gap-3">
                                                <button 
                                                    onClick={activateVoiceSession}
                                                    className="bg-indigo-600 hover:bg-indigo-500 px-8 py-4 rounded-2xl font-bold text-sm tracking-widest uppercase shadow-xl shadow-indigo-500/20 active:scale-95 transition-all"
                                                >
                                                    Start Session
                                                </button>
                                                <button 
                                                    onClick={toggleVoiceMode}
                                                    className="text-white/40 text-[10px] uppercase font-bold tracking-widest hover:text-white"
                                                >
                                                    Back to Text
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="voice-wave mb-8">
                                                {[...Array(8)].map((_, i) => (
                                                    <div 
                                                        key={i} 
                                                        className={`bar ${voiceStatus === 'Listening...' || voiceStatus === 'Speaking...' ? 'bar-active' : ''}`}
                                                        style={{ animationDelay: `${i * 0.15}s` }}
                                                    ></div>
                                                ))}
                                            </div>
                                            <div className="text-sm font-black tracking-[0.4em] uppercase opacity-40 animate-pulse">
                                                {voiceStatus}
                                            </div>
                                            <button 
                                                onClick={toggleVoiceMode}
                                                className="mt-12 px-6 py-2 rounded-xl bg-white/5 border border-white/10 text-[10px] font-bold uppercase tracking-widest hover:bg-red-500/20 hover:text-red-400 hover:border-red-500/40 transition-all"
                                            >
                                                End Voice Mode
                                            </button>
                                        </>
                                    )}
                                </div>
                            )}

                            {!isVoiceMode && isTyping && (
                                <div className="flex gap-3 items-center opacity-40 px-2">
                                    <div className="flex gap-1">
                                        <div className="w-1 h-1 bg-white rounded-full animate-bounce"></div>
                                        <div className="w-1 h-1 bg-white rounded-full animate-bounce [animation-delay:0.2s]"></div>
                                        <div className="w-1 h-1 bg-white rounded-full animate-bounce [animation-delay:0.4s]"></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {!isVoiceMode && (
                        <div className="fixed bottom-0 left-0 right-0 p-4 pb-8 glass border-t border-white/5 z-50">
                            <div className="max-w-2xl mx-auto flex gap-2">
                                <input 
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Type a message..."
                                    className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-indigo-500/50 text-sm transition-all"
                                    onKeyDown={(e) => e.key === 'Enter' && processQuery(input) && setInput("")}
                                />
                                {input.trim() === "" ? (
                                    <button 
                                        onClick={toggleVoiceMode}
                                        className="bg-white/5 border border-white/10 text-white/60 w-12 h-12 rounded-xl flex items-center justify-center active:scale-95 transition-all hover:bg-indigo-600/20 hover:text-indigo-400 hover:border-indigo-500/40"
                                        title="Switch to Voice Mode"
                                    >
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => { processQuery(input); setInput(""); }}
                                        className="bg-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center active:scale-95 transition-all shadow-lg shadow-indigo-600/20"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M5 12h14M12 5l7 7-7 7"/></svg>
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

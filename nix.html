<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nix 1 - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .message {
            white-space: pre-wrap;
        }
        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: -0.32s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            } 40% {
                transform: scale(1.0);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">

    <div class="flex-1 flex flex-col items-center justify-center p-4" id="initial-view">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-4 shadow-lg">
            <span class="text-3xl font-bold">N</span>
        </div>
        <h1 class="text-4xl font-bold text-gray-300">How can I assist you?</h1>
    </div>

    <div id="chat-container" class="chat-container flex-1 overflow-y-auto p-4 space-y-4 hidden">
        <!-- Chat messages will be appended here -->
    </div>

    <div class="p-4 bg-gray-900">
        <div class="max-w-3xl mx-auto relative">
            <div id="command-suggestions" class="absolute bottom-full mb-2 w-full bg-gray-700 rounded-lg shadow-xl overflow-hidden hidden z-10">
                <!-- Command suggestions will be injected here by JavaScript -->
            </div>
             <form id="askForm" class="flex items-center bg-gray-800 rounded-full p-2 shadow-xl">
                <input 
                    type="text" 
                    id="question" 
                    placeholder="Ask Nix 1 anything, or type / for commands..." 
                    required
                    class="flex-1 bg-transparent text-white border-none focus:outline-none px-4"
                    autocomplete="off">
                <button 
                    type="submit"
                    id="send-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full p-3 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:bg-gray-600 disabled:cursor-not-allowed">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        const askForm = document.getElementById("askForm");
        const questionInput = document.getElementById("question");
        const sendButton = document.getElementById("send-button");
        const initialView = document.getElementById("initial-view");
        const chatContainer = document.getElementById("chat-container");
        const commandSuggestionsContainer = document.getElementById("command-suggestions");
        
        const webhookUrl = "https://cloud.activepieces.com/api/v1/webhooks/j114iudpzFIY9Q5HeLsLI/sync";
        let isFirstMessage = true;

        const commands = [
            { name: '/image', description: 'Generate an image from your text.' },
            { name: '/video', description: 'Create a video from your text.' },
            { name: '/audio', description: 'Create a voice response from your text.' },
        ];

        const addMessage = (message, sender, options = {}) => {
            const { isError = false, imageUrl = null, videoUrl = null, audioUrl = null } = options;
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'rounded-2xl', 'p-4', 'max-w-lg', 'break-words');
            
            if (isError) {
                messageDiv.classList.add('bg-red-800', 'text-white');
                messageDiv.textContent = message;
            } else if (sender === 'user') {
                messageDiv.classList.add('bg-blue-600', 'text-white');
                messageDiv.textContent = message;
            } else { // AI message
                messageDiv.classList.add('bg-gray-700', 'text-gray-200');
                
                messageDiv.innerHTML = ''; // Clear any default content

                if (message) {
                    const textElement = document.createElement('p');
                    textElement.textContent = message;
                    messageDiv.appendChild(textElement);
                }

                if (imageUrl) {
                    const imageElement = document.createElement('img');
                    imageElement.src = imageUrl;
                    imageElement.alt = "AI Response";
                    imageElement.classList.add('rounded-lg', 'max-w-full', 'h-auto', 'mt-2');
                    imageElement.onload = () => chatContainer.scrollTop = chatContainer.scrollHeight;
                    messageDiv.appendChild(imageElement);
                }

                if (videoUrl) {
                    const videoElement = document.createElement('video');
                    videoElement.src = videoUrl;
                    videoElement.controls = true;
                    videoElement.autoplay = true;
                    videoElement.muted = true; // Autoplay requires the video to be muted
                    videoElement.playsinline = true; // Essential for iOS support
                    videoElement.classList.add('rounded-lg', 'max-w-full', 'h-auto', 'mt-2');
                    videoElement.onloadeddata = () => chatContainer.scrollTop = chatContainer.scrollHeight;
                    messageDiv.appendChild(videoElement);
                }

                if (audioUrl) {
                    const audioContainer = document.createElement('div');
                    audioContainer.classList.add('mt-2');

                    const audioElement = document.createElement('audio');
                    audioElement.src = audioUrl;
                    audioElement.controls = true;
                    audioElement.classList.add('w-full', 'max-w-xs');
                    audioElement.onloadeddata = () => chatContainer.scrollTop = chatContainer.scrollHeight;
                    audioContainer.appendChild(audioElement);

                    const downloadLink = document.createElement('a');
                    downloadLink.href = audioUrl;
                    downloadLink.download = true; // This attribute prompts the user to download the link's URL
                    downloadLink.classList.add('inline-flex', 'items-center', 'text-sm', 'text-blue-400', 'hover:text-blue-300', 'mt-2', 'bg-gray-800', 'hover:bg-gray-600', 'px-3', 'py-1', 'rounded-full', 'transition-colors', 'duration-200', 'no-underline');
                    downloadLink.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Download
                    `;
                    audioContainer.appendChild(downloadLink);
                    
                    messageDiv.appendChild(audioContainer);
                }
            }
            
            messageWrapper.appendChild(messageDiv);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const showLoadingIndicator = () => {
            const loadingWrapper = document.createElement('div');
            loadingWrapper.id = 'loading-indicator';
            loadingWrapper.classList.add('flex', 'justify-start');
            
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('bg-gray-700', 'rounded-2xl', 'p-4', 'flex', 'items-center', 'space-x-2');
            
            for(let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.classList.add('loading-dot', 'w-2', 'h-2', 'bg-gray-400', 'rounded-full');
                loadingDiv.appendChild(dot);
            }

            loadingWrapper.appendChild(loadingDiv);
            chatContainer.appendChild(loadingWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        
        const removeLoadingIndicator = () => {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        const renderSuggestions = (filteredCommands) => {
            commandSuggestionsContainer.innerHTML = '';
            if (filteredCommands.length === 0) {
                commandSuggestionsContainer.classList.add('hidden');
                return;
            }

            filteredCommands.forEach(command => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('p-3', 'hover:bg-gray-600', 'cursor-pointer', 'transition-colors');
                suggestionItem.innerHTML = `<div class="font-semibold text-white">${command.name}</div><div class="text-sm text-gray-400">${command.description}</div>`;
                
                suggestionItem.addEventListener('mousedown', (e) => { // Use mousedown to fire before blur
                    e.preventDefault();
                    questionInput.value = command.name + ' ';
                    commandSuggestionsContainer.classList.add('hidden');
                    questionInput.focus();
                });

                commandSuggestionsContainer.appendChild(suggestionItem);
            });

            commandSuggestionsContainer.classList.remove('hidden');
        };

        questionInput.addEventListener('input', () => {
            const value = questionInput.value;
            if (value.startsWith('/')) {
                const searchTerm = value.substring(1).toLowerCase();
                const filteredCommands = commands.filter(command => 
                    command.name.substring(1).toLowerCase().startsWith(searchTerm)
                );
                renderSuggestions(filteredCommands);
            } else {
                commandSuggestionsContainer.classList.add('hidden');
            }
        });

        questionInput.addEventListener('blur', () => {
            setTimeout(() => {
                commandSuggestionsContainer.classList.add('hidden');
            }, 150);
        });

        askForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            commandSuggestionsContainer.classList.add('hidden');
            const question = questionInput.value.trim();
            if (!question) return;

            if (isFirstMessage) {
                initialView.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                isFirstMessage = false;
            }

            addMessage(question, 'user');
            questionInput.value = '';
            sendButton.disabled = true;
            
            showLoadingIndicator();

            try {
                const res = await fetch(webhookUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question })
                });
                
                removeLoadingIndicator();

                if (!res.ok) {
                    const errorText = await res.text();
                     if (res.status === 500 && errorText.includes("The flow has failed")) {
                         throw new Error(`The ActivePieces flow failed. Please check your flow's run history for errors.`);
                    }
                    throw new Error(`Server error: ${res.status}. Please try again later.`);
                }

                const responseText = await res.text();
                let answerText = null;
                let imageUrl = null;
                let videoUrl = null;
                let audioUrl = null;

                try {
                    // Try to parse the response as JSON
                    const data = JSON.parse(responseText);
                    answerText = data.answer || null;
                    imageUrl = data.image || null;
                    videoUrl = data.video || null;
                    audioUrl = data.audio || null;
                } catch (jsonError) {
                    // If parsing fails, it's not JSON. Treat the whole response as a text answer.
                    answerText = responseText;
                }


                if (answerText || imageUrl || videoUrl || audioUrl) {
                    addMessage(answerText, 'ai', { imageUrl, videoUrl, audioUrl });
                } else {
                    addMessage("Sorry, I couldn't find an answer. Please check your ActivePieces flow output.", 'ai', { isError: true });
                }

            } catch (error) {
                removeLoadingIndicator();
                console.error("Error fetching answer:", error);
                addMessage(error.message, 'ai', { isError: true });
            } finally {
                sendButton.disabled = false;
                questionInput.focus();
            }
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qurany - إذاعات القرآن الكريم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            scroll-behavior: smooth;
            background-color: #020617;
            color: #f8fafc;
        }

        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 0% 0%, rgba(30, 58, 138, 0.3) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(15, 23, 42, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(30, 64, 175, 0.1) 0%, transparent 60%);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .player-card {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.4) 0%, rgba(15, 23, 42, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .station-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .station-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .active-station {
            background: white !important;
            color: #0f172a !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Volume & Progress Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .is-playing .listening-indicator {
            display: flex;
            animation: pulse-soft 2s infinite;
        }

        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            background-size: 1rem;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="mesh-bg"></div>

    <div class="container mx-auto px-4 py-6 md:py-10 max-w-6xl">
        
        <!-- Header Nav -->
        <nav class="flex justify-between items-center mb-12">
            <a href="portal.html" class="flex items-center gap-2 text-white/70 hover:text-white transition-colors group">
                <div class="p-2 rounded-lg bg-white/5 group-hover:bg-white/10">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </div>
                <span class="font-medium">العودة</span>
            </a>
            <div class="flex items-center gap-2">
                <span class="text-xl font-bold tracking-tighter text-white">QURANY</span>
                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Side: Player & Sidebar -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Main Player Card -->
                <div id="playerContainer" class="player-card rounded-[2.5rem] p-8 sticky top-6 shadow-2xl overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex flex-col items-center text-center">
                            <div class="relative mb-8">
                                <div id="diskVisualizer" class="w-48 h-48 rounded-full border-4 border-white/10 flex items-center justify-center bg-gradient-to-br from-blue-600/20 to-transparent relative overflow-hidden">
                                    <svg class="w-24 h-24 text-white/20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path></svg>
                                    <div id="visualizerBars" class="absolute inset-0 flex items-end justify-center gap-1 p-8 opacity-40">
                                        <!-- Bars added via JS -->
                                    </div>
                                </div>
                                <button id="playPauseBtn" class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 w-16 h-16 rounded-full bg-white text-blue-900 flex items-center justify-center shadow-xl hover:scale-110 transition-transform active:scale-95">
                                    <svg id="playIcon" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5.14v14l11-7-11-7z"></path></svg>
                                    <svg id="pauseIcon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                                </button>
                            </div>

                            <div class="mt-10 w-full">
                                <span class="listening-indicator hidden items-center justify-center gap-2 text-blue-400 text-xs font-bold uppercase tracking-widest mb-2">
                                    <span class="flex gap-0.5">
                                        <span class="w-1 h-3 bg-current animate-bounce"></span>
                                        <span class="w-1 h-3 bg-current animate-bounce" style="animation-delay: 0.1s"></span>
                                        <span class="w-1 h-3 bg-current animate-bounce" style="animation-delay: 0.2s"></span>
                                    </span>
                                    مباشر الآن
                                </span>
                                <h2 id="stationName" class="text-2xl font-bold text-white mb-6 line-clamp-2 min-h-[4rem]">اختر إذاعة للبدء</h2>
                                
                                <div class="space-y-4 px-2">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 012.828 2.828"></path></svg>
                                        <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.8" class="flex-grow accent-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reciters Picker -->
                <div class="glass-panel rounded-3xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                        المصحف المرتل
                    </h3>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] text-white/40 font-bold uppercase pr-1">القارئ</label>
                            <select id="reciterSelect" class="custom-select w-full bg-white/5 border border-white/10 p-3 rounded-xl focus:ring-1 ring-white/20 outline-none text-sm cursor-pointer">
                                <option disabled selected>جاري التحميل...</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-white/40 font-bold uppercase pr-1">السورة</label>
                            <select id="surahSelect" class="custom-select w-full bg-white/5 border border-white/10 p-3 rounded-xl focus:ring-1 ring-white/20 outline-none text-sm cursor-pointer disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                                <option disabled selected>اختر القارئ أولاً</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Station List -->
            <div class="lg:col-span-8 flex flex-col">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-1">المحطات الإذاعية</h1>
                        <p class="text-white/40 text-sm">استمع إلى البث المباشر لأكثر من ١٠٠ إذاعة قرآنية</p>
                    </div>
                    <div class="relative">
                        <input id="searchInput" type="text" placeholder="بحث باسم الإذاعة..." class="w-full md:w-72 bg-white/5 border border-white/10 rounded-2xl py-3 px-12 focus:ring-1 ring-white/20 outline-none text-sm backdrop-blur-md">
                        <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading" class="flex-grow flex flex-col items-center justify-center py-24 glass-panel rounded-[2rem]">
                    <div class="relative w-12 h-12 mb-4">
                        <div class="absolute inset-0 border-2 border-white/10 rounded-full"></div>
                        <div class="absolute inset-0 border-t-2 border-blue-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-white/30 text-sm font-medium">جاري تحديث قائمة الإذاعات</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden flex-grow flex flex-col items-center justify-center py-24 opacity-50">
                    <svg class="w-16 h-16 mb-4 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 9.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p>لا توجد نتائج مطابقة لبحثك</p>
                </div>

                <div id="stationsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-3 pb-12">
                    <!-- Stations injected here -->
                </div>
            </div>
        </div>

        <footer class="mt-12 py-8 border-t border-white/5 text-center">
            <p class="text-white/20 text-xs">تطبيق قرآني &copy; ٢٠٢٤ - جميع الحقوق محفوظة</p>
        </footer>
    </div>

    <audio id="audioPlayer" preload="none"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const audioPlayer = document.getElementById('audioPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            const volumeSlider = document.getElementById('volumeSlider');
            const stationNameDisplay = document.getElementById('stationName');
            const stationsGrid = document.getElementById('stationsGrid');
            const loadingIndicator = document.getElementById('loading');
            const reciterSelect = document.getElementById('reciterSelect');
            const surahSelect = document.getElementById('surahSelect');
            const searchInput = document.getElementById('searchInput');
            const playerContainer = document.getElementById('playerContainer');
            const visualizerBarsContainer = document.getElementById('visualizerBars');
            const emptyState = document.getElementById('emptyState');

            let isPlaying = false;
            let currentActiveEl = null;
            let allStations = [];
            let allReciters = [];
            let allSurahs = [];

            // Static stations (Fallbacks)
            const staticStations = [
                { name: "إذاعة القرآن الكريم من القاهرة", url: "https://n11.radiojar.com/8s5u5tpdtwzuv?rj-ttl=5" },
                { name: "إذاعة القرآن الكريم من مكة", url: "https://stream.radiojar.com/8s5u5tpdtwzuv" }
            ];

            // Setup Visualizer UI
            for(let i=0; i<8; i++) {
                const bar = document.createElement('div');
                bar.className = 'w-1.5 bg-blue-500/50 rounded-full transition-all duration-300';
                bar.style.height = '10%';
                visualizerBarsContainer.appendChild(bar);
            }

            function updateVisualizer() {
                if (!audioPlayer.paused) {
                    Array.from(visualizerBarsContainer.children).forEach(bar => {
                        const h = Math.floor(Math.random() * 60) + 20;
                        bar.style.height = h + '%';
                    });
                } else {
                    Array.from(visualizerBarsContainer.children).forEach(bar => bar.style.height = '10%');
                }
            }
            setInterval(updateVisualizer, 150);

            function togglePlayPause() {
                if (!audioPlayer.src) return;
                if (audioPlayer.paused) {
                    audioPlayer.play().catch(e => console.error(e));
                } else {
                    audioPlayer.pause();
                }
            }

            function updateUIState() {
                isPlaying = !audioPlayer.paused;
                playIcon.classList.toggle('hidden', isPlaying);
                pauseIcon.classList.toggle('hidden', !isPlaying);
                playerContainer.classList.toggle('is-playing', isPlaying);
                
                if (isPlaying) {
                    document.querySelector('.listening-indicator').classList.remove('hidden');
                    document.querySelector('.listening-indicator').classList.add('flex');
                } else {
                    document.querySelector('.listening-indicator').classList.add('hidden');
                }
            }

            function playSource(name, url, el = null) {
                stationNameDisplay.textContent = name;
                audioPlayer.src = url;
                audioPlayer.play().catch(e => {
                    console.error("Playback error", e);
                    stationNameDisplay.textContent = "خطأ في تشغيل المحطة";
                });

                if (currentActiveEl) currentActiveEl.classList.remove('active-station');
                if (el) {
                    el.classList.add('active-station');
                    currentActiveEl = el;
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            function renderStations(list) {
                stationsGrid.innerHTML = '';
                if(list.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }

                list.forEach(station => {
                    const div = document.createElement('div');
                    div.className = 'station-card glass-panel rounded-2xl p-5 cursor-pointer flex justify-between items-center group';
                    div.innerHTML = `
                        <div class="flex items-center gap-4 flex-grow overflow-hidden">
                            <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center flex-shrink-0 group-hover:bg-blue-500/20 group-hover:text-blue-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
                            </div>
                            <span class="font-semibold text-sm line-clamp-1">${station.name}</span>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity pr-2">
                             <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                             </div>
                        </div>
                    `;
                    div.onclick = () => playSource(station.name, station.url, div);
                    stationsGrid.appendChild(div);
                });
            }

            searchInput.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allStations.filter(s => s.name.toLowerCase().includes(term));
                renderStations(filtered);
            };

            playPauseBtn.onclick = togglePlayPause;
            audioPlayer.onplay = updateUIState;
            audioPlayer.onpause = updateUIState;
            volumeSlider.oninput = (e) => audioPlayer.volume = e.target.value;

            async function init() {
                try {
                    const [radioRes, recitersRes, suwarRes] = await Promise.all([
                        fetch('https://www.mp3quran.net/api/v3/radios'),
                        fetch('https://www.mp3quran.net/api/v3/reciters?language=ar'),
                        fetch('https://www.mp3quran.net/api/v3/suwar?language=ar')
                    ]);

                    const radioData = await radioRes.json();
                    const reciterData = await recitersRes.json();
                    const suwarData = await suwarRes.json();

                    allStations = [...staticStations, ...radioData.radios.map(r => ({name: r.name, url: r.url}))];
                    loadingIndicator.classList.add('hidden');
                    renderStations(allStations);

                    allReciters = reciterData.reciters;
                    allSurahs = suwarData.suwar;
                    
                    reciterSelect.innerHTML = '<option selected disabled>اختر القارئ...</option>';
                    allReciters.forEach(r => {
                        const moshaf = r.moshaf.find(m => m.name.includes("حفص")) || r.moshaf[0];
                        const opt = document.createElement('option');
                        opt.value = r.id;
                        opt.textContent = r.name;
                        opt.dataset.server = moshaf.server;
                        opt.dataset.surahs = moshaf.surah_list;
                        reciterSelect.appendChild(opt);
                    });

                } catch (err) {
                    console.error("API Error", err);
                    loadingIndicator.innerHTML = '<p class="text-red-400">حدث خطأ أثناء تحميل البيانات</p>';
                }
            }

            reciterSelect.onchange = (e) => {
                const opt = e.target.options[e.target.selectedIndex];
                const availableIds = opt.dataset.surahs.split(',');
                
                surahSelect.innerHTML = '<option selected disabled>اختر السورة...</option>';
                availableIds.forEach(id => {
                    const s = allSurahs.find(item => item.id == id);
                    if(s) {
                        const sOpt = document.createElement('option');
                        sOpt.value = id;
                        sOpt.textContent = s.name;
                        surahSelect.appendChild(sOpt);
                    }
                });
                surahSelect.disabled = false;
            };

            surahSelect.onchange = (e) => {
                const rOpt = reciterSelect.options[reciterSelect.selectedIndex];
                const sOpt = e.target.options[e.target.selectedIndex];
                const server = rOpt.dataset.server;
                const fileId = String(e.target.value).padStart(3, '0');
                const url = `${server}/${fileId}.mp3`;
                playSource(`${sOpt.textContent} - ${rOpt.textContent}`, url);
            };

            init();
        });
    </script>
</body>
</html>

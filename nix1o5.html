<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nix 1.5 - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .message {
            white-space: pre-wrap;
        }
        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: -0.32s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            } 40% {
                transform: scale(1.0);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">

    <div id="error-banner" class="hidden bg-red-600 text-white p-3 text-center">
        <span class="font-bold">Configuration Error:</span> The Webhook URL is incorrect. Please follow the instructions in the code to fix it.
    </div>

    <div class="flex-1 flex flex-col items-center justify-center p-4" id="initial-view">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-4 shadow-lg">
            <span class="text-3xl font-bold">N</span>
        </div>
        <h1 class="text-4xl font-bold text-gray-300">Nix 1.5</h1>
        <h2 class="text-2xl text-gray-400">How can I assist you?</h2>
    </div>

    <div id="chat-container" class="chat-container flex-1 overflow-y-auto p-4 space-y-4 hidden">
        <!-- Chat messages will be appended here -->
    </div>

    <div class="p-4 bg-gray-900">
        <div class="max-w-3xl mx-auto relative">
            <div id="command-suggestions" class="absolute bottom-full mb-2 w-full bg-gray-700 rounded-lg shadow-xl overflow-hidden hidden z-10">
                <!-- Command suggestions will be injected here by JavaScript -->
            </div>
            <div id="file-preview-container" class="hidden flex justify-between items-center bg-gray-700 rounded-md px-3 py-2 mb-2 text-sm">
                <div class="flex items-center min-w-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mr-2 flex-shrink-0"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    <span id="file-name" class="text-gray-300 truncate"></span>
                </div>
                <button id="remove-file-button" class="text-gray-400 hover:text-white text-xl font-bold">&times;</button>
            </div>
             <form id="askForm" class="flex items-center bg-gray-800 rounded-full p-2 shadow-xl">
                 <input type="file" id="file-input" class="hidden">
                 <button type="button" id="upload-button" class="p-2 text-gray-400 hover:text-white focus:outline-none">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-paperclip"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                 </button>
                 <input 
                     type="text" 
                     id="question" 
                     placeholder="Ask Nix 1.5 anything..." 
                     class="flex-1 bg-transparent text-white border-none focus:outline-none px-2"
                     autocomplete="off">
                 <button 
                     type="submit"
                     id="send-button"
                     class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full p-3 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:bg-gray-600 disabled:cursor-not-allowed">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                 </button>
             </form>
        </div>
    </div>

    <script>
        const askForm = document.getElementById("askForm");
        const questionInput = document.getElementById("question");
        const sendButton = document.getElementById("send-button");
        const initialView = document.getElementById("initial-view");
        const chatContainer = document.getElementById("chat-container");
        const commandSuggestionsContainer = document.getElementById("command-suggestions");
        const errorBanner = document.getElementById("error-banner");
        const uploadButton = document.getElementById("upload-button");
        const fileInput = document.getElementById("file-input");
        const filePreviewContainer = document.getElementById("file-preview-container");
        const fileNameSpan = document.getElementById("file-name");
        const removeFileButton = document.getElementById("remove-file-button");
        
        const webhookUrl = "https://cloud.activepieces.com/api/v1/webhooks/WR43cDYER0O9TiHq8exAH/sync";
        let isFirstMessage = true;

        const commands = [
            { name: '/image', description: 'Generate an image from your text.' },
            { name: '/video', description: 'Create a video from your text.' },
            { name: '/audio', description: 'Create a voice response from your text.' },
            { name: '/qr', description: 'Generate a QR code from your text.' },
            { name: '/file', description: 'Process the uploaded file with your text.' },
            { name: '/doc', description: 'Process the uploaded document with your text.' },
            { name: '/code', description: 'Generate a code snippet.' },
        ];
        
        // --- Helper Functions for creating UI elements ---

        function linkify(text) {
            if (!text) return '';
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return sanitizedText.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">${url}</a>`);
        }

        function createMediaElement(tag, src) {
            const element = document.createElement(tag);
            element.src = src;
            element.classList.add('rounded-lg', 'max-w-full', 'h-auto', 'mt-2');
            element.onload = () => chatContainer.scrollTop = chatContainer.scrollHeight;
            if (tag === 'video' || tag === 'audio') {
                element.controls = true;
                element.playsinline = true;
            }
            return element;
        }
        
        function createQrCodeElement(url) {
            const img = createMediaElement('img', url);
            img.alt = "QR Code";
            img.classList.add('w-48', 'h-48');
            return img;
        }

        function createDownloadLink(url, isDoc = false) {
            const fileContainer = document.createElement('div');
            fileContainer.classList.add('mt-2');
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = true;
            downloadLink.target = "_blank";
            downloadLink.classList.add('inline-flex', 'items-center', 'text-sm', 'text-blue-400', 'hover:text-blue-300', 'mt-2', 'bg-gray-800', 'hover:bg-gray-600', 'px-3', 'py-1', 'rounded-full', 'transition-colors', 'duration-200', 'no-underline');
            const docIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
            const fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
            downloadLink.innerHTML = `${isDoc ? docIcon : fileIcon} Download ${isDoc ? 'Document' : 'File'}`;
            fileContainer.appendChild(downloadLink);
            return fileContainer;
        }

        function createButtons(buttons) {
            const container = document.createElement('div');
            container.classList.add('mt-3', 'flex', 'flex-wrap', 'gap-2');
            buttons.forEach(buttonInfo => {
                if (buttonInfo.text && buttonInfo.url) {
                    const button = document.createElement('a');
                    button.href = buttonInfo.url;
                    button.target = "_blank";
                    button.rel = "noopener noreferrer";
                    button.textContent = buttonInfo.text;
                    button.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'text-sm', 'font-semibold', 'py-2', 'px-4', 'rounded-full', 'transition-colors', 'duration-200', 'no-underline');
                    container.appendChild(button);
                }
            });
            return container;
        }

        function createCodeBlock(code, language) {
            const container = document.createElement('div');
            container.classList.add('bg-gray-800', 'rounded-lg', 'overflow-hidden', 'my-2');
            const header = document.createElement('div');
            header.classList.add('bg-black', 'bg-opacity-30', 'text-gray-400', 'text-xs', 'p-2', 'flex', 'justify-between', 'items-center');
            const langSpan = document.createElement('span');
            langSpan.textContent = language || 'code';
            header.appendChild(langSpan);
            const copyButton = document.createElement('button');
            copyButton.classList.add('flex', 'items-center', 'space-x-1', 'hover:text-white', 'text-gray-400', 'p-1', 'rounded-md', 'hover:bg-gray-700', 'transition-colors');
            const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
            copyButton.innerHTML = `${copyIcon}<span>Copy</span>`;
            copyButton.addEventListener('click', () => {
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyButton.innerHTML = `${copyIcon}<span>Copied!</span>`;
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    copyButton.innerHTML = `${copyIcon}<span>Error</span>`;
                }
                document.body.removeChild(textArea);
                setTimeout(() => {
                    copyButton.innerHTML = `${copyIcon}<span>Copy</span>`;
                }, 2000);
            });
            header.appendChild(copyButton);
            const pre = document.createElement('pre');
            pre.classList.add('p-4', 'text-sm', 'overflow-x-auto');
            const codeEl = document.createElement('code');
            codeEl.textContent = code;
            pre.appendChild(codeEl);
            container.appendChild(header);
            container.appendChild(pre);
            return container;
        }

        const addMessage = (sender, options = {}) => {
            const { message = '', isError = false, imageUrl = null, videoUrl = null, audioUrl = null, qrCodeUrl = null, fileUrl = null, docUrl = null, buttons = [] } = options;
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'rounded-2xl', 'p-4', 'max-w-lg', 'break-words');
            
            if (isError) {
                messageDiv.classList.add('bg-red-800', 'text-white');
                messageDiv.textContent = message;
            } else if (sender === 'user') {
                messageDiv.classList.add('bg-blue-600', 'text-white');
                messageDiv.textContent = message;
            } else { // AI message
                messageDiv.classList.add('bg-gray-700', 'text-gray-200');
                if (message) {
                    if (message.includes('```')) {
                        const parts = message.split('```');
                        parts.forEach((part, index) => {
                            if (part.trim() === '') return;
                            if (index % 2 === 0) {
                                const textElement = document.createElement('p');
                                textElement.innerHTML = linkify(part);
                                messageDiv.appendChild(textElement);
                            } else {
                                const langMatch = part.match(/^[a-z]+\n/);
                                const language = langMatch ? langMatch[0].trim() : '';
                                const code = langMatch ? part.substring(langMatch[0].length) : part;
                                messageDiv.appendChild(createCodeBlock(code.trim(), language));
                            }
                        });
                    } else {
                        const textElement = document.createElement('p');
                        textElement.innerHTML = linkify(message);
                        messageDiv.appendChild(textElement);
                    }
                }
                if (imageUrl) { messageDiv.appendChild(createMediaElement('img', imageUrl)); }
                if (videoUrl) { messageDiv.appendChild(createMediaElement('video', videoUrl)); }
                if (audioUrl) { messageDiv.appendChild(createMediaElement('audio', audioUrl)); }
                if (qrCodeUrl) { messageDiv.appendChild(createQrCodeElement(qrCodeUrl)); }
                if (docUrl) { messageDiv.appendChild(createDownloadLink(docUrl, true)); }
                if (fileUrl) { messageDiv.appendChild(createDownloadLink(fileUrl, false)); }
                if (buttons && buttons.length > 0) { messageDiv.appendChild(createButtons(buttons)); }
            }
            
            messageWrapper.appendChild(messageDiv);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        
        const showLoadingIndicator = () => {
            const loadingWrapper = document.createElement('div');
            loadingWrapper.id = 'loading-indicator';
            loadingWrapper.classList.add('flex', 'justify-start');
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('bg-gray-700', 'rounded-2xl', 'p-4', 'flex', 'items-center', 'space-x-2');
            const thinkingText = document.createElement('span');
            thinkingText.textContent = 'Nix is thinking';
            thinkingText.classList.add('text-gray-400', 'italic');
            loadingDiv.appendChild(thinkingText);
            for(let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.classList.add('loading-dot', 'w-2', 'h-2', 'bg-gray-400', 'rounded-full');
                loadingDiv.appendChild(dot);
            }
            loadingWrapper.appendChild(loadingDiv);
            chatContainer.appendChild(loadingWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const removeLoadingIndicator = () => {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        const renderSuggestions = (filteredCommands) => {
            commandSuggestionsContainer.innerHTML = '';
            if (filteredCommands.length === 0) {
                commandSuggestionsContainer.classList.add('hidden');
                return;
            }
            filteredCommands.forEach(command => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('p-3', 'hover:bg-gray-600', 'cursor-pointer', 'transition-colors');
                suggestionItem.innerHTML = `<div class="font-semibold text-white">${command.name}</div><div class="text-sm text-gray-400">${command.description}</div>`;
                suggestionItem.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    questionInput.value = command.name + ' ';
                    commandSuggestionsContainer.classList.add('hidden');
                    questionInput.focus();
                });
                commandSuggestionsContainer.appendChild(suggestionItem);
            });
            commandSuggestionsContainer.classList.remove('hidden');
        };

        // --- Event Listeners ---
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameSpan.textContent = fileInput.files[0].name;
                filePreviewContainer.classList.remove('hidden');
            }
        });
        removeFileButton.addEventListener('click', () => {
            fileInput.value = '';
            filePreviewContainer.classList.add('hidden');
        });
        questionInput.addEventListener('input', () => {
            const value = questionInput.value;
            if (value.startsWith('/')) {
                const searchTerm = value.substring(1).toLowerCase();
                const filteredCommands = commands.filter(command => command.name.substring(1).toLowerCase().startsWith(searchTerm));
                renderSuggestions(filteredCommands);
            } else {
                commandSuggestionsContainer.classList.add('hidden');
            }
        });
        questionInput.addEventListener('blur', () => {
            setTimeout(() => {
                commandSuggestionsContainer.classList.add('hidden');
            }, 150);
        });

        askForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const question = questionInput.value.trim();
            const file = fileInput.files[0];

            if (!question && !file) return;

            if (isFirstMessage) {
                initialView.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                isFirstMessage = false;
            }
            
            const userMessage = file ? `${question || 'Processing file'}: ${file.name}` : question;
            addMessage('user', { message: userMessage });
            
            questionInput.value = '';
            fileInput.value = '';
            filePreviewContainer.classList.add('hidden');
            sendButton.disabled = true;
            
            showLoadingIndicator();

            try {
                const formData = new FormData();
                formData.append('question', question);
                if (file) {
                    formData.append('file', file);
                }
                const res = await fetch(webhookUrl, {
                    method: "POST",
                    body: formData
                });
                removeLoadingIndicator();

                if (!res.ok) {
                    const errorText = await res.text();
                    if (res.status === 404) {
                         errorBanner.classList.remove('hidden');
                         throw new Error(`Connection failed (Error 404: Not Found). Please verify the webhookUrl in the code is correct and the flow is enabled.`);
                    }
                    throw new Error(`Server error: ${res.status}. ${errorText}`);
                }

                const responseText = await res.text();
                let options = {};

                try {
                    const data = JSON.parse(responseText);
                    options = {
                        message: data.answer || null,
                        imageUrl: data.image || null,
                        videoUrl: data.video || null,
                        audioUrl: data.audio || null,
                        qrCodeUrl: data.qr || null,
                        fileUrl: data.file || null,
                        docUrl: data.doc || null,
                        buttons: data.buttons || []
                    };
                } catch (jsonError) {
                    options = { message: responseText };
                }

                if (Object.values(options).some(val => val && (!Array.isArray(val) || val.length > 0))) {
                    addMessage('ai', options);
                } else {
                    addMessage('ai', { message: "Sorry, I received a response but it was empty.", isError: true });
                }

            } catch (error) {
                removeLoadingIndicator();
                addMessage('ai', { message: error.message, isError: true });
            } finally {
                sendButton.disabled = false;
                questionInput.focus();
            }
        });

    </script>
</body>
</html>


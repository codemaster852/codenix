<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebNix - AI Website Builder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1f2937', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .draggable-item { cursor: grab; }
        #editor-canvas { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .dark #editor-canvas { background-image: radial-gradient(#475569 1px, transparent 1px); }
        .selected-element { outline: 2px solid #9333ea; position: relative; }
        .selected-element::after {
            content: 'Selected'; position: absolute; top: -22px; left: 0; background: #9333ea;
            color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px 4px 0 0; z-index: 50;
        }
    </style>
</head>
<body class="bg-white dark:bg-slate-950 text-slate-800 dark:text-slate-100 h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[100] bg-white dark:bg-slate-950 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-600 mb-4"></div>
        <h2 class="text-xl font-semibold animate-pulse">WebNix Studio</h2>
    </div>

    <!-- Navbar -->
    <nav class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 h-16 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
            <h1 class="font-bold text-xl tracking-tight">WebNix</h1>
        </div>

        <div id="editor-controls" class="hidden flex items-center gap-4">
            <!-- Page Selector -->
            <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                <select id="page-selector" onchange="switchPage(this.value)" class="bg-transparent text-sm font-medium px-2 py-1 outline-none">
                    <!-- Pages Injected Here -->
                </select>
                <button onclick="addNewPage()" class="p-1 hover:text-purple-600" title="Add Page"><i class="fa-solid fa-plus-circle"></i></button>
            </div>

            <div class="h-6 w-px bg-slate-200 dark:bg-slate-700"></div>
            
            <button onclick="saveWebsite()" class="text-sm font-medium hover:text-purple-600"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> Save</button>
            <button onclick="exportCode()" class="text-sm font-medium hover:text-purple-600"><i class="fa-solid fa-code mr-1"></i> Export</button>
            <button onclick="publishWebsite()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">Publish</button>
            
            <button onclick="backToDashboard()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>

        <div id="dashboard-controls" class="flex items-center gap-4">
            <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                <i class="fa-solid fa-sun dark:hidden"></i><i class="fa-solid fa-moon hidden dark:block"></i>
            </button>
            <div id="user-info" class="text-sm font-medium">Loading...</div>
            <button onclick="signOut()" class="text-red-500 text-sm font-medium">Sign Out</button>
        </div>
    </nav>

    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- DASHBOARD -->
        <div id="dashboard-view" class="absolute inset-0 z-10 bg-slate-50 dark:bg-black p-8 overflow-y-auto w-full">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-end mb-8">
                    <h2 class="text-3xl font-bold">Your Projects</h2>
                    <button onclick="createNewProject()" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg font-medium">New Project</button>
                </div>
                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>

        <!-- EDITOR -->
        <div id="editor-view" class="hidden flex-1 flex w-full">
            <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shrink-0">
                <div class="p-4 border-b border-slate-100 dark:border-slate-800"><h3 class="text-xs font-bold text-slate-400 uppercase">Elements</h3></div>
                <div class="p-4 grid grid-cols-2 gap-3 overflow-y-auto">
                    <div draggable="true" ondragstart="drag(event)" data-type="heading" class="draggable-item bg-slate-50 dark:bg-slate-800 p-3 rounded-lg flex flex-col items-center gap-2 border border-slate-200 dark:border-slate-700">
                        <i class="fa-solid fa-heading text-xl"></i><span class="text-xs">Header</span>
                    </div>
                    <div draggable="true" ondragstart="drag(event)" data-type="text" class="draggable-item bg-slate-50 dark:bg-slate-800 p-3 rounded-lg flex flex-col items-center gap-2 border border-slate-200 dark:border-slate-700">
                        <i class="fa-solid fa-paragraph text-xl"></i><span class="text-xs">Text</span>
                    </div>
                    <div draggable="true" ondragstart="drag(event)" data-type="button" class="draggable-item bg-slate-50 dark:bg-slate-800 p-3 rounded-lg flex flex-col items-center gap-2 border border-slate-200 dark:border-slate-700">
                        <i class="fa-solid fa-link text-xl"></i><span class="text-xs">Button</span>
                    </div>
                    <div draggable="true" ondragstart="drag(event)" data-type="image" class="draggable-item bg-slate-50 dark:bg-slate-800 p-3 rounded-lg flex flex-col items-center gap-2 border border-slate-200 dark:border-slate-700">
                        <i class="fa-solid fa-image text-xl"></i><span class="text-xs">Image</span>
                    </div>
                    <div draggable="true" ondragstart="drag(event)" data-type="container" class="draggable-item bg-slate-50 dark:bg-slate-800 p-3 rounded-lg flex flex-col items-center gap-2 border border-slate-200 dark:border-slate-700">
                        <i class="fa-solid fa-box text-xl"></i><span class="text-xs">Box</span>
                    </div>
                    <div draggable="true" ondragstart="drag(event)" data-type="spacer" class="draggable-item bg-slate-50 dark:bg-slate-800 p-3 rounded-lg flex flex-col items-center gap-2 border border-slate-200 dark:border-slate-700">
                        <i class="fa-solid fa-arrows-up-down text-xl"></i><span class="text-xs">Spacer</span>
                    </div>
                </div>
            </aside>

            <main class="flex-1 bg-slate-100 dark:bg-slate-950 flex justify-center overflow-auto p-8" onclick="deselectAll(event)">
                <div id="editor-canvas" class="bg-white dark:bg-slate-900 w-full max-w-4xl min-h-[800px] shadow-lg p-8" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
            </main>

            <!-- Properties -->
            <aside id="properties-panel" class="w-72 bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 flex flex-col shrink-0 transform translate-x-full transition-transform duration-300 absolute right-0 h-full z-20 shadow-xl">
                <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between">
                    <h3 class="text-xs font-bold uppercase">Properties</h3>
                    <button onclick="closeProperties()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-4 space-y-4 overflow-y-auto">
                    <div id="prop-text-group" class="hidden">
                        <label class="block text-xs font-medium mb-1">Content</label>
                        <textarea id="prop-text" oninput="updateElementText(this.value)" class="w-full bg-slate-50 dark:bg-slate-800 border rounded p-2 text-sm" rows="3"></textarea>
                    </div>
                    <div id="prop-link-group" class="hidden">
                        <label class="block text-xs font-medium mb-1">Link Target</label>
                        <select id="prop-link-select" onchange="updateElementLink(this.value)" class="w-full bg-slate-50 dark:bg-slate-800 border rounded p-2 text-sm mb-2">
                            <option value="">External URL</option>
                        </select>
                        <input type="text" id="prop-link-raw" oninput="updateElementLink(this.value)" class="w-full bg-slate-50 dark:bg-slate-800 border rounded p-2 text-sm" placeholder="https://...">
                    </div>
                    <div id="prop-size-group">
                        <label class="block text-xs font-medium mb-1">Width (%)</label>
                        <input type="range" min="10" max="100" oninput="updateSize('width', this.value + '%')" class="w-full accent-purple-600">
                        <label class="block text-xs font-medium mt-2 mb-1">Height (px - auto for 0)</label>
                        <input type="range" min="0" max="800" oninput="updateSize('height', this.value == 0 ? 'auto' : this.value + 'px')" class="w-full accent-purple-600">
                    </div>
                    <button onclick="deleteSelected()" class="w-full bg-red-50 dark:bg-red-900/20 text-red-600 py-2 rounded text-sm mt-4">Delete Element</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-lg max-w-2xl w-full p-6 flex flex-col h-[80vh]">
            <h3 class="text-xl font-bold mb-4">Export Code</h3>
            <textarea id="export-textarea" readonly class="flex-1 bg-slate-900 text-green-400 p-4 font-mono text-xs rounded mb-4 overflow-auto"></textarea>
            <div class="flex gap-2">
                <button onclick="copyExport()" class="flex-1 bg-purple-600 text-white py-2 rounded">Copy Code</button>
                <button onclick="document.getElementById('export-modal').classList.add('hidden')" class="flex-1 bg-slate-200 dark:bg-slate-800 py-2 rounded">Close</button>
            </div>
        </div>
    </div>

    <script>
        const supaUrl = 'https://rnlwrngfgvznndlekmrz.supabase.co';
        const supaKey = 'sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt'; 
        let sbClient, currentUser, currentProjectId;
        let selectedElement = null;
        let pages = { 'index': { title: 'Home', content: '' } };
        let activePage = 'index';

        window.onload = async () => {
            sbClient = supabase.createClient(supaUrl, supaKey);
            initTheme();
            const { data: { session } } = await sbClient.auth.getSession();
            document.getElementById('loading-screen').style.display = 'none';
            if (!session) { window.location.href = 'auth.html'; return; }
            currentUser = session.user;
            document.getElementById('user-info').textContent = currentUser.email;
            loadProjects();
        };

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        async function loadProjects() {
            const { data } = await sbClient.from('websites').select('*').order('updated_at', { ascending: false });
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = data && data.length ? '' : '<p class="text-center py-20 text-slate-400">No projects yet.</p>';
            if (data) {
                data.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-4 cursor-pointer hover:shadow-lg';
                    card.innerHTML = `<h3 class="font-bold mb-1">${p.title}</h3><p class="text-xs text-slate-500">Edited: ${new Date(p.updated_at).toLocaleDateString()}</p>`;
                    card.onclick = () => openProject(p.id);
                    grid.appendChild(card);
                });
            }
        }

        async function openProject(id) {
            currentProjectId = id;
            const { data } = await sbClient.from('websites').select('*').eq('id', id).single();
            if (data) {
                try {
                    pages = data.pages_data ? JSON.parse(data.pages_data) : { 'index': { title: 'Home', content: data.html_content || '' } };
                } catch(e) {
                    pages = { 'index': { title: 'Home', content: data.html_content || '' } };
                }
                switchPage('index');
                updatePageUI();
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('editor-view').classList.remove('hidden');
                document.getElementById('editor-controls').classList.remove('hidden');
                document.getElementById('dashboard-controls').classList.add('hidden');
            }
        }

        function switchPage(pageKey) {
            if (activePage && pages[activePage]) {
                pages[activePage].content = document.getElementById('editor-canvas').innerHTML;
            }
            activePage = pageKey;
            document.getElementById('editor-canvas').innerHTML = pages[pageKey].content || '';
            attachHandlers();
            updateLinkSelect();
        }

        function updatePageUI() {
            const selector = document.getElementById('page-selector');
            selector.innerHTML = '';
            Object.keys(pages).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = pages[key].title;
                if(key === activePage) opt.selected = true;
                selector.appendChild(opt);
            });
        }

        function addNewPage() {
            const name = prompt("Page Name:");
            if(!name) return;
            const key = name.toLowerCase().replace(/ /g, '-');
            pages[key] = { title: name, content: '' };
            updatePageUI();
            switchPage(key);
        }

        function updateLinkSelect() {
            const select = document.getElementById('prop-link-select');
            select.innerHTML = '<option value="">External URL</option>';
            Object.keys(pages).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key + '.html';
                opt.textContent = 'Page: ' + pages[key].title;
                select.appendChild(opt);
            });
        }

        function drag(ev) { ev.dataTransfer.setData("type", ev.target.dataset.type); }
        function allowDrop(ev) { ev.preventDefault(); }
        function drop(ev) {
            ev.preventDefault();
            const type = ev.dataTransfer.getData("type");
            const el = createElement(type);
            document.getElementById('editor-canvas').appendChild(el);
            selectElement(el, new Event('click'));
        }

        function createElement(type) {
            let el;
            const base = "relative hover:outline hover:outline-2 hover:outline-purple-400 cursor-pointer transition-all mb-4 block";
            switch(type) {
                case 'heading': el = document.createElement('h2'); el.className = base + " text-3xl font-bold"; el.innerText = "New Heading"; break;
                case 'text': el = document.createElement('p'); el.className = base + " text-slate-600"; el.innerText = "Paragraph text goes here."; break;
                case 'button': el = document.createElement('a'); el.className = base + " inline-block bg-purple-600 text-white px-6 py-2 rounded text-center"; el.innerText = "Button"; el.href = "#"; break;
                case 'image': el = document.createElement('img'); el.className = base + " rounded-lg max-w-full"; el.src = "https://via.placeholder.com/400x200"; break;
                case 'container': el = document.createElement('div'); el.className = base + " p-6 border-2 border-dashed border-slate-200 min-h-[100px] rounded-lg"; break;
                case 'spacer': el = document.createElement('div'); el.className = base + " h-8 w-full bg-transparent"; break;
            }
            el.onclick = (e) => selectElement(el, e);
            return el;
        }

        function selectElement(el, e) {
            e.stopPropagation();
            if (selectedElement) selectedElement.classList.remove('selected-element');
            selectedElement = el;
            selectedElement.classList.add('selected-element');
            
            document.getElementById('properties-panel').classList.remove('translate-x-full');
            document.getElementById('prop-text-group').classList.toggle('hidden', !['H2', 'P', 'A'].includes(el.tagName));
            document.getElementById('prop-link-group').classList.toggle('hidden', el.tagName !== 'A');
            
            if(['H2','P','A'].includes(el.tagName)) document.getElementById('prop-text').value = el.innerText;
            if(el.tagName === 'A') document.getElementById('prop-link-raw').value = el.getAttribute('href');
        }

        function updateElementText(v) { if(selectedElement) selectedElement.innerText = v; }
        function updateElementLink(v) { if(selectedElement) selectedElement.href = v; }
        function updateSize(prop, val) { if(selectedElement) selectedElement.style[prop] = val; }
        function deleteSelected() { if(selectedElement) { selectedElement.remove(); closeProperties(); } }
        function closeProperties() { document.getElementById('properties-panel').classList.add('translate-x-full'); }

        async function saveWebsite() {
            if (!currentProjectId) return;
            pages[activePage].content = document.getElementById('editor-canvas').innerHTML;
            const { error } = await sbClient.from('websites').update({ 
                pages_data: JSON.stringify(pages),
                updated_at: new Date()
            }).eq('id', currentProjectId);
            alert(error ? "Error saving" : "Project Saved!");
        }

        function exportCode() {
            const html = `<!DOCTYPE html>\n<html>\n<head>\n<script src="https://cdn.tailwindcss.com"></script>\n</head>\n<body>\n${document.getElementById('editor-canvas').innerHTML}\n</body>\n</html>`;
            document.getElementById('export-textarea').value = html;
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function copyExport() {
            const area = document.getElementById('export-textarea');
            area.select();
            document.execCommand('copy');
            alert("Code copied to clipboard!");
        }

        function attachHandlers() {
            document.querySelectorAll('#editor-canvas *').forEach(el => {
                el.onclick = (e) => selectElement(el, e);
            });
        }

        function backToDashboard() {
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('editor-controls').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('dashboard-controls').classList.remove('hidden');
            loadProjects();
        }

        function deselectAll(e) { if(e.target.tagName === 'MAIN') { if(selectedElement) selectedElement.classList.remove('selected-element'); closeProperties(); } }
        
        async function signOut() {
            await sbClient.auth.signOut();
            window.location.href = 'auth.html';
        }
        
        async function createNewProject() {
            const title = prompt("Project Title:", "My New Website");
            if (!title) return;
            const { data, error } = await sbClient.from('websites').insert([{
                title: title,
                user_id: currentUser.id,
                pages_data: JSON.stringify({ 'index': { title: 'Home', content: '' } })
            }]).select();
            if (data) loadProjects();
        }
    </script>
</body>
</html>

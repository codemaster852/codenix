<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebNix AI Studio | Professional Builder</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: background-color 0.3s ease;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Custom Theme Transitions */
        .theme-transition {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* Purple Glow Effect */
        .purple-glow {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.15);
        }

        /* Phone frame silhouette */
        .phone-frame {
            border: 12px solid #18181b;
            border-radius: 40px;
            width: 375px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900" id="app-body">
    <div id="app-root" class="h-screen flex flex-col overflow-hidden">
        <!-- Loader -->
        <div id="loader" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-purple-500 font-bold tracking-widest text-xs uppercase">Initializing WebNix AI...</p>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="hidden flex-1 overflow-y-auto theme-transition">
            <header class="border-b px-8 py-4 flex justify-between items-center sticky top-0 z-10 backdrop-blur-md theme-transition" id="dash-header">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-purple-500/20">W</div>
                    <h1 class="text-xl font-bold tracking-tight">WebNix <span class="text-purple-500">AI Studio</span></h1>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleTheme()" class="p-2 rounded-full border border-slate-200 text-slate-400 hover:bg-slate-100 theme-transition" id="theme-toggle-btn">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-3 pl-3 pr-1 py-1 rounded-full border border-slate-200 bg-slate-100 theme-transition" id="user-pill">
                        <span id="user-email" class="text-xs font-bold opacity-70">user@example.com</span>
                        <button onclick="handleLogout()" class="bg-white/10 p-1.5 rounded-full text-red-400 hover:text-red-500 transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <button onclick="createNewProject()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all shadow-xl shadow-purple-500/20 font-bold text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Project
                    </button>
                </div>
            </header>

            <main class="max-w-6xl mx-auto p-8">
                <h2 class="text-3xl font-black mb-8 tracking-tight">Your Workspace</h2>
                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Projects will be injected here -->
                </div>
            </main>
        </div>

        <!-- Editor View -->
        <div id="view-editor" class="hidden flex-1 flex overflow-hidden theme-transition">
            <!-- Left Sidebar -->
            <aside class="w-80 border-r flex flex-col z-30 shadow-2xl theme-transition" id="editor-sidebar">
                <div class="p-5 border-b flex items-center justify-between border-purple-900/10">
                    <button onclick="setView('dashboard')" class="p-2 rounded-xl border border-slate-100 hover:bg-slate-50 transition-all theme-transition">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <span class="font-black text-sm">WebNix <span class="text-purple-500">Studio</span></span>
                    <button onclick="toggleTheme()" class="p-2 opacity-50"><i data-lucide="sun" class="w-4 h-4"></i></button>
                </div>
                <div class="p-4 overflow-y-auto space-y-4">
                    <div class="text-[10px] font-black uppercase tracking-widest opacity-30">Components</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="addComponent('navbar')" class="p-4 rounded-2xl border border-slate-200 bg-slate-50 hover:border-purple-500 transition-all text-center group theme-transition">
                            <i data-lucide="layers" class="w-5 h-5 mx-auto mb-2 text-purple-500"></i>
                            <span class="text-[10px] font-bold">Navbar</span>
                        </button>
                        <button onclick="addComponent('hero')" class="p-4 rounded-2xl border border-slate-200 bg-slate-50 hover:border-purple-500 transition-all text-center group theme-transition">
                            <i data-lucide="square" class="w-5 h-5 mx-auto mb-2 text-purple-500"></i>
                            <span class="text-[10px] font-bold">Hero</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Canvas Area -->
            <div class="flex-1 flex flex-col relative">
                <header class="h-20 border-b flex justify-between items-center px-8 z-20 theme-transition" id="editor-header">
                    <div class="flex items-center gap-6">
                        <input type="text" id="project-title-input" class="font-black text-lg bg-transparent border-none focus:ring-0 w-48" onchange="updateProjectTitle(this.value)">
                        <div class="flex items-center gap-1 p-1.5 rounded-xl border border-slate-100 bg-slate-100 theme-transition" id="viewport-switcher">
                            <button onclick="setViewport('desktop')" id="btn-vp-desktop" class="p-2 rounded-lg bg-purple-600 text-white shadow-lg shadow-purple-500/30 transition-all">
                                <i data-lucide="monitor" class="w-4 h-4"></i>
                            </button>
                            <button onclick="setViewport('mobile')" id="btn-vp-mobile" class="p-2 rounded-lg opacity-40 transition-all">
                                <i data-lucide="smartphone" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <button onclick="saveProject()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 text-xs font-black rounded-xl shadow-xl shadow-purple-500/20 transition-all">Save Design</button>
                </header>

                <div class="flex-1 overflow-y-auto p-12 flex justify-center theme-transition" id="canvas-container">
                    <div id="canvas-frame" class="bg-white text-slate-900 shadow-2xl transition-all duration-500 min-h-full overflow-hidden w-full max-w-5xl rounded-lg">
                        <div id="canvas-elements" class="flex flex-col">
                            <!-- Dragged elements appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://rnlwrngfgvznndlekmrz.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt';
        let supabaseClient;
        
        // --- STATE ---
        let user = null;
        let theme = 'dark'; // Default to dark as requested
        let view = 'dashboard';
        let viewport = 'desktop';
        let projects = [];
        let currentProject = null;
        let currentPageId = 'index';

        // --- INIT ---
        window.onload = async () => {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            lucide.createIcons();
            await checkAuth();
            applyTheme();
        };

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }
            user = session.user;
            document.getElementById('user-email').textContent = user.email;
            
            supabaseClient.auth.onAuthStateChanged((_event, session) => {
                if (!session) window.location.href = 'auth.html';
            });

            await fetchProjects();
            document.getElementById('loader').classList.add('hidden');
            setView('dashboard');
        }

        async function fetchProjects() {
            const { data, error } = await supabaseClient
                .from('websites')
                .select('*')
                .eq('user_id', user.id)
                .order('updated_at', { ascending: false });
            
            if (data) {
                projects = data;
                renderProjects();
            }
        }

        function setView(v) {
            view = v;
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('view-editor').classList.toggle('hidden', v !== 'editor');
        }

        function toggleTheme() {
            theme = theme === 'light' ? 'dark' : 'light';
            applyTheme();
        }

        function applyTheme() {
            const body = document.getElementById('app-body');
            const dashHeader = document.getElementById('dash-header');
            const editorSidebar = document.getElementById('editor-sidebar');
            const editorHeader = document.getElementById('editor-header');
            const canvasContainer = document.getElementById('canvas-container');
            const dashHeaderClasses = document.getElementById('dash-header');
            const userPill = document.getElementById('user-pill');
            const vpSwitcher = document.getElementById('viewport-switcher');

            if (theme === 'dark') {
                body.className = 'bg-zinc-950 text-white theme-transition';
                dashHeader.className = 'border-b px-8 py-4 flex justify-between items-center sticky top-0 z-10 backdrop-blur-md bg-black/80 border-purple-900/30 theme-transition';
                editorSidebar.className = 'w-80 border-r flex flex-col z-30 shadow-2xl bg-black border-purple-900/30 theme-transition';
                editorHeader.className = 'h-20 border-b flex justify-between items-center px-8 z-20 bg-black border-purple-900/30 theme-transition';
                canvasContainer.className = 'flex-1 overflow-y-auto p-12 flex justify-center bg-zinc-950 theme-transition';
                userPill.className = 'flex items-center gap-3 pl-3 pr-1 py-1 rounded-full border bg-zinc-900 border-purple-900/30 theme-transition';
                vpSwitcher.className = 'flex items-center gap-1 p-1.5 rounded-xl border bg-zinc-900 border-purple-900/30 theme-transition';
                document.getElementById('canvas-frame').classList.add('bg-black', 'text-white', 'shadow-purple-900/20');
                document.getElementById('canvas-frame').classList.remove('bg-white', 'text-slate-900', 'shadow-slate-200');
            } else {
                body.className = 'bg-slate-50 text-slate-900 theme-transition';
                dashHeader.className = 'border-b px-8 py-4 flex justify-between items-center sticky top-0 z-10 backdrop-blur-md bg-white/80 border-slate-200 theme-transition';
                editorSidebar.className = 'w-80 border-r flex flex-col z-30 shadow-2xl bg-white border-slate-200 theme-transition';
                editorHeader.className = 'h-20 border-b flex justify-between items-center px-8 z-20 bg-white border-slate-100 theme-transition';
                canvasContainer.className = 'flex-1 overflow-y-auto p-12 flex justify-center bg-slate-50 theme-transition';
                userPill.className = 'flex items-center gap-3 pl-3 pr-1 py-1 rounded-full border bg-slate-100 border-slate-200 theme-transition';
                vpSwitcher.className = 'flex items-center gap-1 p-1.5 rounded-xl border bg-slate-100 border-slate-200 theme-transition';
                document.getElementById('canvas-frame').classList.add('bg-white', 'text-slate-900', 'shadow-slate-200');
                document.getElementById('canvas-frame').classList.remove('bg-black', 'text-white', 'shadow-purple-900/20');
            }
            renderCanvas();
            lucide.createIcons();
        }

        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = projects.map(proj => `
                <div class="rounded-2xl border overflow-hidden hover:shadow-2xl hover:shadow-purple-500/10 transition-all group flex flex-col ${theme === 'dark' ? 'bg-black border-purple-900/30' : 'bg-white border-slate-200'}">
                    <div class="h-40 flex items-center justify-center border-b ${theme === 'dark' ? 'bg-zinc-900 border-purple-900/20' : 'bg-slate-50 border-slate-100'}">
                        <i data-lucide="layout" class="w-12 h-12 ${theme === 'dark' ? 'text-purple-900' : 'text-slate-200'} group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="font-bold text-lg mb-4 truncate">${proj.title}</h3>
                        <button onclick="openEditor('${proj.id}')" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2.5 rounded-xl text-sm font-black shadow-lg shadow-purple-500/10">Edit Design</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function createNewProject() {
            const initialContent = { pages: { 'index': { title: 'Home', elements: [] } } };
            const newProject = {
                title: 'New WebNix Project',
                html_content: JSON.stringify(initialContent),
                styles_content: { theme: 'dark', primaryColor: '#a855f7' },
                is_published: false,
                user_id: user.id
            };

            const { data, error } = await supabaseClient.from('websites').insert([newProject]).select();
            if (data) {
                projects.unshift(data[0]);
                openEditor(data[0].id);
            }
        }

        function openEditor(id) {
            const project = projects.find(p => p.id == id);
            currentProject = { ...project, html_content: typeof project.html_content === 'string' ? JSON.parse(project.html_content) : project.html_content };
            document.getElementById('project-title-input').value = currentProject.title;
            setView('editor');
            renderCanvas();
        }

        function addComponent(type) {
            const templates = {
                navbar: { type: 'navbar', content: { brand: 'WebNix', links: ['Home', 'Features'] } },
                hero: { type: 'hero', content: { title: 'AI Powered Future', subtitle: 'Built with Codenix AI Studio engine.' } }
            };
            const newEl = { ...templates[type], id: Math.random().toString(36).substr(2, 9) };
            currentProject.html_content.pages[currentPageId].elements.push(newEl);
            renderCanvas();
        }

        function removeComponent(id) {
            currentProject.html_content.pages[currentPageId].elements = currentProject.html_content.pages[currentPageId].elements.filter(el => el.id !== id);
            renderCanvas();
        }

        function renderCanvas() {
            if (!currentProject) return;
            const container = document.getElementById('canvas-elements');
            const elements = currentProject.html_content.pages[currentPageId].elements;
            
            container.innerHTML = elements.map((el, idx) => {
                let html = `<div class="group relative border-b border-transparent hover:border-purple-500/30 transition-all">
                    <div class="absolute -left-12 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="removeComponent('${el.id}')" class="p-2 bg-red-500 text-white rounded-lg shadow-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;

                if (el.type === 'navbar') {
                    html += `<nav class="p-6 flex justify-between font-bold border-b border-purple-900/10">
                        <div class="text-xl tracking-tighter">${el.content.brand}</div>
                        <div class="flex gap-4 opacity-50 text-xs uppercase tracking-widest">${el.content.links.join(' ')}</div>
                    </nav>`;
                } else if (el.type === 'hero') {
                    html += `<section class="py-24 px-12 text-center">
                        <h1 class="text-4xl md:text-6xl font-black mb-4 tracking-tight">${el.content.title}</h1>
                        <p class="opacity-60 max-w-xl mx-auto">${el.content.subtitle}</p>
                        <button class="mt-8 bg-purple-600 text-white px-8 py-3 rounded-full font-bold text-sm">Get Started</button>
                    </section>`;
                }
                
                html += `</div>`;
                return html;
            }).join('');
            lucide.createIcons();
        }

        function setViewport(vp) {
            viewport = vp;
            const frame = document.getElementById('canvas-frame');
            const btnD = document.getElementById('btn-vp-desktop');
            const btnM = document.getElementById('btn-vp-mobile');

            if (vp === 'mobile') {
                frame.className = `transition-all duration-500 min-h-full overflow-hidden phone-frame shadow-2xl ${theme === 'dark' ? 'bg-black text-white shadow-purple-900/20' : 'bg-white text-slate-900 shadow-slate-200'}`;
                btnM.classList.add('bg-purple-600', 'text-white', 'shadow-lg');
                btnM.classList.remove('opacity-40');
                btnD.classList.add('opacity-40');
                btnD.classList.remove('bg-purple-600', 'text-white', 'shadow-lg');
            } else {
                frame.className = `transition-all duration-500 min-h-full overflow-hidden w-full max-w-5xl rounded-lg shadow-2xl ${theme === 'dark' ? 'bg-black text-white shadow-purple-900/20' : 'bg-white text-slate-900 shadow-slate-200'}`;
                btnD.classList.add('bg-purple-600', 'text-white', 'shadow-lg');
                btnD.classList.remove('opacity-40');
                btnM.classList.add('opacity-40');
                btnM.classList.remove('bg-purple-600', 'text-white', 'shadow-lg');
            }
        }

        async function saveProject() {
            const { error } = await supabaseClient
                .from('websites')
                .update({
                    title: currentProject.title,
                    html_content: JSON.stringify(currentProject.html_content),
                    updated_at: new Date().toISOString()
                })
                .eq('id', currentProject.id);
            
            if (!error) alert("Design saved successfully to cloud!");
            else alert("Error saving: " + error.message);
        }

        function updateProjectTitle(val) {
            currentProject.title = val;
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'auth.html';
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebNix - AI Website Builder</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        /* Drag and Drop Visuals */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        
        #editor-canvas {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .drop-zone-active {
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Element Selection */
        .selected-element {
            outline: 2px solid #3b82f6;
            position: relative;
        }
        
        .selected-element::after {
            content: 'Selected';
            position: absolute;
            top: -20px;
            left: 0;
            background: #3b82f6;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 4px 4px 0 0;
            z-index: 50;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
            <h1 class="font-bold text-xl tracking-tight">WebNix <span class="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded ml-1">Beta</span></h1>
        </div>

        <div id="editor-controls" class="hidden flex items-center gap-4">
            <input type="text" id="project-title" class="bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 focus:outline-none px-2 py-1 text-sm font-medium transition" placeholder="Project Name">
            <button onclick="saveWebsite()" class="text-slate-600 hover:text-blue-600 text-sm font-medium transition"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> Save</button>
            <button onclick="togglePreview()" class="text-slate-600 hover:text-blue-600 text-sm font-medium transition"><i class="fa-solid fa-eye mr-1"></i> Preview</button>
            <button onclick="publishWebsite()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition shadow-sm hover:shadow">Publish</button>
            <button onclick="backToDashboard()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>

        <div id="dashboard-controls" class="flex items-center gap-4">
            <div id="user-info" class="text-sm font-medium text-slate-600">Loading...</div>
            <button onclick="signOut()" class="text-red-500 hover:text-red-700 text-sm font-medium">Sign Out</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="absolute inset-0 z-10 bg-slate-50 p-8 overflow-y-auto w-full">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Your Projects</h2>
                        <p class="text-slate-500 mt-2">Manage and edit your websites.</p>
                    </div>
                    <button onclick="createNewProject()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-sm transition flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> New Project
                    </button>
                </div>

                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Projects injected here -->
                    <div class="animate-pulse flex flex-col gap-4">
                        <div class="h-48 bg-slate-200 rounded-xl"></div>
                        <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDITOR VIEW -->
        <div id="editor-view" class="hidden flex-1 flex w-full">
            
            <!-- Sidebar: Components -->
            <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-10">
                <div class="p-4 border-b border-slate-100">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Elements</h3>
                </div>
                <div class="p-4 grid grid-cols-2 gap-3 overflow-y-auto">
                    
                    <div draggable="true" ondragstart="drag(event)" data-type="heading" class="draggable-item bg-slate-50 hover:bg-white hover:shadow-md border border-slate-200 rounded-lg p-3 flex flex-col items-center gap-2 transition group">
                        <i class="fa-solid fa-heading text-slate-400 group-hover:text-blue-500 text-xl"></i>
                        <span class="text-xs font-medium text-slate-600">Header</span>
                    </div>

                    <div draggable="true" ondragstart="drag(event)" data-type="text" class="draggable-item bg-slate-50 hover:bg-white hover:shadow-md border border-slate-200 rounded-lg p-3 flex flex-col items-center gap-2 transition group">
                        <i class="fa-solid fa-paragraph text-slate-400 group-hover:text-blue-500 text-xl"></i>
                        <span class="text-xs font-medium text-slate-600">Text</span>
                    </div>

                    <div draggable="true" ondragstart="drag(event)" data-type="button" class="draggable-item bg-slate-50 hover:bg-white hover:shadow-md border border-slate-200 rounded-lg p-3 flex flex-col items-center gap-2 transition group">
                        <i class="fa-regular fa-square-check text-slate-400 group-hover:text-blue-500 text-xl"></i>
                        <span class="text-xs font-medium text-slate-600">Button</span>
                    </div>

                    <div draggable="true" ondragstart="drag(event)" data-type="image" class="draggable-item bg-slate-50 hover:bg-white hover:shadow-md border border-slate-200 rounded-lg p-3 flex flex-col items-center gap-2 transition group">
                        <i class="fa-regular fa-image text-slate-400 group-hover:text-blue-500 text-xl"></i>
                        <span class="text-xs font-medium text-slate-600">Image</span>
                    </div>

                    <div draggable="true" ondragstart="drag(event)" data-type="container" class="draggable-item bg-slate-50 hover:bg-white hover:shadow-md border border-slate-200 rounded-lg p-3 flex flex-col items-center gap-2 transition group">
                        <i class="fa-solid fa-box-open text-slate-400 group-hover:text-blue-500 text-xl"></i>
                        <span class="text-xs font-medium text-slate-600">Box</span>
                    </div>

                    <div draggable="true" ondragstart="drag(event)" data-type="nav" class="draggable-item bg-slate-50 hover:bg-white hover:shadow-md border border-slate-200 rounded-lg p-3 flex flex-col items-center gap-2 transition group">
                        <i class="fa-solid fa-bars text-slate-400 group-hover:text-blue-500 text-xl"></i>
                        <span class="text-xs font-medium text-slate-600">Navbar</span>
                    </div>

                </div>
            </aside>

            <!-- Canvas Area -->
            <main class="flex-1 bg-slate-100 flex justify-center overflow-auto p-8 relative" onclick="deselectAll(event)">
                <div id="editor-canvas" 
                     class="bg-white w-full max-w-4xl min-h-[800px] shadow-lg rounded-sm p-8 transition-all"
                     ondrop="drop(event)" 
                     ondragover="allowDrop(event)">
                     <!-- Dropped Items Go Here -->
                     <div class="pointer-events-none text-slate-300 text-center mt-32 border-2 border-dashed border-slate-200 p-10 rounded-xl" id="empty-state">
                        <i class="fa-solid fa-arrow-pointer text-4xl mb-4"></i>
                        <p>Drag elements here to build your website</p>
                     </div>
                </div>
            </main>

            <!-- Properties Panel -->
            <aside id="properties-panel" class="w-72 bg-white border-l border-slate-200 flex flex-col shrink-0 transform translate-x-full transition-transform duration-300 absolute right-0 h-full z-20 shadow-xl">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Properties</h3>
                    <button onclick="closeProperties()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="p-4 space-y-4 overflow-y-auto flex-1">
                    <div id="prop-text-group" class="hidden">
                        <label class="block text-xs font-medium text-slate-500 mb-1">Text Content</label>
                        <textarea id="prop-text" oninput="updateElementText(this.value)" class="w-full border border-slate-300 rounded p-2 text-sm focus:border-blue-500 focus:outline-none" rows="3"></textarea>
                    </div>

                    <div id="prop-link-group" class="hidden">
                        <label class="block text-xs font-medium text-slate-500 mb-1">Link URL (Href)</label>
                        <input type="text" id="prop-link" oninput="updateElementLink(this.value)" class="w-full border border-slate-300 rounded p-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="https://...">
                    </div>

                    <div id="prop-src-group" class="hidden">
                        <label class="block text-xs font-medium text-slate-500 mb-1">Image URL</label>
                        <input type="text" id="prop-src" oninput="updateElementSrc(this.value)" class="w-full border border-slate-300 rounded p-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="https://...">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Background Color</label>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="updateBg('bg-transparent')" class="w-6 h-6 rounded border border-slate-300 bg-white" title="Transparent"></button>
                            <button onclick="updateBg('bg-white')" class="w-6 h-6 rounded border border-slate-300 bg-white" title="White"></button>
                            <button onclick="updateBg('bg-slate-100')" class="w-6 h-6 rounded bg-slate-100" title="Slate 100"></button>
                            <button onclick="updateBg('bg-blue-500')" class="w-6 h-6 rounded bg-blue-500" title="Blue"></button>
                            <button onclick="updateBg('bg-green-500')" class="w-6 h-6 rounded bg-green-500" title="Green"></button>
                            <button onclick="updateBg('bg-red-500')" class="w-6 h-6 rounded bg-red-500" title="Red"></button>
                            <button onclick="updateBg('bg-slate-900')" class="w-6 h-6 rounded bg-slate-900" title="Dark"></button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Text Color</label>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="updateColor('text-slate-900')" class="w-6 h-6 rounded bg-slate-900" title="Dark"></button>
                            <button onclick="updateColor('text-slate-600')" class="w-6 h-6 rounded bg-slate-600" title="Grey"></button>
                            <button onclick="updateColor('text-white')" class="w-6 h-6 rounded border border-slate-300 bg-white" title="White"></button>
                            <button onclick="updateColor('text-blue-600')" class="w-6 h-6 rounded bg-blue-600" title="Blue"></button>
                            <button onclick="updateColor('text-red-600')" class="w-6 h-6 rounded bg-red-600" title="Red"></button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Padding</label>
                        <input type="range" min="0" max="8" step="1" oninput="updatePadding(this.value)" class="w-full accent-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Actions</label>
                        <button onclick="deleteSelected()" class="w-full bg-red-50 text-red-600 border border-red-200 py-1 rounded text-sm hover:bg-red-100">Delete Element</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 text-sm flex items-center gap-2">
        <i class="fa-solid fa-circle-info text-blue-400"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <!-- Modals (Publish) -->
    <div id="publish-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-check"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Website Published!</h3>
            <p class="text-slate-600 mb-4 text-sm">Your website is live on the internet.</p>
            <div class="bg-slate-100 p-3 rounded flex items-center gap-2 mb-6 border border-slate-200">
                <input id="publish-url" readonly class="bg-transparent w-full text-xs text-slate-600 outline-none" value="https://webnix.app/site/xyz-123">
                <button onclick="copyUrl()" class="text-blue-600 hover:text-blue-800"><i class="fa-regular fa-copy"></i></button>
            </div>
            <button onclick="closeModal()" class="w-full bg-slate-900 text-white py-2 rounded hover:bg-slate-800">Close</button>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIGURATION ---
        const supaUrl = 'https://rnlwrngfgvznndlekmrz.supabase.co';
        const supaKey = 'sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt'; 
        
        let supabase;
        let currentUser = null;
        let currentProjectId = null;
        let selectedElement = null;

        // --- AUTH & INIT ---
        window.onload = async () => {
            if(!supaKey) {
                alert("Please check your API Key configuration.");
                return;
            }

            supabase = supabase.createClient(supaUrl, supaKey);

            // Check Session
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                // Redirect if not signed in
                window.location.href = 'auth.html';
                return;
            }

            currentUser = session.user;
            
            // Setup User Info in UI
            document.getElementById('user-info').textContent = currentUser.email;

            // Load Projects
            loadProjects();
        };

        async function signOut() {
            await supabase.auth.signOut();
            window.location.href = 'auth.html';
        }

        // --- DASHBOARD LOGIC ---
        async function loadProjects() {
            const { data, error } = await supabase
                .from('websites')
                .select('*')
                .order('updated_at', { ascending: false });

            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';

            if (error) {
                console.error(error);
                showToast("Error loading projects");
                return;
            }

            if (data.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400">
                    <i class="fa-solid fa-layer-group text-4xl mb-4 opacity-50"></i>
                    <p>No projects yet. Create one to get started!</p>
                </div>`;
                return;
            }

            data.forEach(project => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-slate-200 rounded-xl overflow-hidden hover:shadow-lg transition group relative';
                card.innerHTML = `
                    <div class="h-40 bg-slate-100 flex items-center justify-center border-b border-slate-100">
                        <i class="fa-solid fa-window-maximize text-4xl text-slate-300"></i>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-slate-800 truncate">${project.title}</h3>
                        <p class="text-xs text-slate-500 mt-1">Edited: ${new Date(project.updated_at).toLocaleDateString()}</p>
                    </div>
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="deleteProject('${project.id}')" class="bg-white text-red-500 p-2 rounded shadow hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <button onclick="openProject('${project.id}')" class="absolute inset-0 z-0"></button>
                `;
                grid.appendChild(card);
            });
        }

        async function createNewProject() {
            const title = prompt("Enter website name:", "My Amazing Site");
            if (!title) return;

            const { data, error } = await supabase
                .from('websites')
                .insert([{ 
                    user_id: currentUser.id, 
                    title: title, 
                    html_content: '',
                    is_published: false
                }])
                .select()
                .single();

            if (error) {
                showToast("Error creating project");
                console.error(error);
            } else {
                openProject(data.id);
            }
        }

        async function deleteProject(id) {
            if(!confirm("Are you sure? This cannot be undone.")) return;
            
            const { error } = await supabase.from('websites').delete().eq('id', id);
            if(!error) {
                loadProjects();
                showToast("Project deleted");
            }
        }

        async function openProject(id) {
            currentProjectId = id;
            
            // Switch Views
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('dashboard-controls').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
            document.getElementById('editor-controls').classList.remove('hidden');

            // Fetch Data
            const { data, error } = await supabase
                .from('websites')
                .select('*')
                .eq('id', id)
                .single();

            if (data) {
                document.getElementById('project-title').value = data.title;
                const canvas = document.getElementById('editor-canvas');
                if(data.html_content) {
                    canvas.innerHTML = data.html_content;
                } else {
                    // Reset to empty state if new
                    canvas.innerHTML = `<div class="pointer-events-none text-slate-300 text-center mt-32 border-2 border-dashed border-slate-200 p-10 rounded-xl" id="empty-state">
                        <i class="fa-solid fa-arrow-pointer text-4xl mb-4"></i>
                        <p>Drag elements here to build your website</p>
                     </div>`;
                }
                attachClickHandlersToCanvas(); // Reattach listeners to loaded HTML
            }
        }

        function backToDashboard() {
            currentProjectId = null;
            selectedElement = null;
            closeProperties();
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('editor-controls').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('dashboard-controls').classList.remove('hidden');
            loadProjects();
        }

        // --- EDITOR & DRAG DROP LOGIC ---

        function drag(ev) {
            ev.dataTransfer.setData("type", ev.target.dataset.type);
        }

        function allowDrop(ev) {
            ev.preventDefault();
            // Optional: highlight drop target
        }

        function drop(ev) {
            ev.preventDefault();
            const type = ev.dataTransfer.getData("type");
            const emptyState = document.getElementById('empty-state');
            if(emptyState) emptyState.remove();

            // Find Drop Target (handle nesting)
            let target = ev.target;
            // If dropping on text, go to parent
            if(target.nodeName === '#text') target = target.parentNode;
            // Prevent dropping inside self or weird nesting if needed, mostly allow nesting in divs
            if(target.id === 'editor-canvas' || target.classList.contains('drop-container')) {
                // valid
            } else {
                // If dropped on a specific element, append after it or inside if it's a container
                if(!target.classList.contains('drop-container')) {
                    target = target.closest('.drop-container') || document.getElementById('editor-canvas');
                }
            }

            const el = createElement(type);
            target.appendChild(el);
            
            // Select immediately
            selectElement(el, new Event('click'));
        }

        function createElement(type) {
            let el;
            const baseClass = "relative hover:outline hover:outline-2 hover:outline-blue-200 cursor-pointer transition-all";

            switch(type) {
                case 'heading':
                    el = document.createElement('h2');
                    el.innerText = 'New Heading';
                    el.className = `${baseClass} text-3xl font-bold mb-4 text-slate-800`;
                    break;
                case 'text':
                    el = document.createElement('p');
                    el.innerText = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Start editing this text.';
                    el.className = `${baseClass} mb-4 text-slate-600 leading-relaxed`;
                    break;
                case 'button':
                    el = document.createElement('a'); // use A tag for links
                    el.innerText = 'Click Me';
                    el.href = "#";
                    el.className = `${baseClass} inline-block bg-blue-600 text-white px-6 py-2 rounded font-medium hover:bg-blue-700 mb-4`;
                    break;
                case 'image':
                    el = document.createElement('img');
                    el.src = 'https://via.placeholder.com/400x200?text=Image';
                    el.className = `${baseClass} w-full h-auto rounded-lg mb-4 object-cover`;
                    break;
                case 'container':
                    el = document.createElement('div');
                    el.className = `${baseClass} drop-container p-4 border border-slate-200 bg-slate-50 rounded-lg mb-4 min-h-[100px]`;
                    break;
                case 'nav':
                    el = document.createElement('nav');
                    el.className = `${baseClass} drop-container flex justify-between items-center p-4 bg-slate-800 text-white mb-4 rounded`;
                    el.innerHTML = `<span class="font-bold text-lg">Logo</span><div class="flex gap-4"><a href="#" class="hover:text-blue-300">Home</a><a href="#" class="hover:text-blue-300">About</a></div>`;
                    break;
            }

            // Attach click handler for properties
            el.onclick = (e) => selectElement(el, e);
            return el;
        }

        function attachClickHandlersToCanvas() {
            // Helper to re-bind clicks after loading HTML string
            const canvas = document.getElementById('editor-canvas');
            const allElements = canvas.querySelectorAll('*');
            allElements.forEach(el => {
                if(el.id !== 'empty-state') {
                    el.onclick = (e) => selectElement(el, e);
                    // Ensure containers keep drop class logic if needed
                    if(el.tagName === 'DIV' || el.tagName === 'NAV') el.classList.add('drop-container');
                }
            });
        }

        // --- SELECTION & PROPERTIES ---

        function deselectAll(e) {
            // Only deselect if clicking the main gray background, not the canvas
            if(e.target.tagName === 'MAIN') {
                if (selectedElement) {
                    selectedElement.classList.remove('selected-element');
                    selectedElement = null;
                    closeProperties();
                }
            }
        }

        function selectElement(el, e) {
            e.stopPropagation(); // Stop bubbling to parent containers
            
            if (selectedElement) selectedElement.classList.remove('selected-element');
            selectedElement = el;
            selectedElement.classList.add('selected-element');

            openProperties();
        }

        function openProperties() {
            const panel = document.getElementById('properties-panel');
            panel.classList.remove('translate-x-full');

            // Reset inputs
            document.getElementById('prop-text-group').classList.add('hidden');
            document.getElementById('prop-link-group').classList.add('hidden');
            document.getElementById('prop-src-group').classList.add('hidden');

            // Show relevant inputs based on tag
            const tag = selectedElement.tagName.toLowerCase();

            if(['h1','h2','h3','p','a','span','button'].includes(tag)) {
                const textInput = document.getElementById('prop-text');
                textInput.value = selectedElement.innerText;
                document.getElementById('prop-text-group').classList.remove('hidden');
            }

            if(tag === 'a') {
                const linkInput = document.getElementById('prop-link');
                linkInput.value = selectedElement.getAttribute('href') || '#';
                document.getElementById('prop-link-group').classList.remove('hidden');
            }

            if(tag === 'img') {
                const srcInput = document.getElementById('prop-src');
                srcInput.value = selectedElement.src;
                document.getElementById('prop-src-group').classList.remove('hidden');
            }
        }

        function closeProperties() {
            document.getElementById('properties-panel').classList.add('translate-x-full');
        }

        // --- PROPERTY UPDATERS ---

        function updateElementText(val) {
            if(selectedElement) selectedElement.innerText = val;
        }

        function updateElementLink(val) {
            if(selectedElement) selectedElement.href = val;
        }

        function updateElementSrc(val) {
            if(selectedElement) selectedElement.src = val;
        }

        function updateBg(colorClass) {
            if(!selectedElement) return;
            // Remove existing bg classes
            const classes = selectedElement.className.split(' ').filter(c => !c.startsWith('bg-'));
            selectedElement.className = classes.join(' ') + ' ' + colorClass;
        }

        function updateColor(colorClass) {
            if(!selectedElement) return;
            // Remove existing text classes
            const classes = selectedElement.className.split(' ').filter(c => !c.startsWith('text-'));
            selectedElement.className = classes.join(' ') + ' ' + colorClass;
        }

        function updatePadding(val) {
            if(!selectedElement) return;
            // Remove existing padding classes
            const classes = selectedElement.className.split(' ').filter(c => !c.startsWith('p-'));
            selectedElement.className = classes.join(' ') + ' p-' + val;
        }

        function deleteSelected() {
            if(selectedElement) {
                selectedElement.remove();
                selectedElement = null;
                closeProperties();
            }
        }

        // --- SAVING & PUBLISHING ---

        async function saveWebsite() {
            if(!currentProjectId) return;

            // Clean up visual helpers before saving
            if(selectedElement) {
                selectedElement.classList.remove('selected-element');
                selectedElement = null;
                closeProperties();
            }

            const canvas = document.getElementById('editor-canvas');
            const title = document.getElementById('project-title').value;

            // Prepare Content (remove empty state if present)
            let contentToSave = canvas.innerHTML;
            if(contentToSave.includes('id="empty-state"')) contentToSave = '';

            const { error } = await supabase
                .from('websites')
                .update({ 
                    title: title,
                    html_content: contentToSave,
                    updated_at: new Date()
                })
                .eq('id', currentProjectId);

            if(error) {
                showToast("Failed to save");
                console.error(error);
            } else {
                showToast("Website Saved successfully!");
            }
        }

        async function publishWebsite() {
            await saveWebsite(); // Save first

            // Generate a fake link for demo (in real app, you'd route this)
            const slug = currentProjectId.split('-')[0]; // simple short slug
            const publicUrl = `https://webnix.app/site/${slug}`;

            const { error } = await supabase
                .from('websites')
                .update({ 
                    is_published: true,
                    public_link: publicUrl
                })
                .eq('id', currentProjectId);

            if(!error) {
                document.getElementById('publish-url').value = publicUrl;
                document.getElementById('publish-modal').classList.remove('hidden');
            }
        }

        function closeModal() {
            document.getElementById('publish-modal').classList.add('hidden');
        }

        function copyUrl() {
            const copyText = document.getElementById("publish-url");
            copyText.select();
            document.execCommand('copy'); // Fallback for iframe safety
            showToast("Link copied!");
        }

        // --- UI UTILS ---

        function togglePreview() {
            const canvas = document.getElementById('editor-canvas');
            canvas.classList.toggle('w-full');
            canvas.classList.toggle('w-[375px]'); // Mobile width
            showToast("Toggled Mobile View");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

    </script>
</body>
</html>

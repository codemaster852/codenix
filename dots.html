<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dots & Lines: Neural Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #050505;
            font-family: 'JetBrains+Mono', monospace;
            color: #e4e4e7;
            overflow: hidden;
            margin: 0;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #27272a;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .dot.active {
            background: #10b981;
            box-shadow: 0 0 15px #10b981;
            transform: scale(1.5);
        }

        .line {
            position: absolute;
            background: #18181b;
            transition: all 0.4s ease;
            z-index: 5;
        }

        .line.claimed-p1 { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .line.claimed-p2 { background: #3b82f6; box-shadow: 0 0 10px #3b82f6; }

        .box {
            position: absolute;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.5rem;
            opacity: 0;
            transform: scale(0.5);
        }

        .box.claimed { opacity: 0.2; transform: scale(1); }
        .box-p1 { background: #10b981; color: #000; }
        .box-p2 { background: #3b82f6; color: #000; }

        /* Auth Blocking Overlay */
        #auth-guard {
            display: flex; /* Default to visible */
            position: fixed;
            inset: 0;
            background: rgba(5, 5, 5, 0.98);
            backdrop-filter: blur(12px);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }

        .scanline {
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.05) 51%);
            background-size: 100% 4px;
            position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 md:p-8">
    <div class="scanline"></div>

    <!-- Auth Guard Overlay -->
    <div id="auth-guard">
        <div class="max-w-md border border-zinc-800 p-8 rounded-lg bg-zinc-900/50 shadow-2xl">
            <div class="text-red-500 mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0H10m11-3V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
            </div>
            <h2 class="text-xl font-bold uppercase tracking-tighter mb-2">Access_Denied</h2>
            <p class="text-zinc-400 text-sm mb-8 leading-relaxed">Neural Link connection detected. Authentication required to initialize Game Logic. Guest access is prohibited.</p>
            <a href="auth.html" class="inline-block w-full py-4 bg-emerald-500 text-black font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors">
                Proceed_to_Auth
            </a>
        </div>
    </div>

    <div class="max-w-4xl mx-auto w-full flex-1 flex flex-col">
        <header class="mb-8 border-b border-zinc-800 pb-4 flex justify-between items-end">
            <div>
                <h1 class="text-2xl font-black tracking-tighter uppercase">Dots_&_Lines<span class="text-emerald-500">.exe</span></h1>
                <p class="text-[10px] text-zinc-500 font-mono tracking-widest uppercase">Grid_Capture_Protocol_v2.0</p>
            </div>
            <div id="turn-indicator" class="text-[10px] font-bold px-3 py-1 bg-emerald-500 text-black rounded uppercase">
                Player_1_Turn
            </div>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row gap-8 items-center justify-center">
            <div id="game-container" class="relative bg-zinc-900/20 border border-zinc-800 rounded-xl p-8">
                <div id="grid" class="relative"></div>
            </div>

            <div class="w-full lg:w-48 space-y-4">
                <div class="p-4 rounded border border-zinc-800 bg-zinc-900/50">
                    <span class="text-[10px] text-zinc-500 uppercase block mb-2">P1_Captures</span>
                    <div id="score-p1" class="text-3xl font-black text-emerald-500">0</div>
                </div>
                <div class="p-4 rounded border border-zinc-800 bg-zinc-900/50">
                    <span class="text-[10px] text-zinc-500 uppercase block mb-2">P2_Captures</span>
                    <div id="score-p2" class="text-3xl font-black text-blue-500">0</div>
                </div>
                <button onclick="resetGame()" class="w-full py-3 border border-zinc-800 hover:border-white text-[10px] font-bold uppercase transition-all">
                    Reset_Session
                </button>
                <button id="logout-btn" class="hidden w-full py-3 border border-red-900/50 hover:border-red-500 text-[10px] font-bold uppercase transition-all text-red-500">
                    Disconnect
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration - Fixed SyntaxError by renaming local variable
        const SUPABASE_URL = "https://rnlwrngfgvznndlekmrz.supabase.co";
        const SUPABASE_KEY = "sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt";
        
        // The CDN script exposes a global 'supabase' object with a 'createClient' method
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const guard = document.getElementById('auth-guard');
        const logoutBtn = document.getElementById('logout-btn');

        // Check Session & Auth
        async function checkUser() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session && session.user) {
                    guard.style.display = 'none';
                    logoutBtn.classList.remove('hidden');
                } else {
                    guard.style.display = 'flex';
                    logoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error("Auth check failed:", error);
                guard.style.display = 'flex';
            }
        }

        // Listen for Auth Changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || session) {
                guard.style.display = 'none';
                logoutBtn.classList.remove('hidden');
            } else {
                guard.style.display = 'flex';
                logoutBtn.classList.add('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.reload();
        });

        // Initialize check
        checkUser();

        // --- Game Logic ---
        const GRID_SIZE = 5; 
        const DOT_SPACING = 60;
        let currentPlayer = 1;
        let scores = { 1: 0, 2: 0 };
        let lines = new Set();
        let boxes = [];

        function initGame() {
            const grid = document.getElementById('grid');
            grid.style.width = `${(GRID_SIZE - 1) * DOT_SPACING}px`;
            grid.style.height = `${(GRID_SIZE - 1) * DOT_SPACING}px`;
            grid.innerHTML = '';

            boxes = [];
            for (let r = 0; r < GRID_SIZE - 1; r++) {
                for (let c = 0; c < GRID_SIZE - 1; c++) {
                    const boxEl = document.createElement('div');
                    boxEl.className = `box`;
                    boxEl.style.width = `${DOT_SPACING}px`;
                    boxEl.style.height = `${DOT_SPACING}px`;
                    boxEl.style.left = `${c * DOT_SPACING}px`;
                    boxEl.style.top = `${r * DOT_SPACING}px`;
                    grid.appendChild(boxEl);
                    boxes.push({ r, c, element: boxEl, sides: 0, owner: null });
                }
            }

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE - 1; c++) createLine(r, c, r, c + 1, 'h');
            }

            for (let r = 0; r < GRID_SIZE - 1; r++) {
                for (let c = 0; c < GRID_SIZE; c++) createLine(r, c, r + 1, c, 'v');
            }

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const dot = document.createElement('div');
                    dot.className = 'dot absolute';
                    dot.style.left = `${c * DOT_SPACING - 4}px`;
                    dot.style.top = `${r * DOT_SPACING - 4}px`;
                    grid.appendChild(dot);
                }
            }
        }

        function createLine(r1, c1, r2, c2, type) {
            const grid = document.getElementById('grid');
            const line = document.createElement('div');
            const id = `${r1},${c1}-${r2},${c2}`;
            line.className = 'line cursor-pointer hover:bg-zinc-700';
            
            if (type === 'h') {
                line.style.width = `${DOT_SPACING}px`;
                line.style.height = `4px`;
                line.style.left = `${c1 * DOT_SPACING}px`;
                line.style.top = `${r1 * DOT_SPACING - 2}px`;
            } else {
                line.style.width = `4px`;
                line.style.height = `${DOT_SPACING}px`;
                line.style.left = `${c1 * DOT_SPACING - 2}px`;
                line.style.top = `${r1 * DOT_SPACING}px`;
            }

            line.onclick = () => handleMove(line, id, r1, c1, r2, c2, type);
            grid.appendChild(line);
        }

        function handleMove(el, id, r1, c1, r2, c2, type) {
            if (lines.has(id)) return;

            lines.add(id);
            el.classList.add(`claimed-p${currentPlayer}`);
            el.classList.remove('hover:bg-zinc-700');

            let boxCaptured = false;
            boxes.forEach(box => {
                let isSide = false;
                if (type === 'h') {
                    if (c1 === box.c && (r1 === box.r || r1 === box.r + 1)) isSide = true;
                } else {
                    if (r1 === box.r && (c1 === box.c || c1 === box.c + 1)) isSide = true;
                }

                if (isSide) {
                    box.sides++;
                    if (box.sides === 4) {
                        box.owner = currentPlayer;
                        box.element.classList.add('claimed', `box-p${currentPlayer}`);
                        box.element.innerText = currentPlayer === 1 ? '01' : '02';
                        scores[currentPlayer]++;
                        boxCaptured = true;
                    }
                }
            });

            if (!boxCaptured) {
                currentPlayer = currentPlayer === 1 ? 2 : 1;
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('score-p1').innerText = scores[1];
            document.getElementById('score-p2').innerText = scores[2];
            const indicator = document.getElementById('turn-indicator');
            indicator.innerText = `Player_${currentPlayer}_Turn`;
            indicator.className = `text-[10px] font-bold px-3 py-1 rounded uppercase ${currentPlayer === 1 ? 'bg-emerald-500 text-black' : 'bg-blue-500 text-white'}`;
        }

        function resetGame() {
            lines.clear();
            scores = { 1: 0, 2: 0 };
            currentPlayer = 1;
            initGame();
            updateUI();
        }

        window.onload = initGame;
    </script>
</body>
</html>

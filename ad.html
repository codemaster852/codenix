<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Ads - Earn Rewards</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            background: #000;
        }
        .video-container iframe, .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4">

    <!-- Header / Balance Section -->
    <header class="w-full max-w-2xl flex justify-between items-center mb-8 p-4 bg-gray-800 rounded-xl shadow-lg">
        <div>
            <h1 class="text-xl font-bold text-blue-400">AdRewards</h1>
            <p id="user-display" class="text-sm text-gray-400">Loading user...</p>
        </div>
        <div class="text-right">
            <p class="text-xs uppercase tracking-widest text-gray-500">Balance</p>
            <p id="token-balance" class="text-2xl font-black text-yellow-500">0 Tokens</p>
        </div>
    </header>

    <!-- Ad Display Area -->
    <main id="ad-card" class="w-full max-w-2xl bg-gray-800 rounded-2xl overflow-hidden shadow-2xl border border-gray-700 hidden">
        <div id="video-wrapper" class="video-container">
            <!-- Video or Iframe injected here -->
        </div>
        
        <div class="p-6">
            <h2 id="ad-title" class="text-xl font-semibold mb-4 text-center">Watch to earn 3 tokens</h2>
            
            <div class="flex flex-col gap-3">
                <button id="reward-btn" disabled class="w-full py-4 bg-gray-600 text-gray-400 font-bold rounded-lg cursor-not-allowed transition-all">
                    Finish Video to Claim Reward
                </button>
                
                <a id="visit-btn" href="#" target="_blank" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg text-center transition-all">
                    Visit Sponsor Website
                </a>
            </div>
        </div>
    </main>

    <!-- Loading/Status Messages -->
    <div id="status-msg" class="mt-20 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p class="text-gray-400">Initializing...</p>
    </div>

    <script>
        const SUPABASE_URL = "https://rnlwrngfgvznndlekmrz.supabase.co";
        const SUPABASE_KEY = "sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt"; 
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1j0GMlqXCrCcbGxXVaYJCQlVTgHMm6Ocwwp8HdgpmL_E/gviz/tq?tqx=out:csv";
        
        let supabaseClient;
        if (typeof supabaseClient === 'undefined') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        let currentUser = null;
        let currentTokens = 0;

        async function init() {
            try {
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError || !user) {
                    window.location.href = "auth.html";
                    return;
                }
                currentUser = user;
                document.getElementById('user-display').innerText = user.email;
                await fetchUserBalance();
                await loadRandomAd();
            } catch (err) {
                showError("Initialization failed.");
            }
        }

        async function fetchUserBalance() {
            const { data } = await supabaseClient
                .from('user_profiles')
                .select('tokens')
                .eq('id', currentUser.id)
                .maybeSingle();

            if (data) {
                currentTokens = data.tokens || 0;
            } else {
                await supabaseClient.from('user_profiles').insert([{ id: currentUser.id, username: currentUser.email, tokens: 0 }]);
                currentTokens = 0;
            }
            updateBalanceDisplay();
        }

        function updateBalanceDisplay() {
            document.getElementById('token-balance').innerText = `${currentTokens} Tokens`;
        }

        async function loadRandomAd() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                const csvText = await response.text();
                
                const rows = csvText.split('\n').map(row => {
                    return row.split(',').map(cell => cell.replace(/"/g, '').trim());
                }).filter(row => row.length >= 2);

                // Filter out header if it contains non-path strings
                const validAds = rows.filter(r => r[0].startsWith('/'));

                if (validAds.length === 0) {
                    showError("No valid ad paths (starting with /) found.");
                    return;
                }

                const randomAd = validAds[Math.floor(Math.random() * validAds.length)];
                
                // Get the base domain (e.g., https://example.com)
                const baseDomain = window.location.origin;
                // Combine: Domain + /directory/path
                const fullVideoUrl = baseDomain + randomAd[0];
                const webLink = randomAd[1];

                displayAd(fullVideoUrl, webLink);
            } catch (err) {
                showError("Failed to fetch ads.");
            }
        }

        function displayAd(videoUrl, webLink) {
            document.getElementById('status-msg').classList.add('hidden');
            document.getElementById('ad-card').classList.remove('hidden');

            const videoWrapper = document.getElementById('video-wrapper');
            const visitBtn = document.getElementById('visit-btn');
            const rewardBtn = document.getElementById('reward-btn');

            // Logic to handle if it's a direct mp4 file or an internal page
            if (videoUrl.endsWith('.mp4') || videoUrl.endsWith('.webm')) {
                videoWrapper.innerHTML = `<video src="${videoUrl}" autoplay muted playsinline class="w-full h-full"></video>`;
            } else {
                videoWrapper.innerHTML = `<iframe src="${videoUrl}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            }
            
            visitBtn.href = webLink;

            let timeLeft = 10;
            const timer = setInterval(() => {
                timeLeft--;
                rewardBtn.innerText = timeLeft > 0 ? `Watch for ${timeLeft}s...` : "Claim 3 Tokens Now!";
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    rewardBtn.disabled = false;
                    rewardBtn.classList.replace('bg-gray-600', 'bg-green-600');
                    rewardBtn.classList.remove('text-gray-400', 'cursor-not-allowed');
                    rewardBtn.onclick = claimTokens;
                }
            }, 1000);
        }

        async function claimTokens() {
            const rewardBtn = document.getElementById('reward-btn');
            rewardBtn.disabled = true;
            rewardBtn.innerText = "Processing...";

            const newBalance = currentTokens + 3;
            const { error } = await supabaseClient
                .from('user_profiles')
                .update({ tokens: newBalance })
                .eq('id', currentUser.id);

            if (!error) {
                currentTokens = newBalance;
                updateBalanceDisplay();
                rewardBtn.innerText = "Success! Reloading...";
                setTimeout(() => location.reload(), 1500);
            } else {
                rewardBtn.innerText = "Error. Try again.";
                rewardBtn.disabled = false;
            }
        }

        function showError(msg) {
            document.getElementById('status-msg').innerHTML = `<p class="text-red-500">${msg}</p>`;
        }

        window.onload = init;
    </script>
</body>
</html>

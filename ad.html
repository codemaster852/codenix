<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Ads - Earn Rewards</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            background: #000;
        }
        .video-container iframe, .video-container video {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        .sql-box {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #4ade80;
            text-align: left;
            margin-top: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4">

    <header class="w-full max-w-2xl flex justify-between items-center mb-8 p-4 bg-gray-800 rounded-xl shadow-lg">
        <div>
            <h1 class="text-xl font-bold text-blue-400">AdRewards</h1>
            <p id="user-display" class="text-sm text-gray-400">Loading user...</p>
        </div>
        <div class="text-right">
            <p class="text-xs uppercase tracking-widest text-gray-500">Balance</p>
            <p id="token-balance" class="text-2xl font-black text-yellow-500">0 Tokens</p>
        </div>
    </header>

    <main id="ad-card" class="w-full max-w-2xl bg-gray-800 rounded-2xl overflow-hidden shadow-2xl border border-gray-700 hidden">
        <div id="video-wrapper" class="video-container"></div>
        <div class="p-6 text-center">
            <h2 class="text-xl font-semibold mb-4">Watch to earn 3 tokens</h2>
            <div class="flex flex-col gap-3">
                <button id="reward-btn" disabled class="w-full py-4 bg-gray-600 text-gray-400 font-bold rounded-lg cursor-not-allowed transition-all">
                    Waiting for Video...
                </button>
                <a id="visit-btn" href="#" target="_blank" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg text-center transition-all">
                    Visit Sponsor Website
                </a>
            </div>
        </div>
    </main>

    <div id="status-msg" class="mt-20 text-center max-w-xl">
        <div id="spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p id="status-text" class="text-gray-400 font-medium">Connecting to Supabase...</p>
        <div id="debug-sql" class="hidden">
            <p class="text-sm text-gray-500 mt-4">If 'profiles' is still missing, run this in SQL Editor:</p>
            <div class="sql-box">
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users NOT NULL PRIMARY KEY,
  username TEXT,
  tokens INTEGER DEFAULT 0
);
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow individual read/write" ON public.profiles FOR ALL USING (auth.uid() = id);
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://rnlwrngfgvznndlekmrz.supabase.co";
        const SUPABASE_KEY = "sb_publishable_mtI0_ZBvU_n5oRuqV58QHg_qJt3Gfyt"; 
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1j0GMlqXCrCcbGxXVaYJCQlVTgHMm6Ocwwp8HdgpmL_E/gviz/tq?tqx=out:csv";
        const TABLE_NAME = 'profiles'; // Updated to match your database hint
        
        let supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) { console.error(e); }

        let currentUser = null;
        let currentTokens = 0;

        async function init() {
            try {
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError || !user) {
                    window.location.href = "auth.html";
                    return;
                }
                currentUser = user;
                document.getElementById('user-display').innerText = user.email;

                const success = await fetchUserBalance();
                if (success) {
                    await loadRandomAd();
                }
            } catch (err) {
                console.error("Init failed:", err);
                showError("Connection failed.");
            }
        }

        async function fetchUserBalance() {
            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('tokens')
                .eq('id', currentUser.id)
                .maybeSingle();

            if (error) {
                console.error("Fetch Error:", error);
                if (error.code === '42P01' || error.status === 404) {
                    showError(`Table '${TABLE_NAME}' does not exist.`);
                    document.getElementById('debug-sql').classList.remove('hidden');
                } else {
                    showError("Database error: " + error.message);
                }
                return false;
            }

            if (data) {
                currentTokens = data.tokens || 0;
            } else {
                // Auto-create profile row if missing
                const { error: insError } = await supabaseClient
                    .from(TABLE_NAME)
                    .insert([{ id: currentUser.id, username: currentUser.email, tokens: 0 }]);
                if (insError) console.error("Create failed:", insError);
                currentTokens = 0;
            }
            updateBalanceDisplay();
            return true;
        }

        function updateBalanceDisplay() {
            document.getElementById('token-balance').innerText = `${currentTokens} Tokens`;
        }

        async function loadRandomAd() {
            try {
                const response = await fetch(`${GOOGLE_SHEET_CSV_URL}&t=${Date.now()}`);
                const csvText = await response.text();
                const rows = csvText.split('\n').map(row => {
                    return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/"/g, '').trim());
                }).filter(row => row.length >= 2);

                const validAds = rows.filter(r => r[0].startsWith('/'));
                if (validAds.length === 0) {
                    showError("No valid ads found in sheet starting with '/'");
                    return;
                }

                const randomAd = validAds[Math.floor(Math.random() * validAds.length)];
                const fullVideoUrl = window.location.origin + randomAd[0];
                const webLink = randomAd[1];

                displayAd(fullVideoUrl, webLink);
            } catch (err) {
                showError("Failed to load ads from Google Sheet.");
            }
        }

        function displayAd(videoUrl, webLink) {
            document.getElementById('status-msg').classList.add('hidden');
            document.getElementById('ad-card').classList.remove('hidden');

            const videoWrapper = document.getElementById('video-wrapper');
            const visitBtn = document.getElementById('visit-btn');
            const rewardBtn = document.getElementById('reward-btn');

            if (videoUrl.toLowerCase().endsWith('.mp4') || videoUrl.toLowerCase().endsWith('.webm')) {
                videoWrapper.innerHTML = `<video src="${videoUrl}" autoplay muted playsinline class="w-full h-full"></video>`;
            } else {
                videoWrapper.innerHTML = `<iframe src="${videoUrl}" frameborder="0" allow="autoplay" allowfullscreen></iframe>`;
            }
            
            visitBtn.href = webLink;

            let timeLeft = 10;
            const timer = setInterval(() => {
                timeLeft--;
                rewardBtn.innerText = timeLeft > 0 ? `Watch for ${timeLeft}s...` : "Claim 3 Tokens Now!";
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    rewardBtn.disabled = false;
                    rewardBtn.className = "w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all cursor-pointer";
                    rewardBtn.onclick = claimTokens;
                }
            }, 1000);
        }

        async function claimTokens() {
            const rewardBtn = document.getElementById('reward-btn');
            if (rewardBtn.disabled) return;
            
            rewardBtn.disabled = true;
            rewardBtn.innerText = "Saving...";

            const newBalance = currentTokens + 3;
            const { error } = await supabaseClient
                .from(TABLE_NAME)
                .update({ tokens: newBalance })
                .eq('id', currentUser.id);

            if (!error) {
                currentTokens = newBalance;
                updateBalanceDisplay();
                rewardBtn.innerText = "Done! Reloading...";
                setTimeout(() => location.reload(), 1500);
            } else {
                showError("Save error. Please check your Table columns.");
                console.error("Update Error:", error);
            }
        }

        function showError(msg) {
            document.getElementById('status-text').innerText = msg;
            document.getElementById('status-text').classList.add('text-red-500');
            const spinner = document.getElementById('spinner');
            if (spinner) spinner.remove();
        }

        window.onload = init;
    </script>
</body>
</html>

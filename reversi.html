<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OthelloGen - Codenix AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { background-color: #000; color: #fff; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass-card { background: rgba(26, 26, 26, 0.6); backdrop-filter: blur(12px); border: 1px solid #333; }
        
        #othello-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            background-color: #333;
            border: 4px solid #333;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            touch-action: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .cell {
            background-color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cell:hover { background-color: #222; }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0);
            z-index: 10;
        }

        .piece.black { 
            background: radial-gradient(circle at 30% 30%, #444, #000); 
            transform: scale(1); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.8), inset 0 -2px 5px rgba(255,255,255,0.1); 
        }
        
        .piece.white { 
            background: radial-gradient(circle at 30% 30%, #fff, #bbb); 
            transform: scale(1); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 -2px 5px rgba(0,0,0,0.2); 
        }

        /* Valid Move Circles - Now persistent and more visible */
        .valid-move::after {
            content: '';
            width: 20%;
            height: 20%;
            background-color: rgba(16, 185, 129, 0.5);
            border-radius: 50%;
            position: absolute;
            z-index: 5;
            transition: transform 0.2s ease;
        }
        
        .cell:active .valid-move::after {
            transform: scale(1.5);
        }

        .eval-bar-container { width: 30px; height: 500px; background: #222; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid #333; }
        #eval-bar-fill { position: absolute; bottom: 0; width: 100%; background: #fff; transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        @media (max-width: 640px) {
            #othello-board { max-width: 92vw; }
            .valid-move::after { width: 15%; height: 15%; }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Top Navigation -->
    <div class="max-w-7xl mx-auto flex justify-between items-center mb-8">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='portal.html'" class="p-2 hover:bg-zinc-900 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <h1 class="text-xl md:text-2xl font-bold">OthelloGen <span class="text-emerald-500 text-xs md:text-sm font-mono ml-2">Neural v2</span></h1>
        </div>
        <div id="user-badge" class="px-3 py-1 md:px-4 md:py-1.5 rounded-full border border-zinc-800 text-[10px] md:text-sm font-medium flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-zinc-600 animate-pulse"></div>
            Authenticating...
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left Side: Board & Eval -->
        <div class="lg:col-span-7 flex gap-4 items-start justify-center">
            <div class="eval-bar-container hidden md:block">
                <div id="eval-bar-fill" style="height: 50%;"></div>
            </div>
            
            <div class="w-full">
                <div id="othello-board"></div>
                <div class="mt-4 md:mt-6 flex justify-between items-center bg-zinc-900 p-4 rounded-xl border border-zinc-800">
                    <div class="flex gap-4">
                        <div class="bg-black/40 px-3 py-1.5 rounded-lg border border-zinc-800 flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full bg-black border border-zinc-600"></div> 
                            <span id="black-score" class="font-bold text-white">2</span>
                        </div>
                        <div class="bg-white/10 px-3 py-1.5 rounded-lg border border-zinc-800 flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.3)]"></div> 
                            <span id="white-score" class="font-bold text-white">2</span>
                        </div>
                    </div>
                    <div id="game-status" class="text-xs md:text-sm font-bold text-emerald-500 tracking-wider uppercase">Your Turn</div>
                    <button onclick="resetGame()" class="p-2 hover:bg-zinc-800 rounded-lg text-zinc-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Side: Controls & History -->
        <div class="lg:col-span-5 space-y-6">
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4">Neural Engine Settings</h3>
                <div class="space-y-4">
                    <select id="level-select" class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-emerald-500 transition-all">
                        <option value="2">Level 1 (Sub-Process)</option>
                        <option value="4" selected>Level 2 (Neural Link)</option>
                        <option value="6">Level 3 (Super-Intelligence)</option>
                    </select>
                    <div class="text-[11px] text-zinc-500 italic bg-zinc-900/50 p-3 rounded-lg border border-zinc-800/50 leading-relaxed">
                        Notice: Green circles indicate valid move vectors. Click a circle to deploy your piece.
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 h-[250px] md:h-[300px] flex flex-col">
                <h3 class="text-sm font-bold text-zinc-500 uppercase tracking-widest mb-4">Tactical Log</h3>
                <div id="match-log" class="text-xs font-mono text-zinc-400 space-y-2 overflow-y-auto custom-scroll flex-1 pr-2">
                    <div class="text-emerald-500/70">> Othello Core initialized...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const supabaseUrl = 'https://rnlwrngfgvznndlekmrz.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJubHdybmdmZ3Z6bm5kbGVrbXJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzIxODMsImV4cCI6MjA4MTYwODE4M30.4al_pqjZBYgbfoLlMosT500PC85OGsUggCAL-hmtelA';
            const client = window.supabase.createClient(supabaseUrl, supabaseKey);

            let board = Array(8).fill().map(() => Array(8).fill(null));
            let currentPlayer = 'black';
            let gameOver = false;

            async function validateUser() {
                const { data: { session } } = await client.auth.getSession();
                if (!session) { 
                    window.location.href = 'auth.html'; 
                    return; 
                }
                document.getElementById('user-badge').innerHTML = '<span class="text-emerald-500 font-bold text-[10px]">VERIFIED SESSION</span>';
                initGame();
            }

            function initGame() {
                board = Array(8).fill().map(() => Array(8).fill(null));
                board[3][3] = 'white';
                board[3][4] = 'black';
                board[4][3] = 'black';
                board[4][4] = 'white';
                currentPlayer = 'black';
                gameOver = false;
                renderBoard();
                updateUI();
            }

            function renderBoard() {
                const boardEl = document.getElementById('othello-board');
                boardEl.innerHTML = '';
                const validMoves = getValidMoves(board, currentPlayer);

                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        
                        // Show circles if it's a valid move for the human player
                        if (currentPlayer === 'black' && validMoves.some(m => m.r === r && m.c === c)) {
                            cell.classList.add('valid-move');
                        }
                        
                        const piece = document.createElement('div');
                        piece.className = `piece ${board[r][c] || ''}`;
                        cell.appendChild(piece);
                        
                        cell.onclick = () => handleCellClick(r, c);
                        boardEl.appendChild(cell);
                    }
                }
            }

            function getValidMoves(tempBoard, player) {
                const moves = [];
                const opponent = player === 'black' ? 'white' : 'black';
                const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];

                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (tempBoard[r][c]) continue;
                        let canMove = false;
                        for (let [dr, dc] of dirs) {
                            let nr = r + dr, nc = c + dc;
                            let hasOpponent = false;
                            while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && tempBoard[nr][nc] === opponent) {
                                hasOpponent = true;
                                nr += dr; nc += dc;
                            }
                            if (hasOpponent && nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && tempBoard[nr][nc] === player) {
                                canMove = true; break;
                            }
                        }
                        if (canMove) moves.push({r, c});
                    }
                }
                return moves;
            }

            function makeMove(tempBoard, r, c, player) {
                const newBoard = tempBoard.map(row => [...row]);
                const opponent = player === 'black' ? 'white' : 'black';
                const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
                newBoard[r][c] = player;

                for (let [dr, dc] of dirs) {
                    let nr = r + dr, nc = c + dc;
                    let piecesToFlip = [];
                    while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && newBoard[nr][nc] === opponent) {
                        piecesToFlip.push({r: nr, c: nc});
                        nr += dr; nc += dc;
                    }
                    if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && newBoard[nr][nc] === player) {
                        piecesToFlip.forEach(p => newBoard[p.r][p.c] = player);
                    }
                }
                return newBoard;
            }

            function handleCellClick(r, c) {
                if (currentPlayer !== 'black' || gameOver) return;
                const moves = getValidMoves(board, 'black');
                if (!moves.some(m => m.r === r && m.c === c)) return;

                board = makeMove(board, r, c, 'black');
                logMove(`Black occupied ${String.fromCharCode(65 + c)}${r + 1}`);
                nextTurn();
            }

            function nextTurn() {
                currentPlayer = currentPlayer === 'black' ? 'white' : 'black';
                const moves = getValidMoves(board, currentPlayer);
                
                if (moves.length === 0) {
                    logMove(`${currentPlayer.toUpperCase()} forced to pass.`);
                    currentPlayer = currentPlayer === 'black' ? 'white' : 'black';
                    const nextMoves = getValidMoves(board, currentPlayer);
                    if (nextMoves.length === 0) {
                        endGame();
                        return;
                    }
                }

                renderBoard();
                updateUI();

                if (currentPlayer === 'white' && !gameOver) {
                    document.getElementById('game-status').innerText = 'Neural Calculation...';
                    setTimeout(aiMove, 800);
                }
            }

            function aiMove() {
                const depth = parseInt(document.getElementById('level-select').value);
                const best = minimax(board, depth, -Infinity, Infinity, true);
                if (best.move) {
                    board = makeMove(board, best.move.r, best.move.c, 'white');
                    logMove(`White calculated ${String.fromCharCode(65 + best.move.c)}${best.move.r + 1}`);
                }
                nextTurn();
            }

            function evaluate(tempBoard) {
                let score = 0;
                const weights = [
                    [100, -20, 10, 5, 5, 10, -20, 100],
                    [-20, -50, -2, -2, -2, -2, -50, -20],
                    [10, -2, 5, 1, 1, 5, -2, 10],
                    [5, -2, 1, 0, 0, 1, -2, 5],
                    [5, -2, 1, 0, 0, 1, -2, 5],
                    [10, -2, 5, 1, 1, 5, -2, 10],
                    [-20, -50, -2, -2, -2, -2, -50, -20],
                    [100, -20, 10, 5, 5, 10, -20, 100]
                ];

                for(let r=0; r<8; r++) {
                    for(let c=0; c<8; c++) {
                        if (tempBoard[r][c] === 'white') score += weights[r][c];
                        if (tempBoard[r][c] === 'black') score -= weights[r][c];
                    }
                }
                return score;
            }

            function minimax(tempBoard, depth, alpha, beta, isMax) {
                const moves = getValidMoves(tempBoard, isMax ? 'white' : 'black');
                if (depth === 0 || moves.length === 0) return { score: evaluate(tempBoard) };

                let bestMove = null;
                if (isMax) {
                    let maxEval = -Infinity;
                    for (const move of moves) {
                        const nextBoard = makeMove(tempBoard, move.r, move.c, 'white');
                        const ev = minimax(nextBoard, depth - 1, alpha, beta, false).score;
                        if (ev > maxEval) { maxEval = ev; bestMove = move; }
                        alpha = Math.max(alpha, ev);
                        if (beta <= alpha) break;
                    }
                    return { score: maxEval, move: bestMove };
                } else {
                    let minEval = Infinity;
                    for (const move of moves) {
                        const nextBoard = makeMove(tempBoard, move.r, move.c, 'black');
                        const ev = minimax(nextBoard, depth - 1, alpha, beta, true).score;
                        if (ev < minEval) { minEval = ev; bestMove = move; }
                        beta = Math.min(beta, ev);
                        if (beta <= alpha) break;
                    }
                    return { score: minEval, move: bestMove };
                }
            }

            function updateUI() {
                let black = 0, white = 0;
                board.forEach(row => row.forEach(cell => {
                    if (cell === 'black') black++;
                    if (cell === 'white') white++;
                }));
                document.getElementById('black-score').innerText = black;
                document.getElementById('white-score').innerText = white;
                document.getElementById('game-status').innerText = currentPlayer === 'black' ? 'Your Turn' : 'Engine Link Active...';
                
                const total = black + white;
                const percentWhite = (white / total) * 100;
                document.getElementById('eval-bar-fill').style.height = `${percentWhite}%`;
            }

            function logMove(msg) {
                const log = document.getElementById('match-log');
                const entry = document.createElement('div');
                entry.className = "border-l-2 border-emerald-500/20 pl-2 py-1";
                entry.innerText = `> ${msg}`;
                log.prepend(entry);
            }

            function endGame() {
                gameOver = true;
                const black = parseInt(document.getElementById('black-score').innerText);
                const white = parseInt(document.getElementById('white-score').innerText);
                let winner = black > white ? 'Black Objective Achieved' : (white > black ? 'White Objective Achieved' : 'Stalemate');
                document.getElementById('game-status').innerText = winner;
                logMove(`TERMINATED: ${winner}`);
            }

            window.resetGame = () => { 
                document.getElementById('match-log').innerHTML = '<div class="text-emerald-500/70">> Memory purged. System reset.</div>';
                initGame(); 
            };

            validateUser();
        })();
    </script>
</body>
</html>

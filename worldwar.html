<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World War: Tactical Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #020205;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        canvas {
            background: radial-gradient(circle at center, #0a0a1a 0%, #020205 100%);
            max-width: 100%;
            max-height: 100%;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 20px 20px 20px;
        }
        .hud {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .menu-screen {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: all;
        }
        .btn {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            padding: 16px 48px;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: 800;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.2s;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(255, 65, 108, 0.4);
        }
        .btn:active { transform: scale(0.92); }
        .status-bar {
            width: 140px;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        #health-inner {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #ff4b2b, #ff416c);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #boss-health-container {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .boss-bar {
            height: 10px;
            background: #222;
            border: 1px solid #f00;
            border-radius: 5px;
            overflow: hidden;
        }
        #boss-health-inner { width: 100%; height: 100%; background: #f00; box-shadow: 0 0 10px #f00; }
        
        .mobile-controls {
            position: absolute;
            bottom: 40px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 60;
        }
        .control-btn {
            width: 75px;
            height: 75px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 900;
            pointer-events: all;
            backdrop-filter: blur(5px);
            -webkit-tap-highlight-color: transparent;
            font-size: 10px;
            text-align: center;
        }
        .control-btn:active { background: rgba(255, 65, 108, 0.4); border-color: #ff416c; }
        .flash {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 50;
        }
        .joystick-area {
            width: 130px;
            height: 130px;
            background: rgba(255,255,255,0.03);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .joystick-stick {
            width: 55px;
            height: 55px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="flash-overlay" class="flash"></div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="boss-health-container">
        <div class="text-[10px] text-red-500 font-bold mb-1 tracking-widest text-center uppercase">Colossal Threat Detected</div>
        <div class="boss-bar"><div id="boss-health-inner"></div></div>
    </div>

    <div class="ui-overlay">
        <div class="hud">
            <div>
                <span class="text-[10px] text-gray-500">SCORE</span><br>
                <span id="score" class="text-white text-2xl font-black">0</span>
                <div class="status-bar"><div id="health-inner"></div></div>
                <div class="text-[9px] mt-1 text-cyan-400 font-bold">WEAPON LVL: <span id="wpn-lvl">1</span></div>
            </div>
            <div class="text-right">
                <span class="text-[10px] text-gray-500">SECTOR</span><br>
                <span id="wave-display" class="text-red-600 text-2xl font-black">1</span>
                <div class="text-[9px] mt-2 text-yellow-500 font-bold">BOMBS: <span id="bomb-count">3</span></div>
            </div>
        </div>

        <div class="mobile-controls" id="mobile-controls">
            <div class="joystick-area" id="joy-container">
                <div class="joystick-stick" id="joy-stick"></div>
            </div>
            <div class="flex flex-col gap-4">
                <div class="control-btn" id="bomb-btn">LAUNCH<br>BOMB</div>
                <div class="control-btn" id="fire-btn">AUTO<br>FIRE</div>
            </div>
        </div>
    </div>

    <div id="start-menu" class="menu-screen">
        <h1 class="text-6xl font-black mb-1 tracking-tighter italic text-white">WORLD<span class="text-red-600">WAR</span></h1>
        <p class="text-cyan-500 text-[10px] tracking-[0.5em] mb-12 uppercase font-bold">Final Offensive Protocol</p>
        <button class="btn mb-12" onclick="startGame()">INITIATE SYSTEM</button>
        <div class="text-[9px] text-gray-500 flex flex-col gap-2 items-center uppercase tracking-widest">
            <span>Destroy Bosses every 5 sectors</span>
            <span>Collect cores to upgrade weaponry</span>
            <span>Mobile: Joystick to move, tap buttons to fight</span>
        </div>
    </div>

    <div id="game-over" class="menu-screen hidden">
        <h2 class="text-5xl font-black mb-2 text-red-600 italic">MISSION FAILED</h2>
        <p class="text-gray-400 uppercase tracking-widest text-sm mb-10">Sector Cleared: <span id="final-wave" class="text-white">1</span></p>
        <button class="btn" onclick="startGame()">RE-DEPLOY UNIT</button>
    </div>
</div>

<script>
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const finalWaveEl = document.getElementById('final-wave');
const healthInner = document.getElementById('health-inner');
const waveDisplay = document.getElementById('wave-display');
const wpnLvlDisplay = document.getElementById('wpn-lvl');
const bombCountDisplay = document.getElementById('bomb-count');
const flashOverlay = document.getElementById('flash-overlay');
const bossHealthContainer = document.getElementById('boss-health-container');
const bossHealthInner = document.getElementById('boss-health-inner');

// --- AUDIO SYNTH ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, duration, vol = 0.1, slide = 10) {
    try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(slide, audioCtx.currentTime + duration);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    } catch(e) {}
}

const sounds = {
    shoot: () => playSound(350, 'square', 0.1, 0.04),
    missile: () => playSound(800, 'sine', 0.2, 0.02, 200),
    hit: () => playSound(150, 'sawtooth', 0.1, 0.08),
    explode: () => playSound(60, 'sawtooth', 0.5, 0.2),
    bossHurt: () => playSound(100, 'square', 0.1, 0.1, 50),
    powerup: () => {
        playSound(400, 'sine', 0.4, 0.1, 1200);
        setTimeout(() => playSound(600, 'sine', 0.4, 0.1, 1500), 100);
    },
    bomb: () => playSound(40, 'sawtooth', 2.0, 0.4, 5)
};

// --- STATE ---
let gameActive = false;
let score = 0;
let wave = 1;
let enemies = [];
let bullets = [];
let enemyBullets = [];
let particles = [];
let powerups = [];
let missiles = [];
let keys = {};
let screenShake = 0;
let bombs = 3;
let autoFire = true;
let boss = null;

let joyActive = false;
let joyX = 0, joyY = 0;
let joyOriginX = 0, joyOriginY = 0;

const PLAYER_SPEED = 7.5;
const BULLET_SPEED = 14;
let lastSpawn = 0;

function resize() {
    canvas.width = Math.min(window.innerWidth, 500);
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Controls
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (e.code === 'KeyB') useBomb();
});
window.addEventListener('keyup', e => keys[e.code] = false);

document.getElementById('bomb-btn').addEventListener('touchstart', (e) => { e.preventDefault(); useBomb(); });
document.getElementById('fire-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    autoFire = !autoFire;
    document.getElementById('fire-btn').style.background = autoFire ? 'rgba(255, 65, 108, 0.4)' : 'rgba(255,255,255,0.08)';
});

const joyContainer = document.getElementById('joy-container');
const joyStick = document.getElementById('joy-stick');
joyContainer.addEventListener('touchstart', e => {
    joyActive = true;
    const rect = joyContainer.getBoundingClientRect();
    joyOriginX = rect.left + rect.width / 2;
    joyOriginY = rect.top + rect.height / 2;
}, {passive: false});
window.addEventListener('touchmove', e => {
    if (!joyActive) return;
    const touch = e.touches[0];
    const dx = touch.clientX - joyOriginX, dy = touch.clientY - joyOriginY;
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 45);
    const angle = Math.atan2(dy, dx);
    joyX = (dist * Math.cos(angle)) / 45;
    joyY = (dist * Math.sin(angle)) / 45;
    joyStick.style.transform = `translate(${joyX * 45}px, ${joyY * 45}px)`;
}, {passive: false});
window.addEventListener('touchend', () => { joyActive = false; joyX = 0; joyY = 0; joyStick.style.transform = `translate(0,0)`; });

class Player {
    constructor() {
        this.width = 44; this.height = 44;
        this.x = canvas.width / 2 - 22; this.y = canvas.height - 180;
        this.health = 100; this.fireRate = 160; this.lastFire = 0;
        this.wpnLvl = 1; this.lastMissile = 0;
    }
    update() {
        if (keys['ArrowLeft'] || keys['KeyA']) this.x -= PLAYER_SPEED;
        if (keys['ArrowRight'] || keys['KeyD']) this.x += PLAYER_SPEED;
        if (keys['ArrowUp'] || keys['KeyW']) this.y -= PLAYER_SPEED;
        if (keys['ArrowDown'] || keys['KeyS']) this.y += PLAYER_SPEED;
        this.x += joyX * PLAYER_SPEED; this.y += joyY * PLAYER_SPEED;
        this.x = Math.max(0, Math.min(canvas.width - this.width, this.x));
        this.y = Math.max(0, Math.min(canvas.height - this.height, this.y));
        if (autoFire || keys['Space']) this.fire();
        if (Date.now() - this.lastMissile > 2000 && enemies.length > 0) this.launchMissile();
    }
    fire() {
        const now = Date.now();
        if (now - this.lastFire > this.fireRate) {
            sounds.shoot();
            const cx = this.x + this.width/2;
            if (this.wpnLvl === 1) bullets.push(new Bullet(cx, this.y, 0, -BULLET_SPEED));
            else if (this.wpnLvl === 2) {
                bullets.push(new Bullet(this.x + 8, this.y, 0, -BULLET_SPEED));
                bullets.push(new Bullet(this.x + this.width - 8, this.y, 0, -BULLET_SPEED));
            } else if (this.wpnLvl === 3) {
                bullets.push(new Bullet(cx, this.y, 0, -BULLET_SPEED));
                bullets.push(new Bullet(this.x, this.y, -2.5, -BULLET_SPEED));
                bullets.push(new Bullet(this.x + this.width, this.y, 2.5, -BULLET_SPEED));
            } else {
                bullets.push(new Bullet(cx, this.y, 0, -BULLET_SPEED));
                bullets.push(new Bullet(this.x - 5, this.y, -1.5, -BULLET_SPEED));
                bullets.push(new Bullet(this.x + this.width + 5, this.y, 1.5, -BULLET_SPEED));
                bullets.push(new Bullet(this.x - 12, this.y, -3.5, -BULLET_SPEED));
                bullets.push(new Bullet(this.x + this.width + 12, this.y, 3.5, -BULLET_SPEED));
            }
            this.lastFire = now;
        }
    }
    launchMissile() {
        sounds.missile();
        missiles.push(new Missile(this.x + this.width/2, this.y));
        this.lastMissile = Date.now();
    }
    draw() {
        ctx.save();
        ctx.shadowBlur = 15; ctx.shadowColor = '#00f2ff';
        // Engine Flash
        ctx.fillStyle = '#ff6600';
        ctx.beginPath();
        ctx.moveTo(this.x + 10, this.y + this.height);
        ctx.lineTo(this.x + 22, this.y + this.height + (Math.random() * 15));
        ctx.lineTo(this.x + 34, this.y + this.height);
        ctx.fill();
        // Body
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.moveTo(this.x + 22, this.y);
        ctx.lineTo(this.x + 44, this.y + 44);
        ctx.lineTo(this.x + 22, this.y + 36);
        ctx.lineTo(this.x, this.y + 44);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
}

class Enemy {
    constructor(type = 'grunt') {
        this.type = type;
        this.width = type === 'heavy' ? 50 : 32;
        this.height = type === 'heavy' ? 50 : 32;
        this.x = Math.random() * (canvas.width - this.width);
        this.y = -60;
        this.speed = (type === 'kamikaze' ? 5 : type === 'grunt' ? 2.8 : 1.8) + (wave * 0.15);
        this.health = type === 'heavy' ? 5 : type === 'shield' ? 3 : 1;
        this.lastFire = Date.now() + Math.random() * 2000;
        this.angle = 0;
    }
    update() {
        this.y += this.speed;
        if (this.type === 'shield') this.x += Math.sin(this.y / 30) * 3;
        if (this.type === 'kamikaze') {
            const dx = (player.x + 22) - (this.x + this.width/2);
            this.x += dx * 0.02;
        }
        if (Date.now() - this.lastFire > 2500 - (wave * 50) && this.type !== 'kamikaze') {
            enemyBullets.push(new Bullet(this.x + this.width/2, this.y + this.height, 0, 5, true));
            this.lastFire = Date.now();
        }
    }
    draw() {
        ctx.save();
        if (this.type === 'shield') {
            ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(this.x + this.width/2, this.y + this.height/2, 22, 0, Math.PI*2); ctx.stroke();
        }
        ctx.fillStyle = this.type === 'grunt' ? '#ff3333' : this.type === 'kamikaze' ? '#ff9900' : this.type === 'shield' ? '#3366ff' : '#990000';
        ctx.fillRect(this.x, this.y, this.width, this.height);
        ctx.restore();
    }
}

class Boss {
    constructor() {
        this.width = 200; this.height = 100;
        this.x = canvas.width/2 - 100; this.y = -150;
        this.maxHealth = 100 + (wave * 20);
        this.health = this.maxHealth;
        this.targetY = 80;
        this.lastFire = 0;
        this.phase = 0;
    }
    update() {
        if (this.y < this.targetY) this.y += 1;
        this.x += Math.sin(Date.now() / 1000) * 2;
        if (Date.now() - this.lastFire > 1200 - (wave * 50)) {
            sounds.shoot();
            for(let i=-2; i<=2; i++) {
                enemyBullets.push(new Bullet(this.x + 100, this.y + 100, i * 1.5, 4, true));
            }
            this.lastFire = Date.now();
        }
    }
    draw() {
        ctx.save();
        ctx.shadowBlur = 20; ctx.shadowColor = '#f00';
        ctx.fillStyle = '#222';
        ctx.fillRect(this.x, this.y, this.width, this.height);
        ctx.fillStyle = '#f00';
        ctx.fillRect(this.x + 20, this.y + 20, 30, 30);
        ctx.fillRect(this.x + 150, this.y + 20, 30, 30);
        ctx.restore();
    }
}

class Bullet {
    constructor(x, y, vx, vy, isEnemy = false) {
        this.x = x; this.y = y; this.vx = vx; this.vy = vy; this.isEnemy = isEnemy;
    }
    update() { this.x += this.vx; this.y += this.vy; }
    draw() {
        ctx.fillStyle = this.isEnemy ? '#f00' : '#0ff';
        ctx.beginPath(); ctx.arc(this.x, this.y, this.isEnemy ? 4 : 3, 0, Math.PI*2); ctx.fill();
    }
}

class Missile {
    constructor(x, y) {
        this.x = x; this.y = y; this.speed = 5; this.target = null;
    }
    update() {
        if (!this.target || !enemies.includes(this.target)) {
            this.target = enemies[0] || null;
        }
        if (this.target) {
            const dx = (this.target.x + this.target.width/2) - this.x;
            const dy = (this.target.y + this.target.height/2) - this.y;
            const angle = Math.atan2(dy, dx);
            this.x += Math.cos(angle) * this.speed;
            this.y += Math.sin(angle) * this.speed;
            this.speed += 0.2;
        } else {
            this.y -= this.speed;
        }
    }
    draw() {
        ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#fff';
        ctx.fillRect(this.x - 2, this.y - 5, 4, 10);
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.vx = (Math.random()-0.5)*10; this.vy = (Math.random()-0.5)*10;
        this.life = 1.0; this.decay = 0.02 + Math.random()*0.03; this.color = color;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= this.decay; }
    draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 3, 3); ctx.globalAlpha = 1; }
}

class PowerUp {
    constructor(x, y) {
        this.x = x; this.y = y; this.type = Math.random() > 0.4 ? 'W' : 'H';
    }
    update() { this.y += 2; }
    draw() {
        ctx.fillStyle = this.type === 'W' ? '#0ff' : '#0f0';
        ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
        ctx.beginPath(); ctx.arc(this.x, this.y, 12, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#000'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText(this.type, this.x, this.y+5);
    }
}

let player;
function createExplosion(x, y, color = '#ff4b2b', count = 20) {
    sounds.explode(); screenShake = Math.max(screenShake, count/2);
    for(let i=0; i<count; i++) particles.push(new Particle(x, y, color));
}

function useBomb() {
    if (bombs <= 0 || !gameActive) return;
    bombs--; sounds.bomb(); flashOverlay.style.opacity = '0.7';
    setTimeout(() => flashOverlay.style.opacity = '0', 200);
    screenShake = 30;
    enemies.forEach(e => { score += 100; createExplosion(e.x+e.width/2, e.y+e.height/2, '#fff', 15); });
    enemies = []; enemyBullets = []; updateUI();
}

function startGame() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    gameActive = true; score = 0; wave = 1; bombs = 3; boss = null;
    enemies = []; bullets = []; enemyBullets = []; particles = []; powerups = []; missiles = [];
    player = new Player();
    document.getElementById('start-menu').classList.add('hidden');
    document.getElementById('game-over').classList.add('hidden');
    bossHealthContainer.style.opacity = '0';
    updateUI();
    requestAnimationFrame(gameLoop);
}

function updateUI() {
    scoreEl.innerText = score.toLocaleString();
    healthInner.style.width = `${player.health}%`;
    waveDisplay.innerText = wave;
    wpnLvlDisplay.innerText = player.wpnLvl;
    bombCountDisplay.innerText = bombs;
}

function checkCollisions() {
    // Player bullets -> Enemies/Boss
    bullets.forEach((b, bi) => {
        if (boss && b.x > boss.x && b.x < boss.x + boss.width && b.y > boss.y && b.y < boss.y + boss.height) {
            boss.health--; sounds.bossHurt(); bullets.splice(bi, 1);
            bossHealthInner.style.width = `${(boss.health/boss.maxHealth)*100}%`;
            if (boss.health <= 0) {
                createExplosion(boss.x + 100, boss.y + 50, '#fff', 60);
                score += 5000; boss = null; bossHealthContainer.style.opacity = '0';
                wave++; updateUI();
            }
            return;
        }
        enemies.forEach((e, ei) => {
            if (b.x > e.x && b.x < e.x+e.width && b.y > e.y && b.y < e.y+e.height) {
                e.health--; bullets.splice(bi, 1);
                if (e.health <= 0) {
                    createExplosion(e.x+e.width/2, e.y+e.height/2, '#f44');
                    score += 100; if (Math.random() > 0.88) powerups.push(new PowerUp(e.x+e.width/2, e.y+e.height/2));
                    enemies.splice(ei, 1); updateUI();
                }
            }
        });
    });

    // Missiles
    missiles.forEach((m, mi) => {
        enemies.forEach((e, ei) => {
            if (Math.hypot(m.x - (e.x+e.width/2), m.y - (e.y+e.height/2)) < 25) {
                createExplosion(e.x+e.width/2, e.y+e.height/2, '#fff', 20);
                enemies.splice(ei, 1); missiles.splice(mi, 1);
                score += 150; updateUI();
            }
        });
    });

    // Enemy Bullets -> Player
    enemyBullets.forEach((b, bi) => {
        if (b.x > player.x && b.x < player.x+player.width && b.y > player.y && b.y < player.y+player.height) {
            player.health -= 12; sounds.hit(); screenShake = 15; enemyBullets.splice(bi, 1);
            updateUI(); if (player.health <= 0) endGame();
        }
    });

    // Powerups
    powerups.forEach((p, pi) => {
        if (Math.hypot(player.x+22 - p.x, player.y+22 - p.y) < 35) {
            sounds.powerup();
            if (p.type === 'W') { player.wpnLvl = Math.min(4, player.wpnLvl + 1); player.fireRate = Math.max(100, player.fireRate - 10); }
            else { player.health = Math.min(100, player.health + 30); }
            powerups.splice(pi, 1); updateUI();
        }
    });
}

function endGame() {
    gameActive = false; finalWaveEl.innerText = wave;
    document.getElementById('game-over').classList.remove('hidden');
}

let stars = Array(40).fill().map(() => ({ x: Math.random()*500, y: Math.random()*1000, s: Math.random()*3+1 }));

function gameLoop() {
    if (!gameActive) return;
    ctx.save();
    if (screenShake > 0) { ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake); screenShake *= 0.9; }
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Starfield
    ctx.fillStyle = '#334';
    stars.forEach(s => {
        ctx.fillRect(s.x, s.y, s.s, s.s); s.y += s.s * 1.5;
        if (s.y > canvas.height) { s.y = -10; s.x = Math.random()*canvas.width; }
    });

    player.update(); player.draw();

    // Spawning
    if (wave % 5 === 0 && !boss) {
        boss = new Boss();
        bossHealthContainer.style.opacity = '1';
        bossHealthInner.style.width = '100%';
    } else if (!boss && Date.now() - lastSpawn > Math.max(300, 1500 - (wave*80))) {
        const r = Math.random();
        let type = 'grunt';
        if (r > 0.9) type = 'heavy';
        else if (r > 0.8) type = 'kamikaze';
        else if (r > 0.7) type = 'shield';
        enemies.push(new Enemy(type));
        lastSpawn = Date.now();
        if (score > wave * 3000) { wave++; updateUI(); }
    }

    if (boss) { boss.update(); boss.draw(); }

    [bullets, enemyBullets, enemies, particles, powerups, missiles].forEach(collection => {
        for (let i = collection.length - 1; i >= 0; i--) {
            const item = collection[i];
            item.update(); item.draw();
            if (item.y < -200 || item.y > canvas.height + 200 || (item instanceof Particle && item.life <= 0)) {
                collection.splice(i, 1);
            }
        }
    });

    checkCollisions();
    ctx.restore();
    requestAnimationFrame(gameLoop);
}
window.startGame = startGame;
</script>
</body>
</html>

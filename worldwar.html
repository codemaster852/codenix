<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World War: Tactical Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        body {
            margin: 0; padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        canvas {
            background: #020205;
            max-width: 100%;
            max-height: 100%;
            filter: contrast(1.1) brightness(1.1);
        }
        /* CRT Effect */
        #game-container::after {
            content: " ";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 100;
        }
        .ui-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 20px 20px 20px;
            z-index: 80;
        }
        .status-bar {
            width: 150px; height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
            margin-top: 4px;
        }
        #health-inner {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #ff0044, #ff5e00);
            box-shadow: 0 0 10px #ff0044;
            transition: width 0.2s ease-out;
        }
        .mobile-controls {
            position: absolute;
            bottom: 30px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: flex-end;
            pointer-events: none;
        }
        .control-btn {
            width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-weight: 900; pointer-events: all;
            backdrop-filter: blur(5px); font-size: 9px; text-align: center;
            -webkit-tap-highlight-color: transparent;
        }
        .control-btn:active { background: rgba(255, 0, 68, 0.5); transform: scale(0.9); }
        .joystick-area {
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.03);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            pointer-events: all; border: 1px solid rgba(255,255,255,0.1);
        }
        .joystick-stick {
            width: 50px; height: 50px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.3);
        }
        .menu-screen {
            position: absolute; z-index: 200;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: all;
        }
        .glitch-text {
            text-shadow: 2px 0 #f0f, -2px 0 #0ff;
            animation: glitch 1s infinite;
        }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        #boss-health-container {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            width: 70%; opacity: 0; transition: opacity 0.5s;
        }
        .flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; opacity: 0; pointer-events: none; z-index: 150;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="flash-overlay" class="flash"></div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="boss-health-container">
        <div class="text-[9px] text-red-500 font-bold mb-1 tracking-widest text-center uppercase">Vanguard Dreadnought</div>
        <div class="h-1.5 w-full bg-gray-900 border border-red-500 rounded-full overflow-hidden">
            <div id="boss-health-inner" class="h-full bg-red-600 shadow-[0_0_10px_#f00]"></div>
        </div>
    </div>

    <div class="ui-overlay">
        <div class="flex justify-between items-start">
            <div>
                <div class="text-[9px] text-cyan-400 font-bold tracking-widest">RANK: <span id="rank">NOVICE</span></div>
                <div id="score" class="text-3xl font-black italic">0</div>
                <div class="status-bar"><div id="health-inner"></div></div>
                <div class="flex gap-2 mt-2">
                    <div class="text-[8px] text-gray-400 uppercase">EMP: <span id="emp-count" class="text-white">3</span></div>
                    <div class="text-[8px] text-gray-400 uppercase">WPN: <span id="wpn-lvl" class="text-cyan-400">1</span></div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[9px] text-red-500 font-bold tracking-widest">SECTOR</div>
                <div id="wave-display" class="text-3xl font-black italic">1</div>
                <div id="multiplier-tag" class="text-[10px] text-yellow-500 font-black italic opacity-0">x<span id="multiplier">1.0</span> MULTI</div>
            </div>
        </div>

        <div class="mobile-controls">
            <div class="joystick-area" id="joy-container">
                <div class="joystick-stick" id="joy-stick"></div>
            </div>
            <div class="flex flex-col gap-3">
                <div class="control-btn" id="bomb-btn">GIGA<br>BOMB</div>
                <div class="control-btn" id="emp-btn" style="border-color: #0ff; color: #0ff;">EMP<br>BURST</div>
            </div>
        </div>
    </div>

    <div id="start-menu" class="menu-screen">
        <h1 class="text-6xl font-black italic glitch-text tracking-tighter mb-2">WORLD<span class="text-red-600">WAR</span></h1>
        <p class="text-[10px] tracking-[0.4em] mb-12 text-gray-500 font-bold uppercase">Tactical Bullet Hell Edition</p>
        <button class="px-10 py-4 bg-white text-black font-black italic rounded hover:bg-cyan-500 transition-colors uppercase text-lg" onclick="startGame()">Commence</button>
        <div class="mt-12 text-[8px] text-gray-600 uppercase tracking-widest text-center leading-relaxed">
            Joystick to navigate <br>
            EMP clears localized bullets <br>
            Avoid enemy contact at all costs
        </div>
    </div>

    <div id="game-over" class="menu-screen hidden">
        <h2 class="text-4xl font-black text-red-600 mb-2 italic">NEURAL LINK LOST</h2>
        <p class="text-sm text-gray-400 mb-8 uppercase tracking-[0.3em]">Sector Depth: <span id="final-wave" class="text-white">0</span></p>
        <button class="px-8 py-3 border-2 border-white text-white font-black hover:bg-white hover:text-black transition-all italic" onclick="startGame()">Synchronize Again</button>
    </div>
</div>

<script>
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const multiEl = document.getElementById('multiplier');
const multiTag = document.getElementById('multiplier-tag');
const wpnEl = document.getElementById('wpn-lvl');
const empEl = document.getElementById('emp-count');
const rankEl = document.getElementById('rank');

// Audio setup
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function sfx(freq, type, dur, vol, slide=0) {
    try {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        if (slide) o.frequency.exponentialRampToValueAtTime(slide, audioCtx.currentTime + dur);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + dur);
    } catch(e){}
}

// State
let gameActive = false, score = 0, wave = 1, multiplier = 1, multiTimer = 0;
let enemies = [], bullets = [], enemyBullets = [], particles = [], powerups = [], missiles = [];
let player, boss = null, bombs = 3, emps = 3, screenShake = 0, lastSpawn = 0;
let joyActive = false, joyX = 0, joyY = 0, joyOriginX = 0, joyOriginY = 0;

function resize() {
    canvas.width = Math.min(window.innerWidth, 500);
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Controls
const keys = {};
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if(e.code === 'KeyB') useBomb();
    if(e.code === 'KeyE') useEMP();
});
window.addEventListener('keyup', e => keys[e.code] = false);

document.getElementById('bomb-btn').addEventListener('touchstart', (e) => { e.preventDefault(); useBomb(); });
document.getElementById('emp-btn').addEventListener('touchstart', (e) => { e.preventDefault(); useEMP(); });

const joyArea = document.getElementById('joy-container');
const joyStick = document.getElementById('joy-stick');
joyArea.addEventListener('touchstart', e => {
    joyActive = true;
    const r = joyArea.getBoundingClientRect();
    joyOriginX = r.left + r.width/2; joyOriginY = r.top + r.height/2;
}, {passive:false});
window.addEventListener('touchmove', e => {
    if(!joyActive) return;
    const t = e.touches[0];
    const dx = t.clientX - joyOriginX, dy = t.clientY - joyOriginY;
    const d = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
    const a = Math.atan2(dy, dx);
    joyX = (d * Math.cos(a)) / 40; joyY = (d * Math.sin(a)) / 40;
    joyStick.style.transform = `translate(${joyX*40}px, ${joyY*40}px)`;
}, {passive:false});
window.addEventListener('touchend', () => { joyActive = false; joyX = 0; joyY = 0; joyStick.style.transform = `translate(0,0)`; });

class Player {
    constructor() {
        this.x = canvas.width/2; this.y = canvas.height - 150;
        this.w = 36; this.h = 36; this.hp = 100;
        this.lvl = 1; this.lastFire = 0; this.lastMissile = 0;
    }
    update() {
        const speed = 7;
        if(keys['ArrowLeft'] || keys['KeyA']) this.x -= speed;
        if(keys['ArrowRight'] || keys['KeyD']) this.x += speed;
        if(keys['ArrowUp'] || keys['KeyW']) this.y -= speed;
        if(keys['ArrowDown'] || keys['KeyS']) this.y += speed;
        this.x += joyX * speed; this.y += joyY * speed;
        this.x = Math.max(10, Math.min(canvas.width - 10, this.x));
        this.y = Math.max(10, Math.min(canvas.height - 10, this.y));
        
        const now = Date.now();
        if(now - this.lastFire > 140) {
            this.fire(); this.lastFire = now;
        }
        if(now - this.lastMissile > 1500 && enemies.length > 0) {
            missiles.push(new Missile(this.x, this.y));
            this.lastMissile = now;
            sfx(600, 'sine', 0.2, 0.03, 100);
        }
    }
    fire() {
        sfx(400, 'square', 0.05, 0.02);
        const vy = -15;
        if(this.lvl === 1) bullets.push(new Bullet(this.x, this.y, 0, vy));
        else if(this.lvl === 2) {
            bullets.push(new Bullet(this.x-10, this.y, 0, vy));
            bullets.push(new Bullet(this.x+10, this.y, 0, vy));
        } else if(this.lvl === 3) {
            bullets.push(new Bullet(this.x, this.y, 0, vy));
            bullets.push(new Bullet(this.x-15, this.y, -2, vy));
            bullets.push(new Bullet(this.x+15, this.y, 2, vy));
        } else {
            for(let i=-2; i<=2; i++) bullets.push(new Bullet(this.x + i*5, this.y, i*2, vy));
        }
    }
    draw() {
        ctx.save();
        ctx.shadowBlur = 15; ctx.shadowColor = '#0ff';
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y - 20);
        ctx.lineTo(this.x + 18, this.y + 16);
        ctx.lineTo(this.x, this.y + 8);
        ctx.lineTo(this.x - 18, this.y + 16);
        ctx.closePath(); ctx.stroke();
        // Thruster
        ctx.fillStyle = Math.random() > 0.5 ? '#0ff' : '#044';
        ctx.fillRect(this.x - 4, this.y + 12, 8, 5);
        ctx.restore();
    }
}

class Enemy {
    constructor(type) {
        this.type = type;
        this.x = Math.random() * (canvas.width - 40) + 20;
        this.y = -50; this.hp = type === 'heavy' ? 6 : type === 'elite' ? 3 : 1;
        this.speed = (type === 'kamikaze' ? 6 : type === 'elite' ? 4 : 2) + (wave * 0.2);
        this.lastFire = Date.now() + Math.random() * 1000;
        this.sinOffset = Math.random() * Math.PI * 2;
    }
    update() {
        this.y += this.speed;
        if(this.type === 'elite') this.x += Math.sin(this.y * 0.05 + this.sinOffset) * 4;
        if(this.type === 'kamikaze') {
            this.x += (player.x - this.x) * 0.05;
        }
        
        if(Date.now() - this.lastFire > 1800 - (wave*50)) {
            this.shoot(); this.lastFire = Date.now();
        }
        // Warp back if missed
        if(this.y > canvas.height + 50) { this.y = -50; this.hp = Math.max(1, this.hp); }
    }
    shoot() {
        if(this.type === 'kamikaze') return;
        const count = this.type === 'heavy' ? 8 : 1;
        for(let i=0; i<count; i++) {
            const angle = this.type === 'heavy' ? (i/count) * Math.PI*2 : Math.PI/2;
            enemyBullets.push(new Bullet(this.x, this.y, Math.cos(angle)*4, Math.sin(angle)*4, true));
        }
    }
    draw() {
        ctx.save();
        ctx.strokeStyle = this.type === 'heavy' ? '#f0f' : this.type === 'elite' ? '#0f0' : '#f00';
        ctx.lineWidth = 2; ctx.shadowBlur = 10; ctx.shadowColor = ctx.strokeStyle;
        ctx.strokeRect(this.x-15, this.y-15, 30, 30);
        ctx.restore();
    }
}

class Boss {
    constructor() {
        this.x = canvas.width/2; this.y = -100;
        this.maxHp = 200 + (wave * 50); this.hp = this.maxHp;
        this.lastFire = 0; this.angle = 0;
    }
    update() {
        if(this.y < 120) this.y += 1;
        this.x = canvas.width/2 + Math.sin(Date.now() * 0.001) * 100;
        this.angle += 0.05;
        if(Date.now() - this.lastFire > 150) {
            // Spiral pattern
            const vx = Math.cos(this.angle) * 5;
            const vy = Math.sin(this.angle) * 5;
            enemyBullets.push(new Bullet(this.x, this.y, vx, vy, true));
            enemyBullets.push(new Bullet(this.x, this.y, -vx, -vy, true));
            this.lastFire = Date.now();
        }
    }
    draw() {
        ctx.save(); ctx.shadowBlur = 20; ctx.shadowColor = '#f00';
        ctx.strokeStyle = '#f00'; ctx.lineWidth = 4;
        ctx.strokeRect(this.x - 50, this.y - 30, 100, 60);
        ctx.strokeRect(this.x - 30, this.y - 50, 60, 100);
        ctx.restore();
    }
}

class Bullet {
    constructor(x, y, vx, vy, isEnemy=false) {
        this.x = x; this.y = y; this.vx = vx; this.vy = vy; this.isEnemy = isEnemy;
    }
    update() { this.x += this.vx; this.y += this.vy; }
    draw() {
        ctx.fillStyle = this.isEnemy ? '#ff3300' : '#00ffff';
        ctx.beginPath(); ctx.arc(this.x, this.y, this.isEnemy ? 4 : 3, 0, 7); ctx.fill();
    }
}

class Missile {
    constructor(x, y) { this.x = x; this.y = y; this.target = null; }
    update() {
        if(!this.target || !enemies.includes(this.target)) this.target = enemies[0];
        if(this.target) {
            const dx = this.target.x - this.x, dy = this.target.y - this.y;
            const angle = Math.atan2(dy, dx);
            this.x += Math.cos(angle) * 8; this.y += Math.sin(angle) * 8;
        } else { this.y -= 10; }
    }
    draw() {
        ctx.fillStyle = '#fff'; ctx.fillRect(this.x-2, this.y-4, 4, 8);
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.color = color;
        this.vx = (Math.random()-0.5)*12; this.vy = (Math.random()-0.5)*12;
        this.life = 1;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= 0.03; }
    draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 2, 2); ctx.globalAlpha = 1; }
}

class PowerUp {
    constructor(x, y, type) { this.x = x; this.y = y; this.type = type; }
    update() { this.y += 2; }
    draw() {
        ctx.fillStyle = this.type === 'W' ? '#0ff' : '#f0f';
        ctx.font = 'bold 14px Arial'; ctx.fillText(this.type, this.x-5, this.y);
    }
}

function useBomb() {
    if(bombs <= 0 || !gameActive) return;
    bombs--; sfx(40, 'sawtooth', 1, 0.5, 1);
    document.getElementById('flash-overlay').style.opacity = '0.8';
    setTimeout(() => document.getElementById('flash-overlay').style.opacity = '0', 100);
    enemies.forEach(e => {
        addScore(500); explode(e.x, e.y, '#fff');
    });
    enemies = []; enemyBullets = [];
}

function useEMP() {
    if(emps <= 0 || !gameActive) return;
    emps--; sfx(800, 'sine', 0.4, 0.2, 50);
    particles.push({ update:()=>null, draw:() => {
        ctx.strokeStyle = '#0ff'; ctx.beginPath(); ctx.arc(player.x, player.y, 150, 0, 7); ctx.stroke();
    }, life: 0.2 });
    enemyBullets = enemyBullets.filter(b => Math.hypot(b.x - player.x, b.y - player.y) > 150);
    updateUI();
}

function explode(x, y, color, count=15) {
    sfx(100, 'sawtooth', 0.2, 0.1);
    screenShake = 10;
    for(let i=0; i<count; i++) particles.push(new Particle(x, y, color));
}

function addScore(v) {
    score += Math.floor(v * multiplier);
    multiplier = Math.min(10, multiplier + 0.05);
    multiTimer = 120;
    updateUI();
}

function updateUI() {
    scoreEl.innerText = score.toLocaleString();
    multiEl.innerText = multiplier.toFixed(1);
    multiTag.style.opacity = multiplier > 1 ? '1' : '0';
    wpnEl.innerText = player.lvl;
    empEl.innerText = emps;
    document.getElementById('health-inner').style.width = player.hp + '%';
    document.getElementById('wave-display').innerText = wave;
    document.getElementById('rank').innerText = score > 50000 ? 'ACE' : score > 20000 ? 'VETERAN' : 'NOVICE';
}

function checkCollisions() {
    // Bullets vs Enemies
    bullets.forEach((b, bi) => {
        if(boss && Math.hypot(b.x - boss.x, b.y - boss.y) < 50) {
            boss.hp--; bullets.splice(bi, 1);
            sfx(200, 'square', 0.05, 0.05);
            document.getElementById('boss-health-inner').style.width = (boss.hp/boss.maxHp)*100 + '%';
            if(boss.hp <= 0) {
                explode(boss.x, boss.y, '#f00', 50);
                addScore(10000); boss = null; wave++;
                document.getElementById('boss-health-container').style.opacity = '0';
            }
            return;
        }
        enemies.forEach((e, ei) => {
            if(Math.hypot(b.x - e.x, b.y - e.y) < 20) {
                e.hp--; bullets.splice(bi, 1);
                if(e.hp <= 0) {
                    explode(e.x, e.y, '#f00');
                    addScore(200);
                    if(Math.random() > 0.9) powerups.push(new PowerUp(e.x, e.y, Math.random() > 0.5 ? 'W' : 'E'));
                    enemies.splice(ei, 1);
                }
            }
        });
    });

    // Enemy Bullets vs Player
    enemyBullets.forEach((b, bi) => {
        if(Math.hypot(b.x - player.x, b.y - player.y) < 15) {
            player.hp -= 15; enemyBullets.splice(bi, 1);
            multiplier = 1.0; screenShake = 20; sfx(50, 'sawtooth', 0.3, 0.2);
            updateUI(); if(player.hp <= 0) endGame();
        }
    });

    // Powerups
    powerups.forEach((p, pi) => {
        if(Math.hypot(p.x - player.x, p.y - player.y) < 30) {
            if(p.type === 'W') player.lvl = Math.min(4, player.lvl + 1);
            else emps = Math.min(5, emps + 1);
            powerups.splice(pi, 1); sfx(800, 'sine', 0.5, 0.1, 1200); updateUI();
        }
    });
}

function startGame() {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    gameActive = true; score = 0; wave = 1; multiplier = 1.0;
    enemies = []; bullets = []; enemyBullets = []; particles = []; powerups = []; missiles = [];
    player = new Player(); boss = null; bombs = 3; emps = 3;
    document.getElementById('start-menu').classList.add('hidden');
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('boss-health-container').style.opacity = '0';
    updateUI();
    loop();
}

function endGame() {
    gameActive = false;
    document.getElementById('final-wave').innerText = wave;
    document.getElementById('game-over').classList.remove('hidden');
}

function loop() {
    if(!gameActive) return;
    
    ctx.fillStyle = '#010103'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    if(screenShake > 0) {
        ctx.save(); ctx.translate(Math.random()*screenShake, Math.random()*screenShake);
        screenShake *= 0.9;
    }

    // Stars
    ctx.fillStyle = '#223';
    for(let i=0; i<20; i++) ctx.fillRect((Math.random()*canvas.width), (Date.now()*0.2 + i*100)%canvas.height, 2, 2);

    player.update(); player.draw();

    if(wave % 5 === 0 && !boss) {
        boss = new Boss(); document.getElementById('boss-health-container').style.opacity = '1';
    } else if(!boss && Date.now() - lastSpawn > Math.max(200, 1200 - (wave*100))) {
        const r = Math.random();
        enemies.push(new Enemy(r > 0.9 ? 'heavy' : r > 0.7 ? 'elite' : r > 0.5 ? 'kamikaze' : 'grunt'));
        lastSpawn = Date.now();
        if(score > wave * 5000) { wave++; updateUI(); }
    }

    if(boss) { boss.update(); boss.draw(); }

    if(multiTimer > 0) multiTimer--; else multiplier = Math.max(1, multiplier - 0.01);

    [bullets, enemyBullets, enemies, particles, powerups, missiles].forEach(list => {
        for(let i=list.length-1; i>=0; i--) {
            list[i].update(); list[i].draw();
            if(list[i].y < -100 || list[i].y > canvas.height+100 || list[i].life <= 0) list.splice(i, 1);
        }
    });

    checkCollisions();
    if(screenShake > 0) ctx.restore();
    requestAnimationFrame(loop);
}
</script>
</body>
</html>

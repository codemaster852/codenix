<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math2Save - A Game by Codenix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #0f172a;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }

        .pixel-font { font-family: 'Press Start 2P', cursive; }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(3px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-5px, 0, 0); }
            40%, 60% { transform: translate3d(5px, 0, 0); }
        }

        .village-bg {
            background: linear-gradient(to bottom, #1e293b 0%, #334155 40%, #065f46 40%, #064e3b 100%);
            position: relative;
            overflow: hidden;
            border-bottom: 8px solid #064e3b;
        }

        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            animation: float linear infinite;
        }

        @keyframes float {
            from { transform: translateX(110vw); }
            to { transform: translateX(-200px); }
        }

        .house { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .house.damaged {
            filter: grayscale(1) brightness(0.5) sepia(1) hue-rotate(-50deg);
            transform: translateY(12px) rotate(5deg) scale(0.9);
        }

        .monster {
            position: absolute;
            bottom: 20px;
            right: -100px;
            transition: all 0.5s ease;
            filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.5));
        }

        .attack-anim {
            animation: attack 0.5s ease-in-out;
        }

        @keyframes attack {
            0% { transform: translateX(0); }
            50% { transform: translateX(-400px) scale(1.2); }
            100% { transform: translateX(0); }
        }

        .burn-effect {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 40%, rgba(220, 38, 38, 0.4) 100%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .spell-effect {
            position: absolute;
            bottom: 50px;
            left: 100px;
            width: 10px;
            height: 10px;
            background: #60a5fa;
            border-radius: 50%;
            filter: blur(5px);
            opacity: 0;
            z-index: 5;
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #level-up-toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            z-index: 100;
        }
        #level-up-toast.active { transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 md:p-4">

    <div id="game-container" class="w-full max-w-2xl bg-slate-900 rounded-3xl overflow-hidden shadow-2xl border-4 border-slate-700 relative">
        
        <!-- UI Header -->
        <div class="flex justify-between items-center p-3 md:p-5 bg-slate-800/80 backdrop-blur-sm border-b-2 border-slate-700">
            <div class="flex flex-col gap-1">
                <span id="level-label" class="text-[10px] uppercase text-blue-400 font-bold tracking-widest">WAVE 1</span>
                <div class="w-32 md:w-48 h-4 bg-slate-950 rounded-full border border-slate-600 overflow-hidden">
                    <div id="health-bar" class="h-full bg-emerald-500 transition-all duration-500 w-full shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
                </div>
            </div>
            <div class="text-center">
                <h1 class="text-lg md:text-2xl font-black text-blue-400 tracking-tighter italic">MATH<span class="text-white">2</span>SAVE</h1>
                <p class="text-[9px] text-slate-500 font-bold">CODENIX ARCADE</p>
            </div>
            <div class="text-right">
                <span class="text-[10px] uppercase text-slate-400 font-bold tracking-widest">Score</span>
                <div id="score" class="text-xl md:text-3xl font-black text-white tabular-nums">0000</div>
            </div>
        </div>

        <!-- World Scene -->
        <div class="village-bg h-48 md:h-64 w-full relative">
            <div id="clouds-container"></div>
            
            <div id="monster" class="monster w-16 h-16 flex items-center justify-center text-5xl">üëæ</div>

            <div class="absolute bottom-6 left-0 w-full flex justify-around items-end px-4 md:px-12" id="village-assets"></div>
            
            <div id="spell" class="spell-effect"></div>
            <div id="overlay-effect" class="burn-effect"></div>

            <div id="combo-tag" class="absolute top-4 right-4 bg-blue-500 text-white px-3 py-1 rounded-lg font-bold scale-0 transition-transform duration-300 shadow-lg border border-blue-300">
                STREAK: 0
            </div>

            <div id="level-up-toast" class="bg-yellow-400 text-black px-6 py-2 rounded-full font-black text-xl shadow-2xl border-4 border-white">
                WAVE UP!
            </div>
        </div>

        <!-- Gameplay Control -->
        <div class="p-6 md:p-10 flex flex-col items-center justify-center bg-slate-900 relative" id="play-area">
            <div class="w-full h-1.5 bg-slate-800 rounded-full mb-10 overflow-hidden">
                <div id="timer-bar" class="h-full bg-blue-500 w-full shadow-[0_0_8px_rgba(59,130,246,0.5)]"></div>
            </div>

            <div id="problem-display" class="text-4xl md:text-6xl font-black mb-10 flex items-center gap-4 drop-shadow-md whitespace-nowrap">
                <!-- Populated via JS -->
            </div>

            <div class="relative w-full max-w-xs group">
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-emerald-600 rounded-2xl blur opacity-25 group-focus-within:opacity-75 transition duration-1000"></div>
                <input type="number" id="answer-input" 
                    class="relative w-full bg-slate-800 border-2 border-slate-700 rounded-2xl py-4 text-4xl text-center focus:outline-none focus:border-blue-500 transition-all text-white placeholder-slate-700"
                    placeholder="?">
            </div>

            <p class="mt-6 text-slate-500 text-[10px] font-bold uppercase tracking-widest animate-pulse">Auto-detecting answers...</p>
        </div>

        <!-- Menu Screen -->
        <div id="menu-overlay" class="absolute inset-0 bg-slate-950/95 z-50 flex flex-col items-center justify-center p-8 text-center">
            <div class="mb-8">
                <div class="text-6xl mb-4">üõ°Ô∏è</div>
                <h2 class="text-5xl font-black text-white italic tracking-tighter">MATH<span class="text-blue-500">2</span>SAVE</h2>
                <div class="h-1 w-24 bg-blue-500 mx-auto mt-2 rounded-full"></div>
            </div>
            
            <p class="text-slate-400 mb-10 max-w-xs leading-relaxed">Defend the village! All operations active (+, -, √ó, √∑). Wave up every 5 pts. Chaos at 100.</p>
            
            <button onclick="startGame()" class="group relative px-10 py-5 bg-blue-600 border-b-4 border-blue-800 rounded-xl font-black text-2xl hover:bg-blue-500 transition-all active:translate-y-1 active:border-b-0">
                START DEFENSE
            </button>
            
            <p class="mt-12 text-slate-600 text-[10px] font-bold tracking-widest uppercase">V5.0 ALL OPERATIONS &bull; CODENIX</p>
        </div>

        <!-- Game Over -->
        <div id="game-over-overlay" class="absolute inset-0 bg-rose-950/98 z-50 hidden flex flex-col items-center justify-center p-8 text-center">
            <div class="text-7xl mb-6">üî•</div>
            <h2 class="text-4xl font-black text-white mb-2 tracking-tighter uppercase">Village Overrun</h2>
            <p id="final-score-text" class="text-2xl text-rose-300 font-bold mb-10">Score: 0</p>
            
            <button onclick="location.reload()" class="bg-white text-rose-950 px-10 py-4 rounded-2xl font-black text-xl hover:scale-105 transition-transform active:scale-95 shadow-xl">
                REBUILD VILLAGE
            </button>
        </div>
    </div>

    <script>
        const state = {
            score: 0,
            health: 100,
            wave: 1,
            currentAnswer: null,
            timer: 100,
            timerInterval: null,
            combo: 0,
            gameActive: false,
            baseTime: 7500, // Slightly more time for division logic
            currentMonster: 'üëæ'
        };

        const monsters = ['üëæ', 'üëπ', 'üëª', 'üëΩ', 'üßõ', 'üßü'];

        const elements = {
            problem: document.getElementById('problem-display'),
            input: document.getElementById('answer-input'),
            score: document.getElementById('score'),
            healthBar: document.getElementById('health-bar'),
            timerBar: document.getElementById('timer-bar'),
            menu: document.getElementById('menu-overlay'),
            gameOver: document.getElementById('game-over-overlay'),
            finalScore: document.getElementById('final-score-text'),
            overlayEffect: document.getElementById('overlay-effect'),
            clouds: document.getElementById('clouds-container'),
            village: document.getElementById('village-assets'),
            comboTag: document.getElementById('combo-tag'),
            container: document.getElementById('game-container'),
            monster: document.getElementById('monster'),
            spell: document.getElementById('spell'),
            levelLabel: document.getElementById('level-label'),
            levelToast: document.getElementById('level-up-toast')
        };

        function createVillage() {
            elements.village.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const house = document.createElement('div');
                house.className = 'house w-10 md:w-14 h-16 md:h-20 bg-slate-200 border-2 border-slate-900 relative rounded-t-sm';
                house.innerHTML = `<div class="absolute -top-4 md:-top-5 left-0 w-full h-5 bg-rose-600 rounded-t-full border-b-2 border-slate-900"></div>
                                   <div class="absolute bottom-2 left-1/2 -translate-x-1/2 w-4 h-6 bg-amber-900 rounded-t-sm border border-slate-900"></div>`;
                elements.village.appendChild(house);
            }
        }

        function createClouds() {
            for (let i = 0; i < 6; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.style.width = (Math.random() * 80 + 40) + 'px';
                cloud.style.height = '15px';
                cloud.style.top = (Math.random() * 80 + 10) + 'px';
                cloud.style.animationDuration = (Math.random() * 30 + 30) + 's';
                cloud.style.animationDelay = (Math.random() * 20) + 's';
                elements.clouds.appendChild(cloud);
            }
        }

        function startGame() {
            state.score = 0;
            state.health = 100;
            state.combo = 0;
            state.wave = 1;
            state.gameActive = true;
            elements.menu.classList.add('hidden');
            elements.score.textContent = '0000';
            updateHealthUI();
            nextProblem();
            elements.input.focus();
            spawnMonster();
        }

        function spawnMonster() {
            state.currentMonster = monsters[Math.floor(Math.random() * monsters.length)];
            elements.monster.textContent = state.currentMonster;
            elements.monster.style.right = '20px';
        }

        function generateTerm(max) {
            return Math.floor(Math.random() * max) + 1;
        }

        function generateOperation(n1, n2, op) {
            switch(op) {
                case '+': return { str: `${n1} + ${n2}`, val: n1 + n2 };
                case '-': return n1 >= n2 ? { str: `${n1} - ${n2}`, val: n1 - n2 } : { str: `${n2} - ${n1}`, val: n2 - n1 };
                case '*': return { str: `${n1} √ó ${n2}`, val: n1 * n2 };
                case '/': 
                    // To ensure whole numbers: result * n2 = product. We show product / n2.
                    const divisor = Math.max(1, n2 % 12); 
                    const result = Math.floor(Math.random() * 10) + 1;
                    return { str: `${result * divisor} √∑ ${divisor}`, val: result };
            }
        }

        function nextProblem() {
            const newWave = Math.floor(state.score / 5) + 1;
            if (newWave > state.wave) {
                state.wave = newWave;
                showLevelUp();
            }
            elements.levelLabel.textContent = `WAVE ${state.wave}`;
            
            let problemStr = "";
            let answer = 0;
            const ops = ['+', '-', '*', '/'];

            if (state.score >= 100) {
                // CHAOS MODE: (A op B) op C
                const op1 = ops[Math.floor(Math.random() * 4)];
                const op2 = ops[Math.floor(Math.random() * 4)];
                
                // For Chaos Mode, we simplify components to keep it solvable in head
                const t1 = generateTerm(10 + state.wave);
                const t2 = generateTerm(10);
                const firstPart = generateOperation(t1, t2, op1);
                
                const t3 = generateTerm(5);
                const finalPart = generateOperation(firstPart.val, t3, op2);
                
                answer = finalPart.val;
                problemStr = `(${firstPart.str}) ${finalPart.str.split(' ')[1]} ${finalPart.str.split(' ')[2]}`;
            } else {
                // NORMAL MODE: Scaled operations
                const maxNum = 10 + (state.wave * 2);
                const n1 = generateTerm(maxNum);
                const n2 = generateTerm(maxNum);
                
                // Randomly pick operation from all 4
                const op = ops[Math.floor(Math.random() * 4)];
                const result = generateOperation(n1, n2, op);
                
                answer = result.val;
                problemStr = result.str;
            }

            state.currentAnswer = answer;
            elements.problem.innerHTML = problemStr.split('').map(char => 
                `<span class="${['+', '-', '√ó', '√∑'].includes(char) ? 'text-blue-500 mx-1' : (isNaN(char) ? 'text-slate-400' : 'text-white')}">${char}</span>`
            ).join('');
            
            elements.input.value = '';
            startTimer();
        }

        function showLevelUp() {
            elements.levelToast.classList.add('active');
            setTimeout(() => elements.levelToast.classList.remove('active'), 1200);
        }

        function startTimer() {
            clearInterval(state.timerInterval);
            let currentLimit = Math.max(1200, state.baseTime - ((state.wave - 1) * 350));
            let timeLeft = currentLimit;
            
            state.timerInterval = setInterval(() => {
                timeLeft -= 50;
                const percent = (timeLeft / currentLimit) * 100;
                elements.timerBar.style.width = percent + '%';
                
                if (timeLeft <= 0) {
                    handleWrong(true);
                }
            }, 50);
        }

        function handleWrong(isTimeout = false) {
            state.combo = 0;
            updateComboUI();
            damageVillage(isTimeout ? 20 : 12);
            
            elements.monster.classList.add('attack-anim');
            setTimeout(() => elements.monster.classList.remove('attack-anim'), 500);

            elements.container.classList.add('shake');
            elements.overlayEffect.style.opacity = '1';
            setTimeout(() => {
                elements.container.classList.remove('shake');
                elements.overlayEffect.style.opacity = '0';
            }, 300);

            nextProblem();
        }

        function handleCorrect() {
            state.combo++;
            castSpell();
            state.score += 1;
            elements.score.textContent = state.score.toString().padStart(4, '0');
            updateComboUI();
            
            elements.monster.style.transform = 'translateX(50px)';
            setTimeout(() => {
                elements.monster.style.transform = 'translateX(0)';
                if (state.combo % 3 === 0) spawnMonster();
            }, 150);

            if (state.combo % 5 === 0 && state.health < 100) {
                state.health = Math.min(100, state.health + 10);
                updateHealthUI();
            }
            nextProblem();
        }

        function castSpell() {
            elements.spell.style.opacity = '1';
            const targetX = elements.monster.offsetLeft;
            elements.spell.animate([
                { left: '100px', bottom: '50px', opacity: 1, scale: 1 },
                { left: (targetX + 30) + 'px', bottom: '100px', opacity: 0, scale: 4 }
            ], { duration: 300, easing: 'ease-out' });
        }

        function damageVillage(amount) {
            state.health -= amount;
            if (state.health <= 0) {
                state.health = 0;
                endGame();
            }
            updateHealthUI();
        }

        function updateHealthUI() {
            elements.healthBar.style.width = state.health + '%';
            if (state.health < 40) elements.healthBar.className = 'h-full bg-rose-500 transition-all duration-500 w-full shadow-[0_0_10px_rgba(244,63,94,0.5)]';
            else if (state.health < 70) elements.healthBar.className = 'h-full bg-amber-500 transition-all duration-500 w-full shadow-[0_0_10px_rgba(245,158,11,0.5)]';
            else elements.healthBar.className = 'h-full bg-emerald-500 transition-all duration-500 w-full shadow-[0_0_10px_rgba(16,185,129,0.5)]';

            const houses = document.querySelectorAll('.house');
            houses.forEach((h, i) => {
                if (state.health < (houses.length - i - 0.5) * (100/houses.length)) h.classList.add('damaged');
                else h.classList.remove('damaged');
            });
        }

        function updateComboUI() {
            if (state.combo >= 2) {
                elements.comboTag.textContent = `STREAK: ${state.combo}`;
                elements.comboTag.classList.remove('scale-0');
                elements.comboTag.classList.add('scale-100');
            } else {
                elements.comboTag.classList.remove('scale-100');
                elements.comboTag.classList.add('scale-0');
            }
        }

        function endGame() {
            state.gameActive = false;
            clearInterval(state.timerInterval);
            elements.gameOver.classList.remove('hidden');
            elements.finalScore.textContent = `DEFENSE SCORE: ${state.score}`;
        }

        elements.input.addEventListener('input', (e) => {
            if (!state.gameActive) return;
            const val = parseInt(elements.input.value);
            const rawVal = elements.input.value;
            if (rawVal === "-" && state.currentAnswer < 0) return;
            
            if (!isNaN(val) && val === state.currentAnswer) {
                handleCorrect();
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });

        createVillage();
        createClouds();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nix 3 - Local LLM Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400&display=swap');
        
        body {
            background-color: #09090b;
            color: #e4e4e7;
            font-family: 'Inter', sans-serif;
        }

        .chat-container {
            height: calc(100vh - 180px);
        }

        .message-bubble {
            max-width: 85%;
            animation: fadeIn 0.2s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nix-gradient {
            background: linear-gradient(135deg, #00ff41 0%, #008f11 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        pre {
            background: #18181b;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Fira+Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            border: 1px solid #27272a;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="p-6 border-b border-zinc-800 flex justify-between items-center bg-zinc-950/50 backdrop-blur-md sticky top-0 z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-green-500/10 border border-green-500/50 flex items-center justify-center">
                <span class="text-green-500 font-bold text-xl">N</span>
            </div>
            <div>
                <h1 class="text-lg font-semibold tracking-tight nix-gradient">Nix 3 <span class="text-xs font-normal text-zinc-500 ml-1">v3.4 Local</span></h1>
                <p id="status" class="text-[10px] text-zinc-500 uppercase tracking-widest text-orange-400">Initializing Engine...</p>
            </div>
        </div>
        <div id="model-badge" class="hidden px-3 py-1 bg-zinc-800 rounded-full text-[10px] font-medium text-zinc-400 border border-zinc-700">
            Qwen1.5-0.5B
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-window" class="chat-container overflow-y-auto p-4 md:p-8 space-y-6">
        <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50" id="welcome">
            <div class="w-16 h-16 rounded-2xl bg-zinc-900 border border-zinc-800 flex items-center justify-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
            </div>
            <h2 class="text-xl font-medium">How can I help you today?</h2>
            <p id="init-progress" class="text-sm max-w-xs text-zinc-400">Ready to start engine...</p>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="p-4 md:p-6 border-t border-zinc-800 bg-zinc-950/80">
        <div class="max-w-4xl mx-auto relative">
            <textarea 
                id="user-input" 
                rows="1" 
                class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-4 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all resize-none placeholder:text-zinc-600"
                placeholder="Downloading model..."
                disabled
            ></textarea>
            <button 
                id="send-btn"
                class="absolute right-3 bottom-3 p-2 bg-green-600 text-white rounded-lg hover:bg-green-500 disabled:opacity-30 disabled:hover:bg-green-600 transition-colors"
                disabled
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div id="progress-container" class="max-w-4xl mx-auto mt-2 hidden">
            <div class="w-full bg-zinc-800 h-1 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-green-500 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
        <p id="footer-note" class="text-center text-[10px] text-zinc-600 mt-3">Powered by Transformers.js (v3)</p>
    </footer>

    <script type="module">
        import { pipeline, TextStreamer, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusText = document.getElementById('status');
        const modelBadge = document.getElementById('model-badge');
        const welcome = document.getElementById('welcome');
        const footerNote = document.getElementById('footer-note');
        const initProgress = document.getElementById('init-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        let generator = null;
        let messages = [];

        // Switching to the most stable official version to avoid 99% hang
        const MODEL_ID = 'Xenova/Qwen1.5-0.5B-Chat';

        async function initModel() {
            try {
                statusText.innerText = "Connecting...";
                progressContainer.classList.remove('hidden');

                // --- 99% HANG FIXES ---
                env.allowLocalModels = false;
                env.useBrowserCache = false; // Prevents loading corrupted chunks from previous attempts
                
                // ORT Stability tweaks
                env.backends.onnx.wasm.proxy = false;
                env.backends.onnx.wasm.numThreads = 1; // Lower thread count for initialization stability
                // -----------------------

                generator = await pipeline('text-generation', MODEL_ID, {
                    device: 'wasm',
                    dtype: 'q4', 
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const p = Math.round(data.progress);
                            progressBar.style.width = `${p}%`;
                            initProgress.innerText = `Downloading: ${data.file} (${p}%)`;
                            statusText.innerText = `Fetching ${p}%`;
                        } else if (data.status === 'done') {
                            initProgress.innerText = "Processing model files...";
                            statusText.innerText = "Finalizing...";
                        } else if (data.status === 'ready') {
                            initProgress.innerText = "Engine Ready!";
                        }
                    }
                });

                statusText.innerText = "Online";
                statusText.classList.replace('text-orange-400', 'text-green-500');
                modelBadge.classList.remove('hidden');
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.placeholder = "Type your message...";
                initProgress.innerText = "Model loaded successfully.";
                progressContainer.classList.add('hidden');
            } catch (err) {
                console.error("Critical Error:", err);
                statusText.innerText = "Init Failed";
                initProgress.innerText = `Error: ${err.message}`;
                // Suggest clearing site data if it still hangs
                footerNote.innerHTML = "If stuck at 99%, please <b>Clear Site Data</b> in your browser settings and refresh.";
            }
        }

        function appendMessage(role, text) {
            if (document.getElementById('welcome')) welcome.remove();
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble p-4 rounded-2xl text-sm ${
                role === 'user' 
                ? 'bg-green-600 text-white rounded-br-none shadow-lg' 
                : 'bg-zinc-900 border border-zinc-800 text-zinc-200 rounded-bl-none'
            }`;
            
            bubble.innerText = text;
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return bubble;
        }

        async function handleChat() {
            const text = userInput.value.trim();
            if (!text || !generator) return;

            userInput.value = "";
            userInput.disabled = true;
            sendBtn.disabled = true;

            appendMessage('user', text);

            const responseBubble = appendMessage('assistant', '...');
            
            try {
                let fullResponse = "";
                const streamer = new TextStreamer(generator.tokenizer, {
                    skip_prompt: true,
                    callback_function: (token) => {
                        fullResponse += token;
                        responseBubble.innerText = fullResponse
                            .replace('<|im_end|>', '')
                            .replace('<|endoftext|>', '')
                            .trim();
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                });

                // ChatML Format
                const prompt = `<|im_start|>user\n${text}<|im_end|>\n<|im_start|>assistant\n`;

                await generator(prompt, {
                    max_new_tokens: 256,
                    temperature: 0.7,
                    do_sample: true,
                    streamer: streamer,
                });

            } catch (err) {
                responseBubble.innerText = "Error: " + err.message;
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        sendBtn.addEventListener('click', handleChat);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleChat();
            }
        });

        initModel();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nix 1 - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Supabase client library
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-radius: 1.5rem 1.5rem 0.25rem 1.5rem;
        }
        .chat-bubble-bot {
            background-color: #374151; /* gray-700 */
            color: white;
            border-radius: 1.5rem 1.5rem 1.5rem 0.25rem;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            background: #a8a29e; /* stone-400 */
            box-shadow: -16px 0 #a8a29e, 16px 0 #a8a29e;
            box-sizing: border-box;
            animation: shadowPulse 1s linear infinite;
        }
        @keyframes shadowPulse {
            33% {
                background: #a8a29e;
                box-shadow: -16px 0 #3b82f6, 16px 0 #a8a29e;
            }
            66% {
                background: #3b82f6;
                box-shadow: -16px 0 #a8a29e, 16px 0 #a8a29e;
            }
            100% {
                background: #a8a29e;
                box-shadow: -16px 0 #a8a29e, 16px 0 #3b82f6;
            }
        }
        /* Styles for Stack Overflow code snippets */
        .chat-bubble-bot pre {
            background-color: #111827; /* gray-900 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
            line-height: 1.5;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .chat-bubble-bot code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen p-4 transition-colors duration-500">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-4xl h-[95vh] flex flex-col">

        <!-- Initial View -->
        <div id="initial-view" class="flex flex-col items-center justify-center h-full text-center">
            <div class="mb-6">
                <svg class="w-24 h-24 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2Z" stroke="currentColor" stroke-width="1.5" stroke-opacity="0.5"/>
                    <path d="M7.5 12C7.5 14.485 9.515 16.5 12 16.5C14.485 16.5 16.5 14.485 16.5 12C16.5 9.515 14.485 7.5 12 7.5C9.515 7.5 7.5 9.515 7.5 12Z" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M12 2V3M12 21V22M2 12H3M21 12H22M4.929 4.929L5.636 5.636M18.364 18.364L19.071 19.071M4.929 19.071L5.636 18.364M18.364 5.636L19.071 4.929" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold text-gray-100 mb-8 animate-pulse">how can i help you?</h1>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="hidden flex-1 flex-col overflow-hidden bg-gray-800 rounded-2xl shadow-2xl">
            <div class="p-4 border-b border-gray-700 flex items-center space-x-3">
                <svg class="w-8 h-8 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2Z" stroke="currentColor" stroke-width="1.5" stroke-opacity="0.5"/><path d="M7.5 12C7.5 14.485 9.515 16.5 12 16.5C14.485 16.5 16.5 14.485 16.5 12C16.5 9.515 14.485 7.5 12 7.5C9.515 7.5 7.5 9.515 7.5 12Z" stroke="currentColor" stroke-width="1.5"/></svg>
                <h2 class="text-xl font-semibold">Nix 1</h2>
            </div>
            <div id="chat-container" class="flex-1 p-6 space-y-4 overflow-y-auto">
                <!-- Chat messages will be appended here -->
            </div>
        </div>

        <!-- Command Suggestion -->
        <div id="command-suggestion" class="hidden w-full max-w-4xl mt-2 px-2">
            <div class="bg-gray-700 rounded-lg p-4 text-gray-300 text-sm shadow-lg space-y-3">
                <div>
                    <p><strong class="font-bold text-blue-400">/translate</strong> source:target, text</p>
                    <p class="text-xs text-gray-400 mt-1 pl-1">Example: /translate english:arabic, hello world</p>
                </div>
                 <div>
                    <p><strong class="font-bold text-blue-400">/code</strong> your programming question</p>
                    <p class="text-xs text-gray-400 mt-1 pl-1">Example: /code javascript sort array of objects</p>
                </div>
            </div>
        </div>

        <!-- Shared Chat Input Form -->
        <form id="chat-form" class="w-full max-w-4xl mt-2">
            <div class="relative">
                <input type="text" id="message-input" class="w-full bg-gray-800 border-2 border-gray-700 rounded-full py-4 pl-6 pr-16 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="Ask Nix 1 anything...">
                <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 rounded-full p-3 text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <footer id="footer" class="text-center text-gray-500 text-sm mt-4 cursor-pointer select-none">
        &copy; 2025 Nix 1. All rights reserved.
    </footer>

    <!-- Admin Login Modal -->
    <div id="admin-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4">Admin Access</h3>
            <p class="text-gray-400 mb-6">Enter the password to access the training panel.</p>
            <form id="admin-login-form">
                <input type="password" id="admin-password" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-md transition">Login</button>
                <button type="button" id="close-admin-modal" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-md transition">Cancel</button>
            </form>
            <p id="admin-error" class="text-red-500 mt-4 text-center"></p>
        </div>
    </div>

    <!-- Training Panel Modal -->
    <div id="training-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Train Nix 1</h3>
                <button id="close-training-modal" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="training-form">
                <div class="mb-4">
                    <label for="training-question" class="block text-gray-400 mb-2">Question / Keyword</label>
                    <input type="text" id="training-question" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., What is the capital of France?">
                </div>
                <div class="mb-6">
                    <label for="training-answer" class="block text-gray-400 mb-2">Answer</label>
                    <textarea id="training-answer" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., The capital of France is Paris."></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-md transition">Add to Knowledge Base</button>
            </form>
            <p id="training-status" class="mt-4 text-center"></p>
        </div>
    </div>


    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://nxsyrdgtktphdwmdkbnr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54c3lyZGd0a3RwaGR3bWRrYm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTc1MTgsImV4cCI6MjA3MjkzMzUxOH0.yFfCTivKJppPBCx_Ebv9Uce1rkPTZoSJRavjbzR2E9E';
        // IMPORTANT: Get your own free API key from https://newsapi.org/
        const NEWS_API_KEY = 'YOUR_NEWS_API_KEY_HERE'; // Replace with your key
        const ADMIN_PASSWORD = '123456789#Osama';

        // --- SUPABASE CLIENT ---
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ELEMENTS ---
        const initialView = document.getElementById('initial-view');
        const chatView = document.getElementById('chat-view');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatContainer = document.getElementById('chat-container');
        const footer = document.getElementById('footer');
        const adminModal = document.getElementById('admin-modal');
        const trainingModal = document.getElementById('training-modal');
        const commandSuggestion = document.getElementById('command-suggestion');

        let firstMessageSent = false;

        // --- FUNCTIONS ---

        /**
         * Toggles from the initial centered view to the chat interface.
         */
        function switchToChatView() {
            if (!firstMessageSent) {
                initialView.classList.add('hidden');
                chatView.classList.remove('hidden');
                chatView.classList.add('flex', 'fade-in');
                firstMessageSent = true;
            }
        }

        /**
         * Adds a message bubble to the chat container.
         * @param {string} text - The message content.
         * @param {('user'|'bot')} sender - Who sent the message.
         */
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `p-4 max-w-lg lg:max-w-xl fade-in ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
            // Sanitize HTML slightly to prevent major layout breaks but allow formatting tags
            // Note: A more robust solution would use a dedicated sanitizer library like DOMPurify
            bubble.innerHTML = text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");


            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll to bottom
        }
        
        /**
         * Shows a "thinking" loader in the chat.
         */
        function showThinkingIndicator() {
             const messageDiv = document.createElement('div');
            messageDiv.className = 'w-full flex justify-start';
            messageDiv.id = 'thinking-indicator';
            messageDiv.innerHTML = `<div class="p-4 max-w-xs chat-bubble-bot"><span class="loader"></span></div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * Removes the "thinking" loader.
         */
        function hideThinkingIndicator() {
            const indicator = document.getElementById('thinking-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        /**
         * Queries the Supabase database for an answer.
         * @param {string} userQuery - The user's input.
         * @returns {Promise<string|null>} The answer or null if not found.
         */
        async function querySupabase(userQuery) {
            // This is a simple search. For a real-world scenario, you'd use pg_trgm for fuzzy search or vector embeddings.
            const { data, error } = await supabase
                .from('knowledge') // Assuming your table is named 'knowledge'
                .select('answer')
                .ilike('question', `%${userQuery.trim()}%`); // Case-insensitive search for the query as a substring

            if (error) {
                console.error('Supabase error:', error);
                return "I'm having trouble accessing my knowledge base right now.";
            }

            return data && data.length > 0 ? data[0].answer : null;
        }
        
        /**
         * Fetches weather data.
         * @param {string} city - The city to get weather for.
         * @returns {Promise<string>} The formatted weather string.
         */
        async function getWether(city) {
            try {
                // First, get coordinates for the city
                const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=en&format=json`);
                const geoData = await geoResponse.json();
                if (!geoData.results || geoData.results.length === 0) {
                    return `Sorry, I couldn't find the city "${city}".`;
                }
                const { latitude, longitude, name, admin1, country } = geoData.results[0];

                // Then, get the weather for those coordinates
                const weatherResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                const weatherData = await weatherResponse.json();
                
                const { temperature, windspeed, weathercode } = weatherData.current_weather;
                return `The current weather in <strong>${name}, ${country}</strong> is ${temperature}Â°C with wind speeds of ${windspeed} km/h.`;

            } catch (error) {
                console.error('Weather API error:', error);
                return "Sorry, I'm unable to fetch the weather information at the moment.";
            }
        }

        /**
         * Fetches news headlines.
         * @param {string} topic - The topic to search for news on.
         * @returns {Promise<string>} The formatted news string.
         */
        async function getNews(topic) {
             if (NEWS_API_KEY === 'YOUR_NEWS_API_KEY_HERE') {
                return "The news feature is not configured. The website owner needs to add a NewsAPI.org API key in the code.";
            }
            try {
                const newsResponse = await fetch(`https://newsapi.org/v2/everything?q=${topic}&sortBy=publishedAt&pageSize=5&apiKey=${NEWS_API_KEY}`);
                const newsData = await newsResponse.json();

                if (newsData.status !== 'ok' || newsData.articles.length === 0) {
                    return `I couldn't find any recent news about "${topic}".`;
                }

                let response = `Here are the top headlines about <strong>${topic}</strong>:<br><ul class="list-disc pl-5 mt-2 space-y-2">`;
                newsData.articles.forEach(article => {
                    response += `<li><a href="${article.url}" target="_blank" class="text-blue-400 hover:underline">${article.title}</a></li>`;
                });
                response += "</ul>";
                return response;

            } catch(error) {
                console.error('News API Error:', error);
                return "Sorry, I can't fetch the news right now. There might be an issue with the API configuration.";
            }
        }
        
        /**
         * Fetches a code snippet from Stack Overflow.
         * @param {string} query - The programming question to search for.
         * @returns {Promise<string>} The formatted code snippet or an error message.
         */
        async function getCodeSnippet(query) {
            try {
                // Step 1: Search for a relevant question on Stack Overflow, sorted by votes.
                const searchUrl = `https://api.stackexchange.com/2.3/search/advanced?order=desc&sort=votes&q=${encodeURIComponent(query)}&site=stackoverflow`;
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.error_message) {
                    console.error("StackExchange API Search Error:", searchData.error_message);
                    return `Sorry, the code search API returned an error: ${searchData.error_message}`;
                }

                if (!searchData.items || searchData.items.length === 0) {
                    return `I couldn't find any code snippets related to "${query}" on Stack Overflow. Try rephrasing your question.`;
                }

                const questionId = searchData.items[0].question_id;
                const questionLink = searchData.items[0].link;

                // Step 2: Get the top-voted answer for that specific question.
                const answerUrl = `https://api.stackexchange.com/2.3/questions/${questionId}/answers?order=desc&sort=votes&site=stackoverflow&filter=withbody`;
                const answerResponse = await fetch(answerUrl);
                const answerData = await answerResponse.json();

                if (answerData.error_message) {
                    console.error("StackExchange API Answer Error:", answerData.error_message);
                    return `Sorry, the code search API returned an error: ${answerData.error_message}`;
                }

                if (!answerData.items || answerData.items.length === 0) {
                    return `I found a relevant question about "${query}", but it doesn't have any answers yet. You can view it here: <a href="${questionLink}" target="_blank" class="text-blue-400 hover:underline">View Question</a>`;
                }
                
                // The answer body is HTML, which can be directly injected.
                const answerBody = answerData.items[0].body;

                return `Here's a code snippet from Stack Overflow related to your query:<br><div class="mt-2 p-3 bg-gray-900 rounded-lg text-left">${answerBody}</div><a href="${questionLink}" target="_blank" class="text-blue-400 text-sm hover:underline mt-2 inline-block">View original question for more context</a>`;

            } catch (error) {
                console.error("StackExchange API error:", error);
                return "Sorry, I'm having trouble connecting to the code snippet service right now.";
            }
        }

        /**
         * Maps common language names to their ISO 639-1 codes.
         * @param {string} langName - The full name of the language.
         * @returns {string} The two-letter language code.
         */
        function getLangCode(langName) {
            const languageMap = {
                'english': 'en', 'arabic': 'ar', 'spanish': 'es', 'french': 'fr',
                'german': 'de', 'italian': 'it', 'japanese': 'ja', 'korean': 'ko',
                'portuguese': 'pt', 'russian': 'ru', 'chinese': 'zh', 'hindi': 'hi'
            };
            return languageMap[langName.toLowerCase()] || langName; // Default to the input if not found
        }

        /**
         * Fetches a translation from the MyMemory API.
         * @param {string} text - The text to translate.
         * @param {string} sourceLang - The source language name.
         * @param {string} targetLang - The target language name.
         * @returns {Promise<string>} The translated text.
         */
        async function getTranslation(text, sourceLang, targetLang) {
            const sourceCode = getLangCode(sourceLang);
            const targetCode = getLangCode(targetLang);

            if (!text || !sourceCode || !targetLang) {
                return "Invalid translation format. Please use: /translate source:target, text";
            }

            try {
                const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceCode}|${targetCode}`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.responseStatus === 200 && data.responseData.translatedText) {
                    return `Translation: <strong>${data.responseData.translatedText}</strong>`;
                } else {
                    return `Sorry, I couldn't translate that. Error: ${data.responseDetails || 'Unknown issue'}`;
                }
            } catch (error) {
                console.error("Translation API error:", error);
                return "Sorry, there was a problem connecting to the translation service.";
            }
        }

        /**
         * Evaluates a mathematical expression using the math.js API.
         * @param {string} expression - The mathematical expression to evaluate.
         * @returns {Promise<string|null>} The result or null if it's not a valid expression.
         */
        async function getMathResult(expression) {
            // This regex checks for characters typically found in math expressions.
            // It helps prevent sending random strings to the math API.
            const mathRegex = /^[0-9+\-*/^().\s]+$/;
            if (!mathRegex.test(expression)) {
                return null; // Not a math expression, so we won't query the API.
            }

            try {
                const apiUrl = `https://api.mathjs.org/v4/?expr=${encodeURIComponent(expression)}`;
                const response = await fetch(apiUrl);
                
                if (response.ok) {
                    const result = await response.text();
                    // The API returns a string starting with "Error: " for invalid expressions.
                    if (result.startsWith('Error:')) {
                         return null; // Treat invalid math as a normal query for Supabase.
                    }
                    return `The answer is <strong>${result}</strong>.`;
                } else {
                     console.error('Math API server error:', response.status, response.statusText);
                     return null; // On server error, fall back to Supabase.
                }
            } catch (error) {
                console.error("Math API fetch error:", error);
                return "Sorry, I'm having trouble with my calculator right now.";
            }
        }

        /**
         * Gets a conversational response from a generative AI model.
         * @param {string} prompt - The user's input.
         * @returns {Promise<string>} The AI-generated response.
         */
        async function getChatResponse(prompt) {
            // This uses the Gemini Flash model via the Google AI platform.
            // In this environment, the API key is automatically handled.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: `Please provide a concise and direct answer to the following question: ${prompt}` }] }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Generative AI API error:", response.status, errorBody);
                    return "Sorry, I'm having trouble connecting to my creative brain right now.";
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    // Basic markdown-to-HTML conversion
                    let text = candidate.content.parts[0].text;
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');       // Italics
                    text = text.replace(/\n/g, '<br>');                      // Newlines
                    return text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    return "I received a strange response from my AI core. Please try again.";
                }

            } catch (error) {
                console.error("Generative AI fetch error:", error);
                return "Sorry, I can't connect to my AI core at the moment. Please check your connection.";
            }
        }

        /**
         * Main handler for processing the user's message.
         * @param {string} message - The user's input.
         */
        async function handleUserMessage(message) {
            const lowerCaseMessage = message.toLowerCase().trim();

            // Handle "translate" keyword with a guide.
            if (lowerCaseMessage.startsWith('translate ')) {
                addMessageToChat("Tip: For future translations, you can use the command format: <strong>/translate source:target, text</strong>", 'bot');
            }
            // Handle "code" keyword with a guide.
            if (lowerCaseMessage.startsWith('code ')) {
                 addMessageToChat("Tip: For future code searches, you can use the command format: <strong>/code your query</strong>", 'bot');
            }


            showThinkingIndicator();
            let botResponse = null;

            // Command-based routing
            if (lowerCaseMessage.startsWith('/translate ') || lowerCaseMessage.startsWith('translate ')) {
                const commandPrefix = lowerCaseMessage.startsWith('/') ? '/translate ' : 'translate ';
                const commandBody = message.substring(commandPrefix.length);
                const commaIndex = commandBody.indexOf(',');

                if (commaIndex === -1) {
                    botResponse = "Invalid format. Please use: /translate source:target, text to translate";
                } else {
                    const langPairStr = commandBody.substring(0, commaIndex).trim();
                    const textToTranslate = commandBody.substring(commaIndex + 1).trim();
                    const [sourceLang, targetLang] = langPairStr.split(':').map(l => l.trim());
                    botResponse = await getTranslation(textToTranslate, sourceLang, targetLang);
                }
            } else if (lowerCaseMessage.startsWith('weather in ')) {
                const city = message.substring('weather in '.length);
                botResponse = await getWether(city);
            } else if (lowerCaseMessage.startsWith('news about ')) {
                const topic = message.substring('news about '.length);
                botResponse = await getNews(topic);
            } else if (lowerCaseMessage.startsWith('/code ') || lowerCaseMessage.startsWith('code ')) {
                const commandPrefix = lowerCaseMessage.startsWith('/') ? '/code ' : 'code ';
                const query = message.substring(commandPrefix.length);
                botResponse = await getCodeSnippet(query);
            } else {
                // First, try to solve it as a math problem.
                botResponse = await getMathResult(message);

                // If it's not a math expression (getMathResult returned null), get a chat response.
                if (botResponse === null) {
                    botResponse = await getChatResponse(message);
                }
            }

            hideThinkingIndicator();

            if (botResponse) {
                addMessageToChat(botResponse, 'bot');
            } else {
                addMessageToChat("I couldn't find an answer for that. You can try rephrasing, or use a command like '/translate', '/code', 'weather in [city]', or 'news about [topic]'.", 'bot');
            }
        }


        // --- EVENT LISTENERS ---

        messageInput.addEventListener('input', () => {
            const value = messageInput.value;
            if (value.startsWith('/')) {
                commandSuggestion.classList.remove('hidden');
            } else {
                commandSuggestion.classList.add('hidden');
            }
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;
            
            commandSuggestion.classList.add('hidden'); // Hide suggestion on submit
            switchToChatView();
            addMessageToChat(message, 'user');
            messageInput.value = '';

            handleUserMessage(message);
        });

        // Admin Panel Logic
        footer.addEventListener('dblclick', () => {
            adminModal.classList.remove('hidden');
            document.getElementById('admin-password').focus();
        });

        document.getElementById('close-admin-modal').addEventListener('click', () => {
             adminModal.classList.add('hidden');
             document.getElementById('admin-error').textContent = '';
        });

        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const errorP = document.getElementById('admin-error');
            
            if (password === ADMIN_PASSWORD) {
                adminModal.classList.add('hidden');
                trainingModal.classList.remove('hidden');
                document.getElementById('admin-password').value = '';
                errorP.textContent = '';
            } else {
                errorP.textContent = 'Incorrect password. Please try again.';
            }
        });
        
        // Training Panel Logic
        document.getElementById('close-training-modal').addEventListener('click', () => {
            trainingModal.classList.add('hidden');
            document.getElementById('training-status').textContent = '';
        });
        
        document.getElementById('training-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = document.getElementById('training-question').value.trim();
            const answer = document.getElementById('training-answer').value.trim();
            const statusP = document.getElementById('training-status');
            
            if (!question || !answer) {
                statusP.textContent = 'Both fields are required.';
                statusP.className = 'mt-4 text-center text-red-500';
                return;
            }
            
            statusP.textContent = 'Adding to knowledge base...';
            statusP.className = 'mt-4 text-center text-yellow-500';
            
            const { data, error } = await supabase
                .from('knowledge')
                .insert([
                    { question: question, answer: answer },
                ]);

            if (error) {
                console.error('Training error:', error);
                statusP.textContent = `Error: ${error.message}`;
                statusP.className = 'mt-4 text-center text-red-500';
            } else {
                statusP.textContent = 'Successfully added to knowledge base!';
                statusP.className = 'mt-4 text-center text-green-500';
                document.getElementById('training-question').value = '';
                document.getElementById('training-answer').value = '';
            }
        });
    </script>

</body>
</html>




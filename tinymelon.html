<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Melon | Omni-Resilient Neural Gen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --melon-primary: #4ade80;
            --melon-dark: #070a13;
            --melon-surface: #111827;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--melon-dark);
            color: #f8fafc;
            overflow-x: hidden;
        }

        .melon-gradient-text {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .melon-btn {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .melon-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(34, 197, 94, 0.4);
        }

        .glass-card {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-mono {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(74, 222, 128, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-full md:w-72 glass-card border-r border-slate-800 p-6 flex flex-col hidden md:flex">
        <div class="flex items-center gap-3 mb-10">
            <div class="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center border border-green-500/30">
                <i class="fas fa-microchip text-green-400 text-sm"></i>
            </div>
            <div>
                <h2 class="text-[10px] font-800 uppercase tracking-widest text-slate-500">Neural Gateway</h2>
                <div class="text-xs font-bold text-slate-300">Resiliency Level: 5</div>
            </div>
        </div>
        
        <div id="historyList" class="flex-1 overflow-y-auto space-y-4 pr-2">
            <div class="text-xs text-slate-600 italic">Core log empty...</div>
        </div>

        <div class="mt-auto space-y-4 pt-6 border-t border-slate-800">
            <div class="flex items-center justify-between text-[10px] text-slate-500">
                <span>API STATUS:</span>
                <span class="text-green-400 font-bold">OPTIMAL</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-slate-900 rounded p-2 text-[9px] border border-slate-800">
                    <span class="block text-slate-500">Stability AI</span>
                    <span id="st-status" class="text-green-500">ACTIVE</span>
                </div>
                <div class="bg-slate-900 rounded p-2 text-[9px] border border-slate-800">
                    <span class="block text-slate-500">Search Core</span>
                    <span class="text-blue-400">READY</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Workspace -->
    <main class="flex-1 relative flex flex-col h-screen">
        
        <!-- Top Nav -->
        <nav class="p-4 md:p-6 flex justify-between items-center bg-slate-950/20 backdrop-blur-sm z-10 border-b border-white/5">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-800 tracking-tight">Tiny <span class="melon-gradient-text">Melon</span></h1>
                <div class="hidden sm:flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900 border border-slate-800">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Cascade Protected</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearHistory()" class="text-[10px] uppercase font-bold text-slate-500 hover:text-white transition-colors">Clear Cache</button>
            </div>
        </nav>

        <!-- Editor Area -->
        <section class="flex-1 overflow-y-auto p-4 md:p-10 flex flex-col items-center">
            <div class="w-full max-w-4xl space-y-8">
                
                <!-- Input Module -->
                <div class="glass-card rounded-3xl p-1 shadow-2xl relative overflow-hidden">
                    <div id="inputShimmer" class="absolute inset-0 shimmer opacity-0 transition-opacity pointer-events-none"></div>
                    <div class="relative">
                        <textarea id="promptInput" 
                            class="w-full bg-slate-900/40 border-0 rounded-[22px] p-6 pr-44 text-lg focus:ring-0 transition-all resize-none h-40 outline-none placeholder:text-slate-700"
                            placeholder="Describe anything... (Automated failover enabled)"></textarea>
                        
                        <div class="absolute bottom-6 right-6 flex items-center gap-4">
                            <button id="generateBtn" 
                                class="melon-btn text-slate-950 font-800 px-8 py-4 rounded-2xl flex items-center gap-3 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span id="btnText">Synthesize</span>
                                <i class="fas fa-atom text-sm" id="btnIcon"></i>
                                <div id="btnLoader" class="hidden w-5 h-5 border-2 border-slate-900 border-t-transparent rounded-full animate-spin"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Diagnostics -->
                <div id="logSection" class="hidden glass-card rounded-2xl p-4 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-3 border-b border-slate-800/50 pb-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2">
                            <i class="fas fa-terminal text-green-500"></i>
                            Neural Pipeline Status
                        </span>
                        <span id="current-engine" class="text-[10px] font-mono text-blue-400">Standby</span>
                    </div>
                    <div id="logContent" class="log-mono space-y-1 h-24 overflow-y-auto pr-2"></div>
                </div>

                <!-- Output Container -->
                <div id="outputGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                    <!-- Primary Result -->
                    <div class="group relative rounded-3xl overflow-hidden glass-card border border-white/5">
                        <img id="resultImage" src="" alt="Output" class="w-full h-full object-cover min-h-[400px]">
                        <div class="absolute top-4 left-4">
                            <span id="engineBadge" class="bg-black/50 backdrop-blur-md text-[9px] font-bold text-green-400 px-3 py-1.5 rounded-full border border-green-500/20">PRIMARY NODE</span>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 p-8 flex flex-col justify-end">
                            <p id="finalPrompt" class="text-sm text-white/80 line-clamp-2 italic mb-4"></p>
                            <div class="flex gap-2">
                                <button onclick="downloadImage()" class="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl text-xs font-bold transition-all">Download PNG</button>
                                <button onclick="shareImage()" class="w-12 h-12 bg-white/10 hover:bg-white/20 rounded-xl flex items-center justify-center transition-all">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Alternate/Search Options -->
                    <div id="searchGrid" class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 text-[10px] font-800 text-slate-500 uppercase tracking-widest">Web Search Fallbacks</div>
                        <!-- Search results dynamically added here -->
                    </div>
                </div>

                <!-- Initial State -->
                <div id="placeholder" class="py-32 flex flex-col items-center justify-center text-slate-700 space-y-6">
                    <div class="relative">
                        <div class="absolute inset-0 blur-2xl bg-green-500/10 rounded-full"></div>
                        <i class="fas fa-brain text-5xl opacity-20 relative z-10"></i>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-bold text-slate-500">Triple-Redundant Engine Online</p>
                        <p class="text-[10px] text-slate-600 mt-1 max-w-xs uppercase tracking-tighter">Stability AI -> Pollinations AI -> Unsplash Search -> Lexica Index</p>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <script>
        // API Config
        const STABILITY_KEY = "sk-46PR2cohKeslNX6jsJZ9VRU8gWDN7rwTmTaa5HDPAhPxYNbn"; // Publicly exposed/free tier
        
        const generateBtn = document.getElementById('generateBtn');
        const promptInput = document.getElementById('promptInput');
        const logContent = document.getElementById('logContent');
        const logSection = document.getElementById('logSection');
        const resultImage = document.getElementById('resultImage');
        const outputGrid = document.getElementById('outputGrid');
        const placeholder = document.getElementById('placeholder');
        const engineTag = document.getElementById('current-engine');
        const engineBadge = document.getElementById('engineBadge');
        const searchGrid = document.getElementById('searchGrid');

        function log(msg, type = 'info') {
            const styles = { info: 'text-slate-500', success: 'text-green-400', warn: 'text-yellow-400', error: 'text-rose-500 font-bold' };
            const div = document.createElement('div');
            div.className = `${styles[type]} leading-tight mb-1`;
            div.innerHTML = `<span class="opacity-20">#</span> [${new Date().toLocaleTimeString()}] ${msg}`;
            logContent.appendChild(div);
            logContent.scrollTop = logContent.scrollHeight;
            logSection.classList.remove('hidden');
        }

        // --- THE CASCADE ENGINES ---

        // Level 1: Stability AI (Premium/Free Tier)
        async function genStability(prompt) {
            log("Attempting Neural Cluster 01: Stability...", "info");
            engineTag.innerText = "Processing: Stability AI";
            const response = await fetch("https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json", "Authorization": `Bearer ${STABILITY_KEY}` },
                body: JSON.stringify({
                    text_prompts: [{ text: prompt, weight: 1 }],
                    cfg_scale: 7, height: 1024, width: 1024, samples: 1, steps: 30,
                }),
            });
            if (!response.ok) throw new Error("Stability Offline");
            const data = await response.json();
            return { src: `data:image/png;base64,${data.artifacts[0].base64}`, engine: "Stability AI V1" };
        }

        // Level 2: Pollinations AI (Free Public Neural Engine - No Key)
        async function genPollinations(prompt) {
            log("Stability fail. Switching to Neural Cluster 02: Pollinations...", "warn");
            engineTag.innerText = "Processing: Pollinations AI";
            const seed = Math.floor(Math.random() * 99999);
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${seed}&width=1024&height=1024&nologo=true`;
            // Pollinations returns image directly, we verify it loads
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ src: url, engine: "Pollinations Neural" });
                img.onerror = reject;
                img.src = url;
            });
        }

        // Level 3: Web Search Fallback (Unsplash / Lexica)
        async function fetchWebSearch(prompt) {
            log("Neural generation timed out. Executing Deep Web Search...", "error");
            engineTag.innerText = "Processing: Global Web Index";
            
            const query = encodeURIComponent(prompt);
            // We use Unsplash Source and Lexica as fallbacks
            const unsplashUrl = `https://source.unsplash.com/featured/1024x1024/?${query}`;
            const lexicaUrl = `https://lexica.art/api/v1/search?q=${query}`;

            try {
                const res = await fetch(lexicaUrl);
                const data = await res.json();
                if (data.images && data.images.length > 0) {
                    // Populate the search grid with alternates
                    updateSearchGrid(data.images.slice(1, 5));
                    return { src: data.images[0].src, engine: "Lexica Search Engine" };
                }
            } catch(e) {
                log("Lexica API failed. Using direct image buffer...", "warn");
            }

            return { src: unsplashUrl, engine: "Unsplash Index" };
        }

        function updateSearchGrid(images) {
            searchGrid.querySelectorAll('.search-item').forEach(e => e.remove());
            images.forEach(img => {
                const div = document.createElement('div');
                div.className = "search-item group relative aspect-square rounded-2xl overflow-hidden glass-card cursor-pointer";
                div.innerHTML = `
                    <img src="${img.src}" class="w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all">
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/40 transition-all">
                        <i class="fas fa-plus text-white"></i>
                    </div>
                `;
                div.onclick = () => {
                    resultImage.src = img.src;
                    engineBadge.innerText = "SEARCH NODE";
                };
                searchGrid.appendChild(div);
            });
        }

        generateBtn.addEventListener('click', async () => {
            const input = promptInput.value.trim();
            if (!input) return;

            // UI Reset
            generateBtn.disabled = true;
            document.getElementById('btnText').innerText = "CALCULATING";
            document.getElementById('btnIcon').className = "hidden";
            document.getElementById('btnLoader').classList.remove('hidden');
            document.getElementById('inputShimmer').classList.remove('opacity-0');
            logContent.innerHTML = '';
            
            let result = null;

            try {
                // CASCADE ATTEMPT 1: STABILITY
                try {
                    result = await genStability(input);
                    engineBadge.className = "bg-green-500/20 text-green-400 px-3 py-1.5 rounded-full text-[9px] font-bold border border-green-500/30";
                } catch (e) {
                    // CASCADE ATTEMPT 2: POLLINATIONS
                    try {
                        result = await genPollinations(input);
                        engineBadge.className = "bg-blue-500/20 text-blue-400 px-3 py-1.5 rounded-full text-[9px] font-bold border border-blue-500/30";
                    } catch (e2) {
                        // CASCADE ATTEMPT 3: SEARCH
                        result = await fetchWebSearch(input);
                        engineBadge.className = "bg-orange-500/20 text-orange-400 px-3 py-1.5 rounded-full text-[9px] font-bold border border-orange-500/30";
                    }
                }

                if (result) {
                    resultImage.src = result.src;
                    document.getElementById('finalPrompt').innerText = input;
                    engineBadge.innerText = result.engine.toUpperCase();
                    outputGrid.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    log(`Success: Asset delivered via ${result.engine}`, "success");
                    addToHistory(input, result.src);
                }

            } catch (err) {
                log(`FATAL ERROR: All engines unreachable. ${err.message}`, "error");
            } finally {
                generateBtn.disabled = false;
                document.getElementById('btnText').innerText = "Synthesize";
                document.getElementById('btnIcon').className = "fas fa-atom text-sm";
                document.getElementById('btnLoader').classList.add('hidden');
                document.getElementById('inputShimmer').classList.add('opacity-0');
            }
        });

        function addToHistory(p, s) {
            const h = document.getElementById('historyList');
            if(h.querySelector('.italic')) h.innerHTML = '';
            const d = document.createElement('div');
            d.className = "group relative aspect-square w-full rounded-2xl overflow-hidden glass-card cursor-pointer border border-white/5 hover:border-green-500/30 transition-all";
            d.innerHTML = `<img src="${s}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-all">`;
            d.onclick = () => { resultImage.src = s; document.getElementById('finalPrompt').innerText = p; };
            h.prepend(d);
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.href = resultImage.src;
            link.download = `melon-asset-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearHistory() {
            document.getElementById('historyList').innerHTML = '<div class="text-xs text-slate-600 italic">Core log empty...</div>';
            log("Local cache cleared.", "info");
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codenix IDE 3.5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Fira Code', monospace; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Resizing Overlay to prevent iframe interference */
        .resize-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1000;
            cursor: col-resize;
        }
        .resizing-v .resize-overlay { cursor: row-resize; display: block; }
        .resizing-h .resize-overlay { cursor: col-resize; display: block; }

        /* Animations */
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="bg-[#0d0d0d] text-[#e0e0e0] overflow-hidden select-none">

    <div id="resize-overlay" class="resize-overlay"></div>

    <div class="flex h-screen w-full">
        
        <!-- Activity Bar -->
        <div class="w-12 h-full bg-[#1e1e1e] flex flex-col items-center py-4 space-y-4 border-r border-[#2b2b2b] z-50 shadow-xl">
            <button onclick="switchTab('explorer')" id="btn-explorer" class="p-2.5 rounded-xl transition-all bg-[#3b82f6] text-white shadow-lg shadow-blue-500/20">
                <i data-lucide="file-code" size="22"></i>
            </button>
            <button onclick="switchTab('chat')" id="btn-chat" class="p-2.5 rounded-xl transition-all text-[#858585] hover:text-white hover:bg-[#2d2d2d]">
                <i data-lucide="message-square" size="22"></i>
            </button>
            <div class="mt-auto p-2 text-[#858585] cursor-pointer hover:text-white" onclick="toggleSidebar()">
                <i id="sidebar-toggle-icon" data-lucide="panel-left-close" size="20"></i>
            </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar-container" class="flex" style="width: 300px;">
            <div id="sidebar" class="w-full bg-[#181818] flex flex-col border-r border-[#2b2b2b] overflow-hidden">
                
                <!-- Explorer View -->
                <div id="view-explorer" class="flex-1 flex flex-col">
                    <div class="p-4 text-[10px] uppercase font-bold text-[#666] tracking-widest flex justify-between items-center">
                        <span>Workspace</span>
                        <i data-lucide="folder-open" size="14"></i>
                    </div>
                    <div id="file-list" class="px-2 space-y-1">
                        <!-- Files injected by JS -->
                    </div>
                </div>

                <!-- Chat View -->
                <div id="view-chat" class="hidden flex-1 flex flex-col bg-[#181818] overflow-hidden">
                    <div class="p-4 border-b border-[#2b2b2b] flex items-center justify-between">
                        <div class="text-[11px] font-bold uppercase tracking-widest text-purple-400 flex items-center">
                            <i data-lucide="sparkles" size="14" class="mr-2"></i> Nix Intelligence
                        </div>
                    </div>

                    <!-- Tasks List -->
                    <div id="task-container" class="hidden px-4 py-3 border-b border-[#2b2b2b] bg-[#1a1a1a]">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-500 uppercase font-bold">Plan & Progress</span>
                            <button onclick="clearTasks()" class="text-[10px] text-red-400 hover:text-red-300 transition-colors">
                                <i data-lucide="trash-2" size="10"></i>
                            </button>
                        </div>
                        <div id="task-list" class="max-h-32 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                            <!-- Tasks injected by JS -->
                        </div>
                    </div>

                    <!-- Messages -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-xs custom-scrollbar">
                        <div class="flex justify-start">
                            <div class="max-w-[85%] p-3 rounded-2xl bg-[#2a2a2a] border border-[#3e3e3e] text-[#ddd]">
                                Hello! I'm the HTML version of Nix 3.5. Ready to build something great?
                            </div>
                        </div>
                    </div>

                    <!-- Input -->
                    <div class="p-4 border-t border-[#2b2b2b] bg-[#1e1e1e]">
                        <div class="relative">
                            <input id="chat-input" type="text" 
                                class="w-full bg-[#2a2a2a] rounded-xl p-3 pr-10 text-xs outline-none border border-transparent focus:border-purple-500/50 transition-all shadow-inner"
                                placeholder="Ask Nix to modify code...">
                            <button onclick="handleSendMessage()" class="absolute right-2 top-2 p-1.5 text-gray-400 hover:text-white">
                                <i data-lucide="send" size="16"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Resize Handle H -->
            <div id="handle-sidebar" class="w-1 cursor-col-resize hover:bg-blue-500 active:bg-blue-600 transition-colors z-50"></div>
        </div>

        <!-- Main Workspace -->
        <div class="flex-1 flex flex-col min-w-0 bg-[#0d0d0d]">
            <!-- Tab Bar -->
            <div class="h-10 flex bg-[#181818] items-center border-b border-[#2b2b2b] px-2 space-x-1">
                <button onclick="switchView('editor')" id="tab-editor" class="px-4 h-full flex items-center text-[11px] font-medium transition-all rounded-t-lg bg-[#1e1e1e] text-white border-b-2 border-blue-500">
                    <i data-lucide="code-2" size="14" class="mr-2"></i> Editor
                </button>
                <button onclick="switchView('preview')" id="tab-preview" class="px-4 h-full flex items-center text-[11px] font-medium transition-all rounded-t-lg text-gray-500 hover:text-gray-300">
                    <i data-lucide="monitor" size="14" class="mr-2"></i> Live Preview
                </button>
                <div class="flex-1"></div>
                <div id="active-filename" class="mr-4 text-[9px] font-bold text-gray-600 uppercase tracking-[0.2em]">index.html</div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 flex flex-col overflow-hidden relative">
                <textarea id="editor" spellcheck="false" class="flex-1 bg-[#1e1e1e] p-8 outline-none font-mono text-[14px] leading-relaxed resize-none text-[#cbd5e1] caret-blue-500 selection:bg-blue-500/30"></textarea>
                <iframe id="preview" class="hidden w-full h-full border-none bg-white"></iframe>
            </div>

            <!-- Terminal -->
            <div id="terminal-container" class="flex flex-col">
                <div id="handle-terminal" class="h-1 cursor-row-resize hover:bg-blue-500 active:bg-blue-600 transition-colors z-50"></div>
                <div id="terminal" style="height: 160px;" class="bg-[#0f0f0f] border-t border-[#2b2b2b] flex flex-col overflow-hidden shadow-2xl">
                    <div class="h-8 bg-[#1a1a1a] flex items-center justify-between px-4 border-b border-[#2b2b2b]">
                        <div class="text-[10px] font-bold uppercase tracking-widest flex items-center text-gray-400">
                            <i data-lucide="terminal" size="12" class="mr-2 text-blue-500"></i> Output Terminal
                        </div>
                        <i data-lucide="minimize-2" size="12" class="cursor-pointer text-gray-500 hover:text-white transition-colors" onclick="toggleTerminal()"></i>
                    </div>
                    <div id="terminal-content" class="flex-1 p-4 font-mono text-[12px] overflow-y-auto custom-scrollbar">
                        <div class="text-emerald-500 mb-1 opacity-80">✓ Nix-Runtime Environment Connected</div>
                        <div class="text-blue-400 opacity-80">ℹ Hot-Reload initialized</div>
                        <div class="flex items-center mt-2">
                            <span class="text-blue-500 font-bold mr-2">$</span>
                            <span class="w-2 h-4 bg-gray-600 animate-pulse rounded-sm"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="h-7 bg-[#2563eb] flex items-center justify-between px-4 text-white text-[10px] font-medium z-50">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center cursor-pointer hover:bg-white/10 px-2 py-0.5 rounded transition-all" onclick="toggleTerminal()">
                        <i data-lucide="terminal" size="12" class="mr-1.5"></i> Console <span id="console-status">Active</span>
                    </div>
                    <div class="opacity-80">UTF-8</div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="status-filename" class="opacity-80 uppercase">INDEX.HTML</span>
                    <div class="flex items-center space-x-1.5 bg-blue-400/30 px-2 py-0.5 rounded-full">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></div>
                        <span class="text-[9px]">SYNCED</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        const INITIAL_FILES = {
            'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nix Website</title>
</head>
<body>
    <div class="hero">
        <h1>Nix HTML Edition</h1>
        <p>A high-speed, resizable developer workspace.</p>
        <button id="main-btn">Click Me</button>
    </div>
</body>
</html>`,
            'styles.css': `body { background: #0f172a; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
.hero { text-align: center; }
button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }`,
            'script.js': `document.getElementById('main-btn').addEventListener('click', () => alert('Hello from Nix!'));`
        };

        let files = { ...INITIAL_FILES };
        let activeFile = 'index.html';
        let isSidebarVisible = true;
        let isTerminalVisible = true;
        let currentTab = 'explorer';
        let currentView = 'editor';
        let sidebarWidth = 300;
        let terminalHeight = 160;

        // API Setup
        const API_KEY = ""; // Environment Key
        const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

        // Initialization
        window.onload = () => {
            lucide.createIcons();
            renderFileList();
            updateEditor();
            setupResizing();
            
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSendMessage();
            });
        };

        function renderFileList() {
            const list = document.getElementById('file-list');
            list.innerHTML = Object.keys(files).map(name => `
                <div onclick="setActiveFile('${name}')" class="flex items-center px-3 py-2 rounded-md cursor-pointer text-xs transition-colors ${activeFile === name ? 'bg-[#2d2d2d] text-blue-400 border border-[#3e3e3e]' : 'hover:bg-[#252525] text-[#999]'}">
                    <i data-lucide="file-code" class="w-3.5 h-3.5 mr-2 ${activeFile === name ? 'text-blue-400' : 'text-gray-500'}"></i> ${name}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function setActiveFile(name) {
            // Save current editor content back to files
            files[activeFile] = document.getElementById('editor').value;
            activeFile = name;
            updateEditor();
            renderFileList();
            document.getElementById('active-filename').innerText = name;
            document.getElementById('status-filename').innerText = name.toUpperCase();
        }

        function updateEditor() {
            document.getElementById('editor').value = files[activeFile];
        }

        // Layout Functions
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('view-explorer').classList.toggle('hidden', tab !== 'explorer');
            document.getElementById('view-chat').classList.toggle('hidden', tab !== 'chat');
            
            document.getElementById('btn-explorer').className = tab === 'explorer' ? 
                'p-2.5 rounded-xl transition-all bg-[#3b82f6] text-white shadow-lg shadow-blue-500/20' : 
                'p-2.5 rounded-xl transition-all text-[#858585] hover:text-white hover:bg-[#2d2d2d]';
            
            document.getElementById('btn-chat').className = tab === 'chat' ? 
                'p-2.5 rounded-xl transition-all bg-[#8b5cf6] text-white shadow-lg shadow-purple-500/20' : 
                'p-2.5 rounded-xl transition-all text-[#858585] hover:text-white hover:bg-[#2d2d2d]';
        }

        function switchView(view) {
            currentView = view;
            const editorEl = document.getElementById('editor');
            const previewEl = document.getElementById('preview');
            const tabEditor = document.getElementById('tab-editor');
            const tabPreview = document.getElementById('tab-preview');

            if (view === 'editor') {
                editorEl.classList.remove('hidden');
                previewEl.classList.add('hidden');
                tabEditor.className = 'px-4 h-full flex items-center text-[11px] font-medium transition-all rounded-t-lg bg-[#1e1e1e] text-white border-b-2 border-blue-500';
                tabPreview.className = 'px-4 h-full flex items-center text-[11px] font-medium transition-all rounded-t-lg text-gray-500 hover:text-gray-300';
            } else {
                files[activeFile] = editorEl.value;
                editorEl.classList.add('hidden');
                previewEl.classList.remove('hidden');
                tabPreview.className = 'px-4 h-full flex items-center text-[11px] font-medium transition-all rounded-t-lg bg-[#1e1e1e] text-white border-b-2 border-green-500';
                tabEditor.className = 'px-4 h-full flex items-center text-[11px] font-medium transition-all rounded-t-lg text-gray-500 hover:text-gray-300';
                
                const content = `
                    <html><style>${files['styles.css']}</style><body>${files['index.html']}<script>${files['script.js']}<\/script></body></html>
                `;
                previewEl.srcdoc = content;
            }
        }

        function toggleSidebar() {
            isSidebarVisible = !isSidebarVisible;
            document.getElementById('sidebar-container').style.display = isSidebarVisible ? 'flex' : 'none';
            document.getElementById('sidebar-toggle-icon').setAttribute('data-lucide', isSidebarVisible ? 'panel-left-close' : 'panel-left');
            lucide.createIcons();
        }

        function toggleTerminal() {
            isTerminalVisible = !isTerminalVisible;
            document.getElementById('terminal').style.display = isTerminalVisible ? 'flex' : 'none';
            document.getElementById('handle-terminal').style.display = isTerminalVisible ? 'block' : 'none';
            document.getElementById('console-status').innerText = isTerminalVisible ? 'Active' : 'Hidden';
        }

        // Resizing Logic
        function setupResizing() {
            const hSidebar = document.getElementById('handle-sidebar');
            const hTerminal = document.getElementById('handle-terminal');
            const overlay = document.getElementById('resize-overlay');

            let isResizingH = false;
            let isResizingV = false;

            hSidebar.onmousedown = () => { isResizingH = true; document.body.classList.add('resizing-h'); };
            hTerminal.onmousedown = () => { isResizingV = true; document.body.classList.add('resizing-v'); };

            window.onmousemove = (e) => {
                if (isResizingH) {
                    sidebarWidth = Math.max(200, Math.min(600, e.clientX - 48));
                    document.getElementById('sidebar-container').style.width = sidebarWidth + 'px';
                }
                if (isResizingV) {
                    terminalHeight = Math.max(40, Math.min(600, window.innerHeight - e.clientY));
                    document.getElementById('terminal').style.height = terminalHeight + 'px';
                }
            };

            window.onmouseup = () => {
                isResizingH = false; isResizingV = false;
                document.body.classList.remove('resizing-h', 'resizing-v');
            };
        }

        // AI Messaging
        async function handleSendMessage() {
            const input = document.getElementById('chat-input');
            const userPrompt = input.value.trim();
            if (!userPrompt) return;

            addChatMessage('user', userPrompt);
            input.value = '';
            
            try {
                // Step 1: Planning
                const planPayload = {
                    contents: [{ parts: [{ text: `Create a coding plan for: "${userPrompt}". Format: {"tasks": [{"id": 1, "label": "Description", "file": "index.html"}]}` }] }],
                    systemInstruction: { parts: [{ text: "Senior Software Architect. Output strict JSON only." }] }
                };

                const planRes = await fetch(`${BASE_URL}${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planPayload)
                });

                const planData = await planRes.json();
                const rawPlan = planData.candidates[0].content.parts[0].text;
                const jsonMatch = rawPlan.match(/\{[\s\S]*\}/);
                const planJson = JSON.parse(jsonMatch ? jsonMatch[0] : rawPlan);

                showTasks(planJson.tasks);

                // Step 2: Code Execution
                for (const task of planJson.tasks) {
                    updateTaskStatus(task.id, 'running');
                    
                    const codePayload = {
                        contents: [{ parts: [{ text: `Full file content for "${task.file}" to: "${task.label}". Overall: "${userPrompt}". No markdown.` }] }],
                        systemInstruction: { parts: [{ text: "Senior Dev. Output source code ONLY. No backticks." }] }
                    };

                    const codeRes = await fetch(`${BASE_URL}${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(codePayload)
                    });

                    const codeData = await codeRes.json();
                    let newCode = codeData.candidates[0].content.parts[0].text;
                    newCode = newCode.replace(/^```[a-z]*\n/i, "").replace(/\n```$/, "");

                    setActiveFile(task.file);
                    await simulateTyping(task.file, newCode);
                    updateTaskStatus(task.id, 'completed');
                }

                addChatMessage('assistant', 'Updates completed successfully.');
            } catch (err) {
                console.error(err);
                addChatMessage('assistant', 'Sorry, I encountered an error.');
            }
        }

        function addChatMessage(role, text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[85%] p-3 rounded-2xl ${role === 'user' ? 'bg-[#2563eb] text-white' : 'bg-[#2a2a2a] border border-[#3e3e3e] text-[#ddd]'}">
                    ${text}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showTasks(tasks) {
            const container = document.getElementById('task-container');
            const list = document.getElementById('task-list');
            container.classList.remove('hidden');
            list.innerHTML = tasks.map(t => `
                <div id="task-${t.id}" class="flex items-start space-x-2 p-1.5 rounded bg-[#252525] border border-[#333]">
                    <div class="status-icon mt-0.5"><i data-lucide="circle" size="12" class="text-gray-600"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[10px] font-medium truncate">${t.label}</div>
                        <div class="text-[8px] text-gray-500 uppercase">${t.file}</div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateTaskStatus(id, status) {
            const el = document.getElementById(`task-${id}`);
            const icon = el.querySelector('.status-icon');
            if (status === 'running') {
                el.classList.add('border-purple-500/50');
                icon.innerHTML = `<i data-lucide="loader-2" size="12" class="text-purple-400 animate-spin"></i>`;
            } else {
                el.classList.remove('border-purple-500/50');
                icon.innerHTML = `<i data-lucide="check-circle-2" size="12" class="text-green-500"></i>`;
            }
            lucide.createIcons();
        }

        function simulateTyping(fileName, fullContent) {
            return new Promise((resolve) => {
                let index = 0;
                const editor = document.getElementById('editor');
                const step = () => {
                    index += Math.ceil(fullContent.length / 30);
                    if (index < fullContent.length) {
                        files[fileName] = fullContent.slice(0, index);
                        if (activeFile === fileName) editor.value = files[fileName];
                        requestAnimationFrame(step);
                    } else {
                        files[fileName] = fullContent;
                        if (activeFile === fileName) editor.value = fullContent;
                        resolve();
                    }
                };
                requestAnimationFrame(step);
            });
        }

        function clearTasks() {
            document.getElementById('task-container').classList.add('hidden');
            document.getElementById('task-list').innerHTML = '';
        }
    </script>
</body>
</html>

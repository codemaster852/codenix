import React, { useState, useEffect, useRef, useCallback } from 'react';
import { 
  FileCode, MessageSquare, Settings, Play, ChevronRight, ChevronDown, 
  Terminal as TerminalIcon, CheckCircle2, Circle, Loader2, Send, Cpu, 
  FolderOpen, Eye, Menu, PanelLeftClose, PanelLeft, Maximize2, Minimize2
} from 'lucide-react';

const API_KEY = ""; // Using environment key
const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

const INITIAL_FILES = {
  'index.html': `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nix 3 Project</title>
</head>
<body>
  <div class="container">
    <h1>Welcome to Nix 3</h1>
    <p>Everything is now resizable and faster.</p>
    <div id="counter-display">Count: 0</div>
    <button id="increment-btn">Increment</button>
  </div>
</body>
</html>`,
  'styles.css': `.container {
  font-family: system-ui, -apple-system, sans-serif;
  text-align: center;
  padding: 40px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  max-width: 320px;
  margin: 15vh auto;
}
button {
  background: #007acc;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
button:active { transform: scale(0.95); }`,
  'script.js': `let count = 0;
const display = document.getElementById('counter-display');
const btn = document.getElementById('increment-btn');

btn.addEventListener('click', () => {
  count++;
  display.innerText = 'Count: ' + count;
});`
};

export default function App() {
  const [files, setFiles] = useState(INITIAL_FILES);
  const [activeFile, setActiveFile] = useState('index.html');
  const [sidebarTab, setSidebarTab] = useState('explorer');
  const [viewMode, setViewMode] = useState('editor');
  const [prompt, setPrompt] = useState("");
  const [isProcessing, setIsProcessing] = useState(false);
  const [aiTasks, setAiTasks] = useState([]);
  const [messages, setMessages] = useState([
    { role: 'assistant', content: 'Nix 3 is ready. I have fixed the connection errors and stabilized the AI task manager. What should we build?' }
  ]);
  const [isTyping, setIsTyping] = useState(false);

  // Layout State
  const [sidebarWidth, setSidebarWidth] = useState(260);
  const [terminalHeight, setTerminalHeight] = useState(140);
  const [isSidebarVisible, setIsSidebarVisible] = useState(true);
  const [isTerminalVisible, setIsTerminalVisible] = useState(true);

  // Resizing Refs
  const isResizingSidebar = useRef(false);
  const isResizingTerminal = useRef(false);

  const startResizingSidebar = () => (isResizingSidebar.current = true);
  const startResizingTerminal = () => (isResizingTerminal.current = true);

  const stopResizing = useCallback(() => {
    isResizingSidebar.current = false;
    isResizingTerminal.current = false;
  }, []);

  const onMouseMove = useCallback((e) => {
    if (isResizingSidebar.current) {
      const newWidth = Math.max(160, Math.min(600, e.clientX - 48));
      setSidebarWidth(newWidth);
    }
    if (isResizingTerminal.current) {
      const newHeight = Math.max(40, Math.min(500, window.innerHeight - e.clientY));
      setTerminalHeight(newHeight);
    }
  }, []);

  useEffect(() => {
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', stopResizing);
    return () => {
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('mouseup', stopResizing);
    };
  }, [onMouseMove, stopResizing]);

  const getPreviewContent = useCallback(() => {
    const html = files['index.html'] || '';
    const css = files['styles.css'] || '';
    const js = files['script.js'] || '';
    const styleTag = `<style>${css}</style>`;
    const scriptTag = `<script>${js}<\/script>`;
    
    let doc = html;
    doc = doc.includes('</head>') ? doc.replace('</head>', `${styleTag}</head>`) : styleTag + doc;
    doc = doc.includes('</body>') ? doc.replace('</body>', `${scriptTag}</body>`) : doc + scriptTag;
    return doc;
  }, [files]);

  const callNix = async (userPrompt) => {
    setIsProcessing(true);
    setSidebarTab('chat');
    
    try {
      // Step 1: Planning with retry logic
      const planPayload = {
        contents: [{ parts: [{ text: `Create a coding plan for this request: "${userPrompt}". Output ONLY valid JSON in this format: {"tasks": [{"id": 1, "label": "Description of action", "file": "index.html"}]}` }] }],
        systemInstruction: { parts: [{ text: "You are Nix 3, a senior software architect. You output strict JSON plans for code modifications." }] }
      };

      const planResponse = await fetch(`${BASE_URL}${API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(planPayload)
      });

      const planData = await planResponse.json();
      const rawContent = planData.candidates?.[0]?.content?.parts?.[0]?.text || "";
      
      let planJson;
      try {
        const jsonMatch = rawContent.match(/\{[\s\S]*\}/);
        planJson = JSON.parse(jsonMatch ? jsonMatch[0] : rawContent);
      } catch (e) {
        // Fallback if planning fails
        planJson = { tasks: [{ id: 1, label: "Update project", file: activeFile }] };
      }

      if (!planJson.tasks || !Array.isArray(planJson.tasks)) {
        planJson = { tasks: [{ id: 1, label: "Update current file", file: activeFile }] };
      }

      setAiTasks(planJson.tasks.map(t => ({ ...t, status: 'pending' })));

      // Step 2: Execute each task
      for (const task of planJson.tasks) {
        setAiTasks(prev => prev.map(t => t.id === task.id ? { ...t, status: 'running' } : t));
        
        const codePayload = {
          contents: [{ parts: [{ text: `Write the full updated content for the file "${task.file}" based on this objective: "${task.label}". User overall prompt: "${userPrompt}". Return ONLY the code, no markdown commentary.` }] }],
          systemInstruction: { parts: [{ text: "You are Nix 3. You only output source code. Do not use markdown backticks unless they are part of the actual code. Provide full file contents." }] }
        };

        const codeResponse = await fetch(`${BASE_URL}${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(codePayload)
        });

        const codeData = await codeResponse.json();
        let newCode = codeData.candidates?.[0]?.content?.parts?.[0]?.text || "";
        
        // Clean up markdown block syntax if the model included it despite instructions
        newCode = newCode.replace(/^```[a-z]*\n/i, "").replace(/\n```$/, "");
        
        setActiveFile(task.file);
        await simulateTyping(task.file, newCode);
        setAiTasks(prev => prev.map(t => t.id === task.id ? { ...t, status: 'completed' } : t));
      }

      setMessages(prev => [...prev, { role: 'assistant', content: `Finished updates for: ${planJson.tasks.map(t => t.file).join(', ')}.` }]);
    } catch (e) {
      console.error("Nix 3 Error:", e);
      setMessages(prev => [...prev, { role: 'assistant', content: "I encountered an error while processing your request. Please try again." }]);
    } finally {
      setIsProcessing(false);
    }
  };

  const simulateTyping = (fileName, fullContent) => {
    return new Promise((resolve) => {
      setIsTyping(true);
      let index = 0;
      const step = () => {
        // High speed typing for UX
        index += Math.ceil(fullContent.length / 50); 
        const currentSlice = fullContent.slice(0, index);
        setFiles(prev => ({ ...prev, [fileName]: currentSlice }));
        
        if (index < fullContent.length) {
          requestAnimationFrame(step);
        } else {
          setFiles(prev => ({ ...prev, [fileName]: fullContent }));
          setIsTyping(false);
          resolve();
        }
      };
      requestAnimationFrame(step);
    });
  };

  return (
    <div className="flex h-screen w-full bg-[#181818] text-[#cccccc] font-sans overflow-hidden select-none">
      
      {/* Activity Bar */}
      <div className="w-12 h-full bg-[#333333] flex flex-col items-center py-4 space-y-4 border-r border-[#2b2b2b] z-50">
        <div 
          className={`p-2 cursor-pointer rounded transition-colors ${sidebarTab === 'explorer' ? 'bg-[#444] text-white' : 'text-[#858585] hover:text-white'}`}
          onClick={() => { setSidebarTab('explorer'); setIsSidebarVisible(true); }}
        >
          <FileCode size={20} />
        </div>
        <div 
          className={`p-2 cursor-pointer rounded transition-colors ${sidebarTab === 'chat' ? 'bg-[#444] text-white' : 'text-[#858585] hover:text-white'}`}
          onClick={() => { setSidebarTab('chat'); setIsSidebarVisible(true); }}
        >
          <MessageSquare size={20} />
        </div>
        <div className="mt-auto p-2 text-[#858585] cursor-pointer hover:text-white" onClick={() => setIsSidebarVisible(!isSidebarVisible)}>
          {isSidebarVisible ? <PanelLeftClose size={20} /> : <PanelLeft size={20} />}
        </div>
      </div>

      {/* Sidebar */}
      {isSidebarVisible && (
        <>
          <div style={{ width: sidebarWidth }} className="bg-[#252526] flex flex-col border-r border-[#181818] overflow-hidden">
            {sidebarTab === 'explorer' ? (
              <div className="flex-1 flex flex-col">
                <div className="p-3 text-[11px] uppercase font-bold text-[#bbbbbb] flex justify-between">
                  <span>Explorer</span>
                  <FolderOpen size={14} />
                </div>
                {Object.keys(files).map(name => (
                  <div 
                    key={name}
                    onClick={() => setActiveFile(name)}
                    className={`flex items-center px-4 py-1.5 cursor-pointer text-xs ${activeFile === name ? 'bg-[#37373d] text-white' : 'hover:bg-[#2a2d2e]'}`}
                  >
                    <FileCode size={14} className="mr-2 text-blue-400" /> {name}
                  </div>
                ))}
              </div>
            ) : (
              <div className="flex-1 flex flex-col bg-[#1e1e1e]">
                <div className="p-3 border-b border-[#2b2b2b] bg-[#252526] text-xs font-bold uppercase tracking-tight flex items-center">
                  <Cpu size={14} className="mr-2 text-purple-400" /> Nix Assistant
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4 text-xs">
                  {messages.map((m, i) => (
                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[90%] p-2.5 rounded-lg ${m.role === 'user' ? 'bg-[#0e639c]' : 'bg-[#2d2d2d] border border-[#3e3e3e]'}`}>
                        {m.content}
                      </div>
                    </div>
                  ))}
                  {aiTasks.map(t => (
                    <div key={t.id} className="flex items-center space-x-2 text-[10px] opacity-70">
                      {t.status === 'completed' ? <CheckCircle2 size={10} className="text-green-500" /> : <Loader2 size={10} className="animate-spin" />}
                      <span>{t.label}</span>
                    </div>
                  ))}
                </div>
                <div className="p-3 border-t border-[#2b2b2b]">
                  <div className="relative">
                    <input 
                      className="w-full bg-[#3c3c3c] rounded p-2 pr-8 text-xs outline-none border border-transparent focus:border-[#007acc]"
                      placeholder="Ask Nix to modify code..."
                      value={prompt}
                      onChange={e => setPrompt(e.target.value)}
                      onKeyDown={e => e.key === 'Enter' && prompt.trim() && (setMessages([...messages, {role:'user', content:prompt}]), callNix(prompt), setPrompt(""))}
                    />
                    <Send size={14} className="absolute right-2 top-2 text-gray-400 cursor-pointer hover:text-white" onClick={() => prompt.trim() && (setMessages([...messages, {role:'user', content:prompt}]), callNix(prompt), setPrompt(""))} />
                  </div>
                </div>
              </div>
            )}
          </div>
          <div 
            onMouseDown={startResizingSidebar}
            className="w-1 cursor-col-resize hover:bg-[#007acc] active:bg-[#007acc] transition-colors z-50 bg-transparent"
          />
        </>
      )}

      {/* Main Area */}
      <div className="flex-1 flex flex-col min-w-0">
        <div className="h-9 flex bg-[#252526] items-center border-b border-[#181818]">
          <div className={`px-4 h-full flex items-center text-xs cursor-pointer transition-colors ${viewMode === 'editor' ? 'bg-[#1e1e1e] border-t border-t-[#007acc]' : 'hover:bg-[#2d2d2d]'}`} onClick={() => setViewMode('editor')}>Editor</div>
          <div className={`px-4 h-full flex items-center text-xs cursor-pointer transition-colors ${viewMode === 'preview' ? 'bg-[#1e1e1e] border-t border-t-[#22c55e]' : 'hover:bg-[#2d2d2d]'}`} onClick={() => setViewMode('preview')}>Preview</div>
          <div className="flex-1"></div>
          <div className="mr-4 text-[10px] opacity-50 uppercase tracking-widest">{activeFile}</div>
        </div>

        <div className="flex-1 flex flex-col overflow-hidden bg-[#1e1e1e]">
          {viewMode === 'editor' ? (
            <textarea
              className="flex-1 bg-transparent p-6 outline-none font-mono text-[13px] leading-relaxed resize-none text-[#d4d4d4] caret-white"
              value={files[activeFile] || ""}
              onChange={e => setFiles({...files, [activeFile]: e.target.value})}
              spellCheck="false"
            />
          ) : (
            <iframe title="p" srcDoc={getPreviewContent()} className="w-full h-full bg-white border-none" />
          )}
        </div>

        {/* Terminal */}
        {isTerminalVisible && (
          <>
            <div 
              onMouseDown={startResizingTerminal}
              className="h-1 cursor-row-resize hover:bg-[#007acc] active:bg-[#007acc] transition-colors z-50 bg-transparent"
            />
            <div style={{ height: terminalHeight }} className="bg-[#181818] border-t border-[#2b2b2b] flex flex-col overflow-hidden">
              <div className="h-7 bg-[#252526] flex items-center justify-between px-3 border-b border-[#181818]">
                <div className="text-[10px] font-bold uppercase tracking-wider flex items-center">
                  <TerminalIcon size={12} className="mr-2" /> Terminal
                </div>
                <Minimize2 size={12} className="cursor-pointer hover:text-white" onClick={() => setIsTerminalVisible(false)} />
              </div>
              <div className="flex-1 p-3 font-mono text-[11px] text-gray-500 overflow-y-auto">
                <div className="text-blue-400">Nix 3.5.0 environment initialized...</div>
                <div>&gt; Live reload active for all files.</div>
                {isProcessing && <div className="text-yellow-500 animate-pulse">&gt; AI is processing changes...</div>}
                <div className="flex items-center">
                  <span className="text-[#007acc] mr-1">$</span>
                  <span className="w-1.5 h-3.5 bg-gray-600 animate-pulse"></span>
                </div>
              </div>
            </div>
          </>
        )}

        {/* Status Bar */}
        <div className="h-6 bg-[#007acc] flex items-center justify-between px-3 text-white text-[10px] z-50">
          <div className="flex items-center space-x-4">
            <div className="flex items-center cursor-pointer hover:bg-white/10 px-1 rounded transition-colors" onClick={() => setIsTerminalVisible(true)}>
              <TerminalIcon size={10} className="mr-1" /> Console {isTerminalVisible ? 'On' : 'Off'}
            </div>
            <span>Ln 1, Col 1</span>
          </div>
          <div className="flex items-center space-x-3">
            <span>{activeFile.split('.').pop()?.toUpperCase()}</span>
            <div className="w-2 h-2 rounded-full bg-green-400" title="System Online" />
          </div>
        </div>
      </div>
    </div>
  );
}

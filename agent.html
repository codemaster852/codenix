<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codenix Pro - Agent Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .agent-thought {
            border-left: 2px solid #4f46e5;
        }
        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .resizer-col {
            background-color: #374151;
            cursor: col-resize;
            width: 6px;
            flex-shrink: 0;
            z-index: 10;
        }
        .resizer-col:hover {
            background-color: #4b5563;
        }
        .resizing {
            user-select: none;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-3 md:p-4 flex justify-between items-center z-20 flex-shrink-0">
        <div class="flex items-center space-x-2 md:space-x-3">
            <svg class="w-7 h-7 md:w-8 md:h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <h1 class="text-xl md:text-2xl font-bold">Codenix Pro <span class="text-purple-400 font-light">Agent</span></h1>
        </div>
        <div class="flex items-center space-x-2">
             <div id="token-display" class="text-sm text-gray-400 mr-4"></div>
            <button id="publish-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md hidden items-center space-x-2 transition-all duration-200 transform hover:scale-105">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span class="hidden md:inline">Publish</span>
            </button>
            <a href="index.html" id="editor-mode-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center space-x-2 transition-all duration-200 transform hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                <span class="hidden md:inline">Editor Mode</span>
            </a>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        <!-- Left Panel: Chat, Plan, ToDo -->
        <div id="left-panel" class="flex-1 flex flex-col md:w-2/5 lg:w-1/3 p-4 overflow-hidden">
            <!-- Tabs -->
            <div class="flex-shrink-0 mb-4 border-b border-gray-700">
                <nav class="flex space-x-2" id="tabs">
                    <button data-tab="chat" class="tab-btn active font-semibold py-2 px-4 rounded-t-md">Chat</button>
                    <button data-tab="plan" class="tab-btn font-semibold py-2 px-4 rounded-t-md">Plan</button>
                    <button data-tab="todo" class="tab-btn font-semibold py-2 px-4 rounded-t-md">To-Do</button>
                </nav>
            </div>
            
            <!-- Tab Content -->
            <div class="flex-1 flex flex-col overflow-y-auto">
                <div id="chat-content" class="tab-content active flex-1 flex flex-col">
                    <div id="chat-history" class="flex-1 space-y-4 pr-2 overflow-y-auto"></div>
                </div>
                <div id="plan-content" class="tab-content flex-1 overflow-y-auto pr-2">
                    <p class="text-gray-400">The agent's plan will appear here...</p>
                </div>
                <div id="todo-content" class="tab-content flex-1 overflow-y-auto pr-2">
                     <p class="text-gray-400">The agent's to-do list will appear here...</p>
                </div>
            </div>

            <div id="chat-input-container" class="mt-4 flex-shrink-0">
                <div class="flex items-center bg-gray-700 rounded-md">
                    <input type="text" id="chat-input" class="flex-1 bg-transparent p-3 focus:outline-none" placeholder="Describe the website or app you want to build...">
                    <button id="send-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-r-md transition-colors duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="resizer-col hidden md:flex" id="resizer-1"></div>

        <!-- Middle Panel: Project Status -->
        <div id="project-panel" class="w-full md:w-1/3 bg-gray-800/50 p-4 border-l border-r border-gray-700 overflow-y-auto">
            <h2 class="text-lg font-semibold mb-4">Project Files</h2>
            <div id="file-list" class="space-y-2">
                <p class="text-gray-400">Waiting for project description...</p>
            </div>
             <div id="send-to-editor-container" class="mt-6 hidden">
                <button id="send-to-editor-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
                    Send Project to Editor
                </button>
            </div>
        </div>
        
        <div class="resizer-col hidden md:flex" id="resizer-2"></div>

        <!-- Right Panel: Live Preview -->
        <div id="preview-panel" class="flex-1 hidden md:flex flex-col">
            <div class="p-4 border-b border-gray-700 flex-shrink-0"><h2 class="text-lg font-semibold">Live Preview</h2></div>
            <iframe id="preview-frame" class="w-full h-full bg-white"></iframe>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const dom = {
                chatHistory: document.getElementById('chat-history'),
                chatInput: document.getElementById('chat-input'),
                sendButton: document.getElementById('send-button'),
                chatInputContainer: document.getElementById('chat-input-container'),
                fileList: document.getElementById('file-list'),
                sendToEditorContainer: document.getElementById('send-to-editor-container'),
                sendToEditorButton: document.getElementById('send-to-editor-button'),
                tabs: document.getElementById('tabs'),
                chatContent: document.getElementById('chat-content'),
                planContent: document.getElementById('plan-content'),
                todoContent: document.getElementById('todo-content'),
                previewFrame: document.getElementById('preview-frame'),
                publishButton: document.getElementById('publish-button'),
                leftPanel: document.getElementById('left-panel'),
                projectPanel: document.getElementById('project-panel'),
                previewPanel: document.getElementById('preview-panel'),
                resizer1: document.getElementById('resizer-1'),
                resizer2: document.getElementById('resizer-2'),
                tokenDisplay: document.getElementById('token-display'),
            };

            const supabaseUrl = 'https://qngaezufoxwzklohhiat.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuZ2FlenVmb3h3emtsb2hoaWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTE1NzcsImV4cCI6MjA3MDgyNzU3N30.4z8RjrPPJ5sqIjbn17h0fdK-V9owLTQN6-JzeAoivxk';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            const GEMINI_API_KEY = "AIzaSyBMVUXGdF56RKxJh-E_cJaITZwwHtKGNjA";
            const DEEPSEEK_API_KEY = "sk-ad74271315714512b770c962a522190d";

            let projectFiles = [];
            let conversationHistory = [];
            let agentState = 'idle'; // idle, planning, awaiting_approval, building, refining
            let userProfile = null;

            // --- AUTHENTICATION CHECK ---
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }
            
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (profileError || !profile) {
                alert('Could not load your profile. Please try logging in again.');
                await supabase.auth.signOut();
                window.location.href = 'auth.html';
                return;
            }
            userProfile = profile;
            updateTokenDisplay();

            // --- Main Agent Logic ---

            const addMessage = (text, sender, isThought = false) => {
                const messageDiv = document.createElement('div');
                let content;

                if (sender === 'user') {
                    messageDiv.className = 'bg-indigo-600 p-3 rounded-lg self-end max-w-lg ml-auto';
                    content = `<p class="text-sm break-words">${text}</p>`;
                } else { // AI
                    if (isThought) {
                        messageDiv.className = 'agent-thought pl-4 py-2 max-w-lg';
                        content = `<div class="flex items-center space-x-2 text-purple-300">
                                <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <p class="text-sm font-medium">${text}</p>
                            </div>`;
                    } else {
                         messageDiv.className = 'bg-gray-700 p-3 rounded-lg max-w-lg';
                         content = `<p class="text-sm break-words">${text}</p>`;
                    }
                }
                
                messageDiv.innerHTML = content;
                dom.chatHistory.appendChild(messageDiv);
                dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight;
                return messageDiv;
            };

            const updateFileList = () => {
                if (projectFiles.length === 0) {
                    dom.fileList.innerHTML = '<p class="text-gray-400">No files generated yet.</p>';
                    return;
                }
                dom.fileList.innerHTML = projectFiles.map(file => `
                    <div class="bg-gray-700 p-3 rounded-md">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-indigo-300">${file.name}</p>
                            ${file.isGenerating ? '<svg class="w-4 h-4 animate-spin text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
                        </div>
                        <pre class="mt-2 text-xs bg-gray-800 p-2 rounded overflow-x-auto"><code>${escapeHtml(file.content.substring(0, 150))}...</code></pre>
                    </div>
                `).join('');
            };
            
            const escapeHtml = (unsafe) => {
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            };

            const handleSend = async () => {
                const prompt = dom.chatInput.value.trim();
                if (!prompt) return;

                addMessage(prompt, 'user');
                conversationHistory.push({role: 'user', text: prompt});
                dom.chatInput.value = '';
                
                if (agentState === 'idle' || agentState === 'awaiting_approval') {
                    await runAgentPlanner();
                } else if (agentState === 'refining') {
                    await runAgentRefiner(prompt);
                }
            };

            async function callApi(model, prompt, jsonSchema = null) {
                const TOKEN_COST = 3000;
                if (!canUseTokens(TOKEN_COST)) {
                    throw new Error("You have insufficient tokens for this action.");
                }

                let url, payload, headers;

                if (model === 'gemini') {
                    url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
                    headers = { 'Content-Type': 'application/json' };
                    payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
                    if (jsonSchema) {
                        payload.generationConfig = {
                            responseMimeType: "application/json",
                            responseSchema: jsonSchema
                        };
                    }
                } else if (model === 'deepseek') {
                    url = 'https://api.deepseek.com/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    };
                    payload = {
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: prompt }]
                    };
                    if (jsonSchema) {
                        payload.response_format = { type: "json_object" };
                    }
                } else {
                    throw new Error("Invalid model specified");
                }

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API Error (${model}): ${response.statusText} - ${errorBody}`);
                    }
                    const result = await response.json();
                    
                    let text;
                    if (model === 'gemini') {
                        if (!result.candidates || result.candidates.length === 0) throw new Error("Gemini API returned no candidates.");
                        text = result.candidates[0].content.parts[0].text;
                    } else { // deepseek
                        text = result.choices[0].message.content;
                    }

                    await deductTokens(TOKEN_COST);
                    return jsonSchema ? JSON.parse(text) : text.replace(/^```(html|javascript|css|json)?\s*|```\s*$/g, '').trim();
                } catch (error) {
                    console.error("API Call Failed:", error);
                    throw error;
                }
            }

            const runAgentPlanner = async () => {
                agentState = 'planning';
                dom.chatInput.disabled = true;
                dom.sendButton.disabled = true;

                try {
                    const planMessage = addMessage('Analyzing request and generating a project plan...', 'ai', true);
                    const planSchema = {
                        type: "OBJECT",
                        properties: {
                            plan: { type: "STRING", description: "A detailed, user-friendly explanation of the project plan, written in markdown. Explain the technology choices (e.g., vanilla JS, Tailwind CSS)." },
                            todo: { type: "ARRAY", items: { type: "STRING" }, description: "A list of tasks to be completed to generate the project." },
                            files: { type: "ARRAY", items: { type: "STRING" }, description: "A list of all filenames required for the project." }
                        },
                        required: ["plan", "todo", "files"]
                    };
                    const fullConversation = conversationHistory.map(m => `${m.role}: ${m.text}`).join('\n');
                    const planPrompt = `Based on the user's request history, create a comprehensive project plan. User request history:\n${fullConversation}\n\nProvide a detailed plan in markdown, a to-do list, and a list of necessary filenames.`;
                    const projectPlan = await callApi('gemini', planPrompt, planSchema);
                    
                    planMessage.innerHTML = planMessage.innerHTML.replace('Analyzing request...', `✅ Plan complete. Please review.`);
                    planMessage.querySelector('svg').style.animation = 'none';
                    agentState = 'awaiting_approval';

                    dom.planContent.innerHTML = `<div class="prose prose-invert text-gray-300">${projectPlan.plan}</div>`;
                    dom.todoContent.innerHTML = `<ul class="space-y-2">${projectPlan.todo.map((item, i) => `<li id="todo-${i}" class="flex items-center transition-colors duration-300 text-gray-400"><input type="checkbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 mr-3" disabled /><span>${item}</span></li>`).join('')}</ul>`;

                    projectFiles = projectPlan.files.map(name => ({ name, content: `<!-- Pending Generation -->`, isGenerating: false }));
                    updateFileList();
                    updatePreview();

                    displayApprovalControls(projectPlan);

                } catch (error) {
                    addMessage(`An error occurred during planning: ${error.message}`, 'ai');
                    agentState = 'idle';
                    dom.chatInput.disabled = false;
                    dom.sendButton.disabled = false;
                }
            };

            const displayApprovalControls = (projectPlan) => {
                const existingControls = document.getElementById('approval-controls');
                if(existingControls) existingControls.remove();

                const controlsContainer = document.createElement('div');
                controlsContainer.id = 'approval-controls';
                controlsContainer.className = 'bg-gray-700/50 p-3 rounded-lg flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4 my-4';
                
                const approveButton = document.createElement('button');
                approveButton.textContent = 'Approve & Build';
                approveButton.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md w-full sm:w-auto';
                
                const changesButton = document.createElement('button');
                changesButton.textContent = 'Request Changes';
                changesButton.className = 'bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md w-full sm:w-auto';

                controlsContainer.appendChild(approveButton);
                controlsContainer.appendChild(changesButton);
                dom.chatHistory.appendChild(controlsContainer);
                dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight;

                approveButton.onclick = async () => {
                    controlsContainer.innerHTML = '<p class="text-green-400">Plan approved. Starting build process...</p>';
                    await executeBuild(projectPlan);
                };

                changesButton.onclick = () => {
                    addMessage("Please specify the changes you'd like to make to the plan.", 'ai');
                    conversationHistory.push({role: 'ai', text: "Please specify the changes you'd like to make to the plan."});
                    agentState = 'refining';
                    dom.chatInput.disabled = false;
                    dom.sendButton.disabled = false;
                    dom.chatInput.focus();
                    controlsContainer.remove();
                };
            };
            
            const executeBuild = async (projectPlan) => {
                agentState = 'building';
                 for (let i = 0; i < projectFiles.length; i++) {
                    const file = projectFiles[i];
                    const todoItem = document.getElementById(`todo-${i}`);
                    if(todoItem) {
                        todoItem.classList.remove('text-gray-400');
                        todoItem.classList.add('text-purple-300');
                    }
                    
                    file.isGenerating = true;
                    updateFileList();

                    const codePrompt = `The user wants to build a project based on this plan: "${projectPlan.plan}". The full file list is: [${projectPlan.files.join(', ')}]. Generate the complete, production-ready code for the file named "${file.name}". Ensure it is well-commented and works with the other files. Only return the raw code, with no explanations or markdown backticks.`;
                    file.content = await callApi('gemini', codePrompt);
                    
                    file.isGenerating = false;
                    updateFileList();
                    updatePreview();

                    if(todoItem) {
                        todoItem.querySelector('input').checked = true;
                        todoItem.classList.remove('text-purple-300');
                        todoItem.classList.add('text-green-400');
                    }
                }

                addMessage('Project generation complete! You can now ask for changes or send it to the editor.', 'ai');
                conversationHistory.push({role: 'ai', text: 'Project generation complete! You can now ask for changes or send it to the editor.'});
                dom.sendToEditorContainer.classList.remove('hidden');
                dom.publishButton.classList.remove('hidden');
                agentState = 'refining';
                dom.chatInput.disabled = false;
                dom.sendButton.disabled = false;
            };

            const runAgentRefiner = async (prompt) => {
                agentState = 'refining';
                dom.chatInput.disabled = true;
                dom.sendButton.disabled = true;

                try {
                    const fileListString = projectFiles.map(f => f.name).join(', ');
                    const thought = addMessage('Analyzing which file to modify...', 'ai', true);
                    const fileTargetPrompt = `Given the following list of files [${fileListString}], which file would you modify to address this user request: "${prompt}"? Respond with only the filename.`;
                    const targetFile = await callApi('deepseek', fileTargetPrompt);
                    
                    const fileToEdit = projectFiles.find(f => f.name === targetFile);
                    if (!fileToEdit) {
                        throw new Error(`Model suggested a file that doesn't exist: ${targetFile}`);
                    }

                    thought.innerHTML = thought.innerHTML.replace('Analyzing which file...', `Okay, I need to modify \`${targetFile}\`. Generating new code...`);

                    fileToEdit.isGenerating = true;
                    updateFileList();

                    const refinementPrompt = `The user wants to modify a project. Their request is: "${prompt}". Here is the original code for the file \`${targetFile}\`:\n\n\`\`\`\n${fileToEdit.content}\n\`\`\`\n\nPlease provide the complete, updated code for this file that incorporates the user's request. Only return the raw, updated code with no explanations or markdown backticks.`;
                    const updatedCode = await callApi('gemini', refinementPrompt);

                    fileToEdit.content = updatedCode;
                    fileToEdit.isGenerating = false;
                    updateFileList();
                    updatePreview();
                    thought.remove();
                    addMessage(`I've updated \`${targetFile}\` with your changes.`, 'ai');

                } catch(error) {
                    addMessage(`Sorry, I ran into an error while refining the code: ${error.message}`, 'ai');
                } finally {
                    agentState = 'refining';
                    dom.chatInput.disabled = false;
                    dom.sendButton.disabled = false;
                }
            };

            const updatePreview = () => {
                const htmlFile = projectFiles.find(f => f.name === 'index.html');
                if (!htmlFile) {
                    dom.previewFrame.srcdoc = `<h1>Waiting for index.html...</h1>`;
                    return;
                }
                
                let htmlContent = htmlFile.content;

                projectFiles.forEach(file => {
                    if (file.name !== 'index.html') {
                        const blob = new Blob([file.content], { type: file.name.endsWith('.css') ? 'text/css' : 'application/javascript' });
                        const blobUrl = URL.createObjectURL(blob);
                        const regex = new RegExp(`(src|href)=["'](./)?${file.name}["']`, 'g');
                        htmlContent = htmlContent.replace(regex, `$1="${blobUrl}"`);
                    }
                });
                
                dom.previewFrame.srcdoc = htmlContent;
            };
            
            const handleSendToEditor = () => {
                if (projectFiles.length > 0) {
                    localStorage.setItem('codenix-agent-project', JSON.stringify(projectFiles.map(({name, content}) => ({name, content}))));
                    window.location.href = 'index.html';
                }
            };
            
            const handlePublish = () => {
                const htmlFile = projectFiles.find(f => f.name === 'index.html');
                if (!htmlFile) {
                    alert("Cannot publish without an index.html file.");
                    return;
                }
                let htmlContent = htmlFile.content;
                projectFiles.forEach(file => {
                     if (file.name.endsWith('.css')) {
                        const styleTag = `<style>${file.content}</style>`;
                        htmlContent = htmlContent.replace(/<link[^>]*?href=["'](.\/)?style.css["'][^>]*?>/, styleTag);
                     } else if (file.name.endsWith('.js')) {
                        const scriptTag = `<script>${file.content}<\/script>`;
                        htmlContent = htmlContent.replace(/<script[^>]*?src=["'](.\/)?script.js["'][^>]*?><\/script>/, scriptTag);
                     }
                });

                const dataUri = `data:text/html;charset=utf-8,${encodeURIComponent(htmlContent)}`;
                window.open(dataUri, '_blank');
            };

            // Tab switching logic
            dom.tabs.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    const tabId = e.target.dataset.tab;
                    dom.tabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-content`).classList.add('active');
                }
            });

            // Resizer Logic
            const initResizer = (resizer, panelA, panelB) => {
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    document.body.classList.add('resizing');
                    const onMouseMove = (moveEvent) => {
                        const totalWidth = panelA.offsetWidth + panelB.offsetWidth;
                        const newPanelAWidth = moveEvent.clientX - panelA.getBoundingClientRect().left;
                        if (newPanelAWidth > 200 && totalWidth - newPanelAWidth > 200) { // Minimum panel width
                            panelA.style.flexBasis = newPanelAWidth + 'px';
                            panelB.style.flexBasis = (totalWidth - newPanelAWidth) + 'px';
                        }
                    };
                    const onMouseUp = () => {
                        document.body.classList.remove('resizing');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            };

            initResizer(dom.resizer1, dom.leftPanel, dom.projectPanel);
            initResizer(dom.resizer2, dom.projectPanel, dom.previewPanel);


            dom.sendButton.addEventListener('click', handleSend);
            dom.chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleSend());
            dom.sendToEditorButton.addEventListener('click', handleSendToEditor);
            dom.publishButton.addEventListener('click', handlePublish);

            // --- Token Management ---
            function canUseTokens(amount) {
                if (userProfile.plan === 'unlimited') return true;
                
                const limits = {
                    free: 10000,
                    platinum: 50000
                };

                return (userProfile.tokens_used + amount) <= limits[userProfile.plan];
            }

            async function deductTokens(amount) {
                if (userProfile.plan === 'unlimited') return;

                const newTotal = userProfile.tokens_used + amount;
                const { error } = await supabase
                    .from('profiles')
                    .update({ tokens_used: newTotal })
                    .eq('id', userProfile.id);

                if (error) {
                    console.error("Error deducting tokens:", error);
                } else {
                    userProfile.tokens_used = newTotal;
                    updateTokenDisplay();
                }
            }

            function updateTokenDisplay() {
                 if (userProfile.plan === 'unlimited') {
                    dom.tokenDisplay.textContent = 'Unlimited Tokens';
                    return;
                 }
                 const limits = {
                    free: 10000,
                    platinum: 50000
                };
                const remaining = limits[userProfile.plan] - userProfile.tokens_used;
                dom.tokenDisplay.textContent = `Tokens: ${remaining.toLocaleString()} / ${limits[userProfile.plan].toLocaleString()}`;
            }


            addMessage('Welcome to the advanced Agent Mode! Describe the project you want to build.', 'ai');
            conversationHistory.push({role: 'ai', text: 'Welcome to the advanced Agent Mode! Describe the project you want to build.'});
        });
    </script>
</body>
</html>
